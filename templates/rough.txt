school_name = request.session.get('school_id', None)
staff_school_name = request.session.get('staff_school_id', None)
if school_name:
    school_id = school_name
elif staff_school_name:
    school_id = staff_school_name   
else:
    school_id = None    
print("school_name@@@",school_name)


if form.is_valid():
form.save()

obj = form.save(commit=False)
obj.created_by = request.user
obj.school_id_id = school_id
obj.save()

edit=======

parent_meeting = ParentMeeting.objects.all()
data = ParentMeeting.objects.get(id=pk)
data_school_id = data.school_id.id


if school_id == data_school_id:
    form.save()
else:
    form.instance.school_id_id = school_id
form.save()

delete========

parent_school_id = parent_meeting.school_id.id
if int(parent_school_id) == int(school_id):                        
    ParentMeeting.objects.get(id=pk).delete()
else:
    messages.error(request, "School id Doesn't match record no delete")

================================

def create_branch(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "" in request.permissions
        or "" in request.permissions
    ):
        # try:
            branch_name = request.POST.get("branch_name")
            print('branch_name',branch_name)
            location = request.POST.get("location")
            print('location',location)
            email = request.POST.get("email")
            print('email',email)
            school_id = request.POST.get("school_id")
            print('school_id',school_id)
            records = SchoolRegistration.objects.all()
            if request.method == "POST":
                record = Branch.objects.create(  
                        name=branch_name,
                        location=location,
                        email=email,
                        school_id=school_id
                    )            
                request.session['branch_id'] = record.id
                print("session_value",request.session['branch_id'])
                messages.success(request, "Record Saved Successfully")
                return HttpResponseRedirect("/")
            else:
                print("Not comes")
            context = {"records": records, "school_registration": "active"}
            return render(request, "System_setting/create_branch.html", context)
        # except Exception as error:
        #     return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")   


record=Branch.objects.get(school_id=school_name)        

''''''''''''''''''''''''''''''''''''''''''''''''''''''

    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)


obj = form.save(commit=False)
obj.created_by = request.user
obj.branch_id = branch_id
obj.save()  


widgets = {
    "branch_id": forms.HiddenInput(),           
}
labels={
    "branch_id":""
}

branch


data_branch_id = record.branch.id
form = ExpenseHeadForm(instance=record)
if request.method == "POST":
    form = ExpenseHeadForm(request.POST, instance=record)
    if form.is_valid():
        if branch_id == data_branch_id:
            form.save()
        else:
            form.instance.branch_id = branch_id
        form.save()

delete==============

@login_required
@user_type_required("Staff")
def expense_head_delete(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "expense_head_delete" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            expense_head=ExpenseHead.objects.get(id=pk)
            expense_head_branch_id = expense_head.branch.id
            if int(expense_head_branch_id) == int(branch_id):                        
                ExpenseHead.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/expense_head")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


        if form.is_valid():
        obj=form.save()
        obj.branch_id = branch_id
        obj.save()        
===============================================================submit============================
{% extends 'student_base.html' %}




{% block body_block %}
{% load static %}
<style>
    @media only screen and (max-width: 750px) {
        #title {
          font-size: 24px!important;
          margin-bottom: 0px!important;
        }
        #description {
          font-size: 15px!important;
          margin-bottom: 15px!important;
        }
        form {
          width: 550px!important;
        }
        .width {
          width: 500px!important;
        }
        input[type="checkbox"], input[type="radio"]
        {
          width: 12px!important;
          margin-right: 6px!important;
        } 
      }
      @media only screen and (max-width: 570px) {
        #title {
          font-size: 19px!important;
          margin-bottom: 0px!important;
        }
        #description {
          font-size: 12px!important;
          margin-bottom: 15px!important;
        }
        form {
          width: 430px!important;
          padding-top: 10px!important;
          padding-bottom: -5px!important;
        }
        .width {
          width: 390px!important;
        }
        input[type="checkbox"], input[type="radio"]
        {
          width: 11px!important;
          margin-right: 2px!important;
          margin-left: 3px!important;
        }
      }
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        background-color: rgba(249, 249, 249, 0.8);
        color: #f3f2f2;
        font-family: Tahoma;
      }
      h1, p {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      p {
        margin-bottom: 30px;
      }
      form {
        display: flex;
        flex-direction: column;
        width: 700px;
        background-color: rgba(43, 61, 81, 0.7);
        align-items: left;
        padding-top: 25px;
        border-radius: 10px;
        padding-left: 20px;
      }
      .width {
        width: 650px;
      }
      fieldset {
        display: flex;
        flex-direction: column;
        border: none;
      }
      legend {
        font-size: 18px;
        padding-top: 10px;
      }
      input, select, textarea {
        display: block;
        margin: 5px 0 20px 0;
        min-height: 2em;
        background-color: #0a0a23;
        border: 1px solid #0a0a23;
        color: #ffffff;
      }
      input, select {
         height: 2.5em;
      }
      label {
        display: block;
      }
      .inline {
        display: inline;
      }
      input[type="radio"] {
        width: 1em;
        min-height: auto;
        height: 1em;
        transform: scale(1.25);
        margin-bottom: 10px;
        margin-top: 10px;
        margin-left: 5px;
      }
      input[type="checkbox"] {
        width: 1em;
        min-height: auto;
        height: 1em;
        transform: scale(1.50);
        margin-bottom: 15px;
        margin-top: 15px;
        margin-left: 10px;
      }
      #name-label, #email-label, #number-label {
        font-size: 18px;
        font-family: sans-serif;
      }
      textarea {
        padding-bottom: 2em;
        height: 7em;
        font-size: 16px;
      }
      
      hr {
       border-color: white;
      }
</style>

<style>
  #counter {
      color: red; /* Red text color for the counter */
      font-size: 24px;
  }
</style>


<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Mental Health Survey Form</title>
        <link rel="stylesheet" href="styles.css">
    </head>
    <body>       
        <br>
     
       
              <!-- Displaying Start Time and Duration -->
<h6>Start Time: {{ Enrollment_record.start_time|date:"Y-m-d H:i:s" }} | Duration: {{ question_paper_record.duration }}</h6>

<!-- Timer display -->
<center><h6 style="color: red;" id="timer"> </h6></center>

        <h1 style="color: black;"> Madel Qewwstion Paper</h1>     
          
          
      </em><p> Please take your time to read and answer the following questions </em></p>
        <form method="post">
          {% csrf_token %} 
            <hr class="width">
            <!--radio question-->
            {% for data in questions %}
            <div style="margin-bottom: 20px;">
               <center> <h5 style="text-transform:capitalize;"> </h5></center>  
                        
               
                <h5 style="text-align: left;" name="questions">{{ forloop.counter }}. {{ data.text }}</h5>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                  <ol type="A">
                    {% for option in data.options %}
                   
                      <li>
                        
                        <div class="d-flex ">
                          <input type="radio" name="answers_{{data.id}}" value="{{ option.option }}" >
                          
                          
                        <label for="option_{{ option.id }}"  name="text_option_{{data.id}}" style="color: white;margin-top: 8px;">&nbsp;&nbsp;  {{ option.text }}</label>
                        </div>
                      </li>
                     
                    {% endfor %}
                  </ol>
              </div>
            </div>
            {%  if data.question_type == "paragraph"  %}
            <fieldset class="width">
             
              <label>
                  <textarea class="width" id="area" placeholder="Fill the answer..." row="3" cols="30" name="answers_{{data.id}}" ></textarea>
              </label>
          </fieldset>
          {% endif %}
          
            {% endfor %}      
        <center>
            <button type="submit" style="
            width: 200px;
            height: 50px;
            background: linear-gradient(to right, white 50%, rgb(255, 255, 255) 50%);
    
            cursor: pointer;
            font-size: 16px;
            text-align: center;
            padding: 10px;
            border-radius: 5px;
          ">
            Submit
          </button>
        </center>
            <hr class="width">
            <!--textarea question-->
            
        </form>

<!-- Timer display -->
<!-- <center><h6 style="color: red;" id="timer"></h6></center> -->

<script>
  document.addEventListener("DOMContentLoaded", function () {
      // Get the duration value from the template as a string "HH:MM:SS"
      var countdownDuration = "{{ question_paper_record.duration }}"; // e.g., "03:00:00"
  
      // Get the start time from the template (ensure it's in 'Y-m-d H:i:s' format)
      var startTimeStr = "{{ Enrollment_record.start_time|date:'Y-m-d H:i:s' }}"; // Ensure correct format
  
      // Check if we have stored data in sessionStorage
      var examStarted = sessionStorage.getItem('examStarted');
      if (!examStarted) {
          // If not started, set the examStarted flag and start time
          sessionStorage.setItem('examStarted', true);
          sessionStorage.setItem('examStartTime', new Date().toISOString());
      }
  
      // Function to parse start time and handle different formats
      function parseStartTime(startTimeStr) {
          // Try to parse directly
          var startTime = new Date(startTimeStr);
  
          // If the direct parse fails, manually construct the date
          if (isNaN(startTime.getTime())) {
              var parts = startTimeStr.split(/[- :]/);
              if (parts.length === 6) {
                  startTime = new Date(
                      parseInt(parts[0]),              // Year
                      parseInt(parts[1], 10) - 1,      // Month (0-based)
                      parseInt(parts[2]),              // Day
                      parseInt(parts[3]),              // Hours
                      parseInt(parts[4]),              // Minutes
                      parseInt(parts[5])               // Seconds
                  );
              } else {
                  startTime = new Date(); // Fallback to current date/time
              }
          }
          return startTime;
      }
  
      var startTime = parseStartTime(startTimeStr);
  
      // Check if the start time is valid
      if (isNaN(startTime.getTime())) {
          console.error("Invalid start time:", startTimeStr);
          document.getElementById("timer").innerHTML = "Invalid time configuration!";
          return;
      }
  
      // Ensure the duration is in the "HH:MM:SS" format
      if (!countdownDuration) {
          console.error("Duration is not available or improperly formatted.");
          document.getElementById("timer").innerHTML = "Invalid time configuration!";
          return;
      }
  
      // Split the duration string into hours, minutes, and seconds
      var durationParts = countdownDuration.split(":");
  
      // Parse hours, minutes, and seconds into integers
      var hours = parseInt(durationParts[0], 10);
      var minutes = parseInt(durationParts[1], 10);
      var seconds = parseInt(durationParts[2], 10);
  
      // Calculate the countdown time in milliseconds
      var countdownTime = (hours * 60 * 60 + minutes * 60 + seconds) * 1000;
  
      // Get the current time (when the page is loaded)
      var currentTime = new Date().getTime();
  
      // Get the stored exam start time
      var examStartTimeStr = sessionStorage.getItem('examStartTime');
      var examStartTime = new Date(examStartTimeStr).getTime();
  
      // Calculate the end time by adding the countdown duration to the start time
      var endTime = new Date(examStartTime + countdownTime).getTime();
  
      // If time has already passed, show "Time's Up!" and stop the function
      if (currentTime > endTime) {
          document.getElementById("timer").innerHTML = "Time's Up!";
          window.location.href = "/student/online_exam_complete"; // Redirect to another page if time's up
          return;
      }
  
      // Update the countdown every second
      var countdownInterval = setInterval(function () {
        // Get the current time
        var now = new Date().getTime();
    
        // Calculate the time remaining
        var remainingTime = endTime - now;
    
        // If the time is up, stop the countdown and submit the form
        if (remainingTime <= 0) {
            clearInterval(countdownInterval);
            document.getElementById("timer").innerHTML = "Time's Up!";
            
            // Submit the form via AJAX
            var form = document.querySelector('form');
            var formData = new FormData(form);
    
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name="csrfmiddlewaretoken"]').value
                }
            }).then(response => {
                if (response.ok) {
                    window.location.href = "/student/online_exam_complete"; // Replace with your desired URL
                } else {
                    console.error('Form submission failed');
                }
            }).catch(error => {
                console.error('Error:', error);
            });
    
            return;
        }
    
        // Time calculations for hours, minutes, and seconds
        var remainingHours = Math.floor((remainingTime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        var remainingMinutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
        var remainingSeconds = Math.floor((remainingTime % (1000 * 60)) / 1000);
    
        // Display the time in the hh:mm:ss format
        document.getElementById("timer").innerHTML = 
            (remainingHours.toString().padStart(2, '0')) + ":" + 
            (remainingMinutes.toString().padStart(2, '0')) + ":" + 
            (remainingSeconds.toString().padStart(2, '0'));
    
    }, 1000);
  
      // Function to handle page unload
      window.addEventListener('beforeunload', function (e) {
          var confirmationMessage = 'You will lose your progress if you leave this page. Are you sure you want to continue?';
          e.returnValue = confirmationMessage; // Standard for most browsers
          return confirmationMessage; // For some older browsers
      });
  
      // Function to disable navigation elements
      function disableNavigation() {
        var links = document.querySelectorAll('a');
        var buttons = document.querySelectorAll('button');
        var submitButton = document.querySelector('button[type="submit"]');
        
        links.forEach(function(link) {
            link.addEventListener('click', function(event) {
                event.preventDefault();
            });
        });
        
        buttons.forEach(function(button) {
            if (button !== submitButton) {
                button.disabled = true;
            }
        });
    }
  
      // Call this function at the start of the exam
      disableNavigation();
  
      // Function to enable navigation elements
      function enableNavigation() {
        var links = document.querySelectorAll('a');
        var buttons = document.querySelectorAll('button');
        
        links.forEach(function(link) {
            link.removeEventListener('click', function(event) {
                event.preventDefault();
            });
        });
        
        buttons.forEach(function(button) {
            button.disabled = false;
        });
    }
  
      // Example: Call `enableNavigation()` when the exam is completed
      function examComplete() {
        enableNavigation();
        // Redirect or show a completion message
        window.location.href = "/online_exam_complete";
    }
  
      // Call `examComplete()` function at the appropriate time
      // e.g., after the countdown is over
  
      // Fullscreen API Function
      function enterFullscreen() {
          if (document.documentElement.requestFullscreen) {
              document.documentElement.requestFullscreen();
          } else if (document.documentElement.mozRequestFullScreen) { // Firefox
              document.documentElement.mozRequestFullScreen();
          } else if (document.documentElement.webkitRequestFullscreen) { // Chrome, Safari and Opera
              document.documentElement.webkitRequestFullscreen();
          } else if (document.documentElement.msRequestFullscreen) { // IE/Edge
              document.documentElement.msRequestFullscreen();
          }
      }
  
      // Enter fullscreen on page load
      enterFullscreen();
  
      // Optional: Prevent context menu (right-click)
      document.addEventListener('contextmenu', function(e) {
          e.preventDefault();
      });
  });

  
  </script>
</body>
</html>


{% endblock %}
{% block script_block %}

{% endblock  %}

====================================+++++++++++++++++=================================================
{% extends 'student_base.html' %}




{% block body_block %}
{% load static %}
<style>
    @media only screen and (max-width: 750px) {
        #title {
          font-size: 24px!important;
          margin-bottom: 0px!important;
        }
        #description {
          font-size: 15px!important;
          margin-bottom: 15px!important;
        }
        form {
          width: 550px!important;
        }
        .width {
          width: 500px!important;
        }
        input[type="checkbox"], input[type="radio"]
        {
          width: 12px!important;
          margin-right: 6px!important;
        } 
      }
      @media only screen and (max-width: 570px) {
        #title {
          font-size: 19px!important;
          margin-bottom: 0px!important;
        }
        #description {
          font-size: 12px!important;
          margin-bottom: 15px!important;
        }
        form {
          width: 430px!important;
          padding-top: 10px!important;
          padding-bottom: -5px!important;
        }
        .width {
          width: 390px!important;
        }
        input[type="checkbox"], input[type="radio"]
        {
          width: 11px!important;
          margin-right: 2px!important;
          margin-left: 3px!important;
        }
      }
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        background-color: rgba(249, 249, 249, 0.8);
        color: #f3f2f2;
        font-family: Tahoma;
      }
      h1, p {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      p {
        margin-bottom: 30px;
      }
      form {
        display: flex;
        flex-direction: column;
        width: 700px;
        background-color: rgba(43, 61, 81, 0.7);
        align-items: left;
        padding-top: 25px;
        border-radius: 10px;
        padding-left: 20px;
      }
      .width {
        width: 650px;
      }
      fieldset {
        display: flex;
        flex-direction: column;
        border: none;
      }
      legend {
        font-size: 18px;
        padding-top: 10px;
      }
      input, select, textarea {
        display: block;
        margin: 5px 0 20px 0;
        min-height: 2em;
        background-color: #0a0a23;
        border: 1px solid #0a0a23;
        color: #ffffff;
      }
      input, select {
         height: 2.5em;
      }
      label {
        display: block;
      }
      .inline {
        display: inline;
      }
      input[type="radio"] {
        width: 1em;
        min-height: auto;
        height: 1em;
        transform: scale(1.25);
        margin-bottom: 10px;
        margin-top: 10px;
        margin-left: 5px;
      }
      input[type="checkbox"] {
        width: 1em;
        min-height: auto;
        height: 1em;
        transform: scale(1.50);
        margin-bottom: 15px;
        margin-top: 15px;
        margin-left: 10px;
      }
      #name-label, #email-label, #number-label {
        font-size: 18px;
        font-family: sans-serif;
      }
      textarea {
        padding-bottom: 2em;
        height: 7em;
        font-size: 16px;
      }
      
      hr {
       border-color: white;
      }
</style>

<style>
  #counter {
      color: red; /* Red text color for the counter */
      font-size: 24px;
  }
</style>


<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Mental Health Survey Form</title>
        <link rel="stylesheet" href="styles.css">
    </head>
    <body>       
        <br>
     
       
              <!-- Displaying Start Time and Duration -->
<h6>Start Time: {{ Enrollment_record.start_time|date:"Y-m-d H:i:s" }} | Duration: {{ question_paper_record.duration }}</h6>

<!-- Timer display -->
<center><h6 style="color: red;" id="timer"> </h6></center>

        <h1 style="color: black;"> Madel Qewwstion Paper</h1>     
          
          
      </em><p> Please take your time to read and answer the following questions </em></p>
        <form method="post">
          {% csrf_token %} 
            <hr class="width">
            <!--radio question-->
            {% for data in questions %}
            <div style="margin-bottom: 20px;">
               <center> <h5 style="text-transform:capitalize;"> </h5></center>  
                        
               
                <h5 style="text-align: left;" name="questions">{{ forloop.counter }}. {{ data.text }}</h5>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                  <ol type="A">
                    {% for option in data.options %}
                   
                      <li>
                        
                        <div class="d-flex ">
                          <input type="radio" name="answers_{{data.id}}" value="{{ option.option }}" >
                          
                          
                        <label for="option_{{ option.id }}"  name="text_option_{{data.id}}" style="color: white;margin-top: 8px;">&nbsp;&nbsp;  {{ option.text }}</label>
                        </div>
                      </li>
                     
                    {% endfor %}
                  </ol>
              </div>
            </div>
            {%  if data.question_type == "paragraph"  %}
            <fieldset class="width">
             
              <label>
                  <textarea class="width" id="area" placeholder="Fill the answer..." row="3" cols="30" name="answers_{{data.id}}" ></textarea>
              </label>
          </fieldset>
          {% endif %}
          
            {% endfor %}      
        <center>
            <button type="submit" style="
            width: 200px;
            height: 50px;
            background: linear-gradient(to right, white 50%, rgb(255, 255, 255) 50%);
    
            cursor: pointer;
            font-size: 16px;
            text-align: center;
            padding: 10px;
            border-radius: 5px;
          ">
            Submit
          </button>
        </center>
            <hr class="width">
            <!--textarea question-->
            
        </form>

<!-- Timer display -->
<!-- <center><h6 style="color: red;" id="timer"></h6></center> -->

<script>
  document.addEventListener("DOMContentLoaded", function () {
      // Get the duration value from the template as a string "HH:MM:SS"
      var countdownDuration = "{{ question_paper_record.duration }}"; // e.g., "03:00:00"
  
      // Get the start time from the template (ensure it's in 'Y-m-d H:i:s' format)
      var startTimeStr = "{{ Enrollment_record.start_time|date:'Y-m-d H:i:s' }}"; // Ensure correct format
  
      // Check if we have stored data in sessionStorage
      var examStarted = sessionStorage.getItem('examStarted');
      if (!examStarted) {
          // If not started, set the examStarted flag and start time
          sessionStorage.setItem('examStarted', true);
          sessionStorage.setItem('examStartTime', new Date().toISOString());
      }
  
      // Function to parse start time and handle different formats
      function parseStartTime(startTimeStr) {
          // Try to parse directly
          var startTime = new Date(startTimeStr);
  
          // If the direct parse fails, manually construct the date
          if (isNaN(startTime.getTime())) {
              var parts = startTimeStr.split(/[- :]/);
              if (parts.length === 6) {
                  startTime = new Date(
                      parseInt(parts[0]),              // Year
                      parseInt(parts[1], 10) - 1,      // Month (0-based)
                      parseInt(parts[2]),              // Day
                      parseInt(parts[3]),              // Hours
                      parseInt(parts[4]),              // Minutes
                      parseInt(parts[5])               // Seconds
                  );
              } else {
                  startTime = new Date(); // Fallback to current date/time
              }
          }
          return startTime;
      }
  
      var startTime = parseStartTime(startTimeStr);
  
      // Check if the start time is valid
      if (isNaN(startTime.getTime())) {
          console.error("Invalid start time:", startTimeStr);
          document.getElementById("timer").innerHTML = "Invalid time configuration!";
          return;
      }
  
      // Ensure the duration is in the "HH:MM:SS" format
      if (!countdownDuration) {
          console.error("Duration is not available or improperly formatted.");
          document.getElementById("timer").innerHTML = "Invalid time configuration!";
          return;
      }
  
      // Split the duration string into hours, minutes, and seconds
      var durationParts = countdownDuration.split(":");
  
      // Parse hours, minutes, and seconds into integers
      var hours = parseInt(durationParts[0], 10);
      var minutes = parseInt(durationParts[1], 10);
      var seconds = parseInt(durationParts[2], 10);
  
      // Calculate the countdown time in milliseconds
      var countdownTime = (hours * 60 * 60 + minutes * 60 + seconds) * 1000;
  
      // Get the current time (when the page is loaded)
      var currentTime = new Date().getTime();
  
      // Get the stored exam start time
      var examStartTimeStr = sessionStorage.getItem('examStartTime');
      var examStartTime = new Date(examStartTimeStr).getTime();
  
      // Calculate the end time by adding the countdown duration to the start time
      var endTime = new Date(examStartTime + countdownTime).getTime();
  
      // If time has already passed, show "Time's Up!" and stop the function
      if (currentTime > endTime) {
          document.getElementById("timer").innerHTML = "Time's Up!";
          window.location.href = "/student/online_exam_complete"; // Redirect to another page if time's up
          return;
      }
  
      // Update the countdown every second
      var countdownInterval = setInterval(function () {
        // Get the current time
        var now = new Date().getTime();
    
        // Calculate the time remaining
        var remainingTime = endTime - now;
    
        // If the time is up, stop the countdown and submit the form
        if (remainingTime <= 0) {
            clearInterval(countdownInterval);
            document.getElementById("timer").innerHTML = "Time's Up!";
            
            // Submit the form via AJAX
            var form = document.querySelector('form');
            var formData = new FormData(form);
    
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name="csrfmiddlewaretoken"]').value
                }
            }).then(response => {
                if (response.ok) {
                    window.location.href = "/student/online_exam_complete"; // Replace with your desired URL
                } else {
                    console.error('Form submission failed');
                }
            }).catch(error => {
                console.error('Error:', error);
            });
    
            return;
        }
    
        // Time calculations for hours, minutes, and seconds
        var remainingHours = Math.floor((remainingTime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        var remainingMinutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
        var remainingSeconds = Math.floor((remainingTime % (1000 * 60)) / 1000);
    
        // Display the time in the hh:mm:ss format
        document.getElementById("timer").innerHTML = 
            (remainingHours.toString().padStart(2, '0')) + ":" + 
            (remainingMinutes.toString().padStart(2, '0')) + ":" + 
            (remainingSeconds.toString().padStart(2, '0'));
    
    }, 1000);
  
      // Function to handle page unload
      {% comment %} window.addEventListener('beforeunload', function (e) {
          var confirmationMessage = 'You will lose your progress if you leave this page. Are you sure you want to continue?';
          e.returnValue = confirmationMessage; // Standard for most browsers
          return confirmationMessage; // For some older browsers
      }); {% endcomment %}
  
      // Function to disable navigation elements
      function disableNavigation() {
        var links = document.querySelectorAll('a');
        var buttons = document.querySelectorAll('button');
        var submitButton = document.querySelector('button[type="submit"]');
        
        links.forEach(function(link) {
            link.addEventListener('click', function(event) {
                event.preventDefault();
            });
        });
        
        buttons.forEach(function(button) {
            if (button !== submitButton) {
                button.disabled = true;
            }
        });
    }
  
      // Call this function at the start of the exam
      disableNavigation();
  
      // Function to enable navigation elements
      function enableNavigation() {
        var links = document.querySelectorAll('a');
        var buttons = document.querySelectorAll('button');
        
        links.forEach(function(link) {
            link.removeEventListener('click', function(event) {
                event.preventDefault();
            });
        });
        
        buttons.forEach(function(button) {
            button.disabled = false;
        });
    }
  
      // Example: Call `enableNavigation()` when the exam is completed
      function examComplete() {
        enableNavigation();
        // Redirect or show a completion message
        window.location.href = "/online_exam_complete";
    }
  
      // Call `examComplete()` function at the appropriate time
      // e.g., after the countdown is over
  
      // Fullscreen API Function
      function enterFullscreen() {
          if (document.documentElement.requestFullscreen) {
              document.documentElement.requestFullscreen();
          } else if (document.documentElement.mozRequestFullScreen) { // Firefox
              document.documentElement.mozRequestFullScreen();
          } else if (document.documentElement.webkitRequestFullscreen) { // Chrome, Safari and Opera
              document.documentElement.webkitRequestFullscreen();
          } else if (document.documentElement.msRequestFullscreen) { // IE/Edge
              document.documentElement.msRequestFullscreen();
          }
      }
  
      // Enter fullscreen on page load
      enterFullscreen();
  
      // Optional: Prevent context menu (right-click)
      document.addEventListener('contextmenu', function(e) {
          e.preventDefault();
      });
  });
  </script>
</body>
</html> 


{% endblock %}
{% block script_block %}

{% endblock  %}

=======================currect script online_exam_assign ==========
{% extends 'student_base.html' %}




{% block body_block %}
{% load static %}
<style>
    @media only screen and (max-width: 750px) {
        #title {
          font-size: 24px!important;
          margin-bottom: 0px!important;
        }
        #description {
          font-size: 15px!important;
          margin-bottom: 15px!important;
        }
        form {
          width: 550px!important;
        }
        .width {
          width: 500px!important;
        }
        input[type="checkbox"], input[type="radio"]
        {
          width: 12px!important;
          margin-right: 6px!important;
        } 
      }
      @media only screen and (max-width: 570px) {
        #title {
          font-size: 19px!important;
          margin-bottom: 0px!important;
        }
        #description {
          font-size: 12px!important;
          margin-bottom: 15px!important;
        }
        form {
          width: 430px!important;
          padding-top: 10px!important;
          padding-bottom: -5px!important;
        }
        .width {
          width: 390px!important;
        }
        input[type="checkbox"], input[type="radio"]
        {
          width: 11px!important;
          margin-right: 2px!important;
          margin-left: 3px!important;
        }
      }
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        background-color: rgba(249, 249, 249, 0.8);
        color: #f3f2f2;
        font-family: Tahoma;
      }
      h1, p {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      p {
        margin-bottom: 30px;
      }
      form {
        display: flex;
        flex-direction: column;
        width: 700px;
        background-color: rgba(43, 61, 81, 0.7);
        align-items: left;
        padding-top: 25px;
        border-radius: 10px;
        padding-left: 20px;
      }
      .width {
        width: 650px;
      }
      fieldset {
        display: flex;
        flex-direction: column;
        border: none;
      }
      legend {
        font-size: 18px;
        padding-top: 10px;
      }
      input, select, textarea {
        display: block;
        margin: 5px 0 20px 0;
        min-height: 2em;
        background-color: #0a0a23;
        border: 1px solid #0a0a23;
        color: #ffffff;
      }
      input, select {
         height: 2.5em;
      }
      label {
        display: block;
      }
      .inline {
        display: inline;
      }
      input[type="radio"] {
        width: 1em;
        min-height: auto;
        height: 1em;
        transform: scale(1.25);
        margin-bottom: 10px;
        margin-top: 10px;
        margin-left: 5px;
      }
      input[type="checkbox"] {
        width: 1em;
        min-height: auto;
        height: 1em;
        transform: scale(1.50);
        margin-bottom: 15px;
        margin-top: 15px;
        margin-left: 10px;
      }
      #name-label, #email-label, #number-label {
        font-size: 18px;
        font-family: sans-serif;
      }
      textarea {
        padding-bottom: 2em;
        height: 7em;
        font-size: 16px;
      }
      
      hr {
       border-color: white;
      }
</style>

<style>
  #counter {
      color: red; /* Red text color for the counter */
      font-size: 24px;
  }
</style>


<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Mental Health Survey Form</title>
        <link rel="stylesheet" href="styles.css">
    </head>
    <body>       
        <br>
     
       
              <!-- Displaying Start Time and Duration -->
<h6>Start Time: {{ Enrollment_record.start_time|date:"Y-m-d H:i:s" }} | Duration: {{ question_paper_record.duration }}</h6>

<!-- Timer display -->
<center><h6 style="color: red;" id="timer"> </h6></center>

        <h1 style="color: black;"> Madel Qewwstion Paper</h1>     
          
          
      </em><p> Please take your time to read and answer the following questions </em></p>
        <form method="post">
          {% csrf_token %} 
            <hr class="width">
            <!--radio question-->
            {% for data in questions %}
            <div style="margin-bottom: 20px;">
               <center> <h5 style="text-transform:capitalize;"> </h5></center>  
                        
               
                <h5 style="text-align: left;" name="questions">{{ forloop.counter }}. {{ data.text }}</h5>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                  <ol type="A">
                    {% for option in data.options %}
                   
                      <li>
                        
                        <div class="d-flex ">
                          <input type="radio" name="answers_{{data.id}}" value="{{ option.option }}" >
                          
                          
                        <label for="option_{{ option.id }}"  name="text_option_{{data.id}}" style="color: white;margin-top: 8px;">&nbsp;&nbsp;  {{ option.text }}</label>
                        </div>
                      </li>
                     
                    {% endfor %}
                  </ol>
              </div>
            </div>
            {%  if data.question_type == "paragraph"  %}
            <fieldset class="width">
             
              <label>
                  <textarea class="width" id="area" placeholder="Fill the answer..." row="3" cols="30" name="answers_{{data.id}}" ></textarea>
              </label>
          </fieldset>
          {% endif %}
          
            {% endfor %}      
        <center>
            <button type="submit" style="
            width: 200px;
            height: 50px;
            background: linear-gradient(to right, white 50%, rgb(255, 255, 255) 50%);
    
            cursor: pointer;
            font-size: 16px;
            text-align: center;
            padding: 10px;
            border-radius: 5px;
          ">
            Submit
          </button>
        </center>
            <hr class="width">
            <!--textarea question-->
            
        </form>

<!-- Timer display -->
<!-- <center><h6 style="color: red;" id="timer"></h6></center> -->

<script>
  document.addEventListener("DOMContentLoaded", function () {
      // Get the duration value from the template as a string "HH:MM:SS"
      var countdownDuration = "{{ question_paper_record.duration }}"; // e.g., "03:00:00"
  
      // Get the start time from the template (ensure it's in 'Y-m-d H:i:s' format)
      var startTimeStr = "{{ Enrollment_record.start_time|date:'Y-m-d H:i:s' }}"; // Ensure correct format
  
      // Check if we have stored data in sessionStorage
      var examStarted = sessionStorage.getItem('examStarted');
      if (!examStarted) {
          // If not started, set the examStarted flag and start time
          sessionStorage.setItem('examStarted', true);
          sessionStorage.setItem('examStartTime', new Date().toISOString());
      }
  
      // Function to parse start time and handle different formats
      function parseStartTime(startTimeStr) {
          // Try to parse directly
          var startTime = new Date(startTimeStr);
  
          // If the direct parse fails, manually construct the date
          if (isNaN(startTime.getTime())) {
              var parts = startTimeStr.split(/[- :]/);
              if (parts.length === 6) {
                  startTime = new Date(
                      parseInt(parts[0]),              // Year
                      parseInt(parts[1], 10) - 1,      // Month (0-based)
                      parseInt(parts[2]),              // Day
                      parseInt(parts[3]),              // Hours
                      parseInt(parts[4]),              // Minutes
                      parseInt(parts[5])               // Seconds
                  );
              } else {
                  startTime = new Date(); // Fallback to current date/time
              }
          }
          return startTime;
      }
  
      var startTime = parseStartTime(startTimeStr);
  
      // Check if the start time is valid
      if (isNaN(startTime.getTime())) {
          console.error("Invalid start time:", startTimeStr);
          document.getElementById("timer").innerHTML = "Invalid time configuration!";
          return;
      }
  
      // Ensure the duration is in the "HH:MM:SS" format
      if (!countdownDuration) {
          console.error("Duration is not available or improperly formatted.");
          document.getElementById("timer").innerHTML = "Invalid time configuration!";
          return;
      }
  
      // Split the duration string into hours, minutes, and seconds
      var durationParts = countdownDuration.split(":");
  
      // Parse hours, minutes, and seconds into integers
      var hours = parseInt(durationParts[0], 10);
      var minutes = parseInt(durationParts[1], 10);
      var seconds = parseInt(durationParts[2], 10);
  
      // Calculate the countdown time in milliseconds
      var countdownTime = (hours * 60 * 60 + minutes * 60 + seconds) * 1000;
  
      // Get the current time (when the page is loaded)
      var currentTime = new Date().getTime();
  
      // Get the stored exam start time
      var examStartTimeStr = sessionStorage.getItem('examStartTime');
      var examStartTime = new Date(examStartTimeStr).getTime();
  
      // Calculate the end time by adding the countdown duration to the start time
      var endTime = new Date(examStartTime + countdownTime).getTime();
  
      // If time has already passed, show "Time's Up!" and stop the function
      if (currentTime > endTime) {
          document.getElementById("timer").innerHTML = "Time's Up!";
          window.location.href = "/student/online_exam_complete"; // Redirect to another page if time's up
          return;
      }
  
      // Update the countdown every second
      var countdownInterval = setInterval(function () {
        // Get the current time
        var now = new Date().getTime();
    
        // Calculate the time remaining
        var remainingTime = endTime - now;
    
        // If the time is up, stop the countdown and submit the form
        if (remainingTime <= 0) {
            clearInterval(countdownInterval);
            document.getElementById("timer").innerHTML = "Time's Up!";
            
            // Submit the form via AJAX
            var form = document.querySelector('form');
            var formData = new FormData(form);
    
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name="csrfmiddlewaretoken"]').value
                }
            }).then(response => {
                if (response.ok) {
                    window.location.href = "/student/online_exam_complete"; // Replace with your desired URL
                } else {
                    console.error('Form submission failed');
                }
            }).catch(error => {
                console.error('Error:', error);
            });
    
            return;
        }
    
        // Time calculations for hours, minutes, and seconds
        var remainingHours = Math.floor((remainingTime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        var remainingMinutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
        var remainingSeconds = Math.floor((remainingTime % (1000 * 60)) / 1000);
    
        // Display the time in the hh:mm:ss format
        document.getElementById("timer").innerHTML = 
            (remainingHours.toString().padStart(2, '0')) + ":" + 
            (remainingMinutes.toString().padStart(2, '0')) + ":" + 
            (remainingSeconds.toString().padStart(2, '0'));
    
    }, 1000);
  
      // Function to handle page unload
      {% comment %} window.addEventListener('beforeunload', function (e) {
          var confirmationMessage = 'You will lose your progress if you leave this page. Are you sure you want to continue?';
          e.returnValue = confirmationMessage; // Standard for most browsers
          return confirmationMessage; // For some older browsers
      }); {% endcomment %}
  
      // Function to disable navigation elements
      function disableNavigation() {
        var links = document.querySelectorAll('a');
        var buttons = document.querySelectorAll('button');
        var submitButton = document.querySelector('button[type="submit"]');
        
        links.forEach(function(link) {
            link.addEventListener('click', function(event) {
                event.preventDefault();
            });
        });
        
        buttons.forEach(function(button) {
            if (button !== submitButton) {
                button.disabled = true;
            }
        });
    }
  
      // Call this function at the start of the exam
      disableNavigation();
  
      // Function to enable navigation elements
      function enableNavigation() {
        var links = document.querySelectorAll('a');
        var buttons = document.querySelectorAll('button');
        
        links.forEach(function(link) {
            link.removeEventListener('click', function(event) {
                event.preventDefault();
            });
        });
        
        buttons.forEach(function(button) {
            button.disabled = false;
        });
    }
  
      // Example: Call `enableNavigation()` when the exam is completed
      function examComplete() {
        enableNavigation();
        // Redirect or show a completion message
        window.location.href = "/online_exam_complete";
    }
  
      // Call `examComplete()` function at the appropriate time
      // e.g., after the countdown is over
  
      // Fullscreen API Function
      function enterFullscreen() {
          if (document.documentElement.requestFullscreen) {
              document.documentElement.requestFullscreen();
          } else if (document.documentElement.mozRequestFullScreen) { // Firefox
              document.documentElement.mozRequestFullScreen();
          } else if (document.documentElement.webkitRequestFullscreen) { // Chrome, Safari and Opera
              document.documentElement.webkitRequestFullscreen();
          } else if (document.documentElement.msRequestFullscreen) { // IE/Edge
              document.documentElement.msRequestFullscreen();
          }
      }
  
      // Enter fullscreen on page load
      enterFullscreen();
  
      // Optional: Prevent context menu (right-click)
      document.addEventListener('contextmenu', function(e) {
          e.preventDefault();
      });
  });
  </script>
</body>
</html>


{% endblock %}
{% block script_block %}

{% endblock  %}

======================================================

{% extends 'base.html' %}
{% block body_block %}
{% load static %}

<div class="container-fluid">
    <div class="row">
       <div class="main-header">
          <h4>Select Criteria</h4>
       </div>
    </div>

    <div class="col-md-12">
        <div class="card" style="padding: 10px;border-top: 5px solid black;">
            <form method="post">
                {% csrf_token %}
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="class">Class</label>
                    <select class="form-control" name="class" id="id_Class">
                        <option value="" >---Select---</option>
                        {% for data in class_records %}
                        <option value="{{ data.id }}">{{data.Class}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="section">Section</label>
                    <select class="form-control" name="section" id="id_section">
                        <option value="">---Select---</option>
                        {% for data in section_records %}
                        <option value="{{ data.id }}">{{data.section_name}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="section">Category</label>
                    <select class="form-control" name="category">
                        <option value="">---Select---</option>
                        {% for data in category_records %}
                        <option value="{{ data.id }}">{{data.category}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="section">Gender</label>
                    <select class="form-control" name="gender">
                        <option value="">---Select---</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="section">RTE</label>
                    <select class="form-control" name="RET">
                        <option value="">---Select---</option>
                        <option value="Yes">Yes</option>
                        <option value="no">no</option>
                    </select>
                </div>

                <div class="col-md-4 mb-3" style="padding-top: 30px;">
                <button type="submit" class="btn btn-primary">Search</button>
                 </div>

            </div>
        </form>
        </div>
    </div>

    {% if records %}
    <div class="row">
     <div class="col-md-12">
         <div class="card" style="padding: 10px;border-top: 5px solid black;">
            <div class="table-responsive">
            <table  class="table"  >
                <thead>
                    <tr>
                        <th colspan="2">Test</th>
                        <th><input type="checkbox" id="select-all-checkbox"> <label for="select-all-checkbox">All</label></th>
                        <th>Admission No</th>
                        <th>Student Name</th>
                        <th>Class</th>
                        <th>Father Name</th>
                        <th>Category</th>
                        <th>Gender</th>
                    </tr>
                </thead>
                <tbody>
                    <form  method="post">
                    {% for data in records %}
                    <tr>
                        <td>{{ fees_record.fees_group }}</td>
                        <td>{{ fees_record.amount }}</td>
                        <td><input type="checkbox" name="check" class="data-checkbox" id="check_{{forloop.counter}}" value="{{data.id}}"></td>
                        <td>{{ data.admission_no }}</td>
                        <td>{{ data.first_name }} {{ data.last_name }}</td>
                        <td>{{ data.Class }}</td>
                        <td>{{ data.Father_name }}</td>
                        <td>{{ data.category }}</td>
                        <td>{{ data.gender }}</td>
                    </tr>
                    {% endfor %}
                    <tr>
                        <td colspan="8"></td>
                            {% comment %} <td ><button type="button" class="btn btn-primary" name="assign_btn" value="assign_btn" onclick="save()">Save</button></td> {% endcomment %}
                            <td><button type="button" class="btn btn-primary" name="assign_btn" value="assign_btn" onclick="save()">Save</button></td>

                        </tr>
                </form>
                </tbody>

            </table>
            </div>
         </div>
     </div>
 </div>
 {% else %}
 <center> <h5>No Records Found </h5></center>
 {% endif %}
     <!-- modal Start -->


 {% endblock %}
 {% block script_block %}



<script>
    $(document).ready(function () {
    $(document).on('change', '#id_Class', function () {
      var class_id = $('#id_Class').val();
      var url = "{% url 'section_js' %}";
      $.ajax({
        url: url,
        data: {
          'class_id': class_id
        },
        success: function (data) {
            $("#id_section").html(data);
            let html_data = '<option value="">--------</option>';
            data.forEach(function (section) {
                html_data += `<option value="${section.id}">${section.section_name}</option>`
            });
            console.log(html_data);
            $("#id_section").html(html_data);
        },
        error: function (data) {
          console.log(data);
        }
      });
    });

});
</script>


{% comment %} <script>
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const dataCheckboxes = document.getElementsByClassName('data-checkbox');

    // Handle "Select All" checkbox
    selectAllCheckbox.addEventListener('change', function() {
        for (let i = 0; i < dataCheckboxes.length; i++) {
            dataCheckboxes[i].checked = selectAllCheckbox.checked;
        }
    });

    // Handle individual checkbox change
    for (let i = 0; i < dataCheckboxes.length; i++) {
        dataCheckboxes[i].addEventListener('change', function() {
            if (!this.checked) {
                selectAllCheckbox.checked = false;
            } else {
                // Check if all checkboxes are selected
                let allSelected = true;
                for (let j = 0; j < dataCheckboxes.length; j++) {
                    if (!dataCheckboxes[j].checked) {
                        allSelected = false;
                        break;
                    }
                }
                selectAllCheckbox.checked = allSelected;
            }
        });
    }

    function save() {
        // Safely pass Django variables to JavaScript
        var fees_id = "{{ fees_record.id }}";
    
        // Alert the `fees_id`
        alert("The fees_id is: " + fees_id);
        var url = "{% url 'fees_master_assign_js' %}";
    
        var id_list = [];
        for (var i = 1; i <= {{ records_count }}; i++) {
            var checkbox = $('#check_' + i);
            if (checkbox.prop('checked')) {
                id_list.push(checkbox.val());
            }
        }
    
        // Make AJAX request with POST method
        $.ajax({
            url: url,
            method: 'POST',
            data: {
                "id_list": JSON.stringify(id_list),  // Serialize array
                "fees_id": fees_id,
                "csrfmiddlewaretoken": '{{ csrf_token }}'  // Add CSRF token
            },
            success: function(data) {
                alert("Updated successfully");
            },
            error: function(xhr, status, error) {
                console.log("Error:", xhr.responseText);
            }
        });
    }
</script> {% endcomment %}

{% comment %} <script>
function save()
    {
        var fees_id = {{fees_record.id}};
        var url="{% url 'fees_master_assign_js' %}";

        var id_list=[]
        for(var i = 1; i < {{records_count}}+1; i++){
            if($('#check_'+i).prop('checked') == true){
                check = $('#check_'+i).val();
                id_list.push(check);
            }
        }
        $.ajax({
            url:url,
            data: {
            "id_list": id_list,
            "fees_id":fees_id,
            },
            success: function(data){
                alert("Updated");
           },
           error:function(data)
            {
                console.log(data);
            }
     });
    }

</script> {% endcomment %}
 <script>
    function save() {
        // Safely pass Django variables to JavaScript
       
        var fees_id = "{{ fees_record.id }}";
    
        // Alert the `fees_id`
        alert("The fees_id is: " + fees_id);
        var url = "{% url 'fees_master_assign_js' %}";
    
        var id_list = [];
        for (var i = 1; i <= {{ records_count }}; i++) {
            var checkbox = $('#check_' + i);
            if (checkbox.prop('checked')) {
                id_list.push(checkbox.val());
            }
        }
    
        // Make AJAX request with POST method
        $.ajax({
            url: url,
            method: 'POST',  // Use POST instead of GET
            data: {
                "id_list": JSON.stringify(id_list),  // Serialize array
                "fees_id": fees_id,
                "csrfmiddlewaretoken": '{{ csrf_token }}'  // Add CSRF token
            },
            success: function(data) {
                alert("Updated successfully");
            },
            error: function(xhr, status, error) {
                console.log("Error:", xhr.responseText);
            }
        });
    }
    </script> 
    
    <!-- Button to trigger the save function -->
    

<!-- JavaScript code to handle checkbox behavior -->
 <script>
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const dataCheckboxes = document.getElementsByClassName('data-checkbox');

    selectAllCheckbox.addEventListener('change', function() {
      for (let i = 0; i < dataCheckboxes.length; i++) {
        dataCheckboxes[i].checked = selectAllCheckbox.checked;
      }
    });

    for (let i = 0; i < dataCheckboxes.length; i++) {
      dataCheckboxes[i].addEventListener('change', function() {
        if (!this.checked) {
          selectAllCheckbox.checked = false;
        } else {
          // Check if all other checkboxes are selected
          let allSelected = true;
          for (let j = 0; j < dataCheckboxes.length; j++) {
            if (!dataCheckboxes[j].checked) {
              allSelected = false;
              break;
            }
          }
          selectAllCheckbox.checked = allSelected;
        }
      });
    }
  </script> 
{% comment %} <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script> {% endcomment %}
 {% endblock  %}

========================================================
def fees_master_assign_js(request):
    print("+++++")
    if request.method == 'POST':  # Use POST to modify the database
        id_list = request.POST.getlist("id_list[]")
        print("+++++id_list",id_list)
        fees_id = request.POST.get("fees_id")
        print("+++++fees_id",fees_id)

        try:
            fees_master = FeesMaster.objects.get(id=fees_id)  # Get the FeesMaster object
        except FeesMaster.DoesNotExist:
            return JsonResponse({'status': 'error', 'message': 'FeesMaster does not exist'}, status=404)

        for student_id in id_list:
            FeesAssign.objects.get_or_create(
                student_id=student_id,
                fees_id=fees_id,
                balance_amount=fees_master.amount,
                paid_amount=0,
                status="pending",
                session=request.session.session_key,  # Correct usage of session
            )

        return JsonResponse({'status': 'success', 'message': 'Saved successfully'}, status=200)

    return JsonResponse({'status': 'error', 'message': 'Invalid request method'}, status=400) 



    ==================================================old code===============================================

    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    system_fields = SystemFields.objects.all()
    guardian_master = GuardianMaster.objects.all()
    system_field = (
        system_fields.last().student_fields if system_fields.last() else None
    )
    custom_fields = CustomFields.objects.filter(field_belongs_to="Student",branch_id=branch_id)
    records = StudentAdmission.objects.all()
    obj=''
    # student_account = None
    # Create the corresponding Account for the student using the function from accounts.py
    student_account = create_student_account(obj)
    form = StudentAdmissionForm()

    if request.method == "POST":  
        user_student = None
        user_parent = None

        names_list=request.POST.getlist("name")
        if names_list:
            guardian_name = names_list[0] 
        
        email_list = request.POST.getlist("guardian_email")

        guardian_email = email_list[0] if email_list else None
        print('gamil_---11111', guardian_email)      

        student_healths=request.POST.get("student_health")
        print('student_healths',student_healths)
        suspended_or_nots= request.POST.get("suspended_or_not")
        print('suspended_or_nots',suspended_or_nots)
        is_suspension_resolveds= request.POST.get("is_suspension_resolved")
        print('is_suspension_resolveds',is_suspension_resolveds)
        form = StudentAdmissionForm(request.POST)
        if form.is_valid():
        
            obj = form.save(commit=False)                    
            obj.student_health = student_healths
            obj.suspended_or_not = suspended_or_nots
            obj.is_suspension_resolved = is_suspension_resolveds
            obj.branch_id = branch_id
            obj.save()
            password_student = generate_password()
            password_parent = generate_password()
          
            last_name = form.cleaned_data["last_name"] or ""

            # Create a user account for the student
            first_name=form.cleaned_data["first_name"]
            username_student = f"student{first_name[0]}{records.count()}"
            user_student = User.objects.create_user(
                username=username_student,
                first_name=form.cleaned_data["first_name"],
                last_name=last_name,
                email=form.cleaned_data["email"],
                password=password_student,
                user_type="Student",
            )
            user_student.save()
            branch = Branch.objects.get(id=branch_id)
            print("branch+++", branch.school.reference_id)            

            data = {
                'password': password_student,
                'first_name': username_student,
                'middle_name': form.cleaned_data["last_name"],
                'last_name': form.cleaned_data["last_name"],
                'email': form.cleaned_data["email"],
                'phone_number': form.cleaned_data["mobile_number"],
                'company_name': branch.school.reference_id,  # Serializing the id
                'branch_name': branch.reference_id  # Serializing the id
            }
            # input_params_values = {
            #     "student_name":username_student,
            #     "roll_no":roll_no,
            # }
            print("++++++++++++++++++")

            json_data = json.dumps(data)
            print("=========", json_data)

            response = call_post_method(BASE_URL, endpoint, json_data, token)
            print("response+++", response)
            if response.status_code != 200:
                print('Response Status Code:', response.content)
            # Create a user account for the parent
            if guardian_name:
                username_parent = f"parent{guardian_name[0]}{records.count()}"
            else:
                username_parent = f"parent{records.count()}"
            if guardian_email:
                user_parent = User.objects.create_user(
                    username=username_parent,
                    first_name=guardian_name if guardian_name else "Parent",
                    email=guardian_email,
                    password=password_parent,
                    user_type="Parent",
                )
                user_parent.save()
            else:
                print("No guardian email provided.")
            
            # Send an email to the student
            recipient_name_student = obj.first_name
            recipient_email_student = form.cleaned_data["email"]
            new_staff_account_email(
                recipient_name_student,
                recipient_email_student,
                password_student,
            )

            # Send an email to the parent
            recipient_name_parent = guardian_name
            print('recipient_name_parent',recipient_name_parent)
            recipient_email_parent = guardian_email
            print('recipient_email_parent',recipient_email_parent)
            new_staff_account_email(
                recipient_name_parent, recipient_email_parent, password_parent
            )

            # Create StudentAdmission instance
            if user_student is not None and user_parent is not None:
                obj.session = request.session
                obj.user_student_id = user_student.pk
                obj.user_parent_id = user_parent.pk
                obj.account = student_account
                obj.created_by = request.user
                obj.save()
            else:
                print("User creation failed or missing required user instance.")
            # Check if the session exists, create if not
            session_instance, created = Session.objects.get_or_create(
                session=request.Session
            )
            LoginCredentials.objects.create(
                student_id=obj.pk,
                student_username=username_student,
                student_password=password_student,
                parent_username=username_parent,
                parent_passwod=password_parent,
                branch_id=branch_id
            )
            StudentSession.objects.create(
                session=session_instance,
                student_id=obj.pk,
                status="Active",
                branch_id = branch_id
            )
            StudentClass.objects.create(
                session=session_instance,
                student_id=obj.pk,
                Class_id=request.POST.get("Class"),
                section_id=request.POST.get("section"),
                status="Active",
                branch_id = branch_id
            )                        
            StudentClass.objects.create(
                session=session_instance,
                student_id=obj.pk,
                Class_id=request.POST.get("Class"),
                section_id=request.POST.get("section"),
                status="Active",
                branch_id = branch_id
            )   
            if guardian_email :
                guardianmaster_id=request.POST.getlist("guardianmaster_id")
                names_list=request.POST.getlist("name")
                phone_list=request.POST.getlist("phone")
                eamil_list=request.POST.getlist("guardian_email")
                occupation_list=request.POST.getlist("occupation")
                branch = Branch.objects.get(id=branch_id)
                print("branch+++", branch.school.reference_id) 
                for i in range(len(names_list)):
                    
                    data = {
                        'password': password_student,
                        'first_name': names_list[i],
                        'middle_name': form.cleaned_data["last_name"],
                        'last_name': form.cleaned_data["last_name"],
                        'email': eamil_list[i],
                        'phone_number': phone_list[i],
                        'company_name': branch.school.reference_id,  # Serializing the id
                        'branch_name': branch.reference_id  # Serializing the id
                    }
                    print("++++++++++++++++++")

                    json_data = json.dumps(data)
                    print("=========", json_data)

                    response = call_post_method(BASE_URL, endpoint, json_data,token)
                    print("response+++", response)
                    if response.status_code != 200:
                        print('Response Status Code:', response.content)  

                    StudentGuardianDetails.objects.get_or_create(
                        student_id=obj.id,
                        guardianmaster_id=int(guardianmaster_id[i]),
                        name=names_list[i],
                        phone=phone_list[i],
                        guardian_email=eamil_list[i],
                        occupation=occupation_list[i],
                        branch_id = branch_id
                    )  


                if staff.is_admin:
                    return HttpResponseRedirect(f"select_branch/{satff.school.id}") 
                else:                    
                    request.session['branch_id'] = satff.branch.id
                    print("request.session",request.session['branch_id'])
                    return redirect("dashboard")    
                    
                    





                    def create_school_registration(request):
 
                    # try:
                        token = request.session['user_token']
                        branch_name = request.session.get('branch_id', None)
                        if branch_name:
                            branch_id = branch_name       
                        else:
                            branch_id = None  
                        print("branch_name@@@",branch_name)
                        endpoint = 'finance/company/'
                        # endpoint_currency = 'finance/currency/'
                        school_name = request.POST.get("school_name")
                        print('school_name',school_name)
                        address = request.POST.get("address")
                        print('address',address)
                        form = SchoolRegistrationForm()
                        records = SchoolRegistration.objects.all()
                        # response = call_get_method(BASE_URL,endpoint_currency,token)
                        # currency_data = response.json()
                        # # Extract all currency_code values into a list
                        # currency_codes = [item['currency_code'] for item in currency_data]
                
                        # print("All currency_codes:", currency_codes)
                        # if response.status_code != 200:
                        #     return render(request, 'error500.html', {'error': str(response.json())})
                        # response1 = call_get_method(BASE_URL,endpoint1,request.user)
                        # if response1.status_code != 200:
                        #     return render(request, 'error500.html', {'error': str(response.json())})
                        if request.method == "POST":
                            form = SchoolRegistrationForm(request.POST)
                            if form.is_valid():
                                local_currency = form.cleaned_data['local_currency']
                                print("reference_id", local_currency.currency_id)
                                currency_value = Currency.objects.get(currency_id=local_currency.currency_id)
                                print("currency_value", currency_value.reference_id)
                                data = {
                                    'company_name': form.cleaned_data['school_name'],
                                    'address': form.cleaned_data['address'],
                                    'last_name': form.cleaned_data['last_name'],
                                    'phone': form.cleaned_data['phone_number'],
                                    'email': form.cleaned_data['email'],
                                    'incorporation_number': form.cleaned_data['incorporation_number'],
                                    'website': form.cleaned_data['website'],
                                    'number_of_branches': form.cleaned_data['number_of_branches'],
                                    'number_of_staffs': form.cleaned_data['number_of_staffs'],
                                    'end_of_financial_year': form.cleaned_data['end_of_financial_year'].strftime('%Y-%m-%d'),
                                    'end_of_month_date': form.cleaned_data['end_of_month_date'].strftime('%Y-%m-%d'),
                                    'amount_rounded_to': form.cleaned_data['amount_rounded_to'],
                                    'local_currency': currency_value.reference_id,
                                }
                
                                print("++++++++++++++++++")
                                json_data = json.dumps(data)
                                print("=========", json_data)
                                response = call_post_method(BASE_URL, endpoint, json_data, token)
                
                                if response.status_code != 200:
                                    print('Response Status Code:', response.content)
                                    response_data = json.loads(response.content.decode('utf-8'))
                
                                    # Handling error messages from the response
                                    for field, errors in response_data.items():
                                        for error in errors:
                                            messages.error(request, f"{field}: {error}")
                                else:
                                    response_data = json.loads(response.content.decode('utf-8'))
                                    print("response_dataelse", response_data)
                
                                    record = form.save(commit=False)
                                    print("record===", record)
                
                                    # Assign branch_id and reference_id before saving
                                    record.branch_id = branch_id
                                    record.reference_id = response_data['record_id']
                
                                    # Generate a unique school_id and assign it
                                    record.school_id = unique_id("SCHREG", SchoolRegistration)
                
                                    # Save the record to the database
                                    record.save()
                                    print('record', record.school_name)
                            
                                    request.session['school_registration_id'] = record.id
                                    print("session_value",request.session['school_registration_id'])
                                    messages.success(request, "Record Saved Successfully")
                                    return HttpResponseRedirect(f"create_branch/{record.id}")
                        else:
                            print("Not comes")
                        context = {"records": records,"form":form, "school_registration": "active"}
                        return render(request, "System_setting/create_school_registration.html", context)
                    # except Exception as error:
                    #     return render(request, "error.html", {"error": error})    
                    
====================================================================================================================


            token = request.session['user_token'] 
            endpoint = 'finance/transaction-type/'
            endpoint_transaction = 'finance/all-transaction/'
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = AddExpense.objects.all()
            form = AddExpenseForm()

            # Get user_id from the current user
            user_id = request.user.id
                                
            # Assuming User model has a ForeignKey to School
            user_school = request.user.school

            # Get the school account associated with the user's school
            # school_account = user_school.account

            if request.method == "POST":
                form = AddExpenseForm(request.POST, request.FILES)
                if form.is_valid():
                    response = call_get_method(BASE_URL, endpoint, token)
                    transaction_data = response.json()
                    print("transaction_data", transaction_data)

                    # Extract 'name' and 'transaction_type_id' into a list of dictionaries
                    transaction_list = [{'name': item['name'], 'transaction_type_id': item['transaction_type_id']} for item in transaction_data]

                    print("transaction_list", transaction_list)
                    payroll_transaction = next((transaction for transaction in transaction_list if transaction['name'] == 'Payroll'), None)
                    if payroll_transaction:
                        transaction_name = payroll_transaction['name']
                        transaction_type_id = payroll_transaction['transaction_type_id']
                        print("Transaction Name:", transaction_name)
                        print("Transaction Type ID:", transaction_type_id)
                    else:
                        print("No 'Payroll' transaction found.")
                    if response.status_code != 200:
                        return render(request, 'error500.html', {'error': str(response.json())})
                            

                    if request.method == "POST":
                        expence_amount=form.cleaned_data["amount"]
                        branch = Branch.objects.get(id=branch_id)
                        print("branch+++", branch.school.reference_id) 
                        
                      
                        student_information = {
                            "student_name": f"{form.cleaned_data.get('name')}",
                            "roll_no": f"{form.cleaned_data.get('invoice_number')}"
                        }

                        # converting student_information to JSON format
                        # student_information_json = json.dumps(student_information)
                        # print("++++tudent",type(student_information_json))

                        # using it in the data dictionary
                    data = {
                        'transaction_type_id': str(transaction_type_id),
                        'company_id': str(branch.school.reference_id),
                        'amount': int(expence_amount),
                        'input_params_values': student_information 
                    }
                    print("++++++++++++++++++",type(data))

                    json_data = json.dumps(data)
                    print("=========", type(json_data))

                    response = call_post_method(BASE_URL, endpoint_transaction, json_data, token)
                    print("response+++", response)
                    if response.status_code != 200:
                        print('Response Status Code:', response.content)
                    response_data = json.loads(response.content.decode('utf-8')) 
                    transaction_id=response_data['record_id']    
                    print("transaction_id",transaction_id)
                    Transaction.objects.create(
                        student_id=None,
                        reference_id=transaction_id,                   
                        branch_id = branch_id
                    )
===================================================================================================================

invoice = Invoice.objects.create(          
  issue_date=current_date,
  due_date=current_date,
  total_amount=total_amount_expense,
  status="GranateInvoice",
  payment_date=current_date,
  created_by=request.user,
  branch_id=branch_id
  )
invoice.invoice_number = unique_id("Invoice", Invoice)
invoice.expense.set(valid_expenses) 
invoice.save() 

======================================================================================================================


{% extends 'base.html' %}

{% block body_block %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Question Paper</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        .question-form, .option-field {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <br>
        <center>
        <div class="row">
            <div class="col-md-12">
                <h4>Add Question Paper</h4>
            </div>
        </div>
    </center>
        <br>
        <form method="post">
            {% csrf_token %}

            <div class="col-md-12">
                <div class="card" style="padding: 10px;">
                    <!-- Question Paper Details -->
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <h5>Question Paper Details</h5>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="{{ paper_form.question_paper_name.id_for_label }}">Question Paper Name</label>
                        </div>
                        <div class="col-md-8 mb-3">
                            {{ paper_form.question_paper_name }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="{{ paper_form.total_mark.id_for_label }}">Total Mark</label>
                        </div>
                        <div class="col-md-8 mb-3">
                            {{ paper_form.total_mark }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="{{ paper_form.pass_mark.id_for_label }}">Pass Mark</label>
                        </div>
                        <div class="col-md-8 mb-3">
                            {{ paper_form.pass_mark }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="{{ paper_form.duration.id_for_label }}">Duration</label>
                        </div>
                        <div class="col-md-8 mb-3">
                            {{ paper_form.duration }}
                        </div>
                    </div>

                    <!-- Parts and Questions -->
                    <div class="container-fluid">
                        <hr>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <h5>Parts and Questions</h5>
                            </div>
                        </div>
                        <hr>
                        <div id="parts-container">
                            <!-- Parts and Questions will be dynamically added here -->
                        </div>
                    </div>

                    <!-- Add Part Button -->
                    <div class="row">
                        <div class="col-md-12 text-right">
                            <button type="button" onclick="addPart()" class="btn btn-primary">Add Part</button>
                        </div>
                    </div>

                    
                    <div class="row mt-3">
                        <div class="col-md-12 text-right">
                            <button type="submit"  class="btn btn-success">Save</button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <script>
        let partCount = 0;
        function addPart() {
            const partsContainer = document.getElementById('parts-container');
            partCount++;
            const partDiv = document.createElement('div');
            partDiv.classList.add('part-form');
            partDiv.innerHTML = `
                <div class="card mb-3" style="padding: 10px;">
                    <h4>Part ${partCount}</h4>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label>Part Name:</label>
                            <input type="text" name="part-${partCount}-name" class="form-control" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label>Marks Per Question:</label>
                            <input type="number" name="part-${partCount}-marks-per-question" class="form-control" value="1" oninput="updateMarksForPart(${partCount})" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label>Total Marks:</label>
                            <input type="number" name="part-${partCount}-marks-total" class="form-control" readonly>
                            <input type="hidden" name="total_part" value="${partCount}" class="form-control" >
                        </div>
                        <div class="col-md-3 mb-3">
                            <label>Total Question:</label>
                            <input type="number" name="part-${partCount}-total-questions" class="form-control" readonly>
                            <input type="hidden" name="total_questions" value="${partCount}" class="form-control" >
                        </div>
                        <div class="col-md-4 text-right">
                            <button type="button" onclick="deletePart(this)" class="btn btn-danger">Delete Part</button>
                        </div>
                    </div>
                    <div id="questions-container-${partCount}">
                        <!-- Questions for this part will be added here -->
                    </div>
                    <button type="button" onclick="addQuestion(${partCount})" class="btn btn-secondary">Add Question to Part ${partCount}</button>
                </div>
            `;
            partsContainer.appendChild(partDiv);
        }

        function addQuestion(partIndex) {
            const questionsContainer = document.getElementById(`questions-container-${partIndex}`);
            const formCount = questionsContainer.querySelectorAll('.question-form').length;
            const newForm = document.createElement('div');
            newForm.classList.add('question-form');
            newForm.dataset.index = formCount;
            newForm.innerHTML = `
                <h5>Question ${formCount + 1}</h5>
                <label>Question Text:</label>
                <input type="text" name="part-${partIndex}-form-${formCount}-text" class='form-control' required>
                <br>
                <label>Question Type:</label>
                <select name="part-${partIndex}-form-${formCount}-question_type" class='form-control' onchange="toggleFields('part-${partIndex}-choice-fields-${formCount}', 'part-${partIndex}-paragraph-fields-${formCount}', this.value)" required>
                    <option value="">Select</option>
                    <option value="choice">Choice</option>
                    <option value="paragraph">Paragraph</option>
                </select>
                <br>
                <label>Marks:</label>
                <input type="number" name="part-${partIndex}-form-${formCount}-marks" class='form-control' readonly>
                <br>
                <div id="part-${partIndex}-choice-fields-${formCount}" class="choice-fields" style="display:none;">
                    <div id="options-container-${partIndex}-${formCount}">
                        <!-- Options for this question will be added here -->
                    </div>
                    <button type="button" onclick="addOption(${partIndex}, ${formCount})" class="btn btn-secondary">+ Add Option</button>
                </div>
                <div id="part-${partIndex}-paragraph-fields-${formCount}" class="paragraph-fields" style="display:none;">
                    <!-- Paragraph field can be added here if needed -->
                </div>
                <br>
                <button type="button" onclick="deleteQuestion(this)" class="btn btn-danger">Delete Question</button>
            `;
            questionsContainer.appendChild(newForm);
            updateMarksForPart(partIndex);
            toggleFieldsForExisting();
        }

        function addOption(partIndex, questionIndex) {
            const optionsContainer = document.getElementById(`options-container-${partIndex}-${questionIndex}`);
            const optionCount = optionsContainer.querySelectorAll('.option-field').length + 1;
            const newOption = document.createElement('div');
            newOption.classList.add('option-field');
            newOption.innerHTML = `
                <label>Option ${optionCount}:</label>
                <input type="text" name="part-${partIndex}-form-${questionIndex}-option" class='form-control' required>
                <label>
                    <input type="radio" name="part-${partIndex}-form-${questionIndex}-correct_option" value="${optionCount}">
                    Correct Answer
                </label>
                <br>
            `;
            optionsContainer.appendChild(newOption);
        }

        function deletePart(button) {
            const partForm = button.closest('.part-form');
            partForm.remove();
        }

        function deleteQuestion(button) {
            const questionForm = button.closest('.question-form');
            questionForm.remove();
            // Recalculate total marks for remaining questions
            const partIndex = button.closest('.part-form').querySelector('input[name^="part-"]').name.split('-')[1];
            updateMarksForPart(partIndex);
        }

        function updateMarksForPart(partIndex) {
            const partDiv = document.querySelector(`.part-form:nth-of-type(${partIndex})`);
            const marksPerQuestion = parseFloat(partDiv.querySelector(`input[name="part-${partIndex}-marks-per-question"]`).value) || 0;
            const questionForms = partDiv.querySelectorAll('.question-form');
            const totalMarksForPart = marksPerQuestion * questionForms.length;

            questionForms.forEach((form) => {
                const marksInput = form.querySelector(`input[name^="part-${partIndex}-form-"][name$="-marks"]`);
                marksInput.value = marksPerQuestion;
            });

            // Update total marks for the part
            partDiv.querySelector(`input[name="part-${partIndex}-marks-total"]`).value = totalMarksForPart;
            partDiv.querySelector(`input[name="part-${partCount}-total-questions"]`).value = questionForms.length;
        }

        function toggleFields(choiceId, paragraphId, questionType) {
            document.getElementById(choiceId).style.display = questionType === 'choice' ? 'block' : 'none';
            document.getElementById(paragraphId).style.display = questionType === 'paragraph' ? 'block' : 'none';

            const choiceFields = document.getElementById(choiceId).querySelectorAll('input, select');
            choiceFields.forEach(field => {
                field.required = questionType === 'choice';
            });
        }

        function toggleFieldsForExisting() {
            const forms = document.querySelectorAll('.question-form');
            forms.forEach((form) => {
                const questionType = form.querySelector('[name$=question_type]').value;
                const choiceFields = form.querySelector('.choice-fields');
                const paragraphFields = form.querySelector('.paragraph-fields');
                toggleFields(choiceFields.id, paragraphFields.id, questionType);
            });
        }

        window.onload = function() {
            toggleFieldsForExisting();
        }
    </script>
{% endblock %}

=================================================================================
<script>
  $(document).ready(function () {
    // Open modal and populate with data
    $('.edit-btn').on('click', function (event) {
      event.preventDefault();
  
      // Get data attributes from the clicked button
      let paymentMode = $(this).data('payment-mode');
      let discount = $(this).data('discount');
      let fine = $(this).data('fine');
      let paid = $(this).data('paid');
      let uniqueid = $(this).data('uniqueid');
      let paymentDate = $(this).data('date');
      let fessId = $(this).data('fess_ids'); // Get fess_id from data attribute
  
      // Debugging to ensure the value is retrieved
      console.log("fess_ids:", fessId);
  
      // Format the date if necessary
      if (paymentDate.includes('/')) {
        let parts = paymentDate.split('/');
        paymentDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
      } else if (paymentDate.includes('-')) {
        let parts = paymentDate.split('-');
        if (parts[2].length === 4) {
          paymentDate = `${parts[2]}-${parts[0]}-${parts[1]}`;
        }
      }
  
      // Set data in modal fields
      $('input[name="payment_mode_fee"][value="' + paymentMode + '"]').prop('checked', true);
      $('#discountAmount').val(discount);
      $('#fineAmount').val(fine);
      $('#paidAmount').val(paid);
      $('#paymentDate').val(paymentDate);
  
      // Set fess_idd value in the modal
      $('#fess_ids').val(fessId);
  
      // Set the form action and hidden input
      setFormAction(uniqueid);
  
      // Show the modal
      $('#editModal').modal('show');
    });
  });
  
  function setFormAction(uniqueid) {
    const form = document.getElementById('feesForm');
    const dataIdField = document.getElementById('dataIdField');
    const pkField = document.getElementById('pkValue').value; // Get pk value
  
    // Update the form action or any hidden field if necessary
    dataIdField.value = uniqueid;  // Set the uniqueid to the hidden field
  
    // You can also change form action or any other logic here
    console.log("Form action updated with ID:", uniqueid);
  }
</script>
=============================================================================

@login_required
@user_type_required("Staff")
def create_expense(request):
    # if (
    #     request.user.is_superuser or request.user.is_school_admin
    #     or "expense_view" in request.permissions
    #     or "expense_add" in request.permissions
    #     or request.permissions
    # ):
    #     try:
            token = request.session['user_token'] 
            endpoint = 'finance/transaction-type/'
            endpoint_transaction = 'finance/all-transaction/'
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Expense.objects.all()
            form = ExpenseForm()

            if request.method == "POST":
                payment_type = request.POST.get("option")                
                print("payment_type", payment_type)
                form = ExpenseForm(request.POST, request.FILES)
                if form.is_valid():
                    response = call_get_method(BASE_URL, endpoint, token)
                    transaction_data = response.json()
                    print("transaction_data", transaction_data)

                    # Extract 'name' and 'transaction_type_id' into a list of dictionaries
                    transaction_list = [{'name': item['name'], 'transaction_type_id': item['transaction_type_id']} for item in transaction_data]

                    print("transaction_list", transaction_list)
                    payroll_transaction = next((transaction for transaction in transaction_list if transaction['name'] == 'Payroll'), None)
                    if payroll_transaction:
                        transaction_name = payroll_transaction['name']
                        transaction_type_id = payroll_transaction['transaction_type_id']
                        print("Transaction Name:", transaction_name)
                        print("Transaction Type ID:", transaction_type_id)
                    else:
                        print("No 'Payroll' transaction found.")
                    if response.status_code != 200:
                        return render(request, 'error500.html', {'error': str(response.json())})
                            

                    if request.method == "POST":
                        expence_amount=form.cleaned_data["amount"]
                        branch = Branch.objects.get(id=branch_id)
                        print("branch+++", branch.school.reference_id) 
                        
                      
                        student_information = {
                            "student_name": f"{form.cleaned_data.get('name')}",
                            "roll_no": f"{form.cleaned_data.get('invoice_number')}"
                        }

                        # converting student_information to JSON format
                        # student_information_json = json.dumps(student_information)
                        # print("++++tudent",type(student_information_json))

                        # using it in the data dictionary
                    data = {
                        'transaction_type_id': str(transaction_type_id),
                        'company_id': str(branch.school.reference_id),
                        'amount': int(expence_amount),
                        'input_params_values': student_information 
                    }
                    print("++++++++++++++++++",type(data))

                    json_data = json.dumps(data)
                    print("=========", type(json_data))

                    response = call_post_method(BASE_URL, endpoint_transaction, json_data, token)
                    print("response+++", response)
                    if response.status_code != 200:
                        print('Response Status Code:', response.content)
                    response_data = json.loads(response.content.decode('utf-8')) 
                    transaction_id=response_data['record_id']    
                    print("transaction_id",transaction_id)
                    Transaction.objects.create(
                        student_id=None,
                        reference_id=transaction_id,                   
                        branch_id = branch_id
                    )
                    
                expense_instance = form.save()
                expense_instance.branch_id = branch_id
                
                if payment_type == "regular_payment":
                    expense_instance.regular_payment = True 
                    expense_instance.one_time_payment = False   
                    expense_instance.save()
                if  payment_type == "one_time_payment":   
                    expense_instance.one_time_payment = True
                    expense_instance.regular_payment = False     
                    expense_instance.save()
                    
                    valid_expenses = []
                    expense = Expense.objects.get(id=data)            
                    valid_expenses.append(expense.id) 
                    invoice = Invoice.objects.create(          
                    issue_date=form.cleaned_data["invoice_date"],
                    due_date=None,
                    total_amount=form.cleaned_data["amount"],
                    status="GranateInvoice",
                    payment_date=form.cleaned_data["payment_date"],
                    created_by=request.user,
                    branch_id=branch_id       
                    )
                    invoice.invoice_number = unique_id("Invoice", Invoice)
                    invoice.expense.set(valid_expenses) 
                    invoice.save()
                    return HttpResponseRedirect(f"/view_invoice/{invoice}")    
                    
                expense_instance.save()
                
                
                # Call collect_expense function with user_id
                # success = collect_expense(expense_instance, user_id)
                success =True
                if success:
                    messages.success(request, "Record Saved Successfully")
                else:
                    messages.error(request, "Failed to process the expense")
                return HttpResponseRedirect("/create_expense")
            else:
                print(form.errors)

            context = {"form": form, "records": records, "create_expense": "active"}
            return render(request, "Expenses/create_expense.html", context)
    #     except Exception as error:
    #         return render(request, "error.html", {"error": error})
    # else:
    #     return redirect("dashboard")
======================================================================================================


{% extends 'base.html' %}
{% load static %}
<style>
  body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
  }
  .invoice-container {
      max-width: 800px;
      margin: 20px auto;
      background: white;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
  }
  .header {
      background-color: #007b8f;
      color: white;
      padding: 20px;
      text-align: center;
  }
  .header h1 {
      margin: 0;
  }
  .details {
      display: flex;
      justify-content: space-between;
      margin: 20px 0;
  }
  .bill-to {
      width: 40%; /* Adjust the width for the left side */
  }
  .invoice-details {
      width: 55%;
  }
  .total {
      display: flex;
      justify-content: flex-end;
      margin: 20px 0;
  }
  .notes {
      margin: 20px 0;
      font-size: 0.9em;
      color: #555;
  }
  .footer {
      text-align: center;
      margin: 20px 0;
      font-size: 0.9em;
      color: #777;
  }

  /* Style for disabling the left side */
  .disabled {
      pointer-events: none; /* Disable interaction */
      opacity: 0.5; /* Make the left side appear disabled */
  }

  /* Optional: Hide the print button during printing */
  @media print {
      .print-button-container {
          display: none;
      }
  }
</style>
{% block body_block %}
<br>
<div class="invoice-container">
    <div class="header">
        {% for data in records %}
        <h1 style="color: white; margin: 0; font-weight: bold; text-align: left;"> Invoice</h1>
        <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px;">
            <!-- Left Column: Logo -->
            <div style="flex: 1; display: flex; justify-content: flex-start; align-items: center;">
                <div style="padding: 1px;">
                    <img src="{% if data.edit_admin_logo %}{{ data.edit_admin_logo.url }}{% endif %}" 
                         alt="Logo" 
                         style="height: 100px; width: auto;" 
                         loading="lazy">
                </div>
            </div>
            &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
             &nbsp; &nbsp; &nbsp; &nbsp; 
            &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
            &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;

            <!-- Right Column: School Details -->
            <div style="flex: 2; padding: 5px; text-align: left; display: flex; flex-direction: column;">
                <div style="margin-bottom: 5px;"><strong>School Name:</strong> {{ data.school_name }}</div>
                <div style="margin-bottom: 5px;"><strong>School Code:</strong> {{ data.school_code }}</div>
                <div style="margin-bottom: 5px;"><strong>Address:</strong> {{ data.address }}</div>
                <div style="margin-bottom: 5px;"><strong>Phone:</strong> {{ data.phone }}</div>
                <div style="margin-bottom: 5px;"><strong>Email:</strong> {{ data.email }}</div>
            </div>

            
        </div>
        {% endfor %}
    </div>
 
    <div class="details">
        <div class="bill-to">
            <strong>Invoice Details</strong>
            <div style="flex: 2; padding: 5px; text-align: left; display: flex; flex-direction: column;">
            <div style="margin-bottom: 5px;">Invoice Number: {{invoice.invoice_number }}</div>
            <div style="margin-bottom: 5px;">Invoice Due Date: {{invoice.issue_date|date:'Y-m-d' }}</div>
            <div style="margin-bottom: 5px;">Date :</strong> {{invoice.due_date|date:'Y-m-d' }}</div>
            </div>

            <div style="flex: 2; padding: 5px; text-align: left; display: flex; flex-direction: column;">
                <div style="margin-bottom: 5px;">Invoice Number: {{invoice.invoice_number }}</div>
                <div style="margin-bottom: 5px;">Invoice Due Date: {{invoice.issue_date|date:'Y-m-d' }}</div>
                <div style="margin-bottom: 5px;">Date :</strong> {{invoice.due_date|date:'Y-m-d' }}</div>
                </div>

            
          
            <!-- <strong>Bill To:</strong><br> -->
            {{ customer.name }}<br>
            {{ customer.address }}<br>
            {{ customer.city }}<br>
            {{ customer.country }}<br>
            {{ customer.postal }}<br>
        </div>
        <div class="invoice-details">
            <!-- <strong>Invoice #:</strong> {{ invoice.number }}<br> -->


            <br>
        </div>
    </div>

    <table>
        <thead>
            <tr>
        
                <th>Items Type</th>
                <th>Items</th>
                <th>Description</th>
                <th>Quantity</th>
              
                <!-- <th>Tax</th> -->
                <th>Amount</th>
            </tr>
        </thead>
        <tbody>
            {% for item in invoice.expense.all %}
            <tr>
                <td>{{ item.category }}</td>
                <td>{{ item.item_name }}</td>
                <td>{{ item.description }}</td>
                <td>{{ item.quantity }}</td>
                <td>{{ item.amount }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="total">
        <strong>Total: {{ invoice.total_amount }}</strong>
    </div>

    <div class="notes">
        Notes: {{ notes }}
    </div>

    <div class="footer">
        {% for data in records %}
        {{ data.school_name }} . All rights reserved.
        {% endfor %}
    </div>
    <div class="print-button-container" style="text-align: right; margin: 20px 0;">
      <button onclick="printInvoice()" class="btn btn-primary">Print Invoice</button>
      &nbsp;
     
  </div>

</div>

<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f5f5f5;
        margin: 0;
        padding: 0;
    }
    .invoice-container {
        max-width: 800px;
        margin: 20px auto;
        background: white;
        padding: 20px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    .header {
        background-color: #007b8f;
        color: white;
        padding: 20px;
        text-align: center;
    }
    .header h1 {
        margin: 0;
    }
    .details {
        display: flex;
        justify-content: space-between;
        margin: 20px 0;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
    }
    table th, table td {
        border: 1px solid #ddd;
        padding: 10px;
        text-align: left;
    }
    table th {
        background-color: #f2f2f2;
    }
    .total {
        display: flex;
        justify-content: flex-end;
        margin: 20px 0;
    }
    .notes {
        margin: 20px 0;
        font-size: 0.9em;
        color: #555;
    }
    .footer {
        text-align: center;
        margin: 20px 0;
        font-size: 0.9em;
        color: #777;
    }
</style>

<script>
  // Get the current date
  const today = new Date();
  // Format the date to YYYY-MM-DD
  const formattedDate = today.toISOString().split('T')[0];
  // Set the value of the date input field
  document.getElementById('due_date').value = formattedDate;

  // Print Invoice function
  function printInvoice() {
      window.print();
  }
</script>
{% endblock %}
==========================================================================================


{% extends 'base.html' %}
{% block body_block %}
{% load static %}

<div class="container-fluid">
    <div class="row">
       <div class="main-header">
          <h4>Select Criteria</h4>
       </div>
    </div>

    <div class="col-md-12">
        <div class="card" style="padding: 10px;border-top: 5px solid black;">
            <form method="post">
                {% csrf_token %}
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="class">Class</label>
                    <select class="form-control" name="class" id="id_Class">
                        <option value="" >---Select---</option>
                        {% for data in class_records %}
                        <option value="{{ data.id }}">{{data.Class}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="section">Section</label>
                    <select class="form-control" name="section" id="id_section">
                        <option value="">---Select---</option>
                        {% for data in section_records %}
                        <option value="{{ data.id }}">{{data.section_name}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="section">Category</label>
                    <select class="form-control" name="category">
                        <option value="">---Select---</option>
                        {% for data in category_records %}
                        <option value="{{ data.id }}">{{data.category}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="section">Gender</label>
                    <select class="form-control" name="gender">
                        <option value="">---Select---</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="section">RTE</label>
                    <select class="form-control" name="RET">
                        <option value="">---Select---</option>
                        <option value="Yes">Yes</option>
                        <option value="no">no</option>
                    </select>
                </div>

                <div class="col-md-4 mb-3" style="padding-top: 30px;">
                <button type="submit" class="btn btn-primary">Search</button>
                 </div>

            </div>
        </form>
        </div>
    </div>

    {% if records %}
    <div class="row">
     <div class="col-md-12">
         <div class="card" style="padding: 10px;border-top: 5px solid black;">
            <div class="table-responsive">
            <table  class="table"  >
                <thead>
                    <tr>
                       <th colspan="2">Test</th>
                       
                        <th><input type="checkbox" id="select-all-checkbox"> <label for="select-all-checkbox">All</label></th>
                        <th>Admission No</th>
                        <th>Student Name</th>
                        <th>Class</th>
                        <th>Category</th>
                        <th>Gender</th>
                        <!-- <th>Apply</th> -->

                        <th>Excess Fees</th>
                    </tr>
                </thead>
                <tbody>
                    <form  method="post">
                        {% for data in records %}
                        <tr>
                            <td>{{ fees_record.fees_group }}</td>
                            <td>{{ fees_record.amount }}</td>
                            <td><input type="checkbox" name="check" class="data-checkbox" id="check_{{forloop.counter}}" value="{{data.id}}"></td>
                            <td>{{ data.admission_no }}</td>
                            <td>{{ data.first_name }} {{ data.last_name }}</td>
                            <td>{{ data.Class }}</td>
                            <td>{{ data.category }}</td>
                            <td>{{ data.gender }}</td>
                            <!-- <td><input type="checkbox" name="check" class="data-checkbox" id="check_{{forloop.counter}}" value="{{data.id}}"></td> -->
                            <td class="balance-amount"></td>
                        </tr>
                        {% endfor %}
                    <tr>
                        <td colspan="8"></td>
                            {% comment %} <td ><button type="button" class="btn btn-primary" name="assign_btn" value="assign_btn" onclick="save()">Save</button></td> {% endcomment %}
                            <td><button type="button" class="btn btn-primary" name="assign_btn" value="assign_btn" onclick="save()">Save</button></td>

                        </tr>
                </form>
                </tbody>

            </table>
            </div>
         </div>
     </div>
 </div>
 {% else %}
 <center> <h5>No Records Found </h5></center>
 {% endif %}
     <!-- modal Start -->


 {% endblock %}
 {% block script_block %}



<script>
    $(document).ready(function () {
    $(document).on('change', '#id_Class', function () {
      var class_id = $('#id_Class').val();
      var url = "{% url 'section_js' %}";
      $.ajax({
        url: url,
        data: {
          'class_id': class_id
        },
        success: function (data) {
            $("#id_section").html(data);
            let html_data = '<option value="">--------</option>';
            data.forEach(function (section) {
                html_data += `<option value="${section.id}">${section.section_name}</option>`
            });
            console.log(html_data);
            $("#id_section").html(html_data);
        },
        error: function (data) {
          console.log(data);
        }
      });
    });

});
</script>


{% comment %} <script>
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const dataCheckboxes = document.getElementsByClassName('data-checkbox');

    // Handle "Select All" checkbox
    selectAllCheckbox.addEventListener('change', function() {
        for (let i = 0; i < dataCheckboxes.length; i++) {
            dataCheckboxes[i].checked = selectAllCheckbox.checked;
        }
    });

    // Handle individual checkbox change
    for (let i = 0; i < dataCheckboxes.length; i++) {
        dataCheckboxes[i].addEventListener('change', function() {
            if (!this.checked) {
                selectAllCheckbox.checked = false;
            } else {
                // Check if all checkboxes are selected
                let allSelected = true;
                for (let j = 0; j < dataCheckboxes.length; j++) {
                    if (!dataCheckboxes[j].checked) {
                        allSelected = false;
                        break;
                    }
                }
                selectAllCheckbox.checked = allSelected;
            }
        });
    }

    function save() {
        // Safely pass Django variables to JavaScript
        var fees_id = "{{ fees_record.id }}";
    
        // Alert the `fees_id`
        alert("The fees_id is: " + fees_id);
        var url = "{% url 'fees_master_assign_js' %}";
    
        var id_list = [];
        for (var i = 1; i <= {{ records_count }}; i++) {
            var checkbox = $('#check_' + i);
            if (checkbox.prop('checked')) {
                id_list.push(checkbox.val());
            }
        }
    
        // Make AJAX request with POST method
        $.ajax({
            url: url,
            method: 'POST',
            data: {
                "id_list": JSON.stringify(id_list),  // Serialize array
                "fees_id": fees_id,
                "csrfmiddlewaretoken": '{{ csrf_token }}'  // Add CSRF token
            },
            success: function(data) {
                alert("Updated successfully");
            },
            error: function(xhr, status, error) {
                console.log("Error:", xhr.responseText);
            }
        });
    }
</script> {% endcomment %}

{% comment %} <script>
function save()
    {
        var fees_id = {{fees_record.id}};
        var url="{% url 'fees_master_assign_js' %}";

        var id_list=[]
        for(var i = 1; i < {{records_count}}+1; i++){
            if($('#check_'+i).prop('checked') == true){
                check = $('#check_'+i).val();
                id_list.push(check);
            }
        }
        $.ajax({
            url:url,
            data: {
            "id_list": id_list,
            "fees_id":fees_id,
            },
            success: function(data){
                alert("Updated");
           },
           error:function(data)
            {
                console.log(data);
            }
     });
    }

</script> {% endcomment %}
<script>
    function save() {
        // Safely pass Django variables to JavaScript
        var fees_id = "{{ fees_record.id }}";
    
        // Initialize an empty array to hold checked checkbox values
        var id_list = [];
    
        // Loop through the checkboxes
        for (var i = 1; i <= {{ records_count }}; i++) {
            var checkbox = $('#check_' + i);
            // Check if the checkbox is checked
            if (checkbox.prop('checked')) {
                // Add the value of the checked checkbox to the id_list
                id_list.push(checkbox.val());
            }
        }
    
        // Alert the contents of id_list
    
        var url = "{% url 'fees_master_assign_js' %}";
    
        // Make AJAX request with POST method
        $.ajax({
            url: url,
            method: 'POST',  // Use POST instead of GET
            data: {
                "id_list": JSON.stringify(id_list),  // Serialize array
                "fees_id": fees_id,
                "csrfmiddlewaretoken": '{{ csrf_token }}'  // Add CSRF token
            },
            success: function(data) {
                alert("Updated successfully");
            },
            error: function(xhr, status, error) {
                alert("Error: " + xhr.status + " " + xhr.statusText + " - " + xhr.responseText);
            }
        });
    }
    </script>
    
    <!-- Button to trigger the save function -->
    

<!-- JavaScript code to handle checkbox behavior -->
<script>
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const dataCheckboxes = document.getElementsByClassName('data-checkbox');

    selectAllCheckbox.addEventListener('change', function() {
      for (let i = 0; i < dataCheckboxes.length; i++) {
        dataCheckboxes[i].checked = selectAllCheckbox.checked;
        // Alert message when 'Select All' is changed
      }
    });

    for (let i = 0; i < dataCheckboxes.length; i++) {
      dataCheckboxes[i].addEventListener('change', function() {
        if (!this.checked) {
          selectAllCheckbox.checked = false;
        } else {
          // Check if all other checkboxes are selected
          let allSelected = true;
          for (let j = 0; j < dataCheckboxes.length; j++) {
            if (!dataCheckboxes[j].checked) {
              allSelected = false;
              break;
            }
          }
          selectAllCheckbox.checked = allSelected;
        }
        // Alert message when individual checkbox is changed
      });
    }
</script>

<script type="text/javascript">
    // Pass the Python variable `fees_excess_data` into a JavaScript variable
    var feesExcessData = {{ fees_excess_data|safe }};
    
    // Example: Use this data in a function to display in the list
    function displayFeesExcessData() {
        var listContainer = document.getElementById("fees_excess_list");
        listContainer.innerHTML = ""; // Clear current list
        feesExcessData.forEach(function(item) {
            var listItem = document.createElement("li");
            listItem.textContent = "Student ID: " + item.student_id + ", Balance Amount: " + item.balance_amount;
            listContainer.appendChild(listItem);
        });
    }

    // Call the function to display the data in the list
    displayFeesExcessData();
</script>

<script>
    window.onload = function() {
        // Pass the Python variable `fees_excess_data` into a JavaScript variable
        var feesExcessData = {{ fees_excess_data|safe }};

        // Loop through each checkbox
        const checkboxes = document.querySelectorAll('.data-checkbox');
        checkboxes.forEach(function(checkbox) {
            // Get the dataId from the checkbox value
            const dataId = checkbox.value;

            // Find matching data in feesExcessData
            const matchedData = feesExcessData.find(function(item) {
                return item.student_id == dataId; // Check for match
            });

            if (matchedData) {
                // Find the <td> element for balance amount in the same row
                const tableRow = checkbox.closest('tr');
                const balanceTd = tableRow.querySelector('.balance-amount');

                // Update the <td> with the balance amount
                balanceTd.textContent = matchedData.balance_amount;
            } else {
                console.log(`No match for Data ID: ${dataId}`);
            }
        });
    };
</script>
 {% endblock  %}
+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
class StudentMain(models.Model):    
    Gender = (
        ("Male", "Male"),   
        ("Female", "Female"),
    )
    BloodGroup = (
        ("O+", "O+"),
        ("A+", "A+"),
        ("B+", "B+"),
        ("AB+", "AB+"),
        ("O-", "O-"),
        ("A-", "A-"),
        ("B-", "B-"),
        ("AB-", "AB-"),
    )

  
    rte = (
        ("Yes", "Yes"),
        ("No", "No"),
    )
    
    gra_completed = (
        ("Yes", "Yes"),
        ("No", "No"),
    )
    admission_no = models.CharField(max_length=100)
    roll_number = models.CharField(max_length=100,blank=True, null=True)  #!
    account = models.ForeignKey(
        "Account", on_delete=models.CASCADE, null=True, blank=True
    )
    first_name = models.CharField(max_length=500)
    last_name = models.CharField(max_length=500, blank=True, null=True)  #!
    gender = models.CharField(max_length=500, choices=Gender,blank=True, null=True)
    date_of_birth = models.DateField()
    category = models.ForeignKey(
        StudentCategory, on_delete=models.CASCADE, blank=True, null=True
    )  #!
    religion = models.CharField(max_length=500, blank=True, null=True)  #!
    Caste = models.CharField(max_length=500, blank=True, null=True)  #!
    mobile_number = models.CharField(max_length=500, blank=True, null=True)  #!
    email = models.EmailField(max_length=500, blank=True, null=True)  #!
    admission_date = models.DateField(default=date.today, blank=True, null=True)
    student_photo = models.FileField(blank=True, null=True)
    Blood_group = models.CharField(
        max_length=100, choices=BloodGroup, blank=True, null=True
    )  #! 
    height = models.CharField(max_length=500, blank=True, null=True)  #!
    weight = models.CharField(max_length=500, blank=True, null=True)  #!
    as_on_date = models.DateField(blank=True, null=True)  #!
    bank_account_number = models.CharField(max_length=500, blank=True, null=True)  #!
    bank_name = models.CharField(max_length=500, blank=True, null=True)  #!
    ifsc_code = models.CharField(max_length=500, blank=True, null=True)  #!
    national_identification_number = models.CharField(
        max_length=50, blank=True, null=True
    )
    local_identification_number = models.CharField(max_length=50, blank=True, null=True)
    rte = models.CharField(max_length=100, choices=rte, default="No")
    previous_school_detail = models.TextField(max_length=250, blank=True, null=True)
    note = models.TextField(max_length=250, blank=True, null=True)

    title_1 = models.CharField(max_length=500, blank=True, null=True)
    documents_1 = models.FileField(blank=True, null=True)
    title_2 = models.CharField(max_length=500, blank=True, null=True)
    documents_2 = models.FileField(blank=True, null=True)
    title_3 = models.CharField(max_length=500, blank=True, null=True)
    documents_3 = models.FileField(blank=True, null=True)
    title_4 = models.CharField(max_length=500, blank=True, null=True)
    documents_4 = models.FileField(blank=True, null=True)
    disable_date = models.DateField(blank=True, null=True)
    diable_reson = models.ForeignKey(
        DisableReason, on_delete=models.CASCADE, blank=True, null=True
    )
    disable_note = models.TextField(blank=True, null=True)
    status = models.CharField(max_length=250, default="Enable", blank=True, null=True)
    user_student = models.ForeignKey(
        User,
        on_delete=models.CASCADE,
        blank=True,
        null=True,
        related_name="StudentMain_user_student",
    )
    user_parent = models.ForeignKey(
        User,
        on_delete=models.CASCADE,
        blank=True,
        null=True,
        related_name="StudentMain_user_parent",
    )
    created_by = models.ForeignKey(
        User, on_delete=models.CASCADE, blank=True, null=True, related_name="StudentMain_craeted_by"
    )
    created_at = models.DateTimeField(auto_now_add=True, blank=True, null=True)        
    student_health = models.CharField(max_length=100, blank=True, null=True)    
    student_health_description	= models.TextField(max_length=550, blank=True, null=True)
    name_of_last_school = models.CharField(max_length=250,blank=True, null=True)
    leaving_last_school_reason = models.TextField(max_length=550,blank=True, null=True)
    grade_completed = models.CharField(max_length=100, choices=gra_completed,blank=True, null=True)
    suspended_or_not = models.CharField(max_length=100, blank=True, null=True)
    is_suspension_resolved = models.CharField(max_length=100, blank=True, null=True) 
    suspension_reason = models.TextField(max_length=550,blank=True, null=True)
    county = models.CharField(max_length=250,blank=True, null=True)
    sub_county =  models.CharField(max_length=250,blank=True, null=True)
    ward = models.CharField(max_length=250,blank=True, null=True)
    branch = models.ForeignKey(Branch, on_delete=models.CASCADE, null=True, blank=True)   
    source = models.CharField(max_length=250, default="offline",null=True, blank=True) 
    vehicle_number=models.ForeignKey('sub_part.vehicle',on_delete=models.CASCADE,blank=True,null=True)
    route_list=models.ForeignKey(Route,on_delete=models.CASCADE,blank=True,null=True)
    hostel=models.ForeignKey(Hostel,on_delete=models.CASCADE,blank=True,null=True)


    def get_or_generate_account_number(self):
        return f"SCH-{str(self.id)}"

    def get_school_account_number(self):
        # This method should return the school account number
        return self.get_or_generate_account_number()

    def __str__(self):
        return f"{self.first_name} {self.last_name} {self.id}"
    

class StudentVaultAmount(models.Model): 
    student = models.ForeignKey(StudentMain, on_delete=models.CASCADE)
    total_amount = models.IntegerField(blank=True, null=True, default=0)
    paid_amount = models.IntegerField(blank=True, null=True, default=0)
    balance_amount = models.IntegerField(blank=True, null=True, default=0)
    created_at = models.DateTimeField(auto_now_add=True)
    session = models.ForeignKey("sub_part.Session", on_delete=models.CASCADE)
    created_by = models.ForeignKey(
        User, on_delete=models.CASCADE, blank=True, null=True
    )
    branch = models.ForeignKey(Branch, on_delete=models.CASCADE, null=True, blank=True)   
======================================================================================================

{% extends 'base.html' %}


{% block body_block %}
{% load static %}

<div class="container-fluid">

  <div class="row">
    <div class="main-header">
      <h4>Student Fees</h4>
      <a href="{% url 'collect_fees' %}">
        <button type="button" class="btn btn-primary" style="float: right;"> Back</button>
      </a>
    </div>
  </div>


  <div class="card" style="padding: 10px;">
    <div class="row">
      <div class="col-md-12">
        <div class="sfborder">
          <div class="col-md-3">
            <img class="round5"
              src="data:image/jpeg;base64,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"
              class="img-fluid">
            <!-- <img width="115" height="115" class="round5" src="https://www.school.infomainia.in/uploads/student_images/default_male.jpg" alt="No Image"> -->
          </div>

          <div class="col-md-9">
            <div class="row">
              <table class="table">
                <tbody>
                  <tr>
                    <th class="bozero">Name</th>
                    <td class="bozero">{{records.first_name}} {{records.last_name}}</td>

                    <th class="bozero">Class Section</th>
                    <td class="bozero">{{records.Class}} ({{records.section}}) </td>
                  </tr>
                  <!-- <tr>
                    <th>Father Name</th>
                    <td>{{records.Father_name}}</td>
                    <th>Admission No</th>
                    <td>{{records.admission_no}}</td>
                  </tr> -->
                  <tr>
                    <th>Mobile Number</th>
                    <td>{{records.mobile_number}}</td>
                    <th>Roll Number</th>
                    <td> {{records.roll_number}} </td>
                  </tr>
                  <tr>
                    <th>Category</th>
                    <td>
                      {{records.category}} </td>
                    <th>RTE</th>
                    <td><b class=""> {{records.rte}} </b>
                    </td>
                  </tr>

                </tbody>
              </table>
            </div>
          </div>


        </div>
      </div>


    </div>
  </div>


  <div class="card" style="padding: 10px; font-size:13px;">
    <div class="card-body">

      <br>
      <div class="table-responsive">
        <table class="table table-hover">
          <thead style="background-color: rgb(106, 123, 160); color:white;">
            <tr>
              <th> </th>
              <th>Fees Group</th>
              <th>Fees Code</th>
              <th>Due Date</th>
              <th>Status</th>
              <th>Amount ($)</th>
              <th>Payment Id</th>
              <th>Mode</th>
              <th>Date</th>
              <th>Discount ($)</th>
              <th>Fine ($)</th>
              <th>Paid ($)</th>
              <th>Balance ($)</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for data in fees_records %}
            <tr>
              <td></td>
              <td><input type="hidden" value="{{data.id}}" id="table_fees_id">{{data.fees.fees_group}}</td>
              <td>{{data.fees.fees_type.Fees_code}}</td>
              <td>{{data.fees.due_date|date:"d/m/Y"}}</td>
              <td> {% if data.status == 'fully paid' %}<label class="label label-success">{{data.status}}{% else %}<label class="label label-warning">{{data.status}}{% endif %} </label></td>
              <td> <input type="hidden" value="{{data.balance_amount}}" id="table_amount">{{data.fees.amount}}</td>
              <td></td>
              <td></td>
              <td></td>
              <td><input type="hidden" value="{{data.fees.percentage}}" id="table_percentage">{{data.Dicount_amount}}
              </td>
              <td><input type="hidden" value="{% if data.fees.fine_amount %}{{data.fees.fine_amount}}{% else %}0{% endif %}" id="table_fine_amount">{{data.fine_amount}}
              </td>
              <td>{{data.paid_amount}}</td>
              <td>{{data.balance_amount}}</td>
              <td>{% if data.status != 'fully paid' %} <a data-toggle="modal" data-target=".edit" style="color: black;"
                  id="dropdownMenuButton"><i class='fa fa-plus'></i></a>
                {% endif %}
                <a href="{% url 'print_master_fees' data.id  %}"><i class="fa fa-print"></i></a>
              </td>
              

            </tr>
            {% for paid in paid_record %}
            {% if paid.fess_id == data.id %}
                <tr>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td><img src="https://www.school.infomainia.in/backend/images/table-arrow.png" alt=""></td>
                    <td><input type="hidden" value="{{data.fees.amount}}">{{paid.id}}</td>
                    <td>{{paid.payment_mode_fee}}</td>
                    <td>{{paid.created_at|date:"d/m/Y"}}</td>
                    <td>{{paid.amount_discount}}</td>
                    <td>{{paid.amount_fine}}</td>
                    <td>{{paid.paid_amount}}</td>
                    <td></td>
                    <td>
                        <a href="#" class="bozero edit-btn" 
                          data-payment-mode="{{paid.payment_mode_fee}}" 
                          data-discount="{{paid.amount_discount}}" 
                          data-fine="{{paid.amount_fine}}" 
                          data-uniqueid="{{paid.id}}"
                          data-fess_ids="{{paid.fess_id}}"
                          data-paid="{{paid.paid_amount}}" 
                          data-date="{{paid.created_at|date:"d/m/Y"}}"
                          data-toggle="tooltip" title="Edit" style="color: black;">
                            <i class="fa fa-edit"></i>
                        </a>
                        <p>
                            <a href="{% url 'print_fees' paid.id %}"><i class="fa fa-print"></i></a>
                        </p>
                        <p><i class="fa fa-undo"></i></p>
                    </td>
                </tr>
            {% endif %}
        {% endfor %}
   
            {% endfor %}

            {% for data in fees_discount %}
            <tr style="background-color: whitesmoke;">
              <td></td>
              <td>Discount</td>
              <td> {{data.discount.name}}</td>
              <td></td>
              <td>
                {% if data.status == 'applied' or data.status == 'appalied' %}
                <p style="color:red;">Discount of ${{data.discount.amount}} applied</p>
                {% elif data.status == 'pending' %}
                Discount of ${{data.discount.amount}} Assigned
                {% endif %}
              </td>
              <td colspan="9"> </td>

            </tr>
            {% endfor %}
          </tbody>

        </table>
      </div>
    </div>
  </div>
</div>
<br><br><br>

<!-- <---start model ---->
<div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editModalLabel">Edit Payment Details</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="reloadPage()">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form method="post" id="feesForm">
          {% csrf_token %}
          <input type="hidden" id="dataIdField" name="data_id">
          <input type="hidden" value="{{ pk }}" id="pkValue">
          <input name="fees_idd" id="fess_ids"  type="hidden" />
          <!-- Display data fields here -->

          <div class="form-group">
            <label for="paymentMode">Payment Mode</label>
            <div id="paymentModeOptions">
              <label class="radio-inline">
                <input type="radio" name="payment_mode_fee" value="Cash"> Cash
              </label>
              <label class="radio-inline">
                <input type="radio" name="payment_mode_fee" value="Cheque"> Cheque
              </label>
              <label class="radio-inline">
                <input type="radio" name="payment_mode_fee" value="DD"> DD
              </label>
              <label class="radio-inline">
                <input type="radio" name="payment_mode_fee" value="bank_transfer"> Bank Transfer
              </label>
              <label class="radio-inline">
                <input type="radio" name="payment_mode_fee" value="m-pesa"> M-Pesa
              </label>
              <label class="radio-inline">
                <input type="radio" name="payment_mode_fee" value="card"> Card
              </label>

           
              <span class="text-danger" id="payment_mode_error"></span>
            </div>
          </div>
          <div class="form-group">
            <label for="discountAmount">Discount Amount</label>
            <input type="text" class="form-control" name="amount_discount" id="discountAmount" readonly>
          </div>
          <div class="form-group">
            <label for="fineAmount">Fine Amount</label>
            <input type="text" class="form-control" id="fineAmount" name="amount_fine" readonly>
          </div>
          <div class="form-group">
            <label for="paidAmount">Paid Amount</label>
            <input type="text" class="form-control" id="paidAmount" name="amount">
          </div>
          <div class="form-group">
            <label for="paymentDate">Payment Date</label>
            <input type="date" class="form-control" id="paymentDate" name="payment_date">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal"onclick="reloadPage()">Close</button>
        <button type="submit" class="btn btn-primary" form="feesForm">Submit</button>
      </div>
    </div>
  </div>
</div>
 <!-- --- end model---- -->
<!-- modal Start -->

<div class="modal fade edit" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-md">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Admission Enquiry</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <form method="post"><br>
          {% csrf_token %}
          <div class="form-group">
            <label for="inputEmail3" class="col-sm-3 control-label">Date</label>
            <div class="col-sm-9">
              <input id="date" name="admission_date" placeholder="" type="text" class="form-control date_fee"
                value="{{toady_date}}" readonly="readonly" />
              <input name="fees_idd" id="fess_idd" placeholder="" type="Hidden" />
            </div>
          </div><br>

          <div class="form-group">
            <label for="total_amount" class="col-sm-3 control-label">
              Total Amount<small class="req"> *</small>
            </label>
            <div class="col-sm-9">
              <input type="text" class="form-control modal_amount" id="total_amount" name="total_amount" onkeyup="update_balance()">
              <span class="text-danger" id="total_amount_error"></span>
            </div>
          </div>
          
          <br>
          
          <div class="form-group">
            <label for="amount" class="col-sm-3 control-label">
              Amount<small class="req"> *</small>
            </label>
            <div class="col-sm-9">
              <input type="text" class="form-control modal_amount" id="amount" name="amount" onkeyup="update_balance()">
              <span class="text-danger" id="amount_error"></span>
            </div>
          </div>
      <br>

      <div class="form-group">
        <label for="balance_amount" class="col-sm-3 control-label">Vault Amount<small class="req"> *</small></label>
        <div class="col-sm-9">
          <input type="text" class="form-control modal_amount" id="balance_amount" name="balance_amount" readonly>
        </div>
      </div>
          
     
          <br>
          <div class="form-group">
            <label for="inputPassword3" class="col-sm-3 control-label"> Discount Group</label>
            <div class="col-sm-9">
              <select class="form-control modal_discount_group" id="discount_group" name="discount_group">
                <option value="">Select</option>
                {% for data in fees_discount %}
                {% if data.status == 'pending' %}
                <option value="{{data.id}}">{{data.discount.name}}</option>
                {% endif %}
                {% endfor %}
              </select>

              <span class="text-danger" id="amount_error"></span>
            </div>
          </div>

          <br>
          <div class="form-group">
            <label for="inputPassword3" class="col-sm-3 control-label">Discount<small class="req"> *</small></label>
            <div class="col-sm-9">
              <div class="row">

                <div class="col-md-5 col-sm-5">
                  <div class="">
                    <input type="text" class="form-control" id="amount_discount" value="0" name="amount_discount">

                    <span class="text-danger" id="amount_error"></span>
                  </div>
                </div>
                <div class="col-md-2 col-sm-2 ltextright">

                  <label for="inputPassword3" class="control-label">Finedd<small class="req">*</small></label>
                </div>
                <div class="col-md-5 col-sm-5">
                  <div class="">
                    <input type="text" class="form-control" id="amount_fine" value="0" name="amount_fine">

                    <span class="text-danger" id="amount_fine_error"></span>
                  </div>
                </div>
              </div>
            </div><!--./col-sm-9-->
          </div>
       
          <br>
          <div class="form-group">
            <label for="paymentMode">Payment Mode</label>
            <div id="paymentModeOptions">
              <label class="radio-inline">
                  <input type="radio" name="payment_mode_fee" value="Cash"> Cash
              </label>
              <label class="radio-inline">
                  <input type="radio" name="payment_mode_fee" value="Cheque"> Cheque
              </label>
              <label class="radio-inline">
                  <input type="radio" name="payment_mode_fee" value="DD"> DD
              </label>
              <label class="radio-inline">
                  <input type="radio" name="payment_mode_fee" value="bank_transfer"> Bank Transfer
              </label>
              <label class="radio-inline">
                  <input type="radio" name="payment_mode_fee" value="m-pesa"> M-Pesa
              </label>
              <label class="radio-inline">
                  <input type="radio" name="payment_mode_fee" value="card"> Card
              </label>
              <label class="radio-inline">
                <input type="radio" name="payment_mode_fee" value="vault" id="vault-radio"> Vault
              </label>
              <span id="vault-amount" style="display: none; font-weight: bold;">Amount: {{ student_vault }}</span>
              <span class="text-danger" id="payment_mode_error"></span>
          </div>
          
        </div>
          <div class="container">
            <div class="row">
              <div class="col-md-4">
                <div class="form-group">
                  <label for="paid_by">Paid By</label>
                  <input type="text" class="form-control" name="paid_by" placeholder="Enter name of payer">
                </div>
              </div>
          
              <div class="col-md-4">
                <div class="form-group">
                  <label for="ref_number">Reference Number</label>
                  
                  <input type="number" class="form-control" name="ref_number" placeholder="Enter reference number">
                </div>
              </div>
          
              <div class="col-md-4">
                <div class="form-group">
                  <label for="card_holder_name">Card Holder Name</label>
                  <input type="text" class="form-control" name="card_holder_name" placeholder="Enter card holder name">
                </div>
              </div>
            </div>
          
            <div class="row">
              <div class="col-md-4">
                <div class="form-group">
                  <label for="mobile_number">Mobile Number</label>
                  <input type="number" class="form-control" name="mobile_number" placeholder="Enter mobile number">
                </div>
              </div>
              
              <div class="col-md-4">
                <div class="form-group">
                  <label for="amount">Amount</label>
                  <input type="number" class="form-control" name="user_amount" placeholder="Enter amount">
                </div>
              </div>
            </div>
          </div>
        
          <div class="form-group">
            <label for="inputPassword3" class="col-sm-3 control-label">Note</label>
            <div class="col-sm-9">
              <textarea class="form-control" rows="3" id="description" placeholder="" name="description"></textarea>
            </div>
          </div>
          <br>
          <center>
            <button type="sumbit" class="btn btn-primary">Submit</button>
          </center>
        </form>

      </div>
    </div>
  </div>
</div>

<!-- modal End -->
{% endblock %}
{% block script_block %}



<script>
  $(document).ready(function () {

    $(document).on('click', '#dropdownMenuButton', function () {
      var dumy = this;
      var amount = $(dumy).closest('tr').find('#table_amount').val();
      var percentage = $(dumy).closest('tr').find('#table_percentage').val();
      var fine = $(dumy).closest('tr').find('#table_fine_amount').val();
      var id = $(dumy).closest('tr').find('#table_fees_id').val();
      $('#amount').val(amount);
      $('#ref_amount').val(amount);
      <!-- $('#amount_discount').val(percentage); -->
      $('#amount_fine').val(fine);
      $('#fess_idd').val(id);
    });
    $(document).on('change', '#discount_group', function () {
      var disc = this.value;
      var url = "{% url 'discount_js' %}";
      $.ajax({
        url: url,
        data: {
          'disc': disc
        },
        success: function (data) {
          $('#amount_discount').val(data);
        },
        error: function (data) {
          console.log(data);
        }
      });
    });
  });

</script>

<!--  amount validation inside model -->
<!-- <script>
  function update_balance() {
    // Get the input values
    var totalAmount = parseInt($('#total_amount').val()) || 0;
    var receivedAmount = parseInt($('#amount').val()) || 0;

    // Validate the input amounts
    if (receivedAmount > totalAmount) {
      $('#amount_error').text('Enter an amount less than or equal to the total amount');
      $('#balance_amount').val(''); // Clear the balance if invalid
    } else {
      $('#amount_error').text('');
      // Calculate the balance amount
      var balanceAmount = totalAmount - receivedAmount;
      // Update the balance amount field
      $('#balance_amount').val(balanceAmount);
    }
  }
</script> -->

<script>
  $(document).ready(function() {
    // Open modal and populate with data when edit button is clicked
    $('.edit-btn').on('click', function(event) {
      event.preventDefault();
  
      // Get data attributes from the clicked button
      let paymentMode = $(this).data('payment-mode');
      let discount = $(this).data('discount');
      let fine = $(this).data('fine');
      let paid = $(this).data('paid');
      let uniqueid = $(this).data('uniqueid');
      let paymentDate = $(this).data('date');
      let dataId = $(this).data('id'); 
      let fessId = $(this).data('fess_ids');
      console.log("fess_ids:", fessId);
  
      // Format the date if necessary
      if (paymentDate.includes('/')) {
        let parts = paymentDate.split('/');
        paymentDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
      } else if (paymentDate.includes('-')) {
        let parts = paymentDate.split('-');
        if (parts[2].length === 4) {
          paymentDate = `${parts[2]}-${parts[0]}-${parts[1]}`;
        }
      }
  
      // Set data in modal fields
      $('input[name="payment_mode_fee"][value="' + paymentMode + '"]').prop('checked', true);
      $('#discountAmount').val(discount);
      $('#fineAmount').val(fine);
      $('#paidAmount').val(paid);
      $('#paymentDate').val(paymentDate);
      $('#fess_ids').val(fessId);
  
      // Set the form action and hidden input
      setFormAction(uniqueid);
  
      // Show the modal
      $('#editModal').modal('show');
    });
  });
  
  function setFormAction(uniqueid) {
    const form = document.getElementById('feesForm');
    const dataIdField = document.getElementById('dataIdField');
    const pkField = document.getElementById('pkValue').value; // Get pk value
  
    // Check if dataIdField is already populated
    if (dataIdField.value) {
      
    } else {
      // Set the form action to include both uniqueid and pk in the URL
      form.action = `/collect_fees_edit/${uniqueid}/${pkField}`;  // Use uniqueid instead of dataId
      dataIdField.value = uniqueid;  // Set the data_id field to uniqueid
  
      // Show a confirmation alert when the action is set
      
    }
  }
</script>

<script>
  // Refresh the page when the modal is hidden (when the user clicks outside or closes the modal)
  $('#editModal').on('hidden.bs.modal', function () {
    location.reload();  // Reload the page when the modal is closed
  });
</script>

<script>
  function reloadPage() {
    location.reload();  // Reload the page
  }
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
      const paymentModeOptions = document.querySelectorAll('input[name="payment_mode_fee"]');
      const vaultAmount = document.getElementById("vault-amount");

      paymentModeOptions.forEach(option => {
          option.addEventListener("change", function () {
              if (this.value === "vault") {
                  vaultAmount.style.display = "inline"; // Show the vault amount
              } else {
                  vaultAmount.style.display = "none"; // Hide the vault amount
              }
          });
      });
  });
</script>

<!-- <script>
  // JavaScript to handle the Vault radio button click
  document.getElementById("vault-radio").addEventListener("click", function () {
    // Retrieve the vault amount value
    const vaultAmount = "{{ student_vault }}"; // Replace with your backend dynamic value
    // Populate the Total Amount field
    document.getElementById("total_amount").value = vaultAmount;
  });
</script> -->


<script>
  function update_balance() {
    // Get the input values
    const totalAmountField = document.getElementById('total_amount');
    const totalAmount = parseFloat(totalAmountField.value) || 0;
    const receivedAmountField = document.getElementById('amount');
    const receivedAmount = parseFloat(receivedAmountField.value) || 0;
    const balanceAmountField = document.getElementById('balance_amount');
    const amountError = document.getElementById('amount_error');

    // Clear previous error messages
    amountError.textContent = '';

    // Handle errors
    if (receivedAmount > totalAmount) {
        // Show error message if received amount exceeds total amount
        amountError.textContent = 'Enter an amount less than or equal to the total amount';
        balanceAmountField.value = 0; // Clear balance if invalid
    } else {
        // Calculate the balance if valid
        const balanceAmount = totalAmount - receivedAmount;
        balanceAmountField.value = balanceAmount.toFixed(2);
    }

    // Adjust the fields' readonly state based on the amount comparison
    if (receivedAmount > totalAmount) {
        totalAmountField.readOnly = true;
        receivedAmountField.readOnly = false;
    } else if (totalAmount > receivedAmount) {
        receivedAmountField.readOnly = true;
        totalAmountField.readOnly = false;
    } else {
        totalAmountField.readOnly = false;
        receivedAmountField.readOnly = false;
    }
}

document.addEventListener('DOMContentLoaded', function () {
    const vaultRadio = document.getElementById("vault-radio");
    const totalAmountField = document.getElementById("total_amount");
    const amountField = document.getElementById("amount");
    const balanceAmountField = document.getElementById("balance_amount");

    if (vaultRadio) {
        vaultRadio.addEventListener("click", function () {
            // Retrieve the vault amount value dynamically (replace with backend value)
            const vaultAmount = parseFloat("{{ student_vault }}") || 0; // Replace with your backend dynamic value
            const totalAmount = parseFloat(totalAmountField.value) || 0;

            // Check if the vaultAmount is greater than or equal to the current totalAmount
            if (vaultAmount >= totalAmount) {
                totalAmountField.value = vaultAmount;
                if (vaultAmount <= parseFloat(amountField.value) || isNaN(parseFloat(amountField.value))) {
                    amountField.value = vaultAmount; // Reflect in amount field if condition met
                }
                update_balance(); // Recalculate balance after setting total amount
            }

            // Set all fields to read-only
            totalAmountField.readOnly = true;
            amountField.readOnly = true;
            balanceAmountField.readOnly = true;
        });
    }

    // Synchronize total_amount changes with amount only if total_amount is less than or equal to amount
    if (totalAmountField && amountField) {
        totalAmountField.addEventListener("keyup", function () {
            const totalAmount = parseFloat(totalAmountField.value) || 0;
            const currentAmount = parseFloat(amountField.value) || 0;

            if (totalAmount <= currentAmount) {
                amountField.value = totalAmountField.value; // Reflect value if totalAmount <= amount
            }
            update_balance();
        });
    }
});
</script>
{% endblock %}
=============================================================================
{% extends 'base.html' %}


{% block body_block %}
{% load static %}

<div class="container-fluid">

  <div class="row">
    <div class="main-header">
      <h4>Student Fees</h4>
      <a href="{% url 'collect_fees' %}">
        <button type="button" class="btn btn-primary" style="float: right;"> Back</button>
      </a>
    </div>
  </div>


  <div class="card" style="padding: 10px;">
    <div class="row">
      <div class="col-md-12">
        <div class="sfborder">
          <div class="col-md-3">
            <img class="round5"
              src="data:image/jpeg;base64,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"
              class="img-fluid">
            <!-- <img width="115" height="115" class="round5" src="https://www.school.infomainia.in/uploads/student_images/default_male.jpg" alt="No Image"> -->
          </div>

          <div class="col-md-9">
            <div class="row">
              <table class="table">
                <tbody>
                  <tr>
                    <th class="bozero">Name</th>
                    <td class="bozero">{{records.first_name}} {{records.last_name}}</td>

                    <th class="bozero">Class Section</th>
                    <td class="bozero">{{records.Class}} ({{records.section}}) </td>
                  </tr>
                  <!-- <tr>
                    <th>Father Name</th>
                    <td>{{records.Father_name}}</td>
                    <th>Admission No</th>
                    <td>{{records.admission_no}}</td>
                  </tr> -->
                  <tr>
                    <th>Mobile Number</th>
                    <td>{{records.mobile_number}}</td>
                    <th>Roll Number</th>
                    <td> {{records.roll_number}} </td>
                  </tr>
                  <tr>
                    <th>Category</th>
                    <td>
                      {{records.category}} </td>
                    <th>RTE</th>
                    <td><b class=""> {{records.rte}} </b>
                    </td>
                  </tr>

                </tbody>
              </table>
            </div>
          </div>


        </div>
      </div>


    </div>
  </div>


  <div class="card" style="padding: 10px; font-size:13px;">
    <div class="card-body">

      <br>
      <div class="table-responsive">
        <table class="table table-hover">
          <thead style="background-color: rgb(106, 123, 160); color:white;">
            <tr>
              <th> </th>
              <th>Fees Group</th>
              <th>Fees Code</th>
              <th>Due Date</th>
              <th>Status</th>
              <th>Amount ($)</th>
              <th>Payment Id</th>
              <th>Mode</th>
              <th>Date</th>
              <th>Discount ($)</th>
              <th>Fine ($)</th>
              <th>Paid ($)</th>
              <th>Balance ($)</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for data in fees_records %}
            <tr>
              <td></td>
              <td><input type="hidden" value="{{data.id}}" id="table_fees_id">{{data.fees.fees_group}}</td>
              <td>{{data.fees.fees_type.Fees_code}}</td>
              <td>{{data.fees.due_date|date:"d/m/Y"}}</td>
              <td> {% if data.status == 'fully paid' %}<label class="label label-success">{{data.status}}{% else %}<label class="label label-warning">{{data.status}}{% endif %} </label></td>
              <td> <input type="hidden" value="{{data.balance_amount}}" id="table_amount">{{data.fees.amount}}</td>
              <td></td>
              <td></td>
              <td></td>
              <td><input type="hidden" value="{{data.fees.percentage}}" id="table_percentage">{{data.Dicount_amount}}
              </td>
              <td><input type="hidden" value="{% if data.fees.fine_amount %}{{data.fees.fine_amount}}{% else %}0{% endif %}" id="table_fine_amount">{{data.fine_amount}}
              </td>
              <td>{{data.paid_amount}}</td>
              <td>{{data.balance_amount}}</td>
              <td>{% if data.status != 'fully paid' %} <a data-toggle="modal" data-target=".edit" style="color: black;"
                  id="dropdownMenuButton"><i class='fa fa-plus'></i></a>
                {% endif %}
                <a href="{% url 'print_master_fees' data.id  %}"><i class="fa fa-print"></i></a>
              </td>
              

            </tr>
            {% for paid in paid_record %}
            {% if paid.fess_id == data.id %}
                <tr>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td><img src="https://www.school.infomainia.in/backend/images/table-arrow.png" alt=""></td>
                    <td><input type="hidden" value="{{data.fees.amount}}">{{paid.id}}</td>
                    <td>{{paid.payment_mode_fee}}</td>
                    <td>{{paid.created_at|date:"d/m/Y"}}</td>
                    <td>{{paid.amount_discount}}</td>
                    <td>{{paid.amount_fine}}</td>
                    <td>{{paid.paid_amount}}</td>
                    <td></td>
                    <td>
                        <a href="#" class="bozero edit-btn" 
                          data-payment-mode="{{paid.payment_mode_fee}}" 
                          data-discount="{{paid.amount_discount}}" 
                          data-fine="{{paid.amount_fine}}" 
                          data-uniqueid="{{paid.id}}"
                          data-fess_ids="{{paid.fess_id}}"
                          data-paid="{{paid.paid_amount}}" 
                          data-date="{{paid.created_at|date:"d/m/Y"}}"
                          data-toggle="tooltip" title="Edit" style="color: black;">
                            <i class="fa fa-edit"></i>
                        </a>
                        <p>
                            <a href="{% url 'print_fees' paid.id %}"><i class="fa fa-print"></i></a>
                        </p>
                        <p><i class="fa fa-undo"></i></p>
                    </td>
                </tr>
            {% endif %}
        {% endfor %}
   
            {% endfor %}

            {% for data in fees_discount %}
            <tr style="background-color: whitesmoke;">
              <td></td>
              <td>Discount</td>
              <td> {{data.discount.name}}</td>
              <td></td>
              <td>
                {% if data.status == 'applied' or data.status == 'appalied' %}
                <p style="color:red;">Discount of ${{data.discount.amount}} applied</p>
                {% elif data.status == 'pending' %}
                Discount of ${{data.discount.amount}} Assigned
                {% endif %}
              </td>
              <td colspan="9"> </td>

            </tr>
            {% endfor %}
          </tbody>

        </table>
      </div>
    </div>
  </div>
</div>
<br><br><br>

<!-- <---start model ---->
<div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editModalLabel">Edit Payment Details</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="reloadPage()">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form method="post" id="feesForm">
          {% csrf_token %}
          <input type="hidden" id="dataIdField" name="data_id">
          <input type="hidden" value="{{ pk }}" id="pkValue">
          <input name="fees_idd" id="fess_ids"  type="hidden" />
          <!-- Display data fields here -->

          <div class="form-group">
            <label for="paymentMode">Payment Mode</label>
            <div id="paymentModeOptions">
              <label class="radio-inline">
                <input type="radio" name="payment_mode_fee" value="Cash"> Cash
              </label>
              <label class="radio-inline">
                <input type="radio" name="payment_mode_fee" value="Cheque"> Cheque
              </label>
              <label class="radio-inline">
                <input type="radio" name="payment_mode_fee" value="DD"> DD
              </label>
              <label class="radio-inline">
                <input type="radio" name="payment_mode_fee" value="bank_transfer"> Bank Transfer
              </label>
              <label class="radio-inline">
                <input type="radio" name="payment_mode_fee" value="m-pesa"> M-Pesa
              </label>
              <label class="radio-inline">
                <input type="radio" name="payment_mode_fee" value="card"> Card
              </label>

           
              <span class="text-danger" id="payment_mode_error"></span>
            </div>
          </div>
          <div class="form-group">
            <label for="discountAmount">Discount Amount</label>
            <input type="text" class="form-control" name="amount_discount" id="discountAmount" readonly>
          </div>
          <div class="form-group">
            <label for="fineAmount">Fine Amount</label>
            <input type="text" class="form-control" id="fineAmount" name="amount_fine" readonly>
          </div>
          <div class="form-group">
            <label for="paidAmount">Paid Amount</label>
            <input type="text" class="form-control" id="paidAmount" name="amount">
          </div>
          <div class="form-group">
            <label for="paymentDate">Payment Date</label>
            <input type="date" class="form-control" id="paymentDate" name="payment_date">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal"onclick="reloadPage()">Close</button>
        <button type="submit" class="btn btn-primary" form="feesForm">Submit</button>
      </div>
    </div>
  </div>
</div>
 <!-- --- end model---- -->
<!-- modal Start -->

<div class="modal fade edit" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-md">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Admission Enquiry</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <form method="post"><br>
          {% csrf_token %}
          <div class="form-group">
            <label for="inputEmail3" class="col-sm-3 control-label">Date</label>
            <div class="col-sm-9">
              <input id="date" name="admission_date" placeholder="" type="text" class="form-control date_fee"
                value="{{toady_date}}" readonly="readonly" />
              <input name="fees_idd" id="fess_idd" placeholder="" type="Hidden" />
            </div>
          </div><br>
          <div class="form-group">
            <label for="total_amount" class="col-sm-3 control-label">Total Amount<small class="req"> *</small></label>
            <div class="col-sm-9">
              <input type="text" class="form-control modal_amount" id="total_amount" name="total_amount" onkeyup="update_balance()">
              <span class="text-danger" id="total_amount_error"></span>
            </div>
          </div>
    
          <br>
    
          <div class="form-group">
            <label for="amount" class="col-sm-3 control-label">Amount<small class="req"> *</small></label>
            <div class="col-sm-9">
              <input type="text" class="form-control modal_amount" id="amount" name="amount" onkeyup="update_balance()">
              <span class="text-danger" id="amount_error"></span>
            </div>
          </div>
    
          <br>
    
          <div class="form-group">
            <label for="balance_amount" class="col-sm-3 control-label">Vault Amount<small class="req"> *</small></label>
            <div class="col-sm-9">
              <input type="text" class="form-control modal_amount" id="balance_amount" name="balance_amount" readonly>
            </div>
          </div>
          
     
          <br>
          <div class="form-group">
            <label for="inputPassword3" class="col-sm-3 control-label"> Discount Group</label>
            <div class="col-sm-9">
              <select class="form-control modal_discount_group" id="discount_group" name="discount_group">
                <option value="">Select</option>
                {% for data in fees_discount %}
                {% if data.status == 'pending' %}
                <option value="{{data.id}}">{{data.discount.name}}</option>
                {% endif %}
                {% endfor %}
              </select>

              <span class="text-danger" id="amount_error"></span>
            </div>
          </div>

          <br>
          <div class="form-group">
            <label for="inputPassword3" class="col-sm-3 control-label">Discount<small class="req"> *</small></label>
            <div class="col-sm-9">
              <div class="row">

                <div class="col-md-5 col-sm-5">
                  <div class="">
                    <input type="text" class="form-control" id="amount_discount" value="0" name="amount_discount">

                    <span class="text-danger" id="amount_error"></span>
                  </div>
                </div>
                <div class="col-md-2 col-sm-2 ltextright">

                  <label for="inputPassword3" class="control-label">Finedd<small class="req">*</small></label>
                </div>
                <div class="col-md-5 col-sm-5">
                  <div class="">
                    <input type="text" class="form-control" id="amount_fine" value="0" name="amount_fine">

                    <span class="text-danger" id="amount_fine_error"></span>
                  </div>
                </div>
              </div>
            </div><!--./col-sm-9-->
          </div>
       
          <br>
          <div class="form-group">
            <label for="paymentMode">Payment Mode</label>
            <div id="paymentModeOptions">
              <label class="radio-inline">
                  <input type="radio" name="payment_mode_fee" value="Cash"> Cash
              </label>
              <label class="radio-inline">
                  <input type="radio" name="payment_mode_fee" value="Cheque"> Cheque
              </label>
              <label class="radio-inline">
                  <input type="radio" name="payment_mode_fee" value="DD"> DD
              </label>
              <label class="radio-inline">
                  <input type="radio" name="payment_mode_fee" value="bank_transfer"> Bank Transfer
              </label>
              <label class="radio-inline">
                  <input type="radio" name="payment_mode_fee" value="m-pesa"> M-Pesa
              </label>
              <label class="radio-inline">
                  <input type="radio" name="payment_mode_fee" value="card"> Card
              </label>
              <label class="radio-inline">
                <input type="radio" name="payment_mode_fee" value="vault" id="vault-radio"> Vault
              </label>
              <span id="vault-amount" style="display: none; font-weight: bold;">Amount: {{ student_vault }}</span>
              <span class="text-danger" id="payment_mode_error"></span>
          </div>
          
        </div>
          <div class="container">
            <div class="row">
              <div class="col-md-4">
                <div class="form-group">
                  <label for="paid_by">Paid By</label>
                  <input type="text" class="form-control" name="paid_by" placeholder="Enter name of payer">
                </div>
              </div>
          
              <div class="col-md-4">
                <div class="form-group">
                  <label for="ref_number">Reference Number</label>
                  
                  <input type="number" class="form-control" name="ref_number" placeholder="Enter reference number">
                </div>
              </div>
          
              <div class="col-md-4">
                <div class="form-group">
                  <label for="card_holder_name">Card Holder Name</label>
                  <input type="text" class="form-control" name="card_holder_name" placeholder="Enter card holder name">
                </div>
              </div>
            </div>
          
            <div class="row">
              <div class="col-md-4">
                <div class="form-group">
                  <label for="mobile_number">Mobile Number</label>
                  <input type="number" class="form-control" name="mobile_number" placeholder="Enter mobile number">
                </div>
              </div>
              
              <div class="col-md-4">
                <div class="form-group">
                  <label for="amount">Amount</label>
                  <input type="number" class="form-control" name="user_amount" placeholder="Enter amount">
                </div>
              </div>
            </div>
          </div>
        
          <div class="form-group">
            <label for="inputPassword3" class="col-sm-3 control-label">Note</label>
            <div class="col-sm-9">
              <textarea class="form-control" rows="3" id="description" placeholder="" name="description"></textarea>
            </div>
          </div>
          <br>
          <center>
            <button type="sumbit" class="btn btn-primary">Submit</button>
          </center>
        </form>

      </div>
    </div>
  </div>
</div>

<!-- modal End -->
{% endblock %}
{% block script_block %}



<script>
  $(document).ready(function () {

    $(document).on('click', '#dropdownMenuButton', function () {
      var dumy = this;
      var amount = $(dumy).closest('tr').find('#table_amount').val();
      var percentage = $(dumy).closest('tr').find('#table_percentage').val();
      var fine = $(dumy).closest('tr').find('#table_fine_amount').val();
      var id = $(dumy).closest('tr').find('#table_fees_id').val();
      $('#amount').val(amount);
      $('#ref_amount').val(amount);
      <!-- $('#amount_discount').val(percentage); -->
      $('#amount_fine').val(fine);
      $('#fess_idd').val(id);
    });
    $(document).on('change', '#discount_group', function () {
      var disc = this.value;
      var url = "{% url 'discount_js' %}";
      $.ajax({
        url: url,
        data: {
          'disc': disc
        },
        success: function (data) {
          $('#amount_discount').val(data);
        },
        error: function (data) {
          console.log(data);
        }
      });
    });
  });

</script>

<!--  amount validation inside model -->
<!-- <script>
  function update_balance() {
    // Get the input values
    var totalAmount = parseInt($('#total_amount').val()) || 0;
    var receivedAmount = parseInt($('#amount').val()) || 0;

    // Validate the input amounts
    if (receivedAmount > totalAmount) {
      $('#amount_error').text('Enter an amount less than or equal to the total amount');
      $('#balance_amount').val(''); // Clear the balance if invalid
    } else {
      $('#amount_error').text('');
      // Calculate the balance amount
      var balanceAmount = totalAmount - receivedAmount;
      // Update the balance amount field
      $('#balance_amount').val(balanceAmount);
    }
  }
</script> -->

<script>
  $(document).ready(function() {
    // Open modal and populate with data when edit button is clicked
    $('.edit-btn').on('click', function(event) {
      event.preventDefault();
  
      // Get data attributes from the clicked button
      let paymentMode = $(this).data('payment-mode');
      let discount = $(this).data('discount');
      let fine = $(this).data('fine');
      let paid = $(this).data('paid');
      let uniqueid = $(this).data('uniqueid');
      let paymentDate = $(this).data('date');
      let dataId = $(this).data('id'); 
      let fessId = $(this).data('fess_ids');
      console.log("fess_ids:", fessId);
  
      // Format the date if necessary
      if (paymentDate.includes('/')) {
        let parts = paymentDate.split('/');
        paymentDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
      } else if (paymentDate.includes('-')) {
        let parts = paymentDate.split('-');
        if (parts[2].length === 4) {
          paymentDate = `${parts[2]}-${parts[0]}-${parts[1]}`;
        }
      }
  
      // Set data in modal fields
      $('input[name="payment_mode_fee"][value="' + paymentMode + '"]').prop('checked', true);
      $('#discountAmount').val(discount);
      $('#fineAmount').val(fine);
      $('#paidAmount').val(paid);
      $('#paymentDate').val(paymentDate);
      $('#fess_ids').val(fessId);
  
      // Set the form action and hidden input
      setFormAction(uniqueid);
  
      // Show the modal
      $('#editModal').modal('show');
    });
  });
  
  function setFormAction(uniqueid) {
    const form = document.getElementById('feesForm');
    const dataIdField = document.getElementById('dataIdField');
    const pkField = document.getElementById('pkValue').value; // Get pk value
  
    // Check if dataIdField is already populated
    if (dataIdField.value) {
      
    } else {
      // Set the form action to include both uniqueid and pk in the URL
      form.action = `/collect_fees_edit/${uniqueid}/${pkField}`;  // Use uniqueid instead of dataId
      dataIdField.value = uniqueid;  // Set the data_id field to uniqueid
  
      // Show a confirmation alert when the action is set
      
    }
  }
</script>

<script>
  // Refresh the page when the modal is hidden (when the user clicks outside or closes the modal)
  $('#editModal').on('hidden.bs.modal', function () {
    location.reload();  // Reload the page when the modal is closed
  });
</script>

<script>
  function reloadPage() {
    location.reload();  // Reload the page
  }
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
      const paymentModeOptions = document.querySelectorAll('input[name="payment_mode_fee"]');
      const vaultAmount = document.getElementById("vault-amount");

      paymentModeOptions.forEach(option => {
          option.addEventListener("change", function () {
              if (this.value === "vault") {
                  vaultAmount.style.display = "inline"; // Show the vault amount
              } else {
                  vaultAmount.style.display = "none"; // Hide the vault amount
              }
          });
      });
  });
</script>

<!-- <script>
  // JavaScript to handle the Vault radio button click
  document.getElementById("vault-radio").addEventListener("click", function () {
    // Retrieve the vault amount value
    const vaultAmount = "{{ student_vault }}"; // Replace with your backend dynamic value
    // Populate the Total Amount field
    document.getElementById("total_amount").value = vaultAmount;
  });
</script> -->


<script>
  function update_balance() {
    // Get the input values
    const totalAmountField = document.getElementById('total_amount');
    const totalAmount = parseFloat(totalAmountField.value) || 0;
    const receivedAmountField = document.getElementById('amount');
    const receivedAmount = parseFloat(receivedAmountField.value) || 0;
    const balanceAmountField = document.getElementById('balance_amount');
    const amountError = document.getElementById('amount_error');

    // Clear previous error messages
    amountError.textContent = '';
    
    // Handle errors
    if (receivedAmount > totalAmount) {
        // Show error message if received amount exceeds total amount
        amountError.textContent = 'Enter an amount less than or equal to the total amount';
        balanceAmountField.value = 0; // Clear balance if invalid
    } else {
        // Calculate the balance if valid
        const balanceAmount = totalAmount - receivedAmount;
        balanceAmountField.value = balanceAmount.toFixed(2);
    }

    // Adjust the fields' readonly state based on the amount comparison
    if (receivedAmount > totalAmount) {
        totalAmountField.readOnly = true;
        receivedAmountField.readOnly = false;
    } else if (totalAmount > receivedAmount) {
        receivedAmountField.readOnly = true;
        totalAmountField.readOnly = false;
    } else {
        totalAmountField.readOnly = false;
        receivedAmountField.readOnly = false;
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    const vaultRadio = document.getElementById("vault-radio");
    if (vaultRadio) {
      vaultRadio.addEventListener("click", function () {
        // Retrieve the vault amount value dynamically from Django template
        const vaultAmount = parseFloat("{{ student_vault }}") || 0; // Replace with your backend dynamic value
  
        const totalAmountField = document.getElementById("total_amount");
        const totalAmount = parseFloat(totalAmountField.value) || 0;
  
        // Check if the vaultAmount is greater than or equal to the current totalAmount
        if (vaultAmount >= totalAmount) {
          totalAmountField.value = vaultAmount;
          update_balance(); // Recalculate balance after setting total amount
        }
      });
    }
  });
</script>
{% endblock %}


////////////////////////////////////////////////////

try:
        staff_leave_count = StaffLeave.objects.get(staff=pk)
        staff_leave_count=StaffLeave.objects.get(staff=pk)
        print("staff_leave_count---",staff_leave_count.total_leave)
        staff_leave_counts=staff_leave_count.total_leave
        # Perform actions with staff_leave_count
    except StaffLeave.DoesNotExist:
        # Handle the case where the record does not exist
        staff_leave_count = None
        print("No matching StaffLeave record found for the given staff ID.")

===================================================================================

@login_required
@user_type_required("Staff")
def collect_fees_detail(request, pk):
    # if request.user.is_superuser or request.user.is_school_admin or "collect_fees_add" in request.permissions:
    #     try:
                token = request.session['user_token'] 
                branch_name = request.session.get('branch_id', None)
                if branch_name:
                    branch_id = branch_name       
                else:
                    branch_id = None  
                    print("branch_name@@@",branch_name)
                    
                    
                endpoint = 'finance/transaction-type/'
                endpoint_transaction = 'finance/all-transaction/'

                toady_date = datetime.now().date()
                records = StudentAdmission.objects.get(id=pk)
                print("records",records.id)
                fees_records = FeesAssign.objects.filter(
                    student_id=pk, session=request.Session
                )
                print("request.Session",request.Session)
                # fees_discount=FeesTypeDiscount.objects.all()
                fees_discount = DiscountAssign.objects.filter(
                    student=pk, session=request.Session,branch_id = branch_id
                )
                paid_record = StudentFess.objects.filter(
                    student=pk, session=request.Session,branch_id = branch_id
                )
                student_vault_amount = 0   
                student_main = StudentMain.objects.get(id=records.student_main.id)
                print("student_main_id__up", student_main)
                
                student_vault = StudentVaultAmount.objects.get(student=student_main)
                print("student_vault+++",student_vault.balance_amount)
                student_vault_amount = student_vault.balance_amount
                if request.method == "POST":
                    branch = Branch.objects.get(id=branch_id)
                    print("branch+++", branch.school.reference_id) 
                    amount_list = request.POST.get("amount")
                    print("amount_list+++",amount_list)
                    percentage = request.POST.get("percentage")
                    discount_group = request.POST.get("discount_group")
                    amount_discount = request.POST.get("amount_discount")
                    amount_fine = request.POST.get("amount_fine")
                    payment_mode_fee = request.POST.get("payment_mode_fee")
                    description = request.POST.get("description")
                    fess_id = request.POST.get("fees_id")
                    transaction_type = request.POST.get("transaction_type")
                    paid_by = request.POST.get("paid_by") 
                    total_amount = request.POST.get("total_amount") 
                    print("total_amount----",total_amount)
                    balance_amounts = request.POST.get("balance_amount") or 0
                    if amount_list >= total_amount:                        
                        amount = amount_list  
                        print("Total Value:1", amount_list)
                    else:
                        amount = amount_list
                        print("Total Value:2", amount)
                    if total_amount >= amount_list:
                        amount = total_amount 
                        print("Total Value:3", amount)
                    else:
                        amount = total_amount  
                    print("Student Paid Amount: ", amount, "Total Value: ", amount)
                    if paid_by == '':
                        paid_by = None
                    ref_number = request.POST.get("ref_number") 
                    if ref_number == '':
                        ref_number = None
                    card_holder_name = request.POST.get("card_holder_name") 
                    if card_holder_name == '':
                        card_holder_name = None
                    mobile_number = request.POST.get("mobile_number") 
                    if mobile_number == '':
                        mobile_number = None
                    user_amount = request.POST.get("user_amount") 
                    if user_amount == '':
                        user_amount = None
                    print("transaction_type++++",transaction_type,paid_by,ref_number,ref_number,card_holder_name,mobile_number)
                    # student information as a dictionary
                    response = call_get_method(BASE_URL, endpoint, token)
                    transaction_data = response.json()
                    print("transaction_data", transaction_data)

                    # Extract 'name' and 'transaction_type_id' into a list of dictionaries
                    transaction_list = [{'name': item['name'], 'transaction_type_id': item['transaction_type_id']} for item in transaction_data]

                    print("transaction_list", transaction_list)
                    payroll_transaction = next((transaction for transaction in transaction_list if transaction['name'] == 'Payroll'), None)
                    if payroll_transaction:
                        transaction_name = payroll_transaction['name']
                        transaction_type_id = payroll_transaction['transaction_type_id']
                        print("Transaction Name:", transaction_name)
                        print("Transaction Type ID:", transaction_type_id)
                    else:
                        print("No 'Payroll' transaction found.")
                    if response.status_code != 200:
                        return render(request, 'error500.html', {'error': str(response.json())})
                    
                    student_information = {
                        "student_name": f"{records.first_name}",
                        "roll_no": f"{records.roll_number}"
                    }

                    # converting student_information to JSON format
                    # student_information_json = json.dumps(student_information)
                    # print("++++tudent",type(student_information_json))

                    # using it in the data dictionary
                    data = {
                        'transaction_type_id': str(transaction_type_id),
                        'company_id': str(branch.school.reference_id),
                        'amount': int(amount),
                        'input_params_values': student_information 
                    }
                    print("++++++++++++++++++",data)

                    json_data = json.dumps(data)
                    print("=========", json_data)

                    response = call_post_method(BASE_URL, endpoint_transaction, json_data, token)
                    print("response+++", response)
                    if response.status_code != 200:
                        print('Response Status Code:', response.content)
                    response_data = json.loads(response.content.decode('utf-8')) 
                    transaction_id=response_data['record_id']    
                    print("transaction_id",transaction_id)
                    Transaction.objects.create(
                        student_id=pk,
                        reference_id=transaction_id,                   
                        branch_id = branch_id
                    )
                    fees_record = FeesAssign.objects.get(id=fess_id)
                    if discount_group:
                        dis = DiscountAssign.objects.filter(
                            id=discount_group,
                        ).last()
                        if dis:
                            dis.status = "applied"
                            dis.fees_id = fess_id
                            dis.branch_id = branch_id
                            dis.save()
                            fees_record.Dicount_amount = (
                                fees_record.Dicount_amount + dis.discount.amount
                            )
                    if amount_fine:
                        fees_record.fine_amount = int(amount_fine) + fees_record.fine_amount
                    
                    StudentFess.objects.create(
                        student_id=pk,
                        paid_amount=amount,
                        discount_group_id=discount_group,
                        payment_mode_fee=payment_mode_fee,
                        amount_discount=amount_discount,
                        amount_fine=amount_fine,
                        description=description,
                        status="Paid",
                        fess_id=fess_id,
                        session=request.Session,
                        created_by=request.user,
                        branch_id = branch_id,
                        paid_by = paid_by,
                        ref_number = ref_number,
                        card_holder_name = card_holder_name,
                        mobile_number = mobile_number,
                        amount = user_amount,
                    )
                    student_vault = 0
                    if total_amount:
                        try:
                            student_main = StudentMain.objects.get(id=records.student_main.id)
                            print("student_main_id---+++", student_main)
                            
                            student_vault = StudentVaultAmount.objects.get(student=student_main)
                            print("student_vault+++", student_vault)
                            
                            if student_vault:
                                student_vault.student = student_main
                                student_vault.total_amount = Decimal(total_amount) 
                                student_vault.paid_amount = Decimal(amount)        
                                student_vault.balance_amount = Decimal(balance_amounts) 
                                student_vault.session = request.Session             
                                student_vault.created_by = request.user
                                student_vault.branch_id = branch_id
                                student_vault.save()
                            else:
                                StudentVaultAmount.objects.create(
                                    student=student_main,
                                    total_amount=Decimal(total_amount),    
                                    paid_amount=Decimal(amount),          
                                    balance_amount=Decimal(balance_amounts),  
                                    session=request.Session,              
                                    created_by=request.user,
                                    branch_id=branch_id
                                )
                        except StudentMain.DoesNotExist:
                            print(f"StudentMain with admission number {records.admission_no} does not exist.") 
                    
                    fees_record.paid_amount = int(fees_record.paid_amount) + int(amount)
                    if fees_record.balance_amount == None:
                        print("if_es_record.fees.amount---",fees_record.balance_amount,amount,amount_discount)
                        obalance = (
                            int(fees_record.fees.amount)
                            - int(amount)
                            - int(amount_discount)
                        )
                        print('balance+++',balance)
                        paid = fees_record.paid_amount
                    else:
                        print("else_ees_record.fees.amount---",fees_record.balance_amount,amount,amount_discount)
                        print("else_amount---",amount,amount_discount)
                        print("else_amount_discount---",amount_discount)
                        balance = (                            
                              int(amount) - 
                              int(fees_record.balance_amount) - 
                              int(amount_discount)
                        )
                        print('balance---',balance)
                        paid = int(fees_record.paid_amount) + int(amount)
                    fees_record.balance_amount = balance
                    # fees_record.paid_amount=paid
                    if balance == 0:
                        fees_record.status = "fully paid"
                    else:
                        fees_record.status = "partially paid"
                    fees_record.save()

                    # for student in records:
                    if records.branch is not None:
                        # Retrieve the user-inputted amount from the form
                        # fee_amount = request.POST.get(f"fee_amount_{records.id}")
                        print("amount", amount)
                        fee_amount = amount
                        # Ensure fee_amount is not None and is a valid number
                        if fee_amount is not None and fee_amount.isdigit():
                            fee_amount = int(fee_amount)
                        else:
                            print(f"Invalid fee amount for student {records.id}")
                            # Handle the error or return an appropriate response

                        # Collect fees from student and credit it to the school
                        # success = collect_school_fees(request,records, fee_amount)
                        # Assuming you have the student and fee_amount variables defined earlier in your code
                        success = collect_school_fees(
                            records_id=records.id,
                            fee_amount=fee_amount,
                            user_id=request.user.id,
                        )

                        if success:
                            print(f"Fee collected for student {records.id}")
                        else:
                            print(f"Failed to collect fee for student {records.id}")

                    return HttpResponseRedirect(f"/collect_fees_detail/{pk}")

                context = {
                    "records": records,
                    "fees_records": fees_records,
                    "toady_date": toady_date,
                    "fees_discount": fees_discount,
                    "paid_record": paid_record,
                    "collect_fees": "active",                
                    "pk":pk,
                    "student_vault":student_vault_amount
                }
                return render(request, "Fees_Collection/collect_fees_detail.html", context)
    #     except Exception as error:
    #         return render(request, "error.html", {"error": error})
    # else:
    #     return redirect("dashboard")

    ========================================

    if amount_list >= total_amount:                        
        amount = amount_list  
        print("Total Value:1", amount_list)
    else:
        amount = amount_list
        print("Total Value:2", amount)
    if total_amount >= amount_list:
        amount = total_amount 
        print("Total Value:3", amount)
    else:
        amount = total_amount  
    print("Student Paid Amount: ", amount, "Total Value: ", amount)



    ///////////////////////////////////////////////////////////////////

    elif request.user:
    print("request.user++++",request.user)
    # admin = User.objects.get(id=request.user.id)
    # print("admin---",admin.username)    
    payload = {
        "email": un,
        "password": pwd
    }

    # Convert payload to JSON format
    json_payload = json.dumps(payload)
    print("json_payload", json_payload)
    
    url = BASE_URL + '/token/'
    login_response = call_post_method_without_token(url, json_payload)
    print('login_response', login_response)

    if login_response.status_code != 200:
        print('login_response', login_response.json())
        messages.error(request, 'Invalid username (or) password')
        return render(request, 'Auth/SignIn.html')
    else:
        print('login_responseelse', login_response.json())

    login_tokes = login_response.json()
    print('login_tokes', login_tokes)

    token = request.session['user_token'] = login_tokes['access']
    print('token7777', token)

    # After successful login, redirect to another page, like the dashboard
    return redirect("select_school")


    =================


    def signin(request):
    if request.method == "GET":
        # if not request.user.is_authenticated:
        form = AuthenticationForm()
        context = {
            "form": form,
        }
        return render(request, "Auth/SignIn.html", context)
        # else:
        #     return redirect("dashboard")
    if request.method == "POST":
        form = AuthenticationForm(data=request.POST)
        if form.is_valid():
            un = form.cleaned_data["username"]
            pwd = form.cleaned_data["password"]            
            print('un---',un)
            print('pwd---',pwd)
              
            user = authenticate(username=un, password=pwd)
           
            if user is not None:                   
                login(request, user)              
                try:
                    buyer_name = User.objects.get(id=request.user.id)
                    buyer_id = buyer_name.buyer_id
                    request.session['buyer_id'] = buyer_id
                    print("request.session['buyer_id']",request.session['buyer_id'])
                except ObjectDoesNotExist:
                    request.session['buyer_id']  = None
                try:
                    staff = AddStaff.objects.get(user_id=request.user.id)
                    print("staff---+++",staff.is_admin)
                except ObjectDoesNotExist:
                    staff = None
                if request.user.is_superuser or request.user.is_school_admin:
                    # admin = User.objects.get(id=request.user.id)
                    # print("admin---",admin.username)    
                    payload = {        
                        "email" : un,
                        "password" : pwd
                    }
                    # Convert payload to JSON format
                    json_payload = json.dumps(payload)
                    print("json_payload",json_payload)
                    url = BASE_URL+'/token/'
                    login_response = call_post_method_without_token(url,json_payload)
                    print('login_response---',login_response)    
                    if login_response.status_code != 200:
                        print('login_response',login_response.json())      
                        messages.error(request, 'Invalid username (or) password')
                        return render(request, 'Auth/SignIn.html')     
                    else:
                        print('login_responseelse',login_response.json())
                    login_tokes = login_response.json()
                    print('login_tokes',login_tokes)
                    token=request.session['user_token']=login_tokes['access']
                    print('token',token)   
                    return redirect("select_school")
                
                elif staff and staff.is_admin :
                    print("staff---",request.user.id)
                    package_data = json.dumps({'buyer_id':user.buyer_id})
                    print("package_data===",package_data)
                    package_check = call_post_method_for_without_token(PACKAGE_URL,'package_check/',package_data)
                    print('package_check---staff.is_admin',package_check)
                    # if not package_check.status_code == 200:
                    #     messages.error(request, package_check.json())
                    #     return render(request, 'Auth/SignIn.html') 
                    payload = {        
                        "email" : un,
                        "password" : pwd
                    }
                    json_payload = json.dumps(payload)
                    print("json_payload",json_payload)
                    url = BASE_URL+'/token/'
                    login_response = call_post_method_without_token(url,json_payload)
                    print('login_response',login_response)    
                    if login_response.status_code != 200:
                        print('login_response---',login_response.json())      
                        messages.error(request, 'Invalid username (or) password')
                        return render(request, 'Auth/SignIn.html')     
                    else:
                        print('login_responseelse',login_response.json())                  
                   
                        
                    login_tokes = login_response.json()
                    print('login_tokes',login_tokes)
                    token=request.session['user_token']=login_tokes['access']
                    print('token',token)
                    satff = AddStaff.objects.get(user_id=request.user.id)
                    print('satff****',satff.branch.id)
                    print('satffschool****',satff.school.id)  
                    if package_check.status_code == 200:
                        if staff.is_admin:
                            print("---okay",staff.is_admin)
                            return HttpResponseRedirect(f"select_branch/{satff.school.id}") 
                        else: 
                            messages.error(request, 'Invalid username (or) password')
                            return redirect("signin")  
                    elif package_check.status_code == 201:
                        if staff.is_admin:
                            print("---okay",staff.is_admin)     
                            return redirect('warning_page')                        
                        else: 
                            messages.error(request, 'Invalid username (or) password')
                            return redirect("signin")
                    elif package_check.status_code == 400:
                        messages.error(request, package_check.json())
                        print("messages---",messages)
                        return render(request, 'Auth/SignIn.html')  # Replace with the actual error page URL or name
                    else:
                        messages.error(request, 'Unexpected error occurred')
                        print('package_checkelse',package_check.json())                 
                        print("request.user.staff",request.user.is_school_admin)
                elif request.user.user_type == "Staff" :
                    print("staff---",request.user.id)
                    package_data = json.dumps({'buyer_id':user.buyer_id})
                    print("package_data===",package_data)
                    package_check = call_post_method_for_without_token(PACKAGE_URL,'package_check/',package_data)
                    print('package_check---',package_check)
                    if not package_check.status_code == 200:
                        messages.error(request, package_check.json())
                        return render(request, 'Auth/SignIn.html')
                    print("staff---",request.user.id)
                    
                    print("request.user.staff",request.user.is_school_admin)
                    payload = {        
                        "email" : un,
                        "password" : pwd
                    }
                    # Convert payload to JSON format
                    json_payload = json.dumps(payload)
                    print("json_payload",json_payload)
                    url = BASE_URL+'/token/'
                    login_response = call_post_method_without_token(url,json_payload)
                    print('login_response',login_response)    
                    if login_response.status_code != 200:
                        print('login_response',login_response.json())      
                        messages.error(request, 'Invalid username (or) password')
                        return render(request, 'Auth/SignIn.html')     
                    else:
                        print('login_responseelse',login_response.json())
                    login_tokes = login_response.json()
                    print('login_tokes',login_tokes)
                    token=request.session['user_token']=login_tokes['access']
                    print('token',token)                 
                    satff = AddStaff.objects.get(user_id=request.user.id)
                    print('satff****',satff.branch.id)
                    print('satffschool****',satff.school.id)
                    request.session['branch_id'] = satff.branch.id
                    print("request.session",request.session['branch_id'])
                    return redirect("dashboard")                   
                elif request.user.user_type == "Student":
                    print("staff---",request.user.id)
                    package_data = json.dumps({'buyer_id':user.buyer_id})
                    print("package_data===",package_data)
                    package_check = call_post_method_for_without_token(PACKAGE_URL,'package_check/',package_data)
                    print('package_check---',package_check)
                    if not package_check.status_code == 200:
                        messages.error(request, package_check.json())
                        return render(request, 'Auth/SignIn.html')
                    print("Student-----",request.Session)
                    print("student.user.id-----",request.user.id)
                    student = StudentAdmission.objects.filter(user_student_id=request.user.id,session=request.Session)
                    print("-----student)))",student)
                    if student.exists():
                        return redirect("student_dashboard_student")
                    else:
                        print("-----else")
                        logout(request)
                        return redirect("signin")                 
                elif request.user.user_type == "Parent":
                    print("staff---",request.user.id)
                    package_data = json.dumps({'buyer_id':user.buyer_id})
                    print("package_data===",package_data)
                    package_check = call_post_method_for_without_token(PACKAGE_URL,'package_check/',package_data)
                    print('package_check---',package_check)
                    if not package_check.status_code == 200:
                        messages.error(request, package_check.json())
                        return render(request, 'Auth/SignIn.html')
                    print("Parent-----",request.Session)
                    
                    payload = {        
                        "email" : un,
                        "password" : pwd
                    }
                    # Convert payload to JSON format
                    json_payload = json.dumps(payload)
                    print("json_payload",json_payload)
                    url = BASE_URL+'/token/'
                    login_response = call_post_method_without_token(url,json_payload)
                    print('login_response',login_response)    
                    if login_response.status_code != 200:
                        print('login_response',login_response.json())      
                        messages.error(request, 'Invalid username (or) password')
                        return render(request, 'Auth/SignIn.html')     
                    else:
                        print('login_responseelse',login_response.json())
                    login_tokes = login_response.json()
                    print('login_tokes',login_tokes)
                    token=request.session['user_token']=login_tokes['access']
                    print('token',token)   
                    print("request.user.id-----",request.Session)
                    student = StudentAdmission.objects.filter(user_parent_id=request.user.id,session=request.Session)
                    print('student===',student)                    
                    if student.exists():
                        return redirect("parent_dashboard")  
                    else:
                        print("-----else")
                        logout(request)
                        return redirect("signin")
                                                                           
                else:
                    messages.error(request, 'Invalid username (or) password')
                    return redirect("signin")
            else:
                print("invalid username and password")
                context = {
                    "form": form,
                    "error": "Invalid Username And Password",
                }
                return render(request, "Auth/SignIn.html", context)
        else:
            print(form.errors)
            context = {
                "form": form,
            }
            return render(request, "Auth/SignIn.html", context)



            username_student = f"student{records.count()}"

            username_parent = f"parent{records.count()}"



==============================================================================
import logging

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

def clean_value(value):
    """Cleans values by converting float-like numbers to integers and handling None values."""
    try:
        if pd.isna(value) or value in ["", "None", "null"]:
            return None
        if isinstance(value, (int, float)) and value == int(value):  
            return int(value)  # Convert 6.0  6
        return str(value).strip()  # Convert everything else to string
    except ValueError:
        return None

def process_student_data(df_chunk, request):
    logger.info("Processing student data...")
    records = StudentAdmission.objects.all()
    for index, row in df_chunk.iterrows():
         # Ensures data consistency
            try:
                
                # Debug: Print each row being processed
                logger.info(f"Processing Row {index+1}")

                # Clean values from DataFrame
                admission_no = clean_value(row["admission_no"])
                roll_number = clean_value(row["roll_number"])
                first_name_1 = clean_value(row["first_name"])
                last_name_1 = clean_value(row["last_name"])
                Classs = clean_value(row["Class"])
                section_id = clean_value(row["section"])
                gender = clean_value(row["gender"])
                mobile_number = clean_value(row["mobile_number"])
                guardian_name_1 = clean_value(row["father_name"])
                guardian_name_2 = clean_value(row["mother_name"])
                guardian_email_1 = clean_value(row["guardian_email"])
                guardian_occupation_father = clean_value(row["father_occupation"])
                guardian_occupation_mother = clean_value(row["mother_occupation"])
                guardian_relation = clean_value(row["guardian_relation"])
                email_1 = clean_value(row["email"])
                religion = clean_value(row["religion"])
                Caste = clean_value(row["Caste"])
                Blood_group = clean_value(row["Blood_group"])
                height = clean_value(row["height"])
                weight = clean_value(row["weight"])
                bank_account_number = clean_value(row["bank_account_number"])
                bank_name = clean_value(row["bank_name"])
                ifsc_code = clean_value(row["ifsc_code"])
                national_identification_number = clean_value(row["national_identification_number"])
                local_identification_number = clean_value(row["local_identification_number"])
                previous_school_detail = clean_value(row["previous_school_detail"])
                note = clean_value(row["note"])
                title_1 = clean_value(row["title_1"])
                title_2 = clean_value(row["title_2"])
                title_3 = clean_value(row["title_3"])
                title_4 = clean_value(row["title_4"])
                status = clean_value(row["status"])
                session = clean_value(row["session"])
                branch_id = clean_value(row["branch"])
                buyer_id = clean_value(row["buyer_id"])
                category_1 = clean_value(row["category"])
                diable_reson = clean_value(row["diable_reson"])
                account = clean_value(row["account"])
                vehicle_number = clean_value(row["vehicle_number"])
                route_list = clean_value(row["route_list"])
                hostel = clean_value(row["hostel"])

                # Handling date values safely
                date_of_birth = pd.to_datetime(row["date_of_birth"], errors='coerce')
                admission_date = pd.to_datetime(row["admission_date"], errors='coerce')
                as_on_date = pd.to_datetime(row["as_on_date"], errors='coerce')

                date_of_birth = date_of_birth.strftime('%Y-%m-%d') if pd.notna(date_of_birth) else None
                admission_date = admission_date.strftime('%Y-%m-%d') if pd.notna(admission_date) else None
                as_on_date = as_on_date.strftime('%Y-%m-%d') if pd.notna(as_on_date) else None

                # Debugging output
                logger.info(f"Row {index+1} processed successfully.")

            except Exception as e:
                logger.error(f" Error in Row {index+1}: {e}")
                continue  # Skip problematic row
            # Create student & parent users
            password_student = generate_password()  # Replace with `generate_password()`
            password_parent = generate_password()  # Replace with `generate_password()`
            
            username_student = f"student{records.count()}"
            print('username_student+++',username_student)
            user_student = User.objects.create_user(
                username=username_student,
                first_name=first_name_1,
                last_name=last_name_1,
                email=email_1,
                password=password_student,
                user_type="Student",
                buyer_id=buyer_id
            )
            user_student.save()
            user, created = User.objects.get_or_create(username=username_student, defaults={"other_field": row.get("other_field")})
            if created:
                print(f"New user created: {username_student}")
            else:
                print(f"User {username_student} already exists, skipping.")
            print("+++",user_student.first_name)
            print('username_parent+++',password_parent)
            guardian_name_1 = str(guardian_name_1).strip() if isinstance(guardian_name_1, (str, float)) else ""
            print("guardian_name_1",guardian_name_1)
            guardian_email_1 = str(guardian_email_1).strip() if isinstance(guardian_email_1, (str, float)) else ""
            # Create the user
            if guardian_name_1:  # Check if guardian_name_1 is not None or empty
                username_parent = f"parent{records.count()}"
                user_parent = User.objects.create_user(
                    username=username_parent,
                    first_name=guardian_name_1,
                    email=guardian_email_1 or "",  # Ensure email is not None
                    password=password_parent,
                    user_type="Parent",
                    buyer_id=buyer_id
                )
            else:
                user_parent = None    
            # Create Student Admission Record
            student_admission = StudentAdmission.objects.create(
                session=request.Session,
                user_student_id=user_student.pk,
                user_parent=user_parent,
                created_by=request.user,
                admission_no=admission_no,
                roll_number=roll_number,
                first_name=first_name_1,
                Class_id=Classs,
                section_id=section_id,
                date_of_birth=date_of_birth,
                gender=gender,
                category_id=category_1,
                mobile_number=mobile_number,
                vehicle_number_id=vehicle_number,
                route_list_id=route_list,
                hostel_id=hostel ,
                last_name=last_name_1,
                email=email_1,
                religion=religion,
                Caste=Caste,
                Blood_group=Blood_group,
                height=height,
                weight=weight,
                bank_account_number=bank_account_number,
                bank_name=bank_name,
                ifsc_code=ifsc_code,
                national_identification_number=national_identification_number,
                local_identification_number=local_identification_number,
                previous_school_detail=previous_school_detail,
                note=note,
                title_1=title_1,
                title_2=title_2,
                title_3=title_3,
                title_4=title_4,
                diable_reson_id=diable_reson ,
                status=status,
                as_on_date=as_on_date,
                admission_date=admission_date,
                session_id = session,
                account = account,
                branch_id = branch_id
            )

            # Create Student Main Record
            student_main = StudentMain.objects.create(
                admission_no=student_admission.admission_no,
                roll_number=student_admission.roll_number,
                account=student_admission.account,
                first_name=student_admission.first_name,
                last_name=student_admission.last_name,
                gender=student_admission.gender,
                date_of_birth=student_admission.date_of_birth,
                category=student_admission.category,
                religion=student_admission.religion,
                Caste=getattr(student_admission, 'Caste', None),
                mobile_number=student_admission.mobile_number,
                email=student_admission.email,
                admission_date=student_admission.admission_date,
                student_photo=student_admission.student_photo,
                Blood_group=getattr(student_admission, 'Blood_group', None),
                height=student_admission.height,
                weight=student_admission.weight,
                as_on_date=student_admission.as_on_date,
                bank_account_number=student_admission.bank_account_number,
                bank_name=student_admission.bank_name,
                ifsc_code=student_admission.ifsc_code,
                national_identification_number=student_admission.national_identification_number,
                local_identification_number=student_admission.local_identification_number,
                rte=student_admission.rte,
                previous_school_detail=student_admission.previous_school_detail,
                note=student_admission.note,
                title_1=student_admission.title_1,
                documents_1=student_admission.documents_1,
                title_2=student_admission.title_2,
                documents_2=student_admission.documents_2,
                title_3=student_admission.title_3,
                documents_3=student_admission.documents_3,
                title_4=student_admission.title_4,
                documents_4=student_admission.documents_4,
                disable_date=student_admission.disable_date,
                diable_reson=student_admission.diable_reson,
                disable_note=student_admission.disable_note,
                status=student_admission.status,
                user_student=student_admission.user_student,
                user_parent=student_admission.user_parent,
                created_by=student_admission.created_by,
                created_at=student_admission.created_at,
                student_health=student_admission.student_health,
                student_health_description=student_admission.student_health_description,
                name_of_last_school=student_admission.name_of_last_school,
                leaving_last_school_reason=student_admission.leaving_last_school_reason,
                grade_completed=student_admission.grade_completed,
                suspended_or_not=student_admission.suspended_or_not,
                is_suspension_resolved=student_admission.is_suspension_resolved,
                suspension_reason=student_admission.suspension_reason,
                county=student_admission.county,
                sub_county=student_admission.sub_county,
                ward=student_admission.ward,
                branch=student_admission.branch,
                source=student_admission.source,
                vehicle_number=student_admission.vehicle_number,
                route_list=student_admission.route_list,
                hostel=student_admission.hostel,
            )

            # Link StudentMain to StudentAdmission
            student_admission.student_main = student_main
            student_admission.save()

            # Create Login Credentials
            LoginCredentials.objects.create(
                student_id=student_admission.pk,
                student_username=username_student,
                student_password=password_student,
                parent_username=guardian_email_1 or None,
                parent_passwod=password_parent,
                branch_id=branch_id
            )

            # Create Guardian Master
            guardain_master=GuardianMaster.objects.create(
            guardian_name=guardian_relation,
            branch_id = branch_id
            )
            if guardian_name_1:
                StudentGuardianDetails.objects.create(
                    student = student_admission,
                    guardianmaster = guardain_master,
                    name = guardian_name_1,
                    phone = mobile_number or None,
                    occupation = guardian_occupation_father,
                    guardian_email = guardian_email_1,
                    branch_id = branch_id
                )
            if guardian_name_2: 
                StudentGuardianDetails.objects.create(
                    student = student_admission,
                    guardianmaster = guardain_master,
                    name = guardian_name_2,
                    phone = mobile_number or None,
                    occupation = guardian_occupation_mother,
                    guardian_email = guardian_email_1,
                    branch_id = branch_id
                )

            # Create Student Session
            StudentSession.objects.create(
                session=request.Session,  # Ensure session object is properly passed
                student_id=student_main.pk,
                status="Active",
                branch_id=branch_id
            )

            # Create Student Class
            StudentClass.objects.create(
                session=request.Session,
                student_id=student_main.pk,
                Class_id=Classs,
                section_id=section_id,
                status="Active",
                branch_id=branch_id
            )

            # Create Student Vault Amount
            StudentVaultAmount.objects.create(
                student=student_main,
                total_amount=0,
                paid_amount=0,
                balance_amount=0,
                session=request.Session,
                created_by=request.user,
                branch_id=branch_id
            )

            # Create Finance Vault Account
            short_description = f"{student_main.admission_no} vault"
            vault = account_creation_finance(student_main.pk, short_description)
            print("vault++++",vault)

import concurrent.futures

def import_student(request):
    print("000001")
    form = StudentAdmissionForm()

    if request.method == "POST" and request.FILES.get("file"):
        print("000002")
        file = request.FILES["file"]
        
        try:
            df = pd.read_excel(file)
            print("File read successfully")  # Debugging step

            # Process student data using multithreading
            num_chunks = 6
            df_chunks = [df.iloc[i::num_chunks, :].reset_index(drop=True) for i in range(2, num_chunks + 2)]
            print("000003", df_chunks)

            with concurrent.futures.ThreadPoolExecutor(max_workers=num_chunks) as executor:
                futures = {executor.submit(process_student_data, chunk, request): chunk for chunk in df_chunks}
                print("futures++++====",futures)
                for future in concurrent.futures.as_completed(futures):
                    try:
                        future.result()  # This will raise any exceptions that occurred inside `process_student_data`
                    except Exception as e:
                        print(f"Error processing chunk: {e}")  # Print the error for debugging

            return HttpResponseRedirect("/import_student")  # Redirect after successful import

        except Exception as e:
            print(f"Error in import_student function: {e}")  # Print errors

    else:
        print("Error: File not provided or invalid form submission", form.errors)

    context = {}  # Pass form to the template
    return render(request, "Student_information/import_student.html", context)            


    logging.basicConfig(level=logging.INFO)
    logger = logging.getLogger(__name__)
    
    def clean_value(value):
        """Cleans values by converting float-like numbers to integers and handling None values."""
        try:
            if pd.isna(value) or value in ["", "None", "null"]:
                return None
            if isinstance(value, (int, float)) and value == int(value):  
                return int(value)  # Convert 6.0  6
            return str(value).strip()  # Convert everything else to string
        except ValueError:
            return None
    
    def process_student_data(chunk, request):
        logger.info("Processing student data...")
        records = StudentAdmission.objects.all()
        for index, row in chunk.iterrows():
            try:
                logger.info(f"Processing Row {index+1}")
    
                # Clean values from DataFrame
                admission_no = clean_value(row["admission_no"])
                roll_number = clean_value(row["roll_number"])
                first_name_1 = clean_value(row["first_name"])
                last_name_1 = clean_value(row["last_name"])
                Classs = clean_value(row["Class"])
                section_id = clean_value(row["section"])
                gender = clean_value(row["gender"])
                mobile_number = clean_value(row["mobile_number"])
                guardian_name_1 = clean_value(row["father_name"])
                guardian_name_2 = clean_value(row["mother_name"])
                guardian_email_1 = clean_value(row["guardian_email"])
                guardian_occupation_father = clean_value(row["father_occupation"])
                guardian_occupation_mother = clean_value(row["mother_occupation"])
                guardian_relation = clean_value(row["guardian_relation"])
                email_1 = clean_value(row["email"])
                religion = clean_value(row["religion"])
                Caste = clean_value(row["Caste"])
                Blood_group = clean_value(row["Blood_group"])
                height = clean_value(row["height"])
                weight = clean_value(row["weight"])
                bank_account_number = clean_value(row["bank_account_number"])
                bank_name = clean_value(row["bank_name"])
                ifsc_code = clean_value(row["ifsc_code"])
                national_identification_number = clean_value(row["national_identification_number"])
                local_identification_number = clean_value(row["local_identification_number"])
                previous_school_detail = clean_value(row["previous_school_detail"])
                note = clean_value(row["note"])
                title_1 = clean_value(row["title_1"])
                title_2 = clean_value(row["title_2"])
                title_3 = clean_value(row["title_3"])
                title_4 = clean_value(row["title_4"])
                status = clean_value(row["status"])
                session = clean_value(row["session"])
                branch_id = clean_value(row["branch"])
                buyer_id = clean_value(row["buyer_id"])
                category_1 = clean_value(row["category"])
                diable_reson = clean_value(row["diable_reson"])
                account = clean_value(row["account"])
                vehicle_number = clean_value(row["vehicle_number"])
                route_list = clean_value(row["route_list"])
                hostel = clean_value(row["hostel"])
    
                # Handling date values safely
                date_of_birth = pd.to_datetime(row["date_of_birth"], errors='coerce')
                admission_date = pd.to_datetime(row["admission_date"], errors='coerce')
                as_on_date = pd.to_datetime(row["as_on_date"], errors='coerce')
    
                date_of_birth = date_of_birth.strftime('%Y-%m-%d') if pd.notna(date_of_birth) else None
                admission_date = admission_date.strftime('%Y-%m-%d') if pd.notna(admission_date) else None
                as_on_date = as_on_date.strftime('%Y-%m-%d') if pd.notna(as_on_date) else None
    
                # Debugging output
                logger.info(f"Row {index+1} processed successfully.")
    
                # Create student & parent users
                password_student = generate_password()  # Replace with `generate_password()`
                password_parent = generate_password()  # Replace with `generate_password()`
                
                username_student = f"student{records.count()}"
                user_student = User.objects.create_user(
                    username=username_student,
                    first_name=first_name_1,
                    last_name=last_name_1,
                    email=email_1,
                    password=password_student,
                    user_type="Student",
                    buyer_id=buyer_id
                )
                user_student.save()
    
                guardian_name_1 = str(guardian_name_1).strip() if isinstance(guardian_name_1, (str, float)) else ""
                guardian_email_1 = str(guardian_email_1).strip() if isinstance(guardian_email_1, (str, float)) else ""
    
                if guardian_name_1:  # Check if guardian_name_1 is not None or empty
                    username_parent = f"parent{records.count()}"
                    user_parent = User.objects.create_user(
                        username=username_parent,
                        first_name=guardian_name_1,
                        email=guardian_email_1 or "",  # Ensure email is not None
                        password=password_parent,
                        user_type="Parent",
                        buyer_id=buyer_id
                    )
                else:
                    user_parent = None    
    
                # Create Student Admission Record
                student_admission = StudentAdmission.objects.create(
                    session=request.Session,
                    user_student_id=user_student.pk,
                    user_parent=user_parent,
                    created_by=request.user,
                    admission_no=admission_no,
                    roll_number=roll_number,
                    first_name=first_name_1,
                    Class_id=Classs,
                    section_id=section_id,
                    date_of_birth=date_of_birth,
                    gender=gender,
                    category_id=category_1,
                    mobile_number=mobile_number,
                    vehicle_number_id=vehicle_number,
                    route_list_id=route_list,
                    hostel_id=hostel,
                    last_name=last_name_1,
                    email=email_1,
                    religion=religion,
                    Caste=Caste,
                    Blood_group=Blood_group,
                    height=height,
                    weight=weight,
                    bank_account_number=bank_account_number,
                    bank_name=bank_name,
                    ifsc_code=ifsc_code,
                    national_identification_number=national_identification_number,
                    local_identification_number=local_identification_number,
                    previous_school_detail=previous_school_detail,
                    note=note,
                    title_1=title_1,
                    title_2=title_2,
                    title_3=title_3,
                    title_4=title_4,
                    diable_reson_id=diable_reson,
                    status=status,
                    as_on_date=as_on_date,
                    admission_date=admission_date,
                    session_id=session,
                    account=account,
                    branch_id=branch_id
                )
    
                # Create Student Main Record
                student_main = StudentMain.objects.create(
                    admission_no=student_admission.admission_no,
                    roll_number=student_admission.roll_number,
                    account=student_admission.account,
                    first_name=student_admission.first_name,
                    last_name=student_admission.last_name,
                    gender=student_admission.gender,
                    date_of_birth=student_admission.date_of_birth,
                    category=student_admission.category,
                    religion=student_admission.religion,
                    Caste=getattr(student_admission, 'Caste', None),
                    mobile_number=student_admission.mobile_number,
                    email=student_admission.email,
                    admission_date=student_admission.admission_date,
                    student_photo=student_admission.student_photo,
                    Blood_group=getattr(student_admission, 'Blood_group', None),
                    height=student_admission.height,
                    weight=student_admission.weight,
                    as_on_date=student_admission.as_on_date,
                    bank_account_number=student_admission.bank_account_number,
                    bank_name=student_admission.bank_name,
                    ifsc_code=student_admission.ifsc_code,
                    national_identification_number=student_admission.national_identification_number,
                    local_identification_number=student_admission.local_identification_number,
                    rte=student_admission.rte,
                    previous_school_detail=student_admission.previous_school_detail,
                    note=student_admission.note,
                    title_1=student_admission.title_1,
                    documents_1=student_admission.documents_1,
                    title_2=student_admission.title_2,
                    documents_2=student_admission.documents_2,
                    title_3=student_admission.title_3,
                    documents_3=student_admission.documents_3,
                    title_4=student_admission.title_4,
                    documents_4=student_admission.documents_4,
                    disable_date=student_admission.disable_date,
                    diable_reson=student_admission.diable_reson,
                    disable_note=student_admission.disable_note,
                    status=student_admission.status,
                    user_student=student_admission.user_student,
                    user_parent=student_admission.user_parent,
                    created_by=student_admission.created_by,
                    created_at=student_admission.created_at,
                    student_health=student_admission.student_health,
                    student_health_description=student_admission.student_health_description,
                    name_of_last_school=student_admission.name_of_last_school,
                    leaving_last_school_reason=student_admission.leaving_last_school_reason,
                    grade_completed=student_admission.grade_completed,
                    suspended_or_not=student_admission.suspended_or_not,
                    is_suspension_resolved=student_admission.is_suspension_resolved,
                    suspension_reason=student_admission.suspension_reason,
                    county=student_admission.county,
                    sub_county=student_admission.sub_county,
                    ward=student_admission.ward,
                    branch=student_admission.branch,
                    source=student_admission.source,
                    vehicle_number=student_admission.vehicle_number,
                    route_list=student_admission.route_list,
                    hostel=student_admission.hostel,
                )
    
                # Link StudentMain to StudentAdmission
                student_admission.student_main = student_main
                student_admission.save()
    
                # Create Login Credentials
                LoginCredentials.objects.create(
                    student_id=student_admission.pk,
                    student_username=username_student,
                    student_password=password_student,
                    parent_username=guardian_email_1 or None,
                    parent_passwod=password_parent,
                    branch_id=branch_id
                )
    
                # Create Guardian Master
                guardain_master = GuardianMaster.objects.create(
                    guardian_name=guardian_relation,
                    branch_id=branch_id
                )
                if guardian_name_1:
                    StudentGuardianDetails.objects.create(
                        student=student_admission,
                        guardianmaster=guardain_master,
                        name=guardian_name_1,
                        phone=mobile_number or None,
                        occupation=guardian_occupation_father,
                        guardian_email=guardian_email_1,
                        branch_id=branch_id
                    )
                if guardian_name_2: 
                    StudentGuardianDetails.objects.create(
                        student=student_admission,
                        guardianmaster=guardain_master,
                        name=guardian_name_2,
                        phone=mobile_number or None,
                        occupation=guardian_occupation_mother,
                        guardian_email=guardian_email_1,
                        branch_id=branch_id
                    )
    
                # Create Student Session
                StudentSession.objects.create(
                    session=request.Session,  # Ensure session object is properly passed
                    student_id=student_main.pk,
                    status="Active",
                    branch_id=branch_id
                )
    
                # Create Student Class
                StudentClass.objects.create(
                    session=request.Session,
                    student_id=student_main.pk,
                    Class_id=Classs,
                    section_id=section_id,
                    status="Active",
                    branch_id=branch_id
                )
    
                # Create Student Vault Amount
                StudentVaultAmount.objects.create(
                    student=student_main,
                    total_amount=0,
                    paid_amount=0,
                    balance_amount=0,
                    session=request.Session,
                    created_by=request.user,
                    branch_id=branch_id
                )
    
                # Create Finance Vault Account
                short_description = f"{student_main.admission_no} vault"
                vault = account_creation_finance(student_main.pk, short_description)
                logger.info(f"Vault created: {vault}")
    
            except Exception as e:
                logger.error(f" Error in Row {index+1}: {e}")
                continue  # Skip problematic row
    
    import concurrent.futures
    
    def import_student(request):
        logger.info("Importing student data...")
        if request.method == "POST":
            logger.info("POST request received")
            if request.FILES.get("file"):
                logger.info("File found in request")
                file = request.FILES["file"]
                logger.info(f"File name: {file.name}")
                
                try:
                    df = pd.read_excel(file)
                    logger.info("File read successfully")
                    logger.info(f"Number of rows in the file: {len(df)}")
    
                    # Process student data in chunks of 50 rows
                    chunk_size = 50
                    num_chunks = (len(df) // chunk_size) + (1 if len(df) % chunk_size != 0 else 0)
                    
                    logger.info(f"Number of chunks: {num_chunks}")
    
                    for i in range(num_chunks):
                        start_idx = i * chunk_size
                        end_idx = start_idx + chunk_size
                        chunk = df.iloc[start_idx:end_idx]
                        
                        logger.info(f"Processing chunk {i+1} with rows {start_idx} to {end_idx}")
                        
                        try:
                            process_student_data(chunk, request)
                            logger.info(f"Chunk {i+1} processed successfully")
                        except Exception as e:
                            logger.error(f"Error processing chunk {i+1}: {e}")
    
                    return HttpResponseRedirect("/import_student")  # Redirect after successful import
    
                except Exception as e:
                    logger.error(f"Error in import_student function: {e}")
            else:
                logger.error("No file provided in the request")
        else:
            logger.error("Invalid form submission or no file uploaded")
    
        context = {}  
        return render(request, "Student_information/import_student.html", context)

        

        def process_staff_row(row):
        try:
            user_name = row["user"]
            first_name = row["first_name"]
            last_name = row["last_name"]
            phone_no = row["phone_no"]
            date_of_birth = row["date_of_birth"]
            date_of_joining = row["date_of_joining"]
            roles = row.get("roles", None)
            designation = row.get("designation", None)
            department = row.get("department", None)
            branch = row.get("branch", None)
            school = row.get("school", None)
            
            first_name_clean = re.sub(r'[^a-zA-Z]', '', str(first_name)).lower()
            last_name_clean = re.sub(r'[^a-zA-Z]', '', str(last_name)).lower()
            
            phone_no = str(phone_no).strip() if pd.notna(phone_no) else None
            phone_no = int(float(phone_no)) if phone_no and phone_no.replace('.', '', 1).isdigit() else None
            
            dob1 = pd.to_datetime(date_of_birth, format="%d-%m-%Y", errors='coerce')
            doj = pd.to_datetime(date_of_joining, format="%d-%m-%Y", errors='coerce')
            dob1 = dob1.date() if not pd.isna(dob1) else None
            doj = doj.date() if not pd.isna(doj) else None
    
            password_staff = generate_password()
            user = User.objects.create(
                username=user_name,
                email=f"{first_name_clean}.{last_name_clean}@gmail.com" if first_name_clean and last_name_clean else "unknown@gmail.com",
                first_name=first_name,
                last_name=last_name,
                dob=dob1,
                phone_number=phone_no,
                user_type="Staff",
            )
            user.set_password(password_staff)
            user.save()
    
            AddStaff.objects.create(
                user_id=user.pk,
                phone_no=phone_no,
                roles_id=roles,
                designation_id=designation,
                department_id=department,
                first_name=first_name,
                last_name=last_name,
                date_of_birth=dob1,
                date_of_joining=doj,
                branch_id=branch,
                school_id=school,
            )
        except Exception as e:
            print(f"Error processing row: {e}")
    
    def import_staff(request):
        form = AddStaffForm()
        if request.method == "POST" and request.FILES.get("staff_add_file"):
            file = request.FILES["staff_add_file"]
            df = pd.read_excel(file)
            
            with ThreadPoolExecutor(max_workers=5) as executor:
                executor.map(process_staff_row, [row for _, row in df.iterrows()])
            
            return HttpResponseRedirect("/import_staff")
        
        context = {"add_staff": "active"}
        return render(request, "Human_Resource/import_staff.html", context)        