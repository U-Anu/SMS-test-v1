from django.http import HttpResponse, HttpResponseRedirect
import json, random, string
from django.shortcuts import render, redirect, get_object_or_404
# from pesanile_accounting.normal_views import account_creation_finance
from pesanile_accounting.models import AccountPayable, AccountReceivable, TransactionType as FinanceTransactionType
from pesanile_accounting.scripts_pr import receivable_atomic
from pesanile_accounting.views_ms import post_receivable_and_payable_transaction_ms
from sub_part.models import *
from sub_part.forms import *
from django.contrib.auth.forms import AuthenticationForm
from django.contrib.auth import authenticate, login, logout
from django.db.models import Q
from django.http import JsonResponse
from django.contrib import messages
from django.contrib.auth.decorators import login_required
from .password import generate_password
from .emails import new_staff_account_email
from django.db.models import Count, Sum
from .emails import new_staff_account_email, send_email_notification,send_email_notification1
from datetime import datetime, timedelta, date, time
from django.template.defaultfilters import floatformat
import pandas as pd
from payment.models import PaymentKeys
from .sms import *
from .decorators import *
import calendar
from django.utils import timezone
from num2words import num2words  
from .accounts import *
from .api_call import *
import json
from decimal import Decimal
import requests
import re
from concurrent.futures import ThreadPoolExecutor
from sub_part.models import Currency as sub_part_Currency
from django.contrib.auth.hashers import make_password
from reports.models import *
# BASE_URL = 'https://bbaccountingsms.pythonanywhere.com/'
BASE_URL='http://127.0.0.1:9000/'
# PACKAGE_URL = 'https://roisoukv1.pythonanywhere.com/'
PACKAGE_URL='http://127.0.0.1:8501/'
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from rest_framework.exceptions import NotFound

from .models import *
from .serializers import *
from celery import shared_task
User = get_user_model()

class CompanyCreateAPIView(APIView):
    def post(self, request, format=None):
        print('the request data is ',request.data)
        data=request.data.copy()
        # Separate company and user data from request
        company_data = data.get('company', {})
        user_data = data.get('user', {})
        print('company_data---',company_data)
        print('user_data---',user_data)
        password = "1234"
        print('hhhhhhhhcompany_data.get("currency_code")---',company_data.get('curreny_code'))
        currency ,created = sub_part_Currency.objects.get_or_create(
            currency_name=company_data.get('curreny_name'),
            currency_code=company_data.get('curreny_code'),
            symbol=company_data.get('currency_symbol'),
        ) 
        currency_obj = currency
        reference_id=None
        print('currency---',reference_id)
        if created:
            print('Currency created successfully.')
            data = {
                'currency_name': currency.currency_name,
                'currency_code': currency.currency_code,
                'symbol': currency.symbol,
                'reference_id': currency.currency_code,
            }   
            data=json.dumps(data)
            print('data---',data)
            reps=call_post_method_for_without_token(BASE_URL, 'finance/currency/',data )
            print('reps---',reps.json())
            if reps.status_code == 201 or reps.status_code == 200:
                print('Currency synced successfully with finance system.')
                reference_id = reps.json().get('record_id')
                currency_obj.reference_id = reference_id
                currency_obj.save()
                print('reps.json().get---',reps.json())
                print(' reference_id---',reference_id)
            else:
                print('Failed to sync currency with finance system.',reps.json())
                reference_id = None
        else:
            print('Currency already exists.')   
            reference_id = currency_obj.reference_id
        # Validate and create company
        currency_pk = sub_part_Currency.objects.get(currency_code=currency.currency_code).currency_id      
        
        company_data['school_id']=company_data.get('company_id')
        company_data['school_name']=company_data.get('name')
        company_data['phone_number']=company_data.get('contact_number')
        company_data['currency']=currency_pk

        company_serializer = SchoolSerializer(data=company_data)
        print('company_serializer---',company_serializer.is_valid())
        print('compaasaaaaany_seriddddddddddsaalizer---',company_serializer.errors)
        
        if company_serializer.is_valid():
            print('ttttttttttttt',reference_id)
            endpoint = 'finance/api_company/'
            company_data['company_name']=company_data.get('name')
            company_data['phone']=company_data.get('contact_number')
            company_data['local_currency']=reference_id
            company_data['website']='http://127.0.0.1:8501/'

            json_company_data = json.dumps(company_data)
            response = call_post_method_for_without_token(BASE_URL, endpoint, json_company_data)
            print("@@@@@response+++", response)
            company=None
            if response.status_code == 200 or response.status_code == 201:
                print('Response Status Code:', response.content)
                print('response.json().get---',response.json())
                # company_data['reference_id']= response.json().get('record_id')
                # company_serializer.validated_data['reference_id']= response.json().get('record_id')
                company = company_serializer.save()
                company.reference_id= response.json().get('record_id')
                company.save() 
            else:
                print('Failed to create company in finance system.')
                print('Response Status Code:', response.status_code)
                print('Response Status Code:', response.content)
            # If user datas i provided, create user associated with this company
            if user_data:
                user_data['school'] = company.id
                user_data['username'] = user_data.get('email')
                user_data['password'] = make_password(password)
                user_data['is_school_admin'] = True
                user_serializer = UserSerializer(data=user_data)
                print('user_serializer---',user_serializer.is_valid())
                if user_serializer.is_valid():
                    user = user_serializer.save()
                    # user.set_password(user.password)
                    
                    # Employee.objects.create(
                    #     user=user,
                    #     company=company,
                    #     user_role_id=1
                    # )
                    endpoint = 'finance/admin_user/'    
                    data = {
                        'password': password,
                        'first_name': user.first_name,
                        'middle_name': user.last_name,
                        'last_name': user.last_name,
                        'email': user.email,
                        'phone_number': user.phone_number,
                        'company_name':  company.reference_id,  
                    }
                    json_data = json.dumps(data)
                    response = call_post_method_for_without_token(BASE_URL, endpoint, json_data)
                    print("@@@@@response+++", response)
                    if response.status_code == 200 or response.status_code == 201:
                        print('Response Status Code:', response.content)
                        user.save()
                    else:
                        print('Failed to create user in finance system.')
                        print('Response Status Code:', response.json())
                    return Response({
                        'company': company_serializer.data,
                        'user': user_serializer.data
                    }, status=status.HTTP_201_CREATED)
                else:
                    # If user creation fails, delete the company
                    company.delete()
                    print('user_serializer.errors---',user_serializer.errors)
                    return Response(
                        {'user_errors': user_serializer.errors},
                        status=status.HTTP_400_BAD_REQUEST
                    )
            
            return Response(company_serializer.data, status=status.HTTP_201_CREATED)
        
        return Response(company_serializer.errors, status=status.HTTP_400_BAD_REQUEST)
    


class UserSubscriptionAPIView(APIView):
    def post(self, request, *args, **kwargs):
        company_id = request.data.get('company')
        
        # Check if company exists (if company_id is valid)
        try:
            company = SchoolRegistration.objects.get(school_id=company_id)
            print('company---',company)
        except SchoolRegistration.DoesNotExist:
            raise NotFound("Company not found.")
        print('========company.pk---',company.pk)
        # Check if UserSubscription already exists for this company
        subscription, created = UserSubscription.objects.update_or_create(
            company_id=company.pk,
            defaults={
                'start_date': request.data.get('start_date'),
                'end_date': request.data.get('end_date'),
                'module': request.data.get('module'),
                'no_of_user_is_limited': request.data.get('no_of_user_is_limited', False),
                'no_of_user_value': request.data.get('no_of_user_value'),
                'is_active': request.data.get('is_active', True),
            }
        )
        
        # Serialize and return response
        serializer = UserSubscriptionSerializer(subscription)
        print('created---',created)
        print('serializer.data---',serializer.data)
        if created:
            return Response(serializer.data, status=status.HTTP_201_CREATED)
        else:
            return Response(serializer.data, status=status.HTTP_200_OK)

def response_message(status, message=None, record_id=None):
    message = {
        'status': status,
        'message': message,
        'record_id': record_id
    }
    return message

class NotifyExpiredview(APIView):
    def get(self, request, *args, **kwargs):
        try:
            records = Notification.objects.filter(branch=branch_id)
            serializer = NotificationSerializer(records, many=True)
            return Response(data=serializer.data, status=status.HTTP_200_OK)
        except Exception as error:
            message = response_message('Failed', message=f"{error}")
            return Response(data=message, status=status.HTTP_400_BAD_REQUEST)
        
    def post(self, request, *args, **kwargs):
        data=request.data.copy()
        print('===data====',data)
        try:
            user=User.objects.get(email=data.get('email'))
            print('user====',user)
            data['user']=user.id
            data['message']=data.get('messages')
            serializer = NotificationSerializer(data=data)
            if serializer.is_valid():
                obj = serializer.save()
                message = response_message('Success', message="Its Success", record_id=obj.pk)
                return Response(data=message, status=status.HTTP_201_CREATED)
            print('serializer.errors===',serializer.errors )
            return Response(data=serializer.errors, status=status.HTTP_400_BAD_REQUEST)
        except Exception as error:
            print('eeeeeeeeeeeeeeeeeeeeeeeeeeee',str(error))
            message = response_message('Failed', message=f"{error}")
            return Response(data=message, status=status.HTTP_400_BAD_REQUEST)


@shared_task(name='sub_part.views.celery_call')
def celery_call():
    print('the server is called')


def signup(request):
    if request.method == "GET":
        form = SignUpForm()
        context = {
            "form": form,
        }
        return render(request, "Auth/SignUp.html", context)
    elif request.method == "POST":
        print("POST data:", request.POST)
        form = SignUpForm(data=request.POST)
        if form.is_valid():
            user = form.save()
            user.set_password(user.password)
            user.save()
            return redirect("signin")
        else:
            context = {
                "form": form,
            }
            return render(request, "Auth/SignUp.html", context)


def signin(request):
    if request.method == "GET":
        # if not request.user.is_authenticated:
        form = AuthenticationForm()
        context = {
            "form": form,
        }
        return render(request, "Auth/SignIn.html", context)
        # else:
        #     return redirect("dashboard")
    if request.method == "POST":
        print('the request post is ',request.POST)
        form = AuthenticationForm(data=request.POST)
        if form.is_valid():
            un = form.cleaned_data["username"]
            pwd = form.cleaned_data["password"]            
            print('un---',un)
            print('pwd---',pwd)
              
            user = authenticate(username=un, password=pwd)
           
            if user is not None:                   
                login(request, user)              
                try: 
                    buyer_name = User.objects.get(id=request.user.id)
                    print('===buyer_name===',buyer_name)
                    buyer_id = buyer_name.buyer_id
                    print('===KKK===',buyer_id)
                    request.session['buyer_id'] = buyer_id
                    print("request.session['buyer_id']",request.session['buyer_id'])
                except ObjectDoesNotExist:
                    request.session['buyer_id']  = None
                try:
                    staff = AddStaff.objects.get(user_id=request.user.id)
                    print("staff---+++",staff.is_admin)
                except ObjectDoesNotExist:
                    staff = None
                if request.user.is_superuser :
                    # admin = User.objects.get(id=request.user.id)
                    # print("admin---",admin.username)    
                    payload = {        
                        "email" : user.email,
                        "password" : pwd
                    }
                    # Convert payload to JSON format
                    json_payload = json.dumps(payload)
                    print("json_payload",json_payload)
                    url = BASE_URL+'/token/'
                    login_response = call_post_method_without_token(url,json_payload)
                    print('login_response---',login_response)    
                    if login_response.status_code != 200:
                        print('login_respojjjjnse',login_response.json())      
                        messages.error(request, 'Invalid username (or) password')
                        return render(request, 'Auth/SignIn.html')  
                    else:
                        print('login_responseelse',login_response.json())
                    package_data = json.dumps({'buyer_id':user.buyer_id})
                    print("package_data===",package_data)
                    package_check = call_post_method_for_without_token(PACKAGE_URL,'package_check/',package_data)
                    print('package_check---staff.is_admin',package_check)
                    

                    # if package_check.status_code == 200 or package_check.status_code ==201:
                    #     print('dddddddd',package_check.json())
                    #     message=package_check.json().get('message')
                    #     print('eeeeeeeeeeeee',message)
                    #     alert_messages=Notification.objects.create(
                    #         user=request.user,
                    #         message=message

                    #     )
                    #     alert_messages.save()
                    # else:
                    #     print('the else is working')
                    #     return redirect('/signout')
                    login_tokes = login_response.json()
                    print('login_tokes',login_tokes)
                    token=request.session['user_token']=login_tokes['access']
                    print('token',token)   
                    return redirect("select_school") 
                               
                elif request.user.is_school_admin :          
                    payload = {        
                        "email" : user.email,
                        "password" : pwd
                    }
                    json_payload = json.dumps(payload)
                    print("json_payload",json_payload)
                    url = BASE_URL+'/token/'
                    login_response = call_post_method_without_token(url,json_payload)
                    print('login_response',login_response)    
                    print("staff---okay",request.user.id)
                    login_tokes = login_response.json()
                    print('login_tokes',login_tokes)
                    token=request.session['user_token']=login_tokes['access']
                    print('token',token)
                    satff = User.objects.get(pk=request.user.id)
                    print('satffschool****',satff.school.id) 
                    print("staff---",request.user.id)
                    package_data = json.dumps({'buyer_id':user.buyer_id})
                    print("package_data===",package_data)
                    package_check = call_post_method_for_without_token(PACKAGE_URL,'package_check/',package_data)
                    print('package_check---staff.is_admin',package_check)
                    if package_check.status_code == 200:
                        if satff.is_school_admin:
                            print("---okay",satff.is_school_admin)
                            message=package_check.json().get('message')  
                            alert_messages=Notification.objects.create(
                            user=request.user,
                            message=message

                            )
                            alert_messages.save()
                            return redirect(f"select_branch/{satff.school.id}") 
                        else: 
                            messages.error(request, 'Invalid username (or) password')
                            return redirect("signin")  
                    elif package_check.status_code == 201:
                        if staff.is_school_admin:
                            print("---okay",staff.is_school_admin)                           
                            school_id = staff.school.id
                            return redirect(f"/warning_page/?redirect_url=/select_branch/{school_id}")
                        else: 
                            messages.error(request, 'Invalid username (or) password')
                            return redirect("signin")
                    elif package_check.status_code == 400:
                        return render(request, "System_setting/pack_expried.html")  
                    else:
                        messages.error(request, 'Unexpected error occurred')
                        print("request.user.staff",request.user.is_school_admin)           
                
                elif request.user.user_type == "Staff" :
                    payload = {        
                        "email" : user.email,
                        "password" : pwd
                    }
                    # Convert payload to JSON format
                    json_payload = json.dumps(payload)
                    print("json_payload",json_payload)
                    url = BASE_URL+'/token/'
                    login_response = call_post_method_without_token(url,json_payload)
                    print('login_response',login_response)    
                    if login_response.status_code != 200:
                        print('login_response',login_response.json())      
                        messages.error(request, 'Invalid username (or) password')
                        return render(request, 'Auth/SignIn.html')     
                    else:
                        print('login_responseelse',login_response.json())
                    login_tokes = login_response.json()
                    print('login_tokes',login_tokes)
                    token=request.session['user_token']=login_tokes['access']
                    print('token',token)    
                    satff = AddStaff.objects.get(user_id=request.user.id)
                    print('satff****',satff.branch.id)
                    print('satffschool****',satff.school.id)
                    request.session['branch_id'] = satff.branch.id
                    print("request.session",request.session['branch_id'])   
                    
                    print("staff---",request.user.id)
                    package_data = json.dumps({'buyer_id':user.buyer_id})
                    print("package_data===",package_data)
                    package_check = call_post_method_for_without_token(PACKAGE_URL,'package_check/',package_data)
                    print('package_check---',package_check)
                    if package_check.status_code == 200:
                        if staff:
                            print("---okay",staff)                                              
                            return redirect("dashboard")    
                        else: 
                            messages.error(request, 'Invalid username (or) password')
                            return redirect("signin")  
                    elif package_check.status_code == 201:
                        if staff:
                            print("---okay",staff)                            
                            return redirect(f"/warning_page?redirect_url=""")
                   
                        else: 
                            messages.error(request, 'Invalid username (or) password')
                            return redirect("signin")
                    elif package_check.status_code == 400:
                        return render(request, "System_setting/pack_expried.html")  
                    else:
                        messages.error(request, 'Unexpected error occurred')
                elif request.user.user_type == "Student":
                    print("staff---",request.user.id)
                    package_data = json.dumps({'buyer_id':user.buyer_id})
                    print("package_data===",package_data)
                    package_check = call_post_method_for_without_token(PACKAGE_URL,'package_check/',package_data)
                    print('package_check---',package_check)
                    print("Student-----",request.Session)
                    print("student.user.id-----",request.user.id)
                    student = StudentAdmission.objects.filter(user_student_id=request.user.id,session=request.Session)
                    print("-----student)))",student)
                    if package_check.status_code == 200:
                        if student.exists():
                            print("-----studentif",student)
                            return redirect("student_dashboard_student")                            
                        else:
                            print("-----else")
                            logout(request)
                            return redirect("signin")       
                    elif package_check.status_code == 201: 
                        if student.exists():
                            print("-----studentelif",student)
                            return redirect(f"/warning_page?redirect_url=/student/student_dashboard")
                        else:
                            print("-----else")
                            logout(request)
                            return redirect("signin")                     
                    elif package_check.status_code == 400:
                        return render(request, "System_setting/pack_expried.html")  
                    else:
                        messages.error(request, 'Unexpected error occurred')                               
                elif request.user.user_type == "Parent":
                    payload = {        
                        "email" : user.email,
                        "password" : pwd
                    }
                    # Convert payload to JSON format
                    json_payload = json.dumps(payload)
                    print("json_payload",json_payload)
                    url = BASE_URL+'/token/'
                    login_response = call_post_method_without_token(url,json_payload)
                    print('login_response',login_response)    
                    if login_response.status_code != 200:
                        print('login_response',login_response.json())      
                        messages.error(request, 'Invalid username (or) password')
                        return render(request, 'Auth/SignIn.html')     
                    else:
                        print('login_responseelse',login_response.json())
                    login_tokes = login_response.json()
                    print('login_tokes',login_tokes)
                    token=request.session['user_token']=login_tokes['access']
                    print('token',token)   
                    print("request.user.id-----",request.Session)
                    
                    print("staff---",request.user.id)
                    package_data = json.dumps({'buyer_id':user.buyer_id})
                    print("package_data===",package_data)
                    package_check = call_post_method_for_without_token(PACKAGE_URL,'package_check/',package_data)
                    print('package_check---',package_check)
                    student = StudentAdmission.objects.filter(user_parent_id=request.user.id,session=request.Session)
                    print('student===',student)    
                    if package_check.status_code == 200:
                        if student.exists():
                            return redirect("parent_dashboard")  
                        else:
                            print("-----else")
                            logout(request)
                            return redirect("signin")  
                    # elif package_check.status_code == 201:
                    #     if student.exists():
                    # return redirect(f"/warning_page?redirect_url=/parent/parent_dashboard") 
                    # return redirect("parent_dashboard") 
                    #     else:
                    #         print("-----else")
                    #         logout(request)
                    #         return redirect("signin")
                    # elif package_check.status_code == 400:
                    #     return render(request, "System_setting/pack_expried.html")  
                    # else:
                    #     messages.error(request, 'Unexpected error occurred')                
                else:
                    messages.error(request, 'Invalid username (or) password')
                    return redirect("signin")
            else:
                print("invalid username and password")
                context = {
                    "form": form,
                    "error": "Invalid Username And Password",
                }
                return render(request, "Auth/SignIn.html", context)
        else:
            print(form.errors)
            messages.error(request, 'Invalid username (or) password')
            context = {
                "form": form,
            }
            return render(request, "Auth/SignIn.html", context)


def signout(request):
    if request.user.is_authenticated:
        logout(request)
        print("Im log out")
        return redirect("signin")
    else:
        return redirect("signin")


# @login_required
# @user_type_required("Staff")
def dashboard(request):
    print("session", request.Session)
    if request.user.is_authenticated:
        branch_name = request.session.get('branch_id', None)
        if branch_name:
            branch_id = branch_name       
        else:
            branch_id = None 
        pending_total_value = request.session.get('total_fees_amount', 0)
        current_month = datetime.now().month
        current_year = datetime.now().year
        five_years = [str(year) for year in range(current_year - 4, current_year + 1)]
        print("five_years",five_years)  
        year_1 = StudentAdmission.objects.filter(admission_date__year=current_year , branch=branch_id )
        year_2 = StudentAdmission.objects.filter(admission_date__year=current_year - 1, branch=branch_id)
        year_3 = StudentAdmission.objects.filter(admission_date__year=current_year - 2, branch=branch_id)
        year_4 = StudentAdmission.objects.filter(admission_date__year=current_year - 3, branch=branch_id)
        year_5 = StudentAdmission.objects.filter(admission_date__year=current_year - 4, branch=branch_id)
        print("year_1",year_1.count())
        print("year_2",year_2.count())
        print("year_3",year_3.count())  
        print("year_4",year_4.count())
        print("year_5",year_5.count())
        month_jun = StudentAdmission.objects.filter(
            admission_date__month=1, admission_date__year=current_year, branch=branch_id
        )
        month_Fab = StudentAdmission.objects.filter(
            admission_date__month=2, admission_date__year=current_year, branch=branch_id
        )
        month_Mar = StudentAdmission.objects.filter(
            admission_date__month=3, admission_date__year=current_year, branch=branch_id
        )
        month_Apr = StudentAdmission.objects.filter(
            admission_date__month=4, admission_date__year=current_year, branch=branch_id
        )
        month_MAY = StudentAdmission.objects.filter(
            admission_date__month=5, admission_date__year=current_year, branch=branch_id
        )
        month_June = StudentAdmission.objects.filter(
            admission_date__month=6, admission_date__year=current_year, branch=branch_id
        )
        month_July = StudentAdmission.objects.filter(
            admission_date__month=7, admission_date__year=current_year, branch=branch_id
        )
        month_Aug = StudentAdmission.objects.filter(
            admission_date__month=8, admission_date__year=current_year, branch=branch_id
        )
        month_Sep = StudentAdmission.objects.filter(
            admission_date__month=9, admission_date__year=current_year, branch=branch_id
        )
        month_oct = StudentAdmission.objects.filter(
            admission_date__month=10, admission_date__year=current_year, branch=branch_id
        )
        month_Nov = StudentAdmission.objects.filter(
            admission_date__month=11, admission_date__year=current_year, branch=branch_id
        )
        month_Dec = StudentAdmission.objects.filter(
            admission_date__month=12, admission_date__year=current_year, branch=branch_id
        )
        total_complaints = Complain.objects.filter(branch=branch_id).count()
        total_students = StudentAdmission.objects.count()
        total_teacher = AddStaff.objects.count()
        current_date = date.today()
        current_datetime = datetime.now()
        current_session = request.Session
        students_fees = (
            StudentFess.objects.filter(
                session=current_session, created_at__month=current_month, branch=branch_id
            ).aggregate(Sum("paid_amount"))["paid_amount__sum"]
            or 0
        )
        students_expenaces = (
            AddExpense.objects.filter(date__year=current_year, branch=branch_id).aggregate(Sum("amount"))[
                "amount__sum"
            ]
            or 0
        )
        library_return = IssueBook.objects.filter(status="Returned", branch=branch_id).count()
        library_complete = IssueBook.objects.filter(status="complete", branch=branch_id).count()
        library_book = AddBook.objects.filter(branch=branch_id).count()
        fees_unpaid = FeesAssign.objects.filter(status="pending", branch=branch_id).count()
        fees_paid = FeesAssign.objects.filter(status="paid", branch=branch_id).count()
        fees_pertial = FeesAssign.objects.filter(status="partially paid", branch=branch_id).count()
        staff_present_today = StaffAttendance.objects.filter(
            attendance_date=current_date, status="present", branch=branch_id
        ).count()
        student_present_total = StudentAttendance.objects.filter(
            attendance_date=current_date, attendance_status="present", branch=branch_id
        ).count()
        student_half_total = StudentAttendance.objects.filter(
            attendance_status="half", branch=branch_id
        ).count()
        student_absent_total = StudentAttendance.objects.filter(
            attendance_status="Absent", branch=branch_id
        ).count()
        student_late_total = StudentAttendance.objects.filter(
            attendance_status="Late", branch=branch_id
        ).count()
        student_present_today = StudentAttendance.objects.filter(
            attendance_status="present", branch=branch_id
        ).count()
        upcoming_events = AlumniEvent.objects.filter(
            event_date_from__year=current_year, branch=branch_id
        ).count()
        current_students = StudentAdmission.objects.filter(
            session=current_session, branch=branch_id
        ).count()
        total_paid_amount = (
            StudentFess.objects.filter(session=current_session, branch=branch_id).aggregate(
                Sum("paid_amount")
            )["paid_amount__sum"]
            or 0
        )
        # total_expense_spent = AddExpense.objects.aggregate(total_expense_spent=models.Sum('amount'))['total_expense_spent'] or 0
        total_expense_spent = (
            AddExpense.objects.aggregate(total_expense_spent=models.Sum("amount"))[
                "total_expense_spent"
            ]
            or 0
        )
        roles = Role.objects.all()
        role_counts = []
        records = EventCalendar.objects.all()
        record = Calendarnofication.objects.all()

        for role in roles:
            count = AddStaff.objects.filter(roles=role, branch=branch_id).count()
            role_counts.append((role, count))

        context = {
            "dashboard": "active",
            "total_complaints": total_complaints,
            "total_students": total_students,
            "total_teacher": total_teacher,
            "staff_present_today": staff_present_today,
            "student_present_today": student_present_today,
            "upcoming_events_count": upcoming_events,
            "total_paid_amount": total_paid_amount,
            "total_expense_spent": total_expense_spent,
            "role_counts": role_counts,
            "records": records,
            "record": record,
            "students_fees": students_fees,
            "students_expenaces": students_expenaces,
            "student_late_total": student_late_total,
            "student_absent_total": student_absent_total,
            "student_present_total": student_present_total,
            "student_half_total": student_half_total,
            "fees_unpaid": fees_unpaid,
            "fees_paid": fees_paid,
            "fees_pertial": fees_pertial,
            "library_return": library_return,
            "library_complete": library_complete,
            "library_book": library_book,
            "current_students": current_students,
            "month_jun": month_jun.count(),
            "month_Fab": month_Fab.count(),
            "month_Mar": month_Mar.count(),
            "month_Apr": month_Apr.count(),
            "month_MAY": month_MAY.count(),
            "month_June": month_June.count(),
            "month_July": month_July.count(),
            "month_Aug": month_Aug.count(),
            "month_Sep": month_Sep.count(),
            "month_oct": month_oct.count(),
            "month_Nov": month_Nov.count(),
            "month_Dec": month_Dec.count(),
            "year_5": year_5.count(),
            "year_4": year_4.count(),
            "year_3": year_3.count(),
            "year_2": year_2.count(),
            "year_1": year_1.count(),
            "pending_total_value":pending_total_value,
            "five_years":five_years
        }

        return render(request, "dashboard.html", context)
    else:
        return redirect("signin")


@login_required
@user_type_required("Staff")
def admission_enquiry(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "admission_enquiry_view" in request.permissions
        or "admission_enquiry_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None    
            print("branch_name@@@",branch_name)
            records = AdmissionEnquiry.objects.filter(branch=branch_id)
            form = AdmissionEnquiryForm()
            if request.method == "POST":
                form = AdmissionEnquiryForm(request.POST)
                if form.is_valid():
                    obj=form.save()       
                    obj.branch_id = branch_id
                    obj.save()           
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/admission_enquiry")
            context = {"form": form, "records": records, "admission_enquiry": "active"}
            return render(request, "Front_Office/admission_enquiry.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def admission_enquiry_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "admission_enquiry_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
            print("branch_name@@@",branch_name)
            records = AdmissionEnquiry.objects.filter(branch=branch_id)
            record = AdmissionEnquiry.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = AdmissionEnquiryForm(instance=record)
            if request.method == "POST":
                form = AdmissionEnquiryForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                        form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/admission_enquiry")
            context = {"form": form, "records": records, "admission_enquiry": "active"}

            return render(request, "Front_Office/admission_enquiry_edit.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def admission_enquiry_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "admission_enquiry_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = AdmissionEnquiry.objects.filter(branch=branch_id)
            record = AdmissionEnquiry.objects.get(id=pk)
            form = AdmissionEnquiryForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "admission_enquiry": "active",
                "view": True,
            }
            return render(request, "Front_Office/admission_enquiry_edit.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def admission_enquiry_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "admission_enquiry_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None    
            print("branch_name@@@",branch_name)
            admission = AdmissionEnquiry.objects.get(id=pk)
            admission_branch_id = admission.branch.id
            if int(admission_branch_id) == int(branch_id):                        
                AdmissionEnquiry.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/admission_enquiry")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")



@login_required
@user_type_required("Staff")
def phone_call_log(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "phone_call_log_view" in request.permissions
        or "phone_call_log_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = PhoneCallLog.objects.filter(branch=branch_id)
            form = PhoneCallLogForm()
            if request.method == "POST":
                print("3")
                form = PhoneCallLogForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/phone_call_log")
                else:
                    print(form.errors)
            context = {"form": form, "records": records, "phone_call_log": "active"}
            return render(request, "Front_Office/phone_call_log.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def phone_call_log_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "phone_call_log_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = PhoneCallLog.objects.filter(branch=branch_id)
            record = PhoneCallLog.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = PhoneCallLogForm(instance=record)            
            if request.method == "POST":
                form = PhoneCallLogForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                    # Save the form with from_scho ol_id
                        form.save()
                    else:
                    # Save the form with the session value
                        form.instance.branch_id = branch_id
                    form.save()               
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/phone_call_log")
            context = {
                "form": form,
                "records": records,
                "phone_call_log": "active",
                "edit": True,
            }
            return render(request, "Front_Office/phone_call_log.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def phone_call_log_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "phone_call_log_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = PhoneCallLog.objects.filter(branch=branch_id)
            record = PhoneCallLog.objects.get(id=pk)
            form = PhoneCallLogForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "phone_call_log": "active",
                "view": True,
            }
            return render(request, "Front_Office/phone_call_log.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def phone_call_log_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "phone_call_log_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            phonecallLog=PhoneCallLog.objects.get(id=pk)
            phone_callLog_branch_id = phonecallLog.branch.id
            if int(phone_callLog_branch_id) == int(branch_id):                        
                PhoneCallLog.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/phone_call_log")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def postal_dispatch(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "postal_dispatch_view" in request.permissions
        or "postal_dispatch_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = PostalDispatch.objects.filter(branch=branch_id)
            form = PostalDispatchForm()
            if request.method == "POST":
                form = PostalDispatchForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/postal_dispatch")
                else:
                    print(form.errors)
            context = {
                "form": form,
                "records": records,
                "postal_dispatch": "active",
            }
            return render(request, "Front_Office/postal_dispatch.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def postal_dispatch_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "postal_dispatch_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = PostalDispatch.objects.filter(branch=branch_id)
            record = PostalDispatch.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = PostalDispatchForm(instance=record)
            if request.method == "POST":
                form = PostalDispatchForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/postal_dispatch")
            context = {
                "form": form,
                "records": records,
                "postal_dispatch": "active",
                "edit": True,
            }
            return render(request, "Front_Office/postal_dispatch.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def postal_dispatch_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "postal_dispatch_view" in request.permissions:
        try:
            records = PostalDispatch.objects.filter(branch=branch_id)
            record = PostalDispatch.objects.get(id=pk)
            form = PostalDispatchForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "postal_dispatch": "active",
                "view": True,
            }
            return render(request, "Front_Office/postal_dispatch.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def postal_dispatch_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "postal_dispatch_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            postal_dispatch=PostalDispatch.objects.get(id=pk)
            postal_branch_id = postal_dispatch.branch.id
            if int(postal_branch_id) == int(branch_id):                        
                PostalDispatch.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/postal_dispatch")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def postal_receive(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "postal_receive_view" in request.permissions
        or "postal_receive_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = PostalReceive.objects.filter(branch=branch_id)
            form = PostalReceiveForm()
            if request.method == "POST":
                print("3")
                form = PostalReceiveForm(request.POST)
                if form.is_valid():                  
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/postal_receive")
                else:
                    print(form.errors)
            context = {"form": form, "records": records, "postal_receive": "active"}
            return render(request, "Front_Office/postal_receive.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def postal_receive_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "postal_receive_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = PostalReceive.objects.filter(branch=branch_id)
            record = PostalReceive.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = PostalReceiveForm(instance=record)
            if request.method == "POST":
                form = PostalReceiveForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/postal_receive")
            context = {
                "form": form,
                "records": records,
                "postal_receive": "active",
                "edit": True,
            }
            return render(request, "Front_Office/postal_receive.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def postal_receive_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "postal_receive_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = PostalReceive.objects.filter(branch=branch_id)
            record = PostalReceive.objects.get(id=pk)
            form = PostalReceiveForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "postal_receive": "active",
                "view": True,
            }
            return render(request, "Front_Office/postal_receive.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def postal_receive_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "postal_receive_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            postal_receive=PostalReceive.objects.get(id=pk)
            postal_branch_id = postal_receive.branch.id
            if int(postal_branch_id) == int(branch_id):                        
                PostalReceive.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/postal_receive")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def complain(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "complain_view" in request.permissions
        or "complain_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Complain.objects.filter(branch=branch_id)
            form = ComplainForm()
            if request.method == "POST":
                form = ComplainForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/complain")
                else:
                    print(form.errors)
            context = {
                "form": form,
                "records": records,
                "complain": "active",
            }
            return render(request, "Front_Office/complain.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def complain_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "complain_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Complain.objects.filter(branch=branch_id)
            record = Complain.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = ComplainForm(instance=record)
            if request.method == "POST":
                form = ComplainForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/complain")
            context = {
                "form": form,
                "records": records,
                "complain": "active",
                "edit": True,
            }
            return render(request, "Front_Office/complain.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def complain_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "complain_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Complain.objects.filter(branch=branch_id)
            record = Complain.objects.get(id=pk)
            form = ComplainForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "complain": "active",
                "view": True,
            }
            return render(request, "Front_Office/complain.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def complain_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "complain_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            complain_sch_id=Complain.objects.get(id=pk)
            complain_branch_id = complain_sch_id.branch.id
            if int(complain_branch_id) == int(branch_id):                        
                Complain.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/complain")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def setup_front_office_purpose(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "setup_front_office_view" in request.permissions
        or "setup_front_office_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Purpose.objects.filter(branch=branch_id)
            form = PurposeForm()
            if request.method == "POST":
                form = PurposeForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/setup_front_office_purpose")
                else:
                    print(form.errors)
            context = {
                "form": form,
                "records": records,
                "setup_front_office_purpose": "active",
            }
            return render(
                request, "Front_Office/setup_front_office_purpose.html", context
            )
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def setup_front_office_purpose_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "setup_front_office_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Purpose.objects.filter(branch=branch_id)
            record = Purpose.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = PurposeForm(instance=record)
            if request.method == "POST":
                form = PurposeForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/setup_front_office_purpose")
            context = {
                "form": form,
                "records": records,
                "setup_front_office_purpose": "active",
                "edit": True,
            }
            return render(
                request, "Front_Office/setup_front_office_purpose.html", context
            )
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def setup_front_office_purpose_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "setup_front_office_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            purpose=Purpose.objects.get(id=pk)
            purpose_branch_id = purpose.branch.id
            if int(purpose_branch_id) == int(branch_id):                        
                Purpose.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/setup_front_office_purpose")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def setup_front_office_complain_type(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "setup_front_office_view" in request.permissions
        or "setup_front_office_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = ComplainType.objects.filter(branch=branch_id)
            form = ComplainTypeForm()
            if request.method == "POST":
                form = ComplainTypeForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()
                    return HttpResponseRedirect("/setup_front_office_complain_type")
                else:
                    print(form.errors)
            context = {
                "form": form,
                "records": records,
                "setup_front_office_purpose": "active",
                "view": True,
            }
            return render(
                request, "Front_Office/setup_front_office_complain_type.html", context
            )
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def setup_front_office_complain_type_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "setup_front_office_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = ComplainType.objects.filter(branch=branch_id)
            record = ComplainType.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = ComplainTypeForm(instance=record)
            if request.method == "POST":
                form = ComplainTypeForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    return HttpResponseRedirect("/setup_front_office_complain_type")
            context = {
                "form": form,
                "records": records,
                "setup_front_office_purpose": "active",
            }
            return render(
                request,
                "Front_Office/setup_front_office_complain_type_edit.html",
                context,
            )
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def setup_front_office_complain_type_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "setup_front_office_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            complain_type=ComplainType.objects.get(id=pk)
            complain_type_branch_id = complain_type.branch.id
            if int(complain_type_branch_id) == int(branch_id):                        
                ComplainType.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            return HttpResponseRedirect("/setup_front_office_complain_type")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def setup_front_office_source(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "setup_front_office_view" in request.permissions
        or "setup_front_office_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Source.objects.filter(branch=branch_id)
            form = SourceForm()
            if request.method == "POST":
                form = SourceForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()
                    return HttpResponseRedirect("/setup_front_office_source")
                else:
                    print(form.errors)
            context = {
                "form": form,
                "records": records,
                "setup_front_office_purpose": "active",
                "view": True,
            }
            return render(
                request, "Front_Office/setup_front_office_source.html", context
            )
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def setup_front_office_source_edit(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "setup_front_office_view" in request.permissions
        or "setup_front_office_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Source.objects.filter(branch=branch_id)
            record = Source.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = SourceForm(instance=record)
            if request.method == "POST":
                form = SourceForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    return HttpResponseRedirect("/setup_front_office_source")
            context = {"form": form, "records": records, "setup_front_office_purpose": "active"}
            return render(request, "Front_Office/setup_front_office_source_edit.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def setup_front_office_source_delete(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "setup_front_office_view" in request.permissions
        or "setup_front_office_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            source=Source.objects.get(id=pk)
            source_branch_id = source.branch.id
            if int(source_branch_id) == int(branch_id):                        
                Source.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            return HttpResponseRedirect("/setup_front_office_source")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


def setup_front_office_reference(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "setup_front_office_view" in request.permissions
        or "setup_front_office_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Reference.objects.filter(branch=branch_id)
            form = ReferenceForm()
            if request.method == "POST":
                form = ReferenceForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()
                    return HttpResponseRedirect("/setup_front_office_reference")
                else:
                    print(form.errors)
            context = {
                "form": form,
                "records": records,
                "setup_front_office_purpose": "active",
                "view": True,
            }
            return render(request, "Front_Office/setup_front_office_reference.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def setup_front_office_reference_edit(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "setup_front_office_view" in request.permissions
        or "setup_front_office_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Reference.objects.filter(branch=branch_id)
            record = Reference.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = ReferenceForm(instance=record)
            if request.method == "POST":
                form = ReferenceForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    return HttpResponseRedirect("/setup_front_office_reference")
            context = {"form": form, "records": records, "setup_front_office_purpose": "active"}
            return render(
                request, "Front_Office/setup_front_office_reference_edit.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def setup_front_office_reference_delete(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "setup_front_office_view" in request.permissions
        or "setup_front_office_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            reference=Reference.objects.get(id=pk)
            reference_branch_id = reference.branch.id
            if int(reference_branch_id) == int(branch_id):                        
                Reference.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            return HttpResponseRedirect("/setup_front_office_reference")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def student_details(request):
    # if request.user.is_superuser or request.user.is_school_admin or "student_information_view" in request.permissions:
    #     try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
                print("branch_id",branch_id)
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            class_records = Class.objects.filter(branch=branch_id)
            print("class_records",class_records)
            if request.method == "POST":
                classs = request.POST.get("class")
                section = request.POST.get("section")
                if classs and section:
                    records = StudentAdmission.objects.filter(
                        Class_id=classs, section_id=section, session=request.Session,branch_id=branch_id
                    )   
                    # for data in records:
                    #     guardian=StudentGuardianDetails.objects.filter(student=data)
                    #     print("guardian--1",guardian)
                elif classs:
                    records = StudentAdmission.objects.filter(
                        Class_id=classs, session=request.Session,branch_id=branch_id
                    )
                    # guardian=StudentGuardianDetails.objects.filter(student=records)
                elif section:
                    records = StudentAdmission.objects.filter(
                        section_id=section, session=request.Session,branch_id=branch_id
                    )
                    # guardian=StudentGuardianDetails.objects.filter(student=records)
                print("records111",records)
                context = {
                    "student_details": "active",
                    "records": records,
                    "class_records": class_records,
      
                }
                return render(
                    request, "Student_information/student_details.html", context
                )
            context = {
                "student_details": "active",
                "class_records": class_records,
            }
            return render(request, "Student_information/student_details.html", context)
    #     except Exception as error:
    #         return render(request, "error.html", {"error": error})
    # else:
    #     return redirect("dashboard")


# Assuming you have a Session model in sub_part.models
from sub_part.models import Session

def unique_admission_no_id(prefix, queryset):
    # Get the current year
    current_year = datetime.now().year
    
    # Find the last record ID and calculate the next sequence number
    if queryset.last():
        next_seq = queryset.last().id + 1
    else:
        next_seq = 1
    
    # Ensure the sequence number is 4 digits with leading zeros
    seq_str = f"{next_seq:04d}"
    
    # Combine prefix, year, and sequence
    admission_no = f"{prefix}{current_year}{seq_str}"
    
    return admission_no


@login_required
@user_type_required("Staff")
def student_admission(request):
    if request.user.is_superuser or request.user.is_school_admin or "student_information_add" in request.permissions:
        # try:
            token = request.session['user_token']
            branch_name = request.session.get('branch_id', None)
            buyer_name = request.session.get('buyer_id', None)
            print("buyer_name---",buyer_name)
            if buyer_name:
                buyer_id = buyer_name
            else:
                buyer_id = None  
                print("branch_name@@@",branch_name) 
            if branch_name:
                branch_id = branch_name
            endpoint = 'finance/user/'
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            system_fields = SystemFields.objects.filter(branch=branch_id)
            guardian_master = GuardianMaster.objects.filter(branch=branch_id)
            system_field = (
                system_fields.last().student_fields if system_fields.last() else None
            )
            custom_fields = CustomFields.objects.filter(field_belongs_to="Student",branch_id=branch_id)
            records = StudentAdmission.objects.filter(branch=branch_id)
            obj=''            
            student_account = create_student_account(obj)   
            print("student_account",student_account)         
            # id = unique_admission_no_id('ADM',records)
            form = StudentAdmissionForm(branch=branch_id)
            print('the barijakhaskddhuiyoj ',request.user.school.id)
            if request.method == "POST":  
                user_student = None
                user_parent = None
      
                names_list=request.POST.getlist("name")
                if names_list:
                    guardian_name = names_list[0]
                
                email_list = request.POST.getlist("guardian_email")

                if email_list:
                    guardian_email = email_list[0] if email_list else None
                    print('gamil_---11111', guardian_email)     

                student_healths=request.POST.get("student_health")
                print('student_healths',student_healths)
                suspended_or_nots= request.POST.get("suspended_or_not")
                print('suspended_or_nots',suspended_or_nots)
                is_suspension_resolveds= request.POST.get("is_suspension_resolved")
                print('is_suspension_resolveds',is_suspension_resolveds)
                form = StudentAdmissionForm(request.POST)
                if form.is_valid():                
                    obj = form.save(commit=False)                    
                    obj.student_health = student_healths
                    obj.suspended_or_not = suspended_or_nots
                    obj.is_suspension_resolved = is_suspension_resolveds
                    obj.branch_id = branch_id
                    obj.save() 
                    password_student = generate_password()
                    password_parent = generate_password()
                  
                    last_name = form.cleaned_data["last_name"] or ""

                    # Create a user account for the student
                    first_name=form.cleaned_data["first_name"]
                    username_student = f"student{first_name[0]}{records.count()}"
                    print("username_student---",username_student)

                    branch = Branch.objects.get(id=branch_id)
                    print("branch+++", branch.school.reference_id)  
                    user_student = User.objects.create_user(
                        username=username_student,
                        first_name=form.cleaned_data["first_name"],
                        last_name=last_name,
                        email=form.cleaned_data["email"],
                        password=password_student,
                        user_type="Student",
                        buyer_id = buyer_id,
                        school=branch.school
                    )
                    user_student.save()
                              

                    data = {
                        'password': password_student,
                        'first_name': username_student,
                        'middle_name': form.cleaned_data["last_name"],
                        'last_name': form.cleaned_data["last_name"],
                        'email': form.cleaned_data["email"],
                        'phone_number': form.cleaned_data["mobile_number"],
                        'company_name': branch.school.reference_id,  # Serializing the id
                        'branch_name': branch.reference_id  # Serializing the id
                    }
                    # input_params_values = {
                    #     "student_name":username_student,
                    #     "roll_no":roll_no,
                    # }
                    print("++++++++++++++++++")
                   
                    json_data = json.dumps(data)
                    print("=========", json_data)

                    response = call_post_method(BASE_URL, endpoint, json_data, token)
                    print("response+++", response)
                    if response.status_code != 200:
                        print('Response Status Code:', response.content)
                    # Create a user account for the parent
                    # if guardian_name:
                    #     username_parent = f"parent{guardian_name[0]}{records.count()}"
                    # else:
                    #     username_parent = f"parent{records.count()}"
                    if guardian_email:
                        user_parent = User.objects.create_user(
                            username=guardian_email,
                            first_name=guardian_name if guardian_name else "Parent",
                            email=guardian_email,
                            password=password_parent,
                            user_type="Parent",
                            buyer_id = buyer_id,
                            school=branch.school
                        )
                        user_parent.save()
                    else:
                        print("No guardian email provided.")
                    
                    # Send an email to the student
                    recipient_name_student = obj.first_name
                    recipient_email_student = form.cleaned_data["email"]
                    new_staff_account_email(
                        recipient_name_student,
                        recipient_email_student,
                        password_student,
                    )

                    # Send an email to the parent
                    recipient_name_parent = guardian_name
                    print('recipient_name_parent',recipient_name_parent)
                    recipient_email_parent = guardian_email
                    print('recipient_email_parent',recipient_email_parent)
                    new_staff_account_email(
                        recipient_name_parent, recipient_email_parent, password_parent
                    )

                    # Create StudentAdmission instance
                    obj.session = request.Session
                    obj.user_student_id = user_student.pk
                    if user_parent or None:   
                        obj.user_parent_id = user_parent.pk
                    else:
                        print("User creation failed or missing required user instance,user_parent")
                    obj.account = student_account
                    obj.created_by = request.user
                    obj.save()
                    
                    stduent_main_record = StudentMain.objects.create(
                        admission_no=obj.admission_no,
                        roll_number=obj.roll_number,
                        account=obj.account,
                        first_name=obj.first_name,
                        last_name=obj.last_name,
                        gender=obj.gender,
                        date_of_birth=obj.date_of_birth,
                        category=obj.category,
                        religion=obj.religion,
                        Caste=getattr(obj, 'Caste', None),
                        mobile_number=obj.mobile_number,
                        email=obj.email,
                        admission_date=obj.admission_date,
                        student_photo=obj.student_photo,
                        Blood_group=getattr(obj, 'Blood_group', None),
                        height=obj.height,
                        weight=obj.weight,
                        as_on_date=obj.as_on_date,
                        bank_account_number=obj.bank_account_number,
                        bank_name=obj.bank_name,
                        ifsc_code=obj.ifsc_code,
                        national_identification_number=obj.national_identification_number,
                        local_identification_number=obj.local_identification_number,
                        rte=obj.rte,
                        previous_school_detail=obj.previous_school_detail,
                        note=obj.note,
                        title_1=obj.title_1,
                        documents_1=obj.documents_1,
                        title_2=obj.title_2,
                        documents_2=obj.documents_2,
                        title_3=obj.title_3,
                        documents_3=obj.documents_3,
                        title_4=obj.title_4,
                        documents_4=obj.documents_4,
                        disable_date=obj.disable_date,
                        diable_reson=obj.diable_reson,
                        disable_note=obj.disable_note,
                        status=obj.status,
                        user_student=obj.user_student,
                        user_parent=obj.user_parent,
                        created_by=obj.created_by,
                        created_at=obj.created_at,
                        student_health=obj.student_health,
                        student_health_description=obj.student_health_description,
                        name_of_last_school=obj.name_of_last_school,
                        leaving_last_school_reason=obj.leaving_last_school_reason,
                        grade_completed=obj.grade_completed,
                        suspended_or_not=obj.suspended_or_not,
                        is_suspension_resolved=obj.is_suspension_resolved,
                        suspension_reason=obj.suspension_reason,
                        county=obj.county,
                        sub_county=obj.sub_county,
                        ward=obj.ward,
                        branch=obj.branch,
                        source=obj.source,
                        vehicle_number=obj.vehicle_number,
                        route_list=obj.route_list,
                        hostel=obj.hostel,
                    )
                    print("stduent_main+++",stduent_main_record)                                        
                    student_admission_update = StudentAdmission.objects.get(id = obj.pk)  
                    print("student_admission+++",student_admission_update)                                       
                    student_admission_update.student_main = stduent_main_record
                    student_admission_update.save()
                    print("request.Session+++",request.Session)
                    short_description=f"{stduent_main_record.first_name} vault"
                    vault=account_creation_finance(stduent_main_record.pk,short_description)
                    print('vault',vault)
                    StudentVaultAmount.objects.create(
                        student=stduent_main_record,
                        total_amount=0,
                        paid_amount=0,
                        balance_amount=0,
                        session=request.Session,
                        created_by=request.user,
                        branch_id=branch_id
                    )
                    # Check if the session exists, create if not
                    
                    LoginCredentials.objects.create(
                        student_id=obj.pk,
                        student_username=username_student,
                        student_password=password_student,
                        parent_username=guardian_email,
                        parent_passwod=password_parent,
                        branch_id=branch_id
                    )
                    StudentSession.objects.create(
                        session=request.Session,
                        student_id=obj.pk,
                        status="Active",
                        branch_id = branch_id
                    )
                    StudentClass.objects.create(
                        session=request.Session,
                        student_id=obj.pk,
                        Class_id=request.POST.get("Class"),
                        section_id=request.POST.get("section"),
                        status="Active",
                        branch_id = branch_id
                    )    
                    if guardian_email :
                        guardianmaster_id=request.POST.getlist("guardianmaster_id")
                        names_list=request.POST.getlist("name")
                        phone_list=request.POST.getlist("phone")
                        eamil_list=request.POST.getlist("guardian_email")
                        occupation_list=request.POST.getlist("occupation")
                        branch = Branch.objects.get(id=branch_id)
                        print("branch+++", branch.school.reference_id) 
                        for i in range(len(names_list)):
                            
                            data = {
                                'password': password_parent,
                                'first_name': names_list[i],
                                'middle_name': form.cleaned_data["last_name"],
                                'last_name': form.cleaned_data["last_name"],
                                'email': eamil_list[i],
                                'phone_number': phone_list[i],
                                'company_name': branch.school.reference_id,  
                                'branch_name': branch.reference_id  
                            }
                            print("++++++++++++++++++")

                            json_data = json.dumps(data)
                            print("=========", json_data)

                            response = call_post_method(BASE_URL, endpoint, json_data,token)
                            print("response+++", response)
                            if response.status_code != 200:
                                print('Response Status Code:', response.content)  
        
                            StudentGuardianDetails.objects.get_or_create(
                                student_id=obj.id,
                                guardianmaster_id=int(guardianmaster_id[i]),
                                name=names_list[i],
                                phone=phone_list[i],
                                guardian_email=eamil_list[i],
                                occupation=occupation_list[i],
                                branch_id = branch_id
                            )  
                                   

                       

                    # customs fields
                    for data in custom_fields:
                        if data.field_type == "multiselect":
                            value = request.POST.getlist(f"{data.field_name}")
                        else:
                            value = request.POST.get(f"{data.field_name}")
                        if value:
                            StudentCustomFieldValues.objects.create(
                                field=data, student_id=obj.pk, value=value,
                                branch_id = branch_id
                            )

                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/student_admission")

                else:
                    print(form.errors)

            context = {
                "form": form,
                "records": records,
                "student_admission": "active",
                "student_account": student_account,
                "view": True,
                "custom_fields": custom_fields,
                "system_fields": system_field,
                'guardian_master':guardian_master
            }
            return render(
                request, "Student_information/student_admission.html", context
            )
        # except Exception as error:
        #     return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def online_admission(request):
    context = {"online_admission": "active"}
    return render(request, "Student_information/online_admission.html", context)


@login_required
@user_type_required("Staff")
def disabled_students(request):
    if request.user.is_superuser or request.user.is_school_admin or "disble_student_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            class_records = Class.objects.filter(branch=branch_id)
            section_records = Section.objects.filter(branch=branch_id)
            if request.method == "POST":
                classs = request.POST.get("class")
                section = request.POST.get("section")
                print(classs, section)
                if classs and section:
                    records = StudentAdmission.objects.filter(
                        Class_id=classs,
                        section_id=section,
                        status="Disable",
                        session=request.Session,
                        branch_id = branch_id
                    )
                    
                elif classs:
                    records = StudentAdmission.objects.filter(
                        Class_id=classs, status="Disable", session=request.Session,branch_id = branch_id
                    )
                elif section:
                    records = StudentAdmission.objects.filter(
                        section_id=section, status="Disable", session=request.Session,branch_id = branch_id
                    )
                context = {
                    "disabled_students": "active",
                    "records": records,
                    "class_records": class_records,
                    "section_records": section_records,
                }
                return render(
                    request, "Student_information/disabled_students.html", context
                )
            context = {
                "disabled_students": "active",
                "class_records": class_records,
                "section_records": section_records,
            }
            return render(
                request, "Student_information/disabled_students.html", context
            )
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def multi_class_student(request):
    context = {"multi_class_student": "active"}
    return render(request, "Student_information/multi_class_student.html", context)


@login_required
@user_type_required("Staff")
def bulk_delete(request):
    if request.user.is_superuser or request.user.is_school_admin or "student_information_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            class_records = Class.objects.filter(branch=branch_id)
            section_records = Section.objects.filter(branch=branch_id)
            if request.POST.get("search") == "search":
                classs = request.POST.get("class")
                section = request.POST.get("section")
                print(classs, section)
                if classs and section:
                    records = StudentAdmission.objects.filter(
                        Class_id=classs, section_id=section, session=request.Session,branch_id = branch_id
                    )
                elif classs:
                    records = StudentAdmission.objects.filter(
                        Class_id=classs, session=request.Session,branch_id = branch_id
                    )
                elif section:
                    records = StudentAdmission.objects.filter(
                        section_id=section, session=request.Session,branch_id = branch_id
                    )
                context = {
                    "bulk_delete": "active",
                    "records": records,
                    "class_records": class_records,
                    "section_records": section_records,
                }
                return render(request, "Student_information/bulk_delete.html", context)
            if request.POST.get("delete") == "delete":
                check_list = request.POST.getlist("check")
                StudentAdmission.objects.filter(id__in=check_list).delete()

            context = {
                "bulk_delete": "active",
                "class_records": class_records,
                "section_records": section_records,
            }
            return render(request, "Student_information/bulk_delete.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def student_category(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "student_categories_view" in request.permissions
        or "student_categories_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            print("branch_name@@@",branch_name)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = StudentCategory.objects.filter(branch=branch_id)
            form = StudentCategoryForm()
            if request.method == "POST":
                form = StudentCategoryForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/student_category")
                else:
                    print(form.errors)
            context = {"form": form, "records": records, "student_category": "active"}
            return render(request, "Student_information/student_category.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def student_category_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "student_categories_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = StudentCategory.objects.filter(branch=branch_id)
            record = StudentCategory.objects.get(id=pk)
            data_school_id = record.branch.id

            form = StudentCategoryForm(instance=record)
            if request.method == "POST":
                form = StudentCategoryForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_school_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/student_category")
            context = {

                "form": form,
                "records": records,
                "student_category": "active",
                "edit": True,
            }
            return render(request, "Student_information/student_category.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def student_category_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "student_categories_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = StudentCategory.objects.filter(branch=branch_id)
            record = StudentCategory.objects.get(id=pk)
            form = StudentCategoryForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "student_category": "active",
                "view": True,
            }
            return render(request, "Student_information/student_category.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


def student_category_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "student_categories_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            student_cat=StudentCategory.objects.get(id=pk)
            student_cat_school_id = student_cat.branch.id
            if int(student_cat_school_id) == int(branch_id):                        
                StudentCategory.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/student_category")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def student_house(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "student_house_view" in request.permissions
        or "student_house_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = StudentHouse.objects.filter(branch=branch_id)
            form = StudentHouseForm()
            if request.method == "POST":
                form = StudentHouseForm(request.POST)
                if form.is_valid():
                    form.save()
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/student_house")
                else:
                    print(form.errors)
            context = {
                "form": form,
                "records": records,
                "student_house": "active",
            }
            return render(request, "Student_information/student_house.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def student_house_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "student_house_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = StudentHouse.objects.filter(branch=branch_id)
            record = StudentHouse.objects.get(id=pk)
            form = StudentHouseForm(instance=record)
            if request.method == "POST":
                form = StudentHouseForm(request.POST, instance=record)
                if form.is_valid():
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/student_house")
            context = {
                "form": form,
                "records": records,
                "student_house": "active",
                "edit": True,
            }
            return render(request, "Student_information/student_house.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def student_house_view(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "student_house_view" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = StudentHouse.objects.filter(branch=branch_id)
            record = StudentHouse.objects.get(id=pk)
            form = StudentHouseForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "student_house": "active",
                "view": True,
            }
            return render(request, "Student_information/student_house.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def student_house_delete(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "student_house_delete" in request.permissions
        or request.permissions
    ):
        try:
            StudentHouse.objects.get(id=pk).delete()
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/student_house")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def disabled_reason(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "disable_student_view" in request.permissions
        or "disable_student_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = DisableReason.objects.filter(branch=branch_id)
            form = DisableReasonForm()
            if request.method == "POST":
                form = DisableReasonForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/disabled_reason")
                else:
                    print(form.errors)
            context = {
                "form": form,
                "records": records,
                "disabled_reason": "active",
            }
            return render(request, "Student_information/disabled_reason.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def disabled_reason_edit(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "disable_student_edit" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = DisableReason.objects.filter(branch=branch_id)
            record = DisableReason.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = DisableReasonForm(instance=record)
            if request.method == "POST":
                form = StudentHouseForm(request.POST, instance=record)
                if form.is_valid():                  
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/disabled_reason")
            context = {
                "form": form,
                "records": records,
                "disabled_reason": "active",
                "edit": True,
            }
            return render(request, "Student_information/disabled_reason.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def disabled_reason_view(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "disable_student_view" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = DisableReason.objects.filter(branch=branch_id)
            record = DisableReason.objects.get(id=pk)
            form = DisableReasonForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "disabled_reason": "active",
                "view": True,
            }
            return render(request, "Student_information/disabled_reason.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def disabled_reason_delete(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "disable_student_delete" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            disable=DisableReason.objects.get(id=pk)
            disable_branch_id = disable.branch.id
            if int(disable_branch_id) == int(branch_id):                        
                DisableReason.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/disabled_reason")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


## Income
@login_required
@user_type_required("Staff")
def add_income(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "income_view" in request.permissions
        or "income_add" in request.permissions
    ):
        
        try:
            token = request.session['user_token']
            endpoint = 'finance/transaction-type/'
            endpoint_transaction = 'finance/all-transaction/'
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = AddIncome.objects.filter(branch=branch_id)
            form = AddIncomeForm()
            # Get user_id from the current user
            user_id = request.user.id

            # Assuming User model has a ForeignKey to School
            user_school = request.user.school

            # Get the school account associated with the user's school
            # school_account = user_school.account
            if request.method == "POST":
                form = AddIncomeForm(request.POST)
                if form.is_valid():
                    # response = call_get_method(BASE_URL, endpoint, token)
                    # transaction_data = response.json()
                    # print("transaction_data", transaction_data)
                    # transaction_list = [{'name': item['name'], 'transaction_type_id': item['transaction_type_id']} for item in transaction_data]

                    # print("transaction_list", transaction_list)
                    # payroll_transaction = next((transaction for transaction in transaction_list if transaction['name'] == 'Payroll'), None)
                    # if payroll_transaction:
                    #     transaction_name = payroll_transaction['name']
                    #     transaction_type_id = payroll_transaction['transaction_type_id']
                    #     print("Transaction Name:", transaction_name)
                    #     print("Transaction Type ID:", transaction_type_id)
                    # else:
                    #     print("No 'Payroll' transaction found.")
                    # if response.status_code != 200:
                    #     return render(request, 'error500.html', {'error': str(response.json())})
                            

                    # if request.method == "POST":
                    #     expence_amount=form.cleaned_data["amount"]
                    #     branch = Branch.objects.get(id=branch_id)
                    #     print("branch+++", branch.school.reference_id) 
                        
                      
                    #     student_information = {
                    #         "student_name": f"{form.cleaned_data.get('name')}",
                    #         "roll_no": f"{form.cleaned_data.get('invoice_number')}"
                    #     }

                        # converting student_information to JSON format
                        # student_information_json = json.dumps(student_information)
                        # print("++++tudent",type(student_information_json))

                        # using it in the data dictionary
                    # data = {
                    #     'transaction_type_id': str(transaction_type_id),
                    #     'company_id': str(branch.school.reference_id),
                    #     'amount': int(expence_amount),
                    #     'input_params_values': student_information 
                    # }
                    # print("++++++++++++++++++",type(data))

                    # json_data = json.dumps(data)
                    # print("=========", type(json_data))

                    # response = call_post_method(BASE_URL, endpoint_transaction, json_data, token)
                    # print("response+++", response)
                    # if response.status_code != 200:
                    #     print('Response Status Code:', response.content)
                    # response_data = json.loads(response.content.decode('utf-8')) 
                    # transaction_id=response_data['record_id']    
                    # print("transaction_id",transaction_id)
                    # Transaction.objects.create(
                    #     student_id=None,
                    #     reference_id=transaction_id,                   
                    #     branch_id = branch_id
                    # )
                    income_instance = form.save()
                    income_instance.branch_id = branch_id
                    income_instance.save()

                    # Call collect_income function
                    # success = collect_income(income_instance, user_id)
                    success = True
                    if success:
                        messages.success(request, "Record Saved Successfully")
                    else:
                        messages.error(request, "Failed to process the income")
                    return HttpResponseRedirect("/add_income")
                else:
                    print(form.errors)
            context = {"form": form, "records": records, "add_income": "active"}
            return render(request, "Income/add_income.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


# Expense
# Expense
# @login_required
# @user_type_required("Staff")
# def add_expense(request):
#     if (
#         request.user.is_superuser or request.user.is_school_admin
#         or "expense_view" in request.permissions
#         or "expense_add" in request.permissions
#         or request.permissions
#     ):
#         # try:
#             records = AddExpense.objects.filter(branch=branch_id)
#             form = AddExpenseForm()

#             # Get user_id from the current user
#             user_id = request.user.id

#             # Assuming User model has a ForeignKey to School
#             # user_school = request.user.school

#             # Get the school account associated with the user's school
#             # school_account = user_school.account

#             if request.method == "POST":
#                 form = AddExpenseForm(request.POST, request.FILES)
#                 if form.is_valid():
#                     expense_instance = form.save()

#                     # Call collect_expense function with user_id
#                     # success = collect_expense(expense_instance, user_id)
#                     success =True
#                     if success:
#                         messages.success(request, "Record Saved Successfully")
#                     else:
#                         messages.error(request, "Failed to process the expense")
#                     return HttpResponseRedirect("/add_expense")
#                 else:
#                     print(form.errors)

#             context = {"form": form, "records": records, "add_expense": "active"}
#             return render(request, "Expenses/add_expense.html", context)
#         # except Exception as error:
#         #     return render(request, "error.html", {"error": error})
#     else:
#         return redirect("dashboard")


@login_required
@user_type_required("Staff")
def add_income_edit(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "income_edit" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = AddIncome.objects.filter(branch=branch_id)
            record = AddIncome.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = AddIncomeForm(instance=record)
            if request.method == "POST":
                form = StudentHouseForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/add_income")
            context = {
                "form": form,
                "records": records,
                "add_income": "active",
                "edit": True,
            }
            return render(request, "Income/add_income.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def add_income_view(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "income_view" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = AddIncome.objects.filter(branch=branch_id)
            record = AddIncome.objects.get(id=pk)
            form = AddIncomeForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "add_income": "active",
                "view": True,
            }
            return render(request, "Income/add_income.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def add_income_delete(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "income_delete" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            add_income=AddIncome.objects.get(id=pk)
            add_income_branch_id = add_income.branch.id
            if int(add_income_branch_id) == int(branch_id):                        
                AddIncome.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/add_income")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def edit_income(request):
    form = AddIncomeForm()
    context = {
        "form": form,
    }
    return render(request, "Income/edit_income.html", context)


@login_required
@user_type_required("Staff")
def search_income(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "search_income_view" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            if request.method == "POST":
                from_date = request.POST.get("from_date")
                to_date = request.POST.get("to_date")

                filters = {}
                if from_date and to_date:
                    filters["date__range"] = [from_date, to_date]
                elif from_date:
                    filters["date__gte"] = from_date
                elif to_date:
                    filters["date__lte"] = to_date
                elif branch_id:
                    filters["branch_id"] = branch_id

                records = AddIncome.objects.filter(**filters)
                context = {
                    "search_income": "active",
                    "records": records,
                }
                return render(request, "Income/search_income.html", context)
            context = {
                "search_income": "active",
            }
            return render(request, "Income/search_income.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def income_head(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "income_head_view" in request.permissions
        or "income_head_add" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Incomehead.objects.filter(branch=branch_id)
            form = IncomeheadForm()
            if request.method == "POST":
                form = IncomeheadForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/income_head")
                else:
                    print(form.errors)
            context = {"form": form, "records": records, "income_head": "active"}
            return render(request, "Income/income_head.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def income_head_edit(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "income_head_edit" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)

            records = Incomehead.objects.filter(branch=branch_id)
            record = Incomehead.objects.get(id=pk)
            record_branch_id = record.branch.id
            form = IncomeheadForm(instance=record)
            if request.method == "POST":
                form = IncomeheadForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == record_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/income_head")
            context = {
                "form": form,
                "records": records,
                "income_head": "active",
                "edit": True,
            }
            return render(request, "Income/income_head.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def income_head_view(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "income_head_view" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Incomehead.objects.filter(branch=branch_id)
            record = Incomehead.objects.get(id=pk)
            form = IncomeheadForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "income_head": "active",
                "view": True,
            }
            return render(request, "Income/income_head.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def income_head_delete(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "income_head_delete" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            incomehead=Incomehead.objects.get(id=pk)
            incomehead_branch_id = incomehead.branch.id
            if int(incomehead_branch_id) == int(branch_id):                        
                Incomehead.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/income_head")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def edit_income_head(request):
    form = AddIncomeForm()
    context = {
        "form": form,
    }
    return render(request, "Income/edit_income_head.html", context)


# accounts
# Gl LIne
@login_required
@user_type_required("Staff")
def add_gline(request):
    try:
        # Permission checks
        if (
            request.user.is_superuser or request.user.is_school_admin
            or "add_gline" in request.permissions
            or request.permissions
        ):
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            glines = GLLine.objects.filter(branch=branch_id)
            form = GLLineForm()

            if request.method == "POST":
                form = GLLineForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()        
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/add_gline")

            context = {"form": form, "glines": glines}
            return render(request, "Accounts/add_gline.html", context)
        else:
            return render(request, "error.html")
    except Exception as error:
        return render(request, "error.html", {"error": error})
   


@login_required
@user_type_required("Staff")
def view_gline(request):
    try:
        # Permission checks
        if (
            request.user.is_superuser or request.user.is_school_admin
            or "view_gline" in request.permissions
            or request.permissions
        ):
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            glines = GLLine.objects.filter(branch=branch_id)
            context = {"glines": glines}
            return render(request, "Accounts/view_gline.html", context)
    except Exception as error:
        return render(request, "error.html", {"error": error})
    else:
        return render(
            request,
            "error.html",
            {"message": "You don't have permission to access this page."},
        )
    return redirect("dashboard")  # Redirect to the dashboard for unauthenticated users


@login_required
@user_type_required("Staff")
def add_gline_view(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "income_head_view" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = GLLine.objects.filter(branch=branch_id)
            record = GLLine.objects.get(line_number=pk)
            form = GLLineForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "income_head": "active",
                "view": True,
            }
            return render(request, "Accounts/add_gline.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def add_gline_edit(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "add_gline_edit" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = GLLine.objects.filter(branch=branch_id)
            record = GLLine.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = GLLineForm(instance=record)
            if request.method == "POST":
                form = GLLineForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/income_head")
            context = {
                "form": form,
                "records": records,
                "income_head": "active",
                "edit": True,
            }
            return render(request, "Accounts/add_gline.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
def all_gline(request):
    if request.user.is_authenticated:
        check_function_name = (
            "all_gline"  # The function name corresponding to this view
        )
        access_functions = request.session.get("user_allowed_func", [])
        is_superuser = request.session.get("is_super_users", False)

        if check_function_name in access_functions or is_superuser:
            context = {"add_account_type": "active"}
            return render(request, "Accounts/all_gline.html", context)
        else:
            return render(
                request,
                "error.html",
                {"message": "You don't have permission to access this page."},
            )
    else:
        return redirect(
            "dashboard"
        )  # Redirect to the login page for unauthenticated users


@login_required
@user_type_required("Staff")
def add_gline_delete(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "add_gline_delete" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)

            glline = GLLine.objects.get(id=pk)
            glline_branch_id = glline.branch.id
            if int(glline_branch_id) == int(branch_id):                        
                GLLine.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/add_gline")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


# Assert Type
@login_required
def add_asset_type(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    if request.user.is_authenticated:
        check_function_name = (
            "add_asset_type"  # The function name corresponding to this view
        )
        access_functions = request.session.get("user_allowed_func", [])
        is_superuser = request.session.get("is_super_users", False)

        if check_function_name in access_functions or is_superuser:
            form = AssetTypeForm()
            if request.method == "POST":
                form = AssetTypeForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()
                    return redirect("view_asset_type")
            else:
                form = AssetTypeForm()

            return render(request, "Accounts/add_asset_type.html", {"form": form})
        else:
            return render(
                request,
                "error.html",
                {"message": "You don't have permission to access this page."},
            )
    else:
        return redirect(
            "dashboard"
        )  # Redirect to the login page for unauthenticated users


@login_required
@user_type_required("Staff")
def add_asset_type(request):
    try:
        # Permission checks
        if (
            request.user.is_superuser or request.user.is_school_admin
            or "add_asset_type" in request.permissions
            or request.permissions
        ):
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            glines = AssetType.objects.filter(branch=branch_id)
            form = AssetTypeForm()

            if request.method == "POST":
                form = AssetTypeForm(request.POST)
                if form.is_valid():
                    form.save()
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/add_asset_type")

            context = {"form": form, "glines": glines}
            return render(request, "Accounts/add_asset_type.html", context)
        else:
            return render(request, "error.html")
    except Exception as error:
        return render(request, "error.html", {"error": error})
    else:
        return redirect(
            "dashboard"
        )  # Redirect to the dashboard for unauthenticated users


@login_required
def view_asset_type(request):
    if request.user.is_authenticated:
        check_function_name = (
            "view_asset_type"  # The function name corresponding to this view
        )
        access_functions = request.session.get("user_allowed_func", [])
        is_superuser = request.session.get("is_super_users", False)

        if check_function_name in access_functions or is_superuser:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            assets = AssetType.objects.filter(branch=branch_id)
            return render(request, "view_asset_type.html", {"assets": assets})
        else:
            return render(
                request,
                "error.html",
                {"message": "You don't have permission to access this page."},
            )
    else:
        return redirect(
            "dashboard"
        )  # Redirect to the login page for unauthenticated users


@login_required
def all_asset_type(request):
    if request.user.is_authenticated:
        check_function_name = (
            "all_asset_type"  # The function name corresponding to this view
        )
        access_functions = request.session.get("user_allowed_func", [])
        is_superuser = request.session.get("is_super_users", False)

        if check_function_name in access_functions or is_superuser:
            context = {"add_account_type": "active"}
            return render(request, "all_asset_type.html", context)
        else:
            return render(
                request,
                "error.html",
                {"message": "You don't have permission to access this page."},
            )
    else:
        return redirect(
            "dashboard"
        )  # Redirect to the login page for unauthenticated users


# Account Type
@login_required
def add_account_type(request):
    if request.user.is_authenticated:
        check_function_name = (
            "add_account_type"  # The function name corresponding to this view
        )
        access_functions = request.session.get("user_allowed_func", [])
        is_superuser = request.session.get("is_super_users", False)

        if check_function_name in access_functions or is_superuser:
            form = AccountTypeForm()
            if request.method == "POST":
                form = AccountTypeForm(request.POST)
                if form.is_valid():
                    form.save()
                    return redirect("view_account_type")
            else:
                form = AccountTypeForm()
            context = {"form": form, "add_account_type": "active"}
            return render(request, "add_account_type.html", context)
        else:
            return render(
                request,
                "error.html",
                {"message": "You don't have permission to access this page."},
            )
    else:
        return redirect(
            "dashboard"
        )  # Redirect to the login page for unauthenticated users


@login_required
def view_account_type(request):
    if request.user.is_authenticated:
        check_function_name = (
            "view_account_type"  # The function name corresponding to this view
        )
        access_functions = request.session.get("user_allowed_func", [])
        is_superuser = request.session.get("is_super_users", False)

        if check_function_name in access_functions or is_superuser:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            accounts = AccountType.objects.filter(branch=branch_id)
            return render(request, "view_account_type.html", {"accounts": accounts})
        else:
            return render(
                request,
                "error.html",
                {"message": "You don't have permission to access this page."},
            )
    else:
        return redirect(
            "dashboard"
        )  # Redirect to the login page for unauthenticated users


@login_required
def all_account_type(request):
    if request.user.is_authenticated:
        check_function_name = (
            "all_account_type"  # The function name corresponding to this view
        )
        access_functions = request.session.get("user_allowed_func", [])
        is_superuser = request.session.get("is_super_users", False)

        if check_function_name in access_functions or is_superuser:
            return render(request, "all_account_type.html")
        else:
            return render(
                request,
                "error.html",
                {"message": "You don't have permission to access this page."},
            )
    else:
        return redirect(
            "dashboard"
        )  # Redirect to the login page for unauthenticated users


@login_required
@user_type_required("Staff")
def account_type(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "income_head_view" in request.permissions
        or "account_type" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = AccountType.objects.filter(branch=branch_id)
            form = AccountTypeForm()
            if request.method == "POST":
                form = AccountTypeForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()   
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/account_type")
                else:
                    print(form.errors)
            context = {
                "form": form,
                "records": records,
                "charge_typecharge_type": "active",
            }
            return render(request, "Accounts/account_type.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def account_type_edit(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "charge_type_edit" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = AccountType.objects.filter(branch=branch_id)
            record = AccountType.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = AccountTypeForm(instance=record)
            if request.method == "POST":
                form = AccountTypeForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/account_type")
            context = {
                "form": form,
                "records": records,
                "charge_type": "active",
                "edit": True,
            }
            return render(request, "Accounts/account_type.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def account_type_view(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "charge_type_view" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = AccountType.objects.filter(branch=branch_id)
            record = AccountType.objects.get(id=pk)
            form = AccountTypeForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "charge_type": "active",
                "view": True,
            }
            return render(request, "Accounts/account_type.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def account_type_delete(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "charge_type_delete" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)

            charge_type=ChargeType.objects.get(charge_type=pk).delete()
            charge_type_branch_id = charge_type.branch.id
            if int(charge_type_branch_id) == int(branch_id):                        
                ChargeType.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/account_type")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


# Add Account
@login_required
@user_type_required("Staff")
def add_account(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "income_view" in request.permissions
        or "add_account" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Account.objects.filter(branch=branch_id)
            form = AccountForm()
            if request.method == "POST":
                form = AccountForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()     
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/add_account")
                else:
                    print(form.errors)
            context = {"form": form, "records": records, "add_account": "active"}
            return render(request, "Accounts/add_account.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def view_account_edit(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "view_account_edit" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Account.objects.filter(branch=branch_id)
            record = Account.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = AccountForm(instance=record)
            if request.method == "POST":
                form = StudentHouseForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/add_income")
            context = {
                "form": form,
                "records": records,
                "add_income": "active",
                "edit": True,
            }
            return render(request, "Income/add_income.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def view_account_view(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "income_view" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Account.objects.filter(branch=branch_id)
            record = Account.objects.get(id=pk)
            form = AccountForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "add_income": "active",
                "view": True,
            }
            return render(request, "Income/add_income.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def view_account_delete(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "income_delete" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            account=Account.objects.get(id=pk)
            expense_head_branch_id = account.branch.id
            if int(expense_head_branch_id) == int(branch_id):                        
                ExpenseHead.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/add_income")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


# Transaction
@login_required
def add_transaction(request):
    if request.user.is_authenticated:
        check_function_name = (
            "add_transaction"  # The function name corresponding to this view
        )
        access_functions = request.session.get("user_allowed_func", [])
        is_superuser = request.session.get("is_super_users", False)

        if check_function_name in access_functions or is_superuser:
            form = AccountForm()
            if request.method == "POST":
                form = AccountForm(request.POST)
                if form.is_valid():
                    form.save()
                    return redirect("view_account_type")
            else:
                form = AccountForm()
            context = {"form": form, "add_account": "active"}
            return render(request, "add_transaction.html", context)
        else:
            return render(
                request,
                "error.html",
                {"message": "You don't have permission to access this page."},
            )
    else:
        return redirect(
            "dashboard"
        )  # Redirect to the login page for unauthenticated users


@login_required
def view_transaction(request):
    if request.user.is_authenticated:
        check_function_name = (
            "view_transaction"  # The function name corresponding to this view
        )
        access_functions = request.session.get("user_allowed_func", [])
        is_superuser = request.session.get("is_super_users", False)

        if check_function_name in access_functions or is_superuser:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            accounts = TransactionType.objects.filter(branch=branch_id)
            context = {"accounts": accounts}
            return render(request, "view_transaction.html", context)
        else:
            return render(
                request,
                "error.html",
                {"message": "You don't have permission to access this page."},
            )
    else:
        return redirect(
            "dashboard"
        )  # Redirect to the login page for unauthenticated users


@login_required
def all_transaction(request):
    if request.user.is_authenticated:
        check_function_name = (
            "all_transaction"  # The function name corresponding to this view
        )
        access_functions = request.session.get("user_allowed_func", [])
        is_superuser = request.session.get("is_super_users", False)

        if check_function_name in access_functions or is_superuser:
            return render(request, "all_transaction.html")
        else:
            return render(
                request,
                "error.html",
                {"message": "You don't have permission to access this page."},
            )
    else:
        return redirect(
            "dashboard"
        )  # Redirect to the login page for unauthenticated users


# Transaction Code
@login_required
def add_transaction_code(request):
    if request.user.is_authenticated:
        check_function_name = (
            "add_transaction_code"  # The function name corresponding to this view
        )
        access_functions = request.session.get("user_allowed_func", [])
        is_superuser = request.session.get("is_super_users", False)

        if check_function_name in access_functions or is_superuser:
            form = TransactionCodeForm()
            if request.method == "POST":
                form = TransactionCodeForm(request.POST)
                if form.is_valid():
                    form.save()
                    return redirect("view_transaction_code")
            else:
                form = TransactionCodeForm()
            context = {"form": form, "add_transaction_code": "active"}
            return render(request, "add_transaction_code.html", context)
        else:
            return render(
                request,
                "error.html",
                {"message": "You don't have permission to access this page."},
            )
    else:
        return redirect(
            "dashboard"
        )  # Redirect to the login page for unauthenticated users


@login_required
def view_transaction_code(request):
    if request.user.is_authenticated:
        check_function_name = (
            "view_transaction_code"  # The function name corresponding to this view
        )
        access_functions = request.session.get("user_allowed_func", [])
        is_superuser = request.session.get("is_super_users", False)

        if check_function_name in access_functions or is_superuser:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            codes = ChargeType.objects.filter(branch=branch_id)
            context = {"codes": codes}
            return render(request, "view_transcation_code.html", context)
        else:
            return render(
                request,
                "error.html",
                {"message": "You don't have permission to access this page."},
            )
    else:
        return redirect(
            "dashboard"
        )  # Redirect to the login page for unauthenticated users


# Charge Type
@login_required
def add_charge_type(request):
    if request.user.is_authenticated:
        check_function_name = (
            "add_charge_type"  # The function name corresponding to this view
        )
        access_functions = request.session.get("user_allowed_func", [])
        is_superuser = request.session.get("is_super_users", False)

        if check_function_name in access_functions or is_superuser:
            form = ChargeTypeForm()
            if request.method == "POST":
                form = ChargeTypeForm(request.POST)
                if form.is_valid():
                    form.save()
                    return redirect("view_charge_type")
            else:
                form = ChargeTypeForm()
            context = {"form": form, "add_charge_type": "active"}
            return render(request, "add_charge_type.html", context)
        else:
            return render(
                request,
                "error.html",
                {"message": "You don't have permission to access this page."},
            )
    else:
        return redirect(
            "dashboard"
        )  # Redirect to the login page for unauthenticated users


@login_required
def view_charge_type(request):
    if request.user.is_authenticated:
        check_function_name = (
            "view_charge_type"  # The function name corresponding to this view
        )
        access_functions = request.session.get("user_allowed_func", [])
        is_superuser = request.session.get("is_super_users", False)

        if check_function_name in access_functions or is_superuser:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            types = TransactionCode.objects.filter(branch=branch_id)
            context = {"types": types}
            return render(request, "view_charge_type.html", context)
        else:
            return render(
                request,
                "error.html",
                {"message": "You don't have permission to access this page."},
            )
    else:
        return redirect(
            "dashboard"
        )  # Redirect to the login page for unauthenticated users


@login_required
@user_type_required("Staff")
def charge_type(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "income_head_view" in request.permissions
        or "charge_type" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = ChargeType.objects.filter(branch=branch_id)
            form = ChargeTypeForm()
            if request.method == "POST":
                form = ChargeTypeForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/charge_type")
                else:
                    print(form.errors)
            context = {
                "form": form,
                "records": records,
                "charge_typecharge_type": "active",
            }
            return render(request, "Accounts/charge_type.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def charge_type_edit(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "charge_type_edit" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = ChargeType.objects.filter(branch=branch_id)
            record = ChargeType.objects.get(charge_type=pk)
            data_branch_id = record.branch.id
            form = ChargeTypeForm(instance=record)
            if request.method == "POST":
                form = ChargeTypeForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/charge_type")
            context = {
                "form": form,
                "records": records,
                "charge_type": "active",
                "edit": True,
            }
            return render(request, "Accounts/charge_type.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def charge_type_view(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "charge_type_view" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = ChargeType.objects.filter(branch=branch_id)
            record = ChargeType.objects.get(charge_type=pk)
            form = ChargeTypeForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "charge_type": "active",
                "view": True,
            }
            return render(request, "Accounts/charge_type.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def charge_type_delete(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "charge_type_delete" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            charge_type=ChargeType.objects.get(charge_type=pk)
            expense_head_branch_id = charge_type.branch.id
            if int(expense_head_branch_id) == int(branch_id):                        
                ChargeType.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/income_head")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


# Transaction Type
@login_required
def add_transaction_type(request):
    if request.user.is_authenticated:
        check_function_name = (
            "add_transaction_type"  # The function name corresponding to this view
        )
        access_functions = request.session.get("user_allowed_func", [])
        is_superuser = request.session.get("is_super_users", False)

        if check_function_name in access_functions or is_superuser:
            form = TransactionTypeForm()
            if request.method == "POST":
                form = TransactionTypeForm(request.POST)
                if form.is_valid():
                    form.save()
                    return redirect("view_transaction_type")
            else:
                form = TransactionTypeForm()
            context = {"form": form, "add_transaction_type": "active"}
            return render(request, "add_transaction_type.html", context)
        else:
            return render(
                request,
                "error.html",
                {"message": "You don't have permission to access this page."},
            )
    else:
        return redirect(
            "dashboard"
        )  # Redirect to the login page for unauthenticated users


@login_required
def view_transaction_type(request):
    if request.user.is_authenticated:
        check_function_name = (
            "view_transaction_type"  # The function name corresponding to this view
        )
        access_functions = request.session.get("user_allowed_func", [])
        is_superuser = request.session.get("is_super_users", False)

        if check_function_name in access_functions or is_superuser:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            types = TransactionType.objects.filter(branch=branch_id)
            context = {"types": types}
            return render(request, "view_transaction_type.html", context)
        else:
            return render(
                request,
                "error.html",
                {"message": "You don't have permission to access this page."},
            )
    else:
        return redirect(
            "dashboard"
        )  # Redirect to the login page for unauthenticated users


# Account Entry
# def account_entry(member_id, group_id, pay_amount, dr_acc, cr_acc, transaction_id):
#     try:
#         entry_id = "".join(random.choices(string.ascii_letters + string.digits, k=16))
#         print("Account Entry Statement ...")
#         print(member_id, group_id, pay_amount, dr_acc, cr_acc, transaction_id)

#         # Debit account process
#         dr_acc_detail = Account.objects.get(account_number=dr_acc)
#         AccountEntry.objects.create(
#             entry_ID=entry_id,
#             transaction_ID=transaction_id,
#             user_id=member_id,
#             account_number_id=dr_acc,
#             group_name_id=group_id,
#             amount=-pay_amount,
#             currency="KES",
#             debit_credit_marker="Debit",
#         )
#         dr_acc_detail.current_cleared_balance -= float(pay_amount)
#         dr_acc_detail.total_balance -= float(pay_amount)
#         dr_acc_detail.save()
#         print("Credit process.")

#         # Credit account process
#         entry_id = "".join(random.choices(string.ascii_letters + string.digits, k=16))
#         cr_acc_detail = Account.objects.get(account_number=cr_acc)
#         AccountEntry.objects.create(
#             entry_ID=entry_id,
#             transaction_ID=transaction_id,
#             user_id=member_id,
#             account_number_id=cr_acc,
#             group_name_id=group_id,
#             amount=pay_amount,
#             currency="KES",
#             debit_credit_marker="Credit",
#         )
#         print("here...")
#         cr_acc_detail.current_cleared_balance += float(pay_amount)
#         cr_acc_detail.total_balance += float(pay_amount)
#         cr_acc_detail.save()
#         print("llllll")
#         return True
#     except Exception as error:
#         print("error ", error)
#         return False

# from django.db import transaction


def account_entry(request,member_id, group_id, pay_amount, dr_acc, cr_acc, transaction_id):
    try:
        branch_name = request.session.get('branch_id', None)
        if branch_name:
            branch_id = branch_name       
        else:
            branch_id = None  
            print("branch_name@@@",branch_name)
        entry_id = "".join(random.choices(string.ascii_letters + string.digits, k=16))
        print("Account Entry Statement ...")
        print(member_id, group_id, pay_amount, dr_acc, cr_acc, transaction_id)

        # Debit Account Process
        dr_acc_detail = Account.objects.get(account_number=dr_acc)
        AccountEntry.objects.create(
            entry_ID=entry_id,
            transaction_ID=transaction_id,
            user_id=member_id,
            account_number_id=dr_acc,
            group_name_id=group_id,
            amount=-pay_amount,
            currency="KES",
            debit_credit_marker="Debit",
            branch_id=branch_id
        )
        dr_acc_detail.current_cleared_balance -= float(pay_amount)
        dr_acc_detail.total_balance -= float(pay_amount)
        dr_acc_detail.save()

        # Credit Account Process
        entry_id = "".join(random.choices(string.ascii_letters + string.digits, k=16))
        cr_acc_detail = Account.objects.get(account_number=str(cr_acc))
        AccountEntry.objects.create(
            entry_ID=entry_id,
            transaction_ID=transaction_id,
            user_id=member_id,
            account_number_id=cr_acc,
            group_name_id=group_id,
            amount=pay_amount,
            currency="KES",
            debit_credit_marker="Credit",
            branch_id=branch_id
        )
        cr_acc_detail.current_cleared_balance += float(pay_amount)
        cr_acc_detail.total_balance += float(pay_amount)
        cr_acc_detail.save()
        result = account_entry(
            member_id, group_id, pay_amount, dr_acc, cr_acc, transaction_id
        )

        return True
    except Exception as error:
        print("Error: ", error)
        return False


# import logging
# import random
# import string
# from main.models import Account, AccountEntry

# logger = logging.getLogger(__name__)

# def process_debit_entry(entry_id, transaction_id, member_id, dr_acc, group_id, pay_amount):
#     try:
#         dr_acc_detail = Account.objects.get(account_number=dr_acc)

#         # Debit entry logic
#         AccountEntry.objects.create(
#             entry_ID=entry_id,
#             transaction_ID=transaction_id,
#             user_id=member_id,
#             account_number_id=dr_acc,
#             group_name_id=group_id,
#             amount=-pay_amount,
#             currency='KES',
#             debit_credit_marker='Debit',
#         )

#         dr_acc_detail.current_cleared_balance -= float(pay_amount)
#         dr_acc_detail.total_balance -= float(pay_amount)
#         dr_acc_detail.save()

#         return True
#     except Account.DoesNotExist as account_not_found:
#         logger.error(f"Error: {account_not_found}")
#         return False
#     except Exception as error:
#         logger.error(f"Unexpected error in debit entry: {error}")
#         return False

# def process_credit_entry(entry_id, transaction_id, member_id, cr_acc, group_id, pay_amount):
#     try:
#         cr_acc_detail = Account.objects.get(account_number=cr_acc)

#         # Credit entry logic
#         AccountEntry.objects.create(
#             entry_ID=entry_id,
#             transaction_ID=transaction_id,
#             user_id=member_id,
#             account_number_id=cr_acc,
#             group_name_id=group_id,
#             amount=pay_amount,
#             currency='KES',
#             debit_credit_marker='Credit',
#         )

#         cr_acc_detail.current_cleared_balance += float(pay_amount)
#         cr_acc_detail.total_balance += float(pay_amount)
#         cr_acc_detail.save()

#         return True
#     except Account.DoesNotExist as account_not_found:
#         logger.error(f"Error: {account_not_found}")
#         return False
#     except Exception as error:
#         logger.error(f"Unexpected error in credit entry: {error}")
#         return False

# def account_entry(member_id, group_id, pay_amount, dr_acc, cr_acc, transaction_id):
#     try:
#         entry_id = ''.join(random.choices(string.ascii_letters + string.digits, k=16))
#         process_debit_entry(entry_id, transaction_id, member_id, dr_acc, group_id, pay_amount)
#         process_credit_entry(entry_id, transaction_id, member_id, cr_acc, group_id, pay_amount)
#         return True
#     except Exception as error:
#         logger.error(f"Error in account entry: {error}")
#         return False


@login_required
def account_entry_view(request):
    if request.user.is_authenticated:
        check_function_name = (
            "account_entry_view"  # The function name corresponding to this view
        )
        access_functions = request.session.get("user_allowed_func", [])
        is_superuser = request.session.get("is_super_users", False)

        if check_function_name in access_functions or is_superuser:
            if request.method == "POST":
                # Retrieve data from the form
                member_id = request.POST.get("member_id")
                group_id = request.POST.get("group_id")
                pay_amount = float(request.POST.get("pay_amount"))
                dr_acc = request.POST.get("dr_acc")
                cr_acc = request.POST.get("cr_acc")
                transaction_id = request.POST.get("transaction_id")

                # Call the account_entry function
                success = utils.account_entry(
                    member_id, group_id, pay_amount, dr_acc, cr_acc, transaction_id
                )

                if success:
                    return render(request, "account_success_template.html")
                else:
                    return render(request, "error_template.html")

            return render(request, "account_entry_form.html")
        else:
            return render(
                request,
                "error.html",
                {"message": "You don't have permission to access this page."},
            )
    else:
        return redirect(
            "dashboard"
        )  # Redirect to the login page for unauthenticated users


@login_required
@user_type_required("Staff")
def account_entry_edit(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "view_account_edit" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = AccountEntry.objects.filter(branch=branch_id)
            record = AccountEntry.objects.get(id=pk)
            form = AccountEntryForm(instance=record)
            if request.method == "POST":
                form = StudentHouseForm(request.POST, instance=record)
                if form.is_valid():
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/add_income")
            context = {
                "form": form,
                "records": records,
                "add_income": "active",
                "edit": True,
            }
            return render(request, "Income/add_income.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def account_entry_delete(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "income_delete" in request.permissions
        or request.permissions
    ):
        try:
            AccountEntry.objects.get(id=pk).delete()
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/add_income")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


# Fees Collection
@login_required
@user_type_required("Staff")
def collect_fees(request):
    # print(f"is superuser {request.user.is_superuser or request.user.is_school_admin}")
    if (request.user.is_superuser or request.user.is_school_admin or "collect_fees_add" in request.permissions):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name   
                print("branch_name@@@",branch_name)    
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            class_records = Class.objects.filter(branch=branch_id)
            section_records = Section.objects.filter(branch=branch_id)
            if request.method == "POST":
                classs = request.POST.get("class")
                section = request.POST.get("section")
                print(classs, section)
                if classs and section:
                    records = StudentAdmission.objects.filter(
                        Class_id=classs, section_id=section, session=request.Session,branch_id=branch_id
                    )
                elif classs:
                    records = StudentAdmission.objects.filter(
                        Class_id=classs, session=request.Session,branch_id=branch_id
                    )
                elif section:
                    records = StudentAdmission.objects.filter(
                        section_id=section, session=request.Session,branch_id=branch_id
                    )
                context = {
                    "collect_fees": "active",
                    "records": records,
                    "class_records": class_records,
                    "section_records": section_records,
                }
                return render(request, "Fees_Collection/collect_fees.html", context)
            context = {
                "collect_fees": "active",
                "class_records": class_records,
                "section_records": section_records,
            }

            return render(request, "Fees_Collection/collect_fees.html", context)
        except Exception as error:
            print(f"error {error}")
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def class_students(request):
    print(f"is superuser {request.user.is_superuser or request.user.is_school_admin}")
    if request.user.is_superuser or request.user.is_school_admin:
        # or "collect_fees_add" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            class_records = Class.objects.filter(branch=branch_id)
            section_records = Section.objects.filter(branch=branch_id)
            if request.method == "POST":
                classs = request.POST.get("class")
                section = request.POST.get("section")
                print(classs, section)
                if classs and section:
                    records = StudentAdmission.objects.filter(
                        Class_id=classs, section_id=section, session=request.Session
                    )
                elif classs:
                    records = StudentAdmission.objects.filter(
                        Class_id=classs, session=request.Session
                    )
                elif section:
                    records = StudentAdmission.objects.filter(
                        section_id=section, session=request.Session
                    )
                context = {
                    "collect_fees": "active",
                    "records": records,
                    "class_records": class_records,
                    "section_records": section_records,
                }
                return render(request, "Fees_Collection/class_students.html", context)
            context = {
                "collect_fees": "active",
                "class_records": class_records,
                "section_records": section_records,
            }

            return render(request, "Fees_Collection/class_students.html", context)
        except Exception as error:
            print(f"error {error}")
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


# @login_required
# @user_type_required("Staff")
# def collect_fees(request):
#     print(f"is superuser {request.user.is_superuser or request.user.is_school_admin}")
#     if request.user.is_superuser or request.user.is_school_admin:
#         try:
#             class_records = Class.objects.filter(branch=branch_id)
#             section_records = Section.objects.filter(branch=branch_id)

#             if request.method == "POST":
#                 class_id = request.POST.get("class")
#                 section_id = request.POST.get("section")

#                 if class_id and section_id:
#                     records = StudentAdmission.objects.filter(
#                         Class_id=class_id, section_id=section_id, session=request.Session
#                     )
#                 elif class_id:
#                     records = StudentAdmission.objects.filter(
#                         Class_id=class_id, session=request.Session
#                     )
#                 elif section_id:
#                     records = StudentAdmission.objects.filter(
#                         section_id=section_id, session=request.Session
#                     )

#                 # Assuming each student pays a fixed fee (for simplicity)
#                 fee_amount = 100  # You can replace this with the actual fee amount

#                 # Simulate a scenario where a student pays fees
#                 for student in records:
#                     # Create student account
#                     if student.school is not None:
#                         student_account = create_student_account(student)

#                         # Ensure student has a valid school attribute
#                         if student.school is not None:
#                             # Create school account if not exists
#                             school_account = create_school_account(student.school)

#                     # student_account = create_student_account(student)

#                     # Create school account if not exists
#                     # school_account = create_school_account(student.school)

#                     # Simulate a transaction entry for fee payment
#                             success = account_entry(
#                                 member_id=student.id,
#                                 group_id=student.school.id,
#                                 pay_amount=fee_amount,
#                                 dr_acc=school_account,
#                                 cr_acc=student_account,
#                                 transaction_id=f"FEES_{student.id}",
#                             )

#                         if success:
#                             print(f"Fee collected for student {student.id}")

#                 context = {
#                     "collect_fees": "active",
#                     "records": records,
#                     "class_records": class_records,
#                     "section_records": section_records,
#                 }

#                 return render(request, "Fees_Collection/collect_fees.html", context)

#             context = {
#                 "collect_fees": "active",
#                 "class_records": class_records,
#                 "section_records": section_records,
#                 "records": records,
#             }

#             return render(request, "Fees_Collection/collect_fees.html", context)

#         except Exception as error:
#             print(f"error {error}")
#             return render(request, "error.html", {"error": error})
#     else:
#         return redirect("dashboard")


@login_required
@user_type_required("Staff")
def collect_fees_detail(request, pk):
    # if request.user.is_superuser or request.user.is_school_admin or "collect_fees_add" in request.permissions:
    #     try:
                print('--------',pk)
                token = request.session['user_token'] 
                branch_name = request.session.get('branch_id', None)
                if branch_name:
                    branch_id = branch_name       
                else:
                    branch_id = None  
                    print("branch_name@@@",branch_name)
                    
                print("branch_name@@@",branch_name)
                    
                endpoint = 'finance/transaction-type/'
                endpoint_transaction = 'finance/all-transaction/'

                toady_date = datetime.now().date()
                records = StudentAdmission.objects.get(id=pk)
                print("records",records.id)
                fees_records = FeesAssign.objects.filter(
                    student_id=pk, session=request.Session
                )
                print("request.Session",request.Session)
                # fees_discount=FeesTypeDiscount.objects.filter(branch=branch_id)
                fees_discount = DiscountAssign.objects.filter(
                    student=pk, session=request.Session,branch_id = branch_id
                )
                paid_record = StudentFess.objects.filter(
                    student=pk, session=request.Session,branch_id = branch_id
                )
                student_vault_amount = 0   
                student_main = StudentMain.objects.get(id=records.student_main.id)
                print("student_main_id__up", student_main)
                
                student_vault = StudentVaultAmount.objects.get(student=student_main)
                print("student_vault+++",student_vault.balance_amount)
                student_vault_amount = student_vault.balance_amount
                print("student_vault_amount+++",student_vault_amount)
                if request.method == "POST":
                    # branch = Branch.objects.get(id=branch_id)
                    # print("branch+++", branch.school.reference_id) 
                    print("POST request data:", request.POST)
                    amount_list = request.POST.get("amount")
                    print("amount_list+++",amount_list)
                    percentage = request.POST.get("percentage")
                    discount_group = request.POST.get("discount_group")
                    amount_discount = request.POST.get("amount_discount")
                    amount_fine = request.POST.get("amount_fine")
                    payment_mode_fee = request.POST.get("payment_mode_fee")
                    description = request.POST.get("description")
                    fess_id = request.POST.get("fees_id")
                    transaction_type = request.POST.get("transaction_type")
                    paid_by = request.POST.get("paid_by") 
                    total_amount = request.POST.get("total_amount") 
                    print("total_amount----",total_amount)
                    balance_amounts = request.POST.get("balance_amount") or 0
                    if amount_list >= total_amount:                        
                        amount = amount_list
                      
                        stud=StudentAdmission.objects.get(student_main_id=student_main.id)
                        print('stdiff',stud)
                        std=FeesAssign.objects.filter(student_id=stud.id).last()
                        print('stdfeesifff',std)
                        receivable=AccountReceivable.objects.get(reference_number=std.id)
                        print('receivable---',receivable)
                        print('receivable====',receivable.reference_number)

                        amount_lisst = int(amount_list)
                        totals_amount = int(total_amount)

                        if amount_lisst <= totals_amount:
                            balance = totals_amount - amount_lisst
                            print("Condition is Trueif")
                            print("Balanceif:", balance)
                            receivable.amount_received+=float(amount_lisst)
                            receivable.amount_due-=float(amount_lisst)
                            receivable.save()
                        else:
                            balance = totals_amount 
                            print("Condition is False")
                            receivable.amount_received+=float(balance)
                            receivable.amount_due-=float(balance)
                            receivable.save()
                            
                        
                        vault_acc=Accounts.objects.get(student_id=student_main.id)  
                        vault_acc.total_balance=balance_amounts
                        vault_acc.current_cleared_balance=balance_amounts
                        vault_acc.save()
                        print("Total Value:1", amount_list)
                    else:
                        amount = amount_list
                        
                        std=StudentAdmission.objects.get(student_main_id=student_main.id)
                        print('std',std.id)
                        std1=FeesAssign.objects.filter(student_id=std.id).last()
                        print('stdelseeee',std1)
                        receivable=AccountReceivable.objects.get(reference_number=std1.id)   
                        print('reference---',receivable)

                        amount_lisst = int(amount_list)
                        totals_amount = int(total_amount)

                        if amount_lisst <= totals_amount:
                            balance = totals_amount - amount_lisst
                            print("Condition is True")
                            print("Balanceelse:", balance)
                            receivable.amount_received+=float(amount_lisst)
                            receivable.amount_due-=float(amount_lisst)
                            receivable.save()
                        else:
                            balance = totals_amount 
                            print("Condition is Falsee2")
                            receivable.amount_received+=float(balance)
                            receivable.amount_due-=float(balance)
                            receivable.save()                   

                        vault_acc=Accounts.objects.get(student_id=student_main.id)  
                        vault_acc.total_balance=float(balance_amounts)
                        vault_acc.current_cleared_balance=float(balance_amounts)
                        vault_acc.save()
                        print("Total Value:2", amount)
                    if total_amount >= amount_list:
                        amount = total_amount 
                        print("Total Value:3", amount)
                    else:
                        amount = total_amount  
                    print("Student Paid Amount: ", amount, "Total Value: ", amount)
                    if paid_by == '':
                        paid_by = None
                    ref_number = request.POST.get("ref_number") 
                    if ref_number == '':
                        ref_number = None
                    card_holder_name = request.POST.get("card_holder_name") 
                    if card_holder_name == '':
                        card_holder_name = None
                    mobile_number = request.POST.get("mobile_number") 
                    if mobile_number == '':
                        mobile_number = None
                    user_amount = request.POST.get("user_amount") 
                    if user_amount == '':
                        user_amount = None
                    print("transaction_type++++",transaction_type,paid_by,ref_number,ref_number,card_holder_name,mobile_number)
                    # student information as a dictionary
                    response = call_get_method(BASE_URL, endpoint, token)
                    transaction_data = response.json()
                    print("transaction_data", transaction_data)
                    print('student_main',student_main.pk)
                    student=StudentAdmission.objects.get(student_main_id=student_main)
                    print('student',student)
                    reference=FeesAssign.objects.filter(student_id=student).last()
                    print('reference',reference.id)  
                    transaction_type=FinanceTransactionType.objects.get(name='Fees collection') 
                    print('transaction_type',transaction_type.pk)
                    if reference:
                        if amount_lisst <= totals_amount:
                            balance = totals_amount - amount_lisst
                            print("Condition is Truereference")
                            print("Balancereference:", balance)
                            bal_amount = str(balance)
                        else:
                            bal_amount = 0
                            balance = totals_amount  # If totals_amount is less than amount_lisst, assign totals_amount
                            print("Balance_reference:", balance)
                            bal_amount = str(balance)
                            print("Balance_reference:", bal_amount)
                    check = post_receivable_and_payable_transaction_ms(transaction_type.pk,reference,reference,None,bal_amount,request.user.pk)
                    amounts=int(bal_amount)
                    status=receivable_atomic(reference.pk,amounts)
                    print('check',check)
                    print('status',status)
      
                    # Extract 'name' and 'transaction_type_id' into a list of dictionaries
                    # transaction_list = [{'name': item['name'], 'transaction_type_id': item['transaction_type_id']} for item in transaction_data]

                    # print("transaction_list", transaction_list)
                    # payroll_transaction = next((transaction for transaction in transaction_list if transaction['name'] == 'Payroll'), None)
                    # if payroll_transaction:
                    #     transaction_name = payroll_transaction['name']
                    #     transaction_type_id = payroll_transaction['transaction_type_id']
                    #     print("Transaction Name:", transaction_name)
                    #     print("Transaction Type ID:", transaction_type_id)
                    # else:
                    #     print("No 'Payroll' transaction found.")
                    # if response.status_code != 200:
                    #     return render(request, 'error500.html', {'error': str(response.json())})
                    
                    # student_information = {
                    #     "student_name": f"{records.first_name}",
                    #     "roll_no": f"{records.roll_number}"
                    # }

                    # converting student_information to JSON format
                    # student_information_json = json.dumps(student_information)
                    # print("++++tudent",type(student_information_json))

                    # using it in the data dictionary
                    # data = {
                    #     'transaction_type_id': str(transaction_type_id),
                    #     'company_id': str(branch.school.reference_id),
                    #     'amount': int(amount),
                    #     'input_params_values': student_information 
                    # }
                    # print("++++++++++++++++++",data)

                    # json_data = json.dumps(data)
                    # print("=========", json_data)

                    # response = call_post_method(BASE_URL, endpoint_transaction, json_data, token)
                    # print("response+++", response)
                    # if response.status_code != 200:
                    #     print('Response Status Code:', response.content)
                    # response_data = json.loads(response.content.decode('utf-8')) 
                    # transaction_id=response_data['record_id']    
                    # print("transaction_id",transaction_id)
                    # Transaction.objects.create(
                    #     student_id=pk,
                    #     reference_id=transaction_id,                   
                    #     branch_id = branch_id
                    # )
                    fees_record = FeesAssign.objects.filter(id=fess_id).last()
                    if discount_group:
                        dis = DiscountAssign.objects.filter(
                            id=discount_group,
                        ).last()
                        if dis:
                            dis.status = "applied"
                            dis.fees_id = fess_id
                            dis.branch_id = branch_id
                            dis.save()
                            fees_record.Dicount_amount = (
                                fees_record.Dicount_amount + dis.discount.amount
                            )
                    if amount_fine:
                        fees_record.fine_amount = int(amount_fine) + fees_record.fine_amount
                    
                    StudentFess.objects.create(
                        student_id=pk,
                        paid_amount=amount,
                        discount_group_id=discount_group,
                        payment_mode_fee=payment_mode_fee,
                        amount_discount=amount_discount,
                        amount_fine=amount_fine,
                        description=description,
                        status="Paid",
                        fess_id=fess_id,
                        session=request.Session,
                        created_by=request.user,
                        branch_id = branch_id,
                        paid_by = paid_by,
                        ref_number = ref_number,
                        card_holder_name = card_holder_name,
                        mobile_number = mobile_number,
                        amount = user_amount,
                    )
                    student_vault = 0
                    if total_amount:
                        try:
                            student_main = StudentMain.objects.get(id=records.student_main.id)
                            print("student_main_id---+++", student_main)
                            
                            student_vault = StudentVaultAmount.objects.get(student=student_main)
                            print("student_vault+++", student_vault)
                            
                            if student_vault:
                                student_vault.student = student_main
                                student_vault.total_amount = Decimal(total_amount) 
                                student_vault.paid_amount = Decimal(amount)        
                                student_vault.balance_amount = Decimal(balance_amounts) 
                                student_vault.session = request.Session             
                                student_vault.created_by = request.user
                                student_vault.branch_id = branch_id
                                student_vault.save()
                            else:
                                StudentVaultAmount.objects.create(
                                    student=student_main,
                                    total_amount=Decimal(total_amount),    
                                    paid_amount=Decimal(amount),          
                                    balance_amount=Decimal(balance_amounts),  
                                    session=request.Session,
                                    created_by=request.user,
                                    branch_id=branch_id
                                )
                                short_description=f"{student_main.admission_no} vault"
                                vault=account_creation_finance(student_main.pk,short_description)
                                print('vault',vault)
                        except StudentMain.DoesNotExist:
                            print(f"StudentMain with admission number {records.admission_no} does not exist.") 
                    
                    fees_record.paid_amount = int(fees_record.paid_amount) + int(amount)
                    if fees_record.balance_amount == None:
                        print("fees_record.fees.amount---",fees_record.fees.amount)
                        # balance = (
                        #     int(fees_record.fees.amount)
                        #     - int(amount)
                        #     - int(amount_discount)
                        # )
                        balance = max(
                            int(fees_record.amount) - int(amount) - int(amount_discount), 
                            0
                        )
                        paid = fees_record.paid_amount
                    else:
                        # balance = (
                        #     int(fees_record.balance_amount)
                        #     - int(amount)
                        #     - int(amount_discount)
                        # )
                        balance = max(
                            int(fees_record.balance_amount) - int(amount) - int(amount_discount), 
                            0
                        )
                        paid = int(fees_record.paid_amount) + int(amount)
                    fees_record.balance_amount = balance
                    # fees_record.paid_amount=paid
                    if balance == 0:
                        fees_record.status = "fully paid"
                    else:
                        fees_record.status = "partially paid"
                    fees_record.save()

                    # for student in records:
                    if records.branch is not None:
                        # Retrieve the user-inputted amount from the form
                        # fee_amount = request.POST.get(f"fee_amount_{records.id}")
                        print("amount", amount)
                        fee_amount = amount
                        # Ensure fee_amount is not None and is a valid number
                        if fee_amount is not None and fee_amount.isdigit():
                            fee_amount = int(fee_amount)
                        else:
                            print(f"Invalid fee amount for student {records.id}")
                            # Handle the error or return an appropriate response

                        # Collect fees from student and credit it to the school
                        # success = collect_school_fees(request,records, fee_amount)
                        # Assuming you have the student and fee_amount variables defined earlier in your code
                        success = collect_school_fees(
                            records_id=records.id,
                            fee_amount=fee_amount,
                            user_id=request.user.id,
                        )

                        if success:
                            print(f"Fee collected for student {records.id}")
                        else:
                            print(f"Failed to collect fee for student {records.id}")

                    return HttpResponseRedirect(f"/collect_fees_detail/{pk}")

                context = {
                    "records": records,
                    "fees_records": fees_records,
                    "toady_date": toady_date,
                    "fees_discount": fees_discount,
                    "paid_record": paid_record,
                    "collect_fees": "active",                
                    "pk":pk,
                    "student_vault":student_vault_amount
                }
                return render(request, "Fees_Collection/collect_fees_detail.html", context)
    #     except Exception as error:
    #         return render(request, "error.html", {"error": error})
    # else:
    #     return redirect("dashboard")


# cumulative total


from django.db.models import Sum

# ...


@login_required
@user_type_required("Staff")
def collect_fees_total(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "collect_fees_add" in request.permissions:
        try:
            today_date = datetime.now().date()
            records = StudentAdmission.objects.get(id=pk)
            fees_records = FeesAssign.objects.filter(
                student_id=pk, session=request.Session
            )
            fees_discount = DiscountAssign.objects.filter(
                student=pk, session=request.Session
            )

            # Use the PaymentRecord model to get total paid_amount for all students
            total_paid_amount_all_students = PaymentRecord.objects.filter(
                session=request.Session
            ).aggregate(Sum("paid_amount"))["paid_amount__sum"]

            print(total_paid_amount_all_students)

            if request.method == "POST":
                context = {
                    "records": records,
                    "fees_records": fees_records,
                    "today_date": today_date,
                    "fees_discount": fees_discount,
                    "collect_fees": "active",
                    "total_paid_amount_all_students": total_paid_amount_all_students,
                }

            return render(request, "Fees_Collection/collect_fees_detail.html", context)

        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def search_fee_payment(request):
    if request.user.is_superuser or request.user.is_school_admin or "search_fees_payment_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            if request.method == "POST":
                records = StudentFess.objects.filter(
                    id=request.POST.get("payment_id"), session=request.Session,branch_id = branch_id 
                ).last()
                context = {"search_fee_payment": "active", "records": records}
                return render(
                    request, "Fees_Collection/search_fee_payment.html", context
                )
            context = {"search_fee_payment": "active"}
            return render(request, "Fees_Collection/search_fee_payment.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def search_due_fee(request):
    if request.user.is_superuser or request.user.is_school_admin or "search_due_fees_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            fees_type = FeesType.objects.filter(branch=branch_id)
            Classs = Class.objects.filter(branch=branch_id)
            if request.method == "POST":
                records = FeesAssign.objects.filter(
                    fees__fees_type=request.POST.get("fees_type"),
                    session=request.Session,
                    student__Class=request.POST.get("class"),
                    student__section=request.POST.get("section"),
                    student__session=request.Session,
                    branch_id = branch_id 
                ).exclude(status="fully paid")
                print("xxxxxxxxxxxxxxxxxx", records)

                context = {
                    "search_due_fee": "active",
                    "fees_type": fees_type,
                    "Classs": Classs,
                    "records": records,
                }
                return render(request, "Fees_Collection/search_due_fee.html", context)
            context = {
                "search_due_fee": "active",
                "fees_type": fees_type,
                "Classs": Classs,
            }
            return render(request, "Fees_Collection/search_due_fee.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


# @login_required
# @user_type_required("Staff")
# def fees_master(request):
#     print( request.user.is_superuser , request.user.is_school_admin,
#          "fees_master_add" in request.permissions,
#          "fees_master_view" in request.permissions)
#     if (
#         request.user.is_superuser or request.user.is_school_admin 
#         or "fees_master_add" in request.permissions
#         or "fees_master_view" in request.permissions
#     ):
#         try:
#             token = request.session['user_token']
#             endpoint = 'finance/transaction-type/'
#             # endpoint_transaction = 'finance/all-transaction/'
#             branch_name = request.session.get('branch_id', None)
#             if branch_name:
#                 branch_id = branch_name       
#             else:
#                 branch_id = None  
#             print("branch_name@@@",branch_name)
#             records = FeesMaster.objects.filter(status="Active")
#             print("records++++",records)
#             form = FeesMasterForm()
#             if request.method == "POST":
#                 form = FeesMasterForm(request.POST)
#                 print("form++++",form.is_valid())
#                 if form.is_valid():
#                     # response = call_get_method(BASE_URL, endpoint, token)
#                     # transaction_data = response.json()
#                     # print("transaction_data", transaction_data)

#                     # Extract 'name' and 'transaction_type_id' into a list of dictionaries
#                     # transaction_list = [{'name': item['name'], 'transaction_type_id': item['transaction_type_id']} for item in transaction_data]

#                     # print("transaction_list", transaction_list)
#                     # payroll_transaction = next((transaction for transaction in transaction_list if transaction['name'] == 'Payroll'), None)
#                     # if payroll_transaction:
#                     #     transaction_name = payroll_transaction['name']
#                     #     transaction_type_id = payroll_transaction['transaction_type_id']
#                     #     print("Transaction Name:", transaction_name)
#                     #     print("Transaction Type ID:", transaction_type_id)
#                     # else:
#                     #     print("No 'Payroll' transaction found.")
#                     # if response.status_code != 200:
#                     #     return render(request, 'error500.html', {'error': str(response.json())})
                            

#                     # if request.method == "POST":
#                     #     expence_amount=form.cleaned_data["fine_amount"]
#                     #     branch = Branch.objects.get(id=branch_id)
#                     #     print("branch+++", branch.school.reference_id) 
                        
                      
#                     #     student_information = {
#                     #         "student_name": f"{form.cleaned_data.get('amount')}",
#                     #         "roll_no": f"{form.cleaned_data.get('fine_amount')}"
#                     #     }

#                         # converting student_information to JSON format
#                         # student_information_json = json.dumps(student_information)
#                         # print("++++tudent",type(student_information_json))

#                         # using it in the data dictionary
#                     # data = {
#                     #     'transaction_type_id': str(transaction_type_id),
#                     #     'company_id': str(branch.school.reference_id),
#                     #     'amount': int(expence_amount),
#                     #     'input_params_values': student_information 
#                     # }
#                     # print("++++++++++++++++++",type(data))

#                     # json_data = json.dumps(data)
#                     # print("=========", type(json_data))

#                     # response = call_post_method(BASE_URL, endpoint_transaction, json_data, token)
#                     # print("response+++", response)
#                     # if response.status_code != 200:
#                     #     print('Response Status Code:', response.content)
#                     # response_data = json.loads(response.content.decode('utf-8')) 
#                     # transaction_id=response_data['record_id']    
#                     # print("transaction_id",transaction_id)
#                     # Transaction.objects.create(
#                     #     student_id=None,
#                     #     reference_id=transaction_id,                   
#                     #     branch_id = branch_id
#                     # )
#                     obj=form.save()
#                     obj.branch_id = branch_id
#                     obj.save()
#                     print("form.cleaned_data",form.cleaned_data)
#                     messages.success(request, "Record Saved Successfully")
#                     return HttpResponseRedirect("/fees_master")
#                 else:
#                     print('---err-------',form.errors)
#             context = {"form": form, "records": records, "fees_master": "active"}
#             return render(request, "Fees_Collection/fees_master.html", context)
#         except Exception as error:
#             return render(request, "error.html", {"error": error})
#     else:
#         return redirect("dashboard")   -------- recent

@login_required
@user_type_required("Staff")
def fees_master(request):

    if (
        request.user.is_superuser
        or request.user.is_school_admin
        or "fees_master_add" in request.permissions
        or "fees_master_view" in request.permissions
    ):
        try:
            #  Always keep ID and object separate
            branch_id = request.session.get("branch_id")
            branch = None

            if branch_id:
                branch = Branch.objects.get(id=branch_id)
            print("branch_name@@@", branch_id)
            #  Filter by branch
            records = FeesMaster.objects.filter(
                status="Active",
                branch=branch
            )
            print("records++++", records)
            form = FeesMasterForm()

            if request.method == "POST":
                form = FeesMasterForm(request.POST)
                print("form++++", form.is_valid())
                if form.is_valid():
                    obj = form.save(commit=False)  #  IMPORTANT
                    obj.branch = branch
                    obj.save()

                    messages.success(request, "Record Saved Successfully")
                    return redirect("fees_master")
                else:
                    print("Form Errors:", form.errors)

            context = {
                "form": form,
                "records": records,
                "fees_master": "active"
            }

            return render(request, "Fees_Collection/fees_master.html", context)

        except Branch.DoesNotExist:
            messages.error(request, "Branch not found.")
            return redirect("dashboard")

        except Exception as error:
            print("ERROR:", error)
            return render(request, "error.html", {"error": error})

    return redirect("dashboard")

@login_required
@user_type_required("Staff")
def fees_master_assign(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or request.user.is_admin or "fees_gp_assign_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            fees_record = FeesMaster.objects.get(id=pk)
            class_records = Class.objects.filter(branch=branch_id)
            section_records = Section.objects.filter(branch=branch_id)
            category_records = StudentCategory.objects.filter(branch=branch_id)
            if request.method == "POST":
                classs = request.POST.get("class")
                print("classs",classs)
                section = request.POST.get("section")
                print("section",section)
                Category = request.POST.get("category")
                print("Category",Category)
                gender = request.POST.get("gender")
                print("gender",gender)
                ret = request.POST.get("RET")
                print("RET",ret)
                filters = {}
                if classs:
                    filters["Class"] = classs
                if section:
                    filters["section"] = section
                if Category:
                    filters["category"] = Category
                if gender:
                    filters["gender"] = gender
                if ret:
                    filters["rte"] = ret

                records = StudentAdmission.objects.filter(
                    **filters, session=request.Session
                )
                print("records+++++====",records)
                student_fees_assigned = FeesAssign.objects.filter(student__in=records,fees=fees_record )
                print("student_fees_assigned+++", student_fees_assigned)
                student_ids = student_fees_assigned.values_list("student_id", flat=True)
                print("student_ids+++++",student_ids)
                student_records = StudentAdmission.objects.filter(id__in=records).exclude(id__in=student_ids)
                print("student_records===", student_records)
                if not student_records.exists():
                    messages.warning(request, "Fees already assigned to all students.")
                    return redirect(f"/fees_master_assign/{pk}")
                # print("records+++",records)
                # pre_fees_records = []
                # for data in records:
                #     fees_excess = StudentVaultAmount.objects.filter(student_id=data).first()
                #     print("fees_excess+++",fees_excess)
                #     if fees_excess:
                #         pre_fees_records.append({
                #             'student_id': fees_excess.student.id,
                #             'balance_amount': fees_excess.balance_amo unt
                #         })
                #         print("pre_fees_recordsif---",pre_fees_records)        

                #     else:
                #         pre_fees_records.append({
                #             'student_id': data, 
                #             'balance_amount': 0  
                #         })
                #         print("pre_fees_recordsel ---",pre_fees_records)        
                
                context = {
                    "fees_master": "active",
                    "category_records": category_records,
                    "class_records": class_records,
                    "section_records": section_records,
                    "records": student_records,
                    "fees_record": fees_record,
                    "records_count": records.count(),
                    # "fees_excess_data": pre_fees_records,
                    
                }
                return render(
                    request, "Fees_Collection/fees_master_assign.html", context
                )
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")

    context = {
        "fees_master": "active",
        "category_records": category_records,
        "class_records": class_records,
        "section_records": section_records,
        "fees_record": fees_record,
    }
    return render(request, "Fees_Collection/fees_master_assign.html", context)


def fees_master_assign_js(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    id_list = json.loads(request.POST.get("id_list", "[]"))
    print("+++++id_list",id_list)
    fees_id = request.POST.get("fees_id")
    print("+++++fees_id",fees_id)
    fees_master = FeesMaster.objects.get(id=fees_id)
    print("+++++fees_master",fees_master)
    print("+++++equest.Session",request.Session)
        
    for data in id_list:
        print("+++++data",data)
        # fees_excess=StudentVaultAmount.objects.filter(student_id=data)
        # print("fees_excess---",fees_excess)
        fee, created = FeesAssign.objects.get_or_create(
                student_id=data,
                fees_id=fees_id,
                balance_amount=fees_master.amount,
                paid_amount=0,
                status="pending",
                session=request.Session,
                branch_id=branch_id
        )

        print('fee', fee)   
        print('data',data)

        # Use fee.pk correctly
        acc_rec_obj = AccountReceivable.objects.create(
            reference_type_id='RT-001',
            reference_number=fee.pk, 
            student_id=data,
            actual_amount=str(fees_master.amount),
            amount_due=str(fees_master.amount)
        )

        print('acc_rec_obj', acc_rec_obj)

    data = "Saved Sucessfully"
    return JsonResponse(data, safe=False)
    
# def fees_master_assign_js(request):
#     print("+++++")
#     if request.method == 'POST':  # Use POST to modify the database
#         id_list = json.loads(request.POST.get("id_list", "[]"))
#         print("+++++id_list",id_list)
#         fees_id = request.POST.get("fees_id")
#         print("+++++fees_id",fees_id)
    
#         try:
#             fees_master = FeesMaster.objects.get(id=fees_id)  # Get the FeesMaster object
#             print("fees_master10",fees_master)
#         except FeesMaster.DoesNotExist:
#             return JsonResponse({'status': 'error', 'message': 'FeesMaster does not exist'}, status=404)

#         for student_id in id_list:
#             print("student_id++++",student_id)
#             FeesAssign.objects.get_or_create(
#                 student_id=student_id,
#                 fees_id=fees_id,
#                 balance_amount=fees_master.amount,
#                 paid_amount=0,
#                 status="pending",
#                 session=request.session,  # Correct usage of session
#             )

#         return JsonResponse({'status': 'success', 'message': 'Saved successfully'}, status=200)

#     return JsonResponse({'status': 'error', 'message': 'Invalid request method'}, status=400) 


@login_required
def discount_js(request):
    disc = request.GET.get("disc")
    disc_ass = DiscountAssign.objects.get(id=disc)
    data = disc_ass.discount.amount
    return JsonResponse(data, safe=False)


@login_required
@user_type_required("Staff")
def fees_master_edit_1(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "fees_master_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)  
            print("school_name@@@",branch_id)
            records = FeesMaster.objects.filter(branch=branch_id)
            record = FeesMaster.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = FeesMasterForm(instance=record)
            if request.method == "POST":
                form = FeesMasterForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = data_branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/fees_master")
            context = {
                "form": form,
                "records": records,
                "fees_master": "active",
                "edit": True,
            }
            return render(request, "Fees_Collection/fees_master.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def fees_master_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "fees_master_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = FeesMaster.objects.filter(branch=branch_id)
            record = FeesMaster.objects.get(id=pk)
            form = FeesMasterForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "fees_master": "active",
                "view": True,
            }
            return render(request, "Fees_Collection/fees_master.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


# larann
@login_required
@user_type_required("Staff")
def fees_master_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "fees_master_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            fees=FeesMaster.objects.get(id=pk)
            fees_branch_id = fees.branch.id
            if int(fees_branch_id) == int(branch_id):                        
                FeesMaster.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/fees_master")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


# @login_required
# @user_type_required("Staff")
# def fees_master_edit(request):
#     form = FeesMasterForm()
#     context = {
#         "form": form,
#     }
#     return render(request, "Fees_Collection/fees_master_edit.html", context)


@login_required
@user_type_required("Staff")
def fees_group(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "fees_group_view" in request.permissions
        or "fees_group_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = FeesGroup.objects.filter(branch=branch_id)
            form = FeesGroupForm()
            if request.method == "POST":
                form = FeesGroupForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/fees_group")
                else:
                    print(form.errors)
            context = {
                "form": form,
                "records": records,
                "fees_group": "active",
            }
            return render(request, "Fees_Collection/fees_group.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def fees_group_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "fees_group_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = FeesGroup.objects.filter(branch=branch_id)
            record = FeesGroup.objects.get(id=pk)
            data_school_id = record.branch.id
            form = FeesGroupForm(instance=record)
            if request.method == "POST":
                form = FeesGroupForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_school_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/fees_group")
            context = {
                "form": form,
                "records": records,
                "fees_group": "active",
                "edit": True,
            }
            return render(request, "Fees_Collection/fees_group.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def fees_group_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "fees_group_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = FeesGroup.objects.filter(branch=branch_id)
            record = FeesGroup.objects.get(id=pk)
            form = FeesGroupForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "fees_group": "active",
                "view": True,
            }
            return render(request, "Fees_Collection/fees_group.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def fees_group_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "fees_group_delete" in request.permissions:
        try:
            school_name = request.session.get('school_id', None)
            staff_school_name = request.session.get('branch_id', None)
            if school_name:
                school_id = school_name
            elif staff_school_name:
                school_id = staff_school_name   
            else:
                school_id = None    
            print("school_name@@@",school_name)
            fees_group=FeesGroup.objects.get(id=pk)
            fees_group_school_id = fees_group.branch.id
            if int(fees_group_school_id) == int(school_id):                        
                FeesGroup.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/fees_group")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def edit_fees_group(request):
    form = FeesGroupForm()
    context = {
        "form": form,
    }
    return render(request, "Fees_Collection/edit_fees_group.html", context)


@login_required
@user_type_required("Staff")
def fees_type(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "fees_type_view" in request.permissions
        or "fees_type_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = FeesType.objects.filter(branch=branch_id)
            form = FeesTypeForm()
            if request.method == "POST":
                form = FeesTypeForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/fees_type")
                else:
                    for field_name, error_messages in form.errors.items():
                        for message in error_messages:
                            messages.error(
                                request, f"{field_name.capitalize()}:{message}"
                            )
                    print(form.errors)
            context = {
                "form": form,
                "records": records,
                "fees_type": "active",
            }
            return render(request, "Fees_Collection/fees_type.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def fees_type_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "fees_type_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = FeesType.objects.filter(branch=branch_id)
            record = FeesType.objects.get(id=pk)
            data_school_id = record.branch.id
            form = FeesTypeForm(instance=record)
            if request.method == "POST":
                form = FeesTypeForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_school_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/fees_type")
            context = {
                "form": form,
                "records": records,
                "fees_type": "active",
                "edit": True,
            }
            return render(request, "Fees_Collection/fees_type.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def fees_type_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "fees_type_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = FeesType.objects.filter(branch=branch_id)
            record = FeesType.objects.get(id=pk)
            form = FeesTypeForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "fees_type": "active",
                "view": True,
            }
            return render(request, "Fees_Collection/fees_type.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def fees_type_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "fees_type_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            fees_type=FeesType.objects.get(id=pk)
            fees_type_school_id = fees_type.branch.id
            if int(fees_type_school_id) == int(branch_id):                        
                FeesType.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/fees_type")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def edit_fees_type(request):
    form = FeesGroupForm()
    context = {
        "form": form,
    }
    return render(request, "Fees_Collection/edit_fees_type.html", context)


# ... (your existing imports and decorators)

from django.http import JsonResponse

@login_required
@user_type_required("Staff")
def fees_discount(request):

    #  Permission check  redirect ONLY once
    if not (
        request.user.is_superuser
        or request.user.is_school_admin
        or "fees_discount_add" in request.permissions
        or "fees_discount_view" in request.permissions
    ):
        return redirect("dashboard")

    try:
        branch_id = request.session.get("branch_id")

        total_fees_master = FeesMaster.objects.first()

        #  DO NOT redirect to same page
        if not total_fees_master:
            messages.warning(request, "No FeesMaster instance found.")
            return render(
                request,
                "Fees_Collection/fees_discount.html",
                {
                    "form": FeesTypeDiscountForm(),
                    "records": [],
                    "fees_discountt": "active",
                },
            )

        total_fees_amount = total_fees_master.amount
        records = FeesTypeDiscount.objects.filter(branch_id=branch_id)

        if request.method == "POST":
            form = FeesTypeDiscountForm(request.POST)

            if form.is_valid():
                discount = form.save(commit=False)
                discount.branch_id = branch_id

                if discount.discount_type == "Discount Percentage":
                    discount.amount = (
                        discount.percentage / 100
                    ) * total_fees_amount
                    discount.percentage_amount = discount.amount
                else:
                    discount.percentage = None
                    discount.percentage_amount = None

                discount.save()
                messages.success(request, "Record Saved Successfully")

                #  redirect AFTER POST is correct
                return redirect("fees_discount")

            else:
                messages.error(request, form.errors)

        else:
            form = FeesTypeDiscountForm(
                initial={"total_fees_amount": total_fees_amount}
            )

        return render(
            request,
            "Fees_Collection/fees_discount.html",
            {
                "form": form,
                "records": records,
                "fees_discountt": "active",
            },
        )

    except Exception as error:
        return render(request, "error.html", {"error": error})

#old
# @login_required
# @user_type_required("Staff")
# def fees_discount(request):
#     if (
#         request.user.is_superuser or request.user.is_school_admin
#         or "fees_discount_add" in request.permissions
#         or "fees_discount_view" in request.permissions
#     ):
#         try:
#             token = request.session['user_token']
#             endpoint = 'finance/transaction-type/'
#             endpoint_transaction = 'finance/all-transaction/'
#             branch_name = request.session.get('branch_id', None)
#             if branch_name:
#                 branch_id = branch_name       
#             else:
#                 branch_id = None  
#                 print("branch_name@@@",branch_name)

#             # Dynamically get the FeesMaster instance
#             total_fees_master = (
#                 FeesMaster.objects.first()
#             )  # You can adjust the query as needed

#             if not total_fees_master:
#                 messages.warning(request, "No FeesMaster instance found.")
#                 return HttpResponseRedirect("/fees_discount")

#             total_fees_amount = total_fees_master.amount

#             records = FeesTypeDiscount.objects.filter(branch=branch_id)
#             initial_data = {"total_fees_amount": total_fees_amount}

#             form = FeesTypeDiscountForm(initial=initial_data)

#             if request.method == "POST":
#                 form = FeesTypeDiscountForm(request.POST)
#                 if form.is_valid():
                    
#                     # response = call_get_method(BASE_URL, endpoint, token)
#                     # transaction_data = response.json()
#                     # print("transaction_data", transaction_data)

#                     # Extract 'name' and 'transaction_type_id' into a list of dictionaries
#                     # transaction_list = [{'name': item['name'], 'transaction_type_id': item['transaction_type_id']} for item in transaction_data]

#                     # print("transaction_list", transaction_list)
#                     # payroll_transaction = next((transaction for transaction in transaction_list if transaction['name'] == 'Payroll'), None)
#                     # if payroll_transaction:
#                     #     transaction_name = payroll_transaction['name']
#                     #     transaction_type_id = payroll_transaction['transaction_type_id']
#                     #     print("Transaction Name:", transaction_name)
#                     #     print("Transaction Type ID:", transaction_type_id)
#                     # else:
#                     #     print("No 'Payroll' transaction found.")
#                     # if response.status_code != 200:
#                     #     return render(request, 'error500.html', {'error': str(response.json())})
                            

#                     # if request.method == "POST":
#                     #     expence_amount=form.cleaned_data["amount"]
#                     #     branch = Branch.objects.get(id=branch_id)
#                     #     print("branch+++", branch.school.reference_id) 
                        
                      
#                     #     student_information = {
#                     #         "student_name": f"{form.cleaned_data.get('name')}",
#                     #         "roll_no": f"{form.cleaned_data.get('discount_code')}"
#                     #     }

#                         # converting student_information to JSON format
#                         # student_information_json = json.dumps(student_information)
#                         # print("++++tudent",type(student_information_json))

#                         # using it in the data dictionary
#                     # data = {
#                     #     'transaction_type_id': str(transaction_type_id),
#                     #     'company_id': str(branch.school.reference_id),
#                     #     'amount': int(expence_amount),
#                     #     'input_params_values': student_information 
#                     # }
#                     # print("++++++++++++++++++",type(data))

#                     # json_data = json.dumps(data)
#                     # print("=========", type(json_data))

#                     # response = call_post_method(BASE_URL, endpoint_transaction, json_data, token)
#                     # print("response+++", response)
#                     # if response.status_code != 200:
#                     #     print('Response Status Code:', response.content)
#                     # response_data = json.loads(response.content.decode('utf-8')) 
#                     # transaction_id=response_data['record_id']    
#                     # print("transaction_id",transaction_id)
#                     # Transaction.objects.create(
#                     #     student_id=None,
#                     #     reference_id=transaction_id,                   
#                     #     branch_id = branch_id
#                     # )
#                     discount = form.save(commit=False)

#                     if discount.discount_type == "Discount Percentage":
#                         total_amount = total_fees_amount
#                         calculated_percentage_amount = (
#                             discount.percentage / 100
#                         ) * total_amount
#                         discount.amount = calculated_percentage_amount
#                         discount.percentage_amount = calculated_percentage_amount
#                         discount.branch_id = branch_id

#                         print(f"Calculated Amount: {discount.amount}")
#                         print(
#                             f"Calculated Percentage Amount: {discount.percentage_amount}"
#                         )

#                     discount.save()
#                     messages.success(request, "Record Saved Successfully")
#                     return HttpResponseRedirect("/fees_discount")
#                 else:
#                     print(form.errors)

#             context = {"form": form, "records": records, "fees_discountt": "active"}
#             return render(request, "Fees_Collection/fees_discount.html", context)

#         except Exception as error:
#             return render(request, "error.html", {"error": error})
#     else:
#         return redirect("dashboard")


# @login_required
# @user_type_required("Staff")
# def fees_discount(request):
#     if (
#         request.user.is_superuser or request.user.is_school_admin
#         or "fees_discount_add" in request.permissions
#         or "fees_discount_view" in request.permissions
#     ):
#         try:
#             # Dynamically get the FeesMaster instance
#             total_fees_master = (
#                 FeesMaster.objects.first()
#             )  # You can adjust the query as needed

#             if not total_fees_master:
#                 messages.warning(request, "No FeesMaster instance found.")
#                 return HttpResponseRedirect("/fees_discount")

#             total_fees_amount = total_fees_master.amount

#             records = FeesTypeDiscount.objects.filter(branch=branch_id)
#             initial_data = {"total_fees_amount": total_fees_amount}

#             form = FeesTypeDiscountForm(initial=initial_data)

#             if request.method == "POST":
#                 form = FeesTypeDiscountForm(request.POST)
#                 if form.is_valid():
#                     discount = form.save(commit=False)

#                     if discount.discount_type == "Discount Percentage":
#                         total_amount = total_fees_amount
#                         calculated_percentage_amount = (
#                             discount.percentage / 100
#                         ) * total_amount
#                         discount.amount = calculated_percentage_amount
#                         discount.percentage_amount = calculated_percentage_amount

#                         print(f"Calculated Amount: {discount.amount}")
#                         print(
#                             f"Calculated Percentage Amount: {discount.percentage_amount}"
#                         )
#                     discount.save()
#                     messages.success(request, "Record Saved Successfully")
#                     return HttpResponseRedirect("/fees_discount")
#                 else:
#                     print(form.errors)

#             context = {"form": form, "records": records, "fees_discountt": "active"}
#             return render(request, "Fees_Collection/fees_discount.html", context)

#         except Exception as error:
#             return render(request, "error.html", {"error": error})
#     else:
#         return redirect("dashboard")


@login_required
@user_type_required("Staff")
def fees_discount_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "fees_discount_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = FeesTypeDiscount.objects.filter(branch=branch_id)
            record = FeesTypeDiscount.objects.get(id=pk)
            form = FeesTypeDiscountForm(instance=record)
            if request.method == "POST":
                form = FeesTypeDiscountForm(request.POST, instance=record)
                if form.is_valid():
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/fees_discount")
            context = {
                "form": form,
                "records": records,
                "fees_discount": "active",
                "edit": True,
            }
            return render(request, "Fees_Collection/fees_discount.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def fees_discount_assign(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "fees_assign_discount_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)

            fees_discount = FeesTypeDiscount.objects.get(id=pk)
            class_records = Class.objects.filter(branch=branch_id)
            section_records = Section.objects.filter(branch=branch_id)
            category_records = StudentCategory.objects.filter(branch=branch_id)
            if request.method == "POST":
                classs = request.POST.get("class")
                section = request.POST.get("section")
                Category = request.POST.get("category")
                gender = request.POST.get("gender")
                RET = request.POST.get("RET")
                filters = {}
                if classs:
                    filters["Class"] = classs
                if section:
                    filters["section"] = section
                if Category:
                    filters["category"] = Category
                if gender:
                    filters["gender"] = gender
                if RET:
                    filters["rte"] = RET

                records = StudentAdmission.objects.filter(
                    **filters, session=request.Session,branch_id = branch_id
                )
                id_list = request.POST.getlist("selected_students[]")  
                print("id_list=---",id_list)
                for student_id in id_list:
                    DiscountAssign.objects.get_or_create(
                        student_id=student_id,
                        discount_id=pk,
                        status="pending",
                        session=request.Session,     
                    )
                if id_list:
                    messages.warning(request, "Record Updated Successfully")    
                    
                context = {
                    "fees_discountt": "active",
                    "category_records": category_records,
                    "class_records": class_records,
                    "section_records": section_records,
                    "records": records,
                    "fees_discount": fees_discount,
                    "records_count": records.count(),
                }
                return render(
                    request, "Fees_Collection/fees_discount_assign.html", context
                )

            context = {
                "fees_discountt": "active",
                "category_records": category_records,
                "class_records": class_records,
                "section_records": section_records,
                "fees_discount": fees_discount,
            }
            return render(request, "Fees_Collection/fees_discount_assign.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


# @login_required
# def fees_discount_assign_js(request):
#     id_list = request.GET.getlist("id_list[]")
#     fees_id = request.GET.get("fees_id")
#     for data in id_list:
#         DiscountAssign.objects.get_or_create(
#             student_id=data,
#             discount_id=fees_id,
#             status="pending",
#             session=request.Session,
#         )
#     data = "Saved Sucessfully"
#     return JsonResponse(data, safe=False)

def fees_discount_assign_js(request):
    if request.method == "POST":
        id_list = request.POST.getlist("selected_students[]")  
        fees_id = request.POST.get("fees_id") 
        print("id_list=---",id_list,fees_id)
        
        if not id_list or not fees_id:
            return JsonResponse({"error": "Missing required parameters"}, status=400)

        for student_id in id_list:
            DiscountAssign.objects.get_or_create(
                student_id=student_id,
                discount_id=fees_id,
                status="pending",
                 session=request.Session,              )

        return JsonResponse({"message": "Discount assigned successfully"})

    return JsonResponse({"error": "Invalid request method"}, status=405)


def fees_discount_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "fees_discount_delete" in request.permissions:
        try:
            FeesTypeDiscount.objects.get(id=pk).delete()
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/fees_discount")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def edit_fees_discount(request):
    form = FeesGroupForm()
    context = {
        "form": form,
    }
    return render(request, "Fees_Collection/edit_fees_discount.html", context)


from django.db.models import Sum


@login_required
@user_type_required("Staff")
def fees_carry_forward(request):
    if request.user.is_superuser or request.user.is_school_admin or "fees_discount_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            class_records = Class.objects.filter(branch=branch_id)
            print("request.Session.id---",request.Session)
            Session_records = Session.objects.exclude(id=request.Session.id)
            if request.method == "POST":
                session = request.POST.get("session")
                print("session---",session)
                pre_fess = FeesAssign.objects.filter(
                    student__Class__id=request.POST.get("class"),
                    student__section__id=request.POST.get("section"),
                    session=session,                    
                    status__in=["pending", "partially paid"],
                    branch_id = branch_id, 
                )
                admis_no_list = list(set([data.student.admission_no for data in pre_fess]))
                pre_fees_rcords = []
                for data in admis_no_list:
                    dict = {}
                    records = pre_fess.filter(student__admission_no=data)
                    dict["obj"] = records.last()
                    dict["total_amount"] = records.aggregate(Sum("balance_amount"))[
                        "balance_amount__sum"
                    ]
                    pre_fees_rcords.append(dict)
                context = {
                    "fees_carry_forward": "active",
                    "class_records": class_records,
                    "Session_records": Session_records,
                    "pre_fees_rcords": pre_fees_rcords,
                    "session": session,
                }
                return render(request, "Fees_Collection/fees_carry_forward.html", context)
            context = {
                "fees_carry_forward": "active",
                "class_records": class_records,
                "Session_records": Session_records,
            }
            return render(request, "Fees_Collection/fees_carry_forward.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")
    
    
@login_required
@user_type_required("Staff")
def fees_carry_forward_all(request):
    if request.user.is_superuser or request.user.is_school_admin or "fees_discount_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
                   
            pre_fess = FeesAssign.objects.filter(                
                branch_id = branch_id, 
            )
            print("pre_fess----",pre_fess)
            admis_no_list = list(set([data.student.admission_no for data in pre_fess]))
            pre_fees_rcords = []
            total_fees_amount = 0  # Initialize variable to store the total amount for all records

            for data in admis_no_list:
                record_dict = {}
                records = pre_fess.filter(student__admission_no=data)
                record_dict["obj"] = records.last()
                record_dict["total_amount"] = records.aggregate(Sum("balance_amount"))["balance_amount__sum"] or 0
                total_fees_amount += record_dict["total_amount"]  # Add to the total amount
                pre_fees_rcords.append(record_dict)

            # Save the total_fees_amount in session
            request.session['total_fees_amount'] = total_fees_amount 
            print("request.session",request.session['total_fees_amount'])
             
            context = {
                "pre_fees_rcords": pre_fees_rcords,
                "fees_carry_forward_all": "active",
                "total_fees_amount": total_fees_amount,  # Pass the total amount in context
            }
            return render(request, "Fees_Collection/fees_carry_forward_all.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")    


@login_required
@user_type_required("Staff")
def fees_carry_forward_save(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    admission_list = request.POST.getlist("admission_no")
    print("admission_list",admission_list)
    for data in admission_list:
        print("===", data)
        amount = request.POST.get(f"amount_{data}")
        print("amount@@@",amount)
        fess_group = FeesGroup.objects.get_or_create(name="Balance Master")
        fess_type = FeesType.objects.get_or_create(
            name="Previous Session Balance", Fees_code="Previous Session Balance"
        )
        print(fess_group[0].id, "========.SSS")
        fess_master = FeesMaster.objects.get_or_create(
            fees_group_id=fess_group[0].id,
            fees_type_id=fess_type[0].id,
            amount=amount,
            percentage=0,
            fine_amount=0,
            status="Inactive",
            branch_id =  branch_id
        )
        student_obj = StudentAdmission.objects.filter(admission_no=data,session=request.Session).first()
        print("student_obj---",student_obj)
        FeesAssign.objects.create(
            student=student_obj,
            fees=fess_master[0],
            balance_amount=amount,
            paid_amount=0,
            session=request.Session,
            status="pending",
            branch_id = branch_id
        )
        session = request.POST.get("session")
        print("session@@@",session)
        pre_fess = FeesAssign.objects.filter(
            student__admission_no=data, session=session
        )
        for update in pre_fess:
            update.status = "Forward"
            update.save()
    return redirect("fees_carry_forward")


@login_required
@user_type_required("Staff")
def fees_remainder(request):
    context = {"fees_remainder": "active"}
    return render(request, "Fees_Collection/fees_remainder.html", context)


# Expense
# Expense
@login_required
@user_type_required("Staff")
def add_expense(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "expense_view" in request.permissions
        or "expense_add" in request.permissions
        or request.permissions
    ):
        try:
            token = request.session['user_token'] 
            endpoint = 'finance/transaction-type/'
            # endpoint_transaction = 'finance/all-transaction/'
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = AddExpense.objects.filter(branch=branch_id)
            form = AddExpenseForm()

            # Get user_id from the current user
            user_id = request.user.id

            # Assuming User model has a ForeignKey to School
            user_school = request.user.school

            # Get the school account associated with the user's school
            # school_account = user_school.account

            if request.method == "POST":
                form = AddExpenseForm(request.POST, request.FILES)
                if form.is_valid():
                    response = call_get_method(BASE_URL, endpoint, token)
                    transaction_data = response.json()
                    print("transaction_data", transaction_data)

                    # Extract 'name' and 'transaction_type_id' into a list of dictionaries
                    transaction_list = [{'name': item['name'], 'transaction_type_id': item['transaction_type_id']} for item in transaction_data]

                    # print("transaction_list", transaction_list)
                    # payroll_transaction = next((transaction for transaction in transaction_list if transaction['name'] == 'Payroll'), None)
                    # if payroll_transaction:
                    #     transaction_name = payroll_transaction['name']
                    #     transaction_type_id = payroll_transaction['transaction_type_id']
                    #     print("Transaction Name:", transaction_name)
                    #     print("Transaction Type ID:", transaction_type_id)
                    # else:
                    #     print("No 'Payroll' transaction found.")
                    # if response.status_code != 200:
                    #     return render(request, 'error500.html', {'error': str(response.json())})
                            

                    # if request.method == "POST":
                    #     expence_amount=form.cleaned_data["amount"]
                    #     branch = Branch.objects.get(id=branch_id)
                    #     print("branch+++", branch.school.reference_id) 
                        
                      
                    #     student_information = {
                    #         "student_name": f"{form.cleaned_data.get('name')}",
                    #         "roll_no": f"{form.cleaned_data.get('invoice_number')}"
                    #     }

                        # converting student_information to JSON format
                        # student_information_json = json.dumps(student_information)
                        # print("++++tudent",type(student_information_json))

                        # using it in the data dictionary
                    # data = {
                    #     'transaction_type_id': str(transaction_type_id),
                    #     'company_id': str(branch.school.reference_id),
                    #     'amount': int(expence_amount),
                    #     'input_params_values': student_information 
                    # }
                    # print("++++++++++++++++++",type(data))

                    # json_data = json.dumps(data)
                    # print("=========", type(json_data))

                    # response = call_post_method(BASE_URL, endpoint_transaction, json_data, token)
                    # print("response+++", response)
                    # if response.status_code != 200:
                    #     print('Response Status Code:', response.content)
                    # response_data = json.loads(response.content.decode('utf-8')) 
                    # transaction_id=response_data['record_id']    
                    # print("transaction_id",transaction_id)
                    # Transaction.objects.create(
                    #     student_id=None,
                    #     reference_id=transaction_id,                   
                    #     branch_id = branch_id
                    # )
                expense_instance = form.save()
                expense_instance.branch_id = branch_id
                expense_instance.save()
                # Call collect_expense function with user_id
                # success = collect_expense(expense_instance, user_id)
                success =True
                if success:
                    messages.success(request, "Record Saved Successfully")
                else:
                    messages.error(request, "Failed to process the expense")
                return HttpResponseRedirect("/add_expense")
            else:
                print(form.errors)

            context = {"form": form, "records": records, "add_expense": "active"}
            return render(request, "Expenses/add_expense.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def add_expense_edit(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "expense_edit" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)

            records = AddExpense.objects.filter(branch=branch_id)
            record = AddExpense.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = AddExpenseForm(instance=record)
            if request.method == "POST":
                form = AddExpenseForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/add_expense")
            context = {
                "form": form,
                "records": records,
                "add_expense": "active",
                "edit": True,
            }
            return render(request, "Expenses/add_expense.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def add_expense_view(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "expense_view" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = AddExpense.objects.filter(branch=branch_id)
            record = AddExpense.objects.get(id=pk)
            form = AddExpenseForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "add_expense": "active",
                "view": True,
            }
            return render(request, "Expenses/add_expense.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def add_expense_delete(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "expense_delete" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            addexpense=AddExpense.objects.get(id=pk)
            addexpense_branch_id = addexpense.branch.id
            if int(addexpense_branch_id) == int(branch_id):                        
                AddExpense.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/add_expense")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def edit_add_expense(request):
    form = AddExpenseForm()
    context = {
        "form": form,
    }
    return render(request, "Expenses/edit_add_expense.html", context)


@login_required
@user_type_required("Staff")
def search_expense(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "search_expense_view" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            if request.method == "POST":
                from_date = request.POST.get("from_date")
                to_date = request.POST.get("to_date")
                filters = {}
                if from_date and to_date:
                    filters["date__range"] = [from_date, to_date]
                elif from_date:
                    filters["date__gte"] = from_date
                elif to_date:
                    filters["date__lte"] = to_date
                elif branch_id:
                    filters["branch_id"] = branch_id    

                records = AddExpense.objects.filter(**filters)
                context = {
                    "search_expense": "active",
                    "records": records,
                }
                return render(request, "Expenses/search_expense.html", context)
            context = {
                "search_expense": "active",
            }
            return render(request, "Expenses/search_expense.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def expense_head(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "expense_head_view" in request.permissions
        or "expense_head_add" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = ExpenseHead.objects.filter(branch=branch_id)
            form = ExpenseHeadForm()
            if request.method == "POST":
                form = ExpenseHeadForm(request.POST, request.FILES)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/expense_head")
                else:
                    print(form.errors)
            context = {"form": form, "records": records, "expense_head": "active"}
            return render(request, "Expenses/expense_head.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def expense_head_edit_1(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "expense_head_edit" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = ExpenseHead.objects.filter(branch=branch_id)
            record = ExpenseHead.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = ExpenseHeadForm(instance=record)
            if request.method == "POST":
                form = ExpenseHeadForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/expense_head")
            context = {
                "form": form,
                "records": records,
                "expense_head": "active",
                "edit": True,
            }
            return render(request, "Expenses/expense_head.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def expense_head_view(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "expense_head_view" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = ExpenseHead.objects.filter(branch=branch_id)
            record = ExpenseHead.objects.get(id=pk)
            form = ExpenseHeadForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "expense_head": "active",
                "view": True,
            }
            return render(request, "Expenses/expense_head.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def expense_head_delete(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "expense_head_delete" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            expense_head=ExpenseHead.objects.get(id=pk)
            expense_head_branch_id = expense_head.branch.id
            if int(expense_head_branch_id) == int(branch_id):                        
                ExpenseHead.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/expense_head")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


# Attendance
@login_required
@user_type_required("Staff")
def student_attendance(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "student_period_attendance_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)

            class_records = Class.objects.filter(branch=branch_id)
            section_records = Section.objects.filter(branch=branch_id)
            if request.POST.get("search") == "search":
                classs = request.POST.get("class")
                section = request.POST.get("section")
                attendance_date = request.POST.get("attendance_date")
                filters = {}
                if classs:
                    filters["Class"] = classs
                if section:
                    filters["section"] = section
                records = StudentAdmission.objects.filter(
                    **filters, session=request.Session,branch_id = branch_id
                )
                attendance_records = StudentAttendance.objects.filter(
                    student_id__in=records.values("id"), attendance_date=attendance_date,branch_id = branch_id
                )

                context = {
                    "student_attendance": "active",
                    "records": records,
                    "class_records": class_records,
                    "section_records": section_records,
                    "attendance_date": attendance_date,
                    "attendance_records": attendance_records,
                }
                return render(request, "Attendance/student_attendance.html", context)
            if request.POST.get("all_save") == "all_save":
                student_id = request.POST.getlist("student_id")
                for data in student_id:
                    print(request.POST.get(f"attendance{data}"))
                    holiday = request.POST.get("holiday")
                    if request.POST.get(f"attendance{data}") or holiday:
                        edit_stu = StudentAttendance.objects.filter(
                            student=data,
                            attendance_date=request.POST.get("attendance_date1"),branch_id = branch_id
                        ).last()
                        print('edit_stu',edit_stu)
                        if holiday:
                            attendance_status = "Holiday"
                        else:
                            attendance_status = request.POST.get(f"attendance{data}")
                        if edit_stu:
                            edit_stu.attendance_status = attendance_status
                            edit_stu.note = request.POST.get(f"note{data}")
                            edit_stu.branch_id = branch_id
                            edit_stu.save()
                        else:
                            print("save")
                            StudentAttendance.objects.create(
                                student_id=data,
                                attendance_status=attendance_status,
                                attendance_date=request.POST.get("attendance_date1"),
                                note=request.POST.get(f"note{data}"),
                                branch_id = branch_id
                            )
                messages.success(request, "Record Saved Successfully")
                return redirect("student_attendance")
            context = {
                "student_attendance": "active",
                "class_records": class_records,
                "section_records": section_records,
            }
            return render(request, "Attendance/student_attendance.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def approve_leave(request):
    if request.user.is_superuser or request.user.is_school_admin or "approve_leave_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            class_records = Class.objects.filter(branch=branch_id)
            section_records = Section.objects.filter(branch=branch_id)
            records = Addleave.objects.filter(session=request.Session)
            if request.POST.get("search") == "search":
                classs = request.POST.get("class")
                section = request.POST.get("section")
                filters = {}
                if classs:
                    filters["Class"] = classs
                if section:
                    filters["section"] = section
                stu = StudentAdmission.objects.filter(
                    **filters, session=request.Session,branch_id=branch_id
                )
                records = Addleave.objects.filter(
                    student__in=stu.values("id"), session=request.Session,branch_id=branch_id
                )
            form = AddleaveForm()
            if request.method == "POST":
                form = AddleaveForm(request.POST)
                if form.is_valid():
                    instance = form.save(commit=False)
                    instance.session = request.Session
                    instance.created_by = request.user
                    instance.branch_id = branch_id
                    instance.save()
                    return HttpResponseRedirect("/approve_leave")
            context = {
                "form": form,
                "records": records,
                "approve_leave": "active",
                "class_records": class_records,
                "section_records": section_records,
            }
            return render(request, "Attendance/approve_leave.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def leave_approve_disappove(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "approve_leave_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Addleave.objects.get(id=pk)
            data_branch_id = records.branch.id
            print("data_branch",data_branch_id)
            if int(data_branch_id) == int(branch_id):
                if records.status == "disapprove":
                    records.status = "approve"
                    records.approved_by = request.user
                    messages.success(request, "Record Saved Successfully")
                elif records.status == "approve":
                    records.status = "disapprove"
                    messages.success(request, "Record Saved Successfully")
                records.save()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            return redirect("approve_leave")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def approve_leave_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "approve_leave_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)   
            records = Addleave.objects.filter(branch=branch_id)
            record = Addleave.objects.get(id=pk)
            data_school_id = record.branch.id
            print("data_school_id@@@",data_school_id) 
            form = AddleaveForm(instance=record)
            if request.method == "POST":
                form = AddleaveForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_school_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    return HttpResponseRedirect("/approve_leave")
            context = {"form": form, "records": records, "approve_leave": "active"}
            return render(request, "Attendance/approve_leave_edit.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def approve_leave_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "approve_leave_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Addleave.objects.filter(branch=branch_id)
            record = Addleave.objects.get(id=pk)
            form = AddleaveForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "approve_leave": "active",
                "view": True,
            }
            return render(request, "Attendance/approve_leave_edit.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def approve_leave_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "approve_leave_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name) 
            add_leave=Addleave.objects.get(id=pk)
            add_leave_school_id = add_leave.branch.id
            if int(add_leave_school_id) == int(branch_id):                        
                Addleave.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            return HttpResponseRedirect("/approve_leave")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def attendance_by_date(request):
    if request.user.is_superuser or request.user.is_school_admin or "attendance_by_date_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            class_records = Class.objects.filter(branch=branch_id)
            section_records = Section.objects.filter(branch=branch_id)
            if request.POST.get("search") == "search":
                classs = request.POST.get("class")
                section = request.POST.get("section")
                attendance_date = request.POST.get("attendance_date")
                filters = {}
                if classs:
                    filters["Class"] = classs
                if section:
                    filters["section"] = section
                if branch_id:
                    filters["branch_id"] = branch_id    
                records = StudentAdmission.objects.filter(
                    **filters, session=request.Session
                )
                attendance_records = StudentAttendance.objects.filter(
                    attendance_date=attendance_date, student__in=records.values("id"),branch_id=branch_id
                )
                context = {
                    "attendance_by_date": "active",
                    "records": records,
                    "class_records": class_records,
                    "attendance_records": attendance_records,
                    "section_records": section_records,
                    "attendance_date": attendance_date,
                }
                return render(request, "Attendance/attendance_by_date.html", context)
            context = {
                "attendance_by_date": "active",
                "class_records": class_records,
                "section_records": section_records,
            }
            return render(request, "Attendance/attendance_by_date.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


# Examinations


@login_required
@user_type_required("Staff")
def exam_group(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "exam_group_add" in request.permissions
        or "exam_group_view" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            exam_group = examGroup.objects.filter(branch=branch_id)
            records = []
            for data in exam_group:
                dict = {}
                total = AddExam.objects.filter(
                    exam_group=data.id, session=request.Session
                ).count()
                dict["id"] = data.id
                dict["name"] = data.name
                dict["exam_type"] = data.exam_type.name
                dict["description"] = data.description
                dict["exam_count"] = total
                dict["branch_id"]  = branch_id
                records.append(dict)
            print('records',records)    
            form = examGroupForm()
            if request.method == "POST":
                form = examGroupForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()
                    return HttpResponseRedirect("/exam_group")
            context = {"form": form, "records": records, "exam_group": "active"}
            return render(request, "Examinations/exam_group.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def exam_group_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "exam_group_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = examGroup.objects.filter(branch=branch_id)
            record = examGroup.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = examGroupForm(instance=record)
            if request.method == "POST":
                form = examGroupForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/exam_group")
            context = {
                "form": form,
                "records": records,
                "exam_group": "active",
                "edit": True,
            }
            return render(request, "Examinations/exam_group.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def exam_group_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "exam_group_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = examGroup.objects.filter(branch=branch_id)
            record = examGroup.objects.get(id=pk)
            form = examGroupForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "exam_group": "active",
                "view": True,
            }
            return render(request, "Examinations/exam_group.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def exam_group_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "exam_group_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            examgroup=examGroup.objects.get(id=pk)
            examgroup_branch_id = examgroup.branch.id
            if int(examgroup_branch_id) == int(branch_id):                        
                examGroup.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")

            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/exam_group")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def exam_schedule(request):
    if request.user.is_superuser or request.user.is_school_admin or "exam_schedule_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            exam_group = examGroup.objects.filter(branch=branch_id)
            if request.method == "POST":
                records = AddExamSubject.objects.filter(exam=request.POST.get("exam"),branch_id=branch_id)
                context = {
                    "exam_schedule": "active",
                    "exam_group": exam_group,
                    "records": records,
                }
                return render(request, "Examinations/exam_schedule.html", context)
            context = {"exam_schedule": "active", "exam_group": exam_group}
            return render(request, "Examinations/exam_schedule.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
def exam_js(request):
    exam_records = AddExam.objects.filter(
        exam_group=request.GET.get("exam_group"), session=request.Session
    ).values("id", "Exam")
    return JsonResponse(data=list(exam_records), safe=False)


@login_required
@user_type_required("Staff")
def exam_result(request):
    # if request.user.is_superuser or request.user.is_school_admin or "exam_result_view" in request.permissions:
    #     try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            exam_group = examGroup.objects.filter(branch=branch_id)
            class_records = Class.objects.filter(branch=branch_id)
            session_records = Session.objects.filter(branch=branch_id)
            if request.method == "POST":
                exams = AddExamSubject.objects.filter(exam=request.POST.get("exam"),branch_id=branch_id)
                student = ExamStudent.objects.filter(
                    Class=request.POST.get("class"),
                    section=request.POST.get("section"),
                    exam=request.POST.get("exam"),
                    branch_id=branch_id
                )
                print("student---",student)
                records = EntryMarks.objects.filter(
                    student__Class=request.POST.get("class"),
                    student__section=request.POST.get("section"),
                    exam=request.POST.get("exam"),
                    branch_id=branch_id
                )
                print("records---",records)
                listt = []
                for data in student:
                    total_mark = 0
                    total = 0
                    mark_list = []
                    results = []
                    for sub in exams:
                        dict = {}
                        mark = EntryMarks.objects.filter(
                            exam_subject=sub, exam_student=data,branch_id=branch_id
                        ).last()
                        dic = {}
                        if mark:
                            dic["subject"] = mark.subject
                            total_mark += mark.marks
                            if mark.marks <= sub.marks_min:
                                results.append("Fail")
                                dic["marks"] = f"{mark.marks} (F)"
                            else:
                                results.append("Pass")
                                dic["marks"] = mark.marks
                        else:
                            dic["subject"] = sub.subject
                            dic["marks"] = ""
                            results.append(None)
                        total += sub.marks_max
                        mark_list.append(dic)
                        print("mark_list++++",mark_list)
                    dict["mark_list"] = mark_list
                    dict["obj"] = data
                    dict["total"] = f"{total_mark}/{int(total)}"
                    dict["percentage"] = int(total_mark * 100 / int(total))
                    dict["result"] = results
                    print("dic+++",dict)
                    grad_record = AddGrade.objects.filter(
                        exam_type_id=data.exam.exam_group.exam_type.id
                    )
                    print("grad_record===",grad_record)
                    dict["grade"] = ""
                    percentage = float(dict["percentage"])
                    for grad in grad_record:
                        print(grad.percent_from,type(grad.percent_up_to),type(percentage), grad.percent_from >= percentage,grad.percent_up_to <= percentage)
                        if (
                            grad.percent_from >= percentage
                            and grad.percent_up_to <= percentage
                        ):
                            dict["grade"] = grad.grade_name 

                    listt.append(dict)
                    print("dic-000",dict)
                context = {
                    "exam_result": "active",
                    "exam_group": exam_group,
                    "class_records": class_records,
                    "session_records": session_records,
                    "exams": exams,
                    "records": records,
                    "listt": listt,
                }
                return render(request, "Examinations/exam_result.html", context)
            context = {
                "exam_result": "active",
                "exam_group": exam_group,
                "class_records": class_records,
                "session_records": session_records,
            }
            return render(request, "Examinations/exam_result.html", context)
    #     except Exception as error:
    #         return render(request, "error.html", {"error": error})
    # else:
    #     return redirect("dashboard")


@login_required
@user_type_required("Staff")
def design_admit_card(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "design_admit_card_view" in request.permissions
        or "design_admit_card_add" in request.permissions
        or "design_admit_card_edit" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)

            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branddch_name@@@",branch_name)
            records = AdmitCard.objects.filter(branch=branch_id)
            form = AdmitCardForm()
            if request.method == "POST":
                print('dfghjkiujhgvty',request.POST,"jhjkywqejhyetguygu", request.FILES)
                form = AdmitCardForm(request.POST, request.FILES)   
                print('kjuikjuikjuikjui',form.is_valid())
                if form.is_valid():
                    obj=form.save()       
                    obj.branch_id = branch_id
                    obj.save()                     
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/design_admit_card")
                else:
                    print('gggthstsgs',form.errors)
            context = {"form": form, "records": records, "design_admit_card": "active"}
            print("hghghghghghgh",records)
            return render(request, "Examinations/design_admit_card.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def design_admit_card_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "design_admit_card_edit" in request.permissions:
        try:
            if True:
                
                branch_name = request.session.get('branch_id', None)
                if branch_name:
                    branch_id = branch_name    
                    print("branch_id@@@",branch_id)   
                else:
                    branch_id = None  
                    print("branch_name@@@",branch_name)
                records = AdmitCard.objects.filter(branch=branch_id)
                record = AdmitCard.objects.get(id=pk)
                data_branch_id = record.branch.id
                print("data_branch_id===",data_branch_id)   
                data_branch_id = record.branch.id
                form = AdmitCardForm(instance=record)
                if request.method == "POST":
                    form = AdmitCardForm(request.POST, instance=record)
                    if form.is_valid():
                        if branch_id == data_branch_id:
                            form.save()
                        else:
                            form.instance.branch_id = branch_id
                        form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/design_admit_card")
                context = {
                    "form": form,
                    "records": records,
                    "design_admit_card": "active",
                    "record": record,
                    "edit": True,
                }
                return render(request, "Examinations/design_admit_card_edit.html", context)
        except Exception as error:
           return render(request,'error.html',{'error':error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def design_admit_card_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "design_admit_card_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = AdmitCard.objects.filter(branch=branch_id)
            record = AdmitCard.objects.get(id=pk)
            print("record",record)
            form = AdmitCardForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "design_admit": "active",
                "view": True,
                "record": record,
            }
            return render(request, "Examinations/design_admit_card_view.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def design_admit_card_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "design_admit_card_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name  
                print("branch_id@@@",branch_id)     
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            admit_card=AdmitCard.objects.get(id=pk)       
            print("admit_card===",admit_card.branch)     
            admit_card_branch_id = admit_card.branch.id
            print("admit_card_id===",admit_card_branch_id)
            if int(admit_card_branch_id) == int(branch_id):                        
                AdmitCard.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/design_admit_card")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def print_admit_card(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    eaxm_records = examGroup.objects.filter(branch=branch_id)
    session_records = Session.objects.filter(branch=branch_id)
    class_records = Class.objects.filter(branch=branch_id)
    admit_card_records = AdmitCard.objects.filter(branch=branch_id)
    if request.method == "POST":
        exam = request.POST.get("exam")
        print("exam---",exam)
        admit_card = request.POST.get("admit_card")
        print("admit_card---",admit_card)
        records = ExamStudent.objects.filter(
            exam=exam,
            student__session=request.POST.get("session"),
            Class=request.POST.get("class"),
            section=request.POST.get("section"),
            branch_id=branch_id
        )
        print("records---",records)
        context = {
            "print_admit_card": "active",
            "eaxm_records": eaxm_records,
            "session_records": session_records,
            "class_records": class_records,
            "records": records,
            "admit_card_records": admit_card_records,
            "exam": exam,
            "admit_card": admit_card,
        }
        return render(request, "Examinations/print_admit_card.html", context)
    context = {
        "print_admit_card": "active",
        "eaxm_records": eaxm_records,
        "session_records": session_records,
        "class_records": class_records,
        "admit_card_records": admit_card_records,
    }
    return render(request, "Examinations/print_admit_card.html", context)


@login_required
@user_type_required("Staff")
def printing_admit_card(request):
    admit_card = AdmitCard.objects.get(id=request.POST.get("admit_card"))

    student_records = StudentAdmission.objects.filter(
        id__in=request.POST.getlist("checkbox")
    )
    exam_sub = AddExamSubject.objects.filter(exam=request.POST.get("exam"))
    records = []
    for data in student_records:
        dict = {}
        exam_mark = EntryMarks.objects.filter(student=data)
        dict["student_obj"] = data
        dict["marks"] = exam_mark
        records.append(dict)
    print(records)
    context = {
        "print_admit_card": "active",
        "records": records,
        "data": admit_card,
        "exam_sub": exam_sub,
    }
    return render(request, "Examinations/printing_admit_card.html", context)


@login_required
@user_type_required("Staff")
def design_marksheet(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "design_marksheet_add" in request.permissions
        or "design_marksheet_view" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = DesignMarkSheet.objects.filter(branch=branch_id)
            form = DesignMarkSheetForm()
            if request.method == "POST":
                form = DesignMarkSheetForm(request.POST, request.FILES)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/design_marksheet")
            context = {"form": form, "records": records, "design_marksheet": "active"}
            return render(request, "Examinations/design_marksheet.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def design_marksheet_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "design_marksheet_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = DesignMarkSheet.objects.filter(branch=branch_id)
            record = DesignMarkSheet.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = DesignMarkSheetForm(instance=record)
            if request.method == "POST":
                form = DesignMarkSheetForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/design_marksheet")
            context = {
                "form": form,
                "records": records,
                "design_marksheet": "active",
                "record": record,
                "edit": True,
            }
            return render(request, "Examinations/design_marksheet_edit.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def design_marksheet_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "design_admit_card_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = DesignMarkSheet.objects.filter(branch=branch_id)
            record = DesignMarkSheet.objects.get(id=pk)
            form = DesignMarkSheetForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "design_marksheet": "active",
                "view": True,
                "record": record,
            }
            return render(request, "Examinations/design_marksheet.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def design_marksheet_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "design_marksheet_delete":
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            design_mark_sheet=DesignMarkSheet.objects.get(id=pk)
            design_mark_sheet_id = design_mark_sheet.branch.id
            if int(design_mark_sheet_id) == int(branch_id):                        
                DesignMarkSheet.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/design_marksheet")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")

      


@login_required
@user_type_required("Staff")
def print_marksheet(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
    print("branch_name@@@",branch_name)
    eaxm_records = examGroup.objects.filter(branch=branch_id)
    session_records = Session.objects.filter(branch=branch_id)
    class_records = Class.objects.filter(branch=branch_id)
    marksheet_records = DesignMarkSheet.objects.filter(branch=branch_id)
    if request.method == "POST":
        exam = request.POST.get("exam")
        admit_card = request.POST.get("admit_card")
        records = ExamStudent.objects.filter(
            exam=exam,
            student__session=request.POST.get("session"),
            Class=request.POST.get("class"),
            section=request.POST.get("section"),
            branch_id = branch_id
        )
        context = {
            "print_marksheet": "active",
            "eaxm_records": eaxm_records,
            "session_records": session_records,
            "class_records": class_records,
            "marksheet_records": marksheet_records,
            "records": records,
            "exam": exam,
            "admit_card": admit_card,
        }
        return render(request, "Examinations/print_marksheet.html", context)
    context = {
        "print_marksheet": "active",
        "eaxm_records": eaxm_records,
        "session_records": session_records,
        "class_records": class_records,
        "marksheet_records": marksheet_records,
    }
    return render(request, "Examinations/print_marksheet.html", context)


@login_required
@user_type_required("Staff")
def printing_marksheet(request):
    marksheet = DesignMarkSheet.objects.get(id=request.POST.get("admit_card"))
    print("MARKSHEET =", marksheet)

    student_records = StudentAdmission.objects.filter(
        id__in=request.POST.getlist("checkbox")
    )
    print("student_records ===", student_records)

    exam_sub = AddExamSubject.objects.filter(exam=request.POST.get("exam"))
    print("exam_sub =", exam_sub)

    records = []
    for data in student_records:

        dict = {}
        print("\n---- Processing Student:", data, "----")

        exam_mark = EntryMarks.objects.filter(student=data)
        print("exam_mark =", exam_mark)

        dict["student_obj"] = data
        print("student_obj =", dict["student_obj"])

        dict["marks"] = exam_mark
        print("marks =", dict["marks"])

        # FIXED: total = 0 if total is None
        total = exam_mark.aggregate(Sum("marks")).get("marks__sum")
        print("RAW total from DB =", total)

        if total is None:
            total = 0
            print("Total was None  set to 0")

        dict["total"] = total
        print("total =", dict["total"])

        # FIXED: Avoid num2words(None) error
        dict["total_in_words"] = num2words(dict["total"]).upper()
        print("total_in_words =", dict["total_in_words"])

        first_mark = exam_mark.first()
        print("first_mark =", first_mark)
        if first_mark != None:
            grad_record = AddGrade.objects.filter(
            exam_type=first_mark.exam.exam_groupexam_type
             ) 
            print("grad_record =", grad_record)

            max_marks = exam_mark.aggregate(Sum("exam_subject__marks_max")).get(
                "exam_subject__marks_max__sum"
            )
            print("RAW max_marks =", max_marks)

            if max_marks is None or max_marks == 0:
                max_marks = 1  # prevent division by zero
                print("max_marks was None/0  set to 1")

            dict["percentage"] = int(dict["total"] * 100 / int(max_marks))
            print("percentage =", dict["percentage"])

            dict["grade"] = ""
            for grad in grad_record:
                print("Checking grade:", grad.percent_from, "-", grad.percent_up_to)
                if grad.percent_from <= dict["percentage"] <= grad.percent_up_to:
                    dict["grade"] = grad.grade_name
                    print("GRADE MATCHED:", dict["grade"])
                    break

            records.append(dict)
            print("Student dict appended:", dict)

    context = {
        "print_admit_card": "active",
        "records": records,
        "data": marksheet,
        "exam_sub": exam_sub,
    }
    print("\nFINAL CONTEXT =", context)

    return render(request, "Examinations/printing_marksheet.html", context)


    # grade


@login_required
@user_type_required("Staff")
def marks_grade(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
    print("branch_name@@@",branch_name)
    records = AddGrade.objects.filter(branch=branch_id)
    form = AddGradeForm()
    if request.method == "POST":
        form = AddGradeForm(request.POST)
        if form.is_valid():
            obj=form.save()
            obj.branch_id = branch_id
            obj.save()
            messages.success(request, "Record Saved Successfully")
            return HttpResponseRedirect("/marks_grade")
    context = {"form": form, "records": records, "marks_grade": "active"}
    return render(request, "Examinations/marks_grade.html", context)


@login_required
@user_type_required("Staff")
def marks_grade_edit(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    records = AddGrade.objects.filter(branch=branch_id)
    record = AddGrade.objects.get(id=pk)
    data_branch_id = record.branch.id
    form = AddGradeForm(instance=record)
    if request.method == "POST":
        form = AddGradeForm(request.POST, instance=record)
        if form.is_valid():
            if branch_id == data_branch_id:
                form.save()
            else:
                form.instance.branch_id = branch_id
            form.save()
            return HttpResponseRedirect("/marks_grade")
    context = {"form": form, "records": records, "marks_grade": "active"}
    return render(request, "Examinations/marks_grade_edit.html", context)


@login_required
@user_type_required("Staff")
def marks_grade_view(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    records = AddGrade.objects.filter(branch=branch_id)
    record = AddGrade.objects.get(id=pk)
    form = AddGradeForm(instance=record)
    context = {"form": form, "records": records, "marks_grade": "active", "view": True}
    return render(request, "Examinations/marks_grade_edit.html", context)


@login_required
@user_type_required("Staff")
def marks_grade_delete(request, pk):
    try:
        branch_name = request.session.get('branch_id', None)
        if branch_name:
            branch_id = branch_name       
        else:
            branch_id = None  
        print("branch_name@@@",branch_name)
        add_grade=AddGrade.objects.get(id=pk)
        add_grade_id = add_grade.branch.id
        if int(add_grade_id) == int(branch_id):                        
                AddGrade.objects.get(id=pk).delete()
        else:
            messages.error(request, "School id Doesn't match record no delete")
        messages.error(request, "Record Deleted Successfully")
        return HttpResponseRedirect("/marks_grade")
    except Exception as error:
            return render(request, "error.html", {"error": error})


# assign subject


@login_required
@user_type_required("Staff")
def assign_subject(request):
    records = AssignSubject.objects.filter(branch=branch_id)
    subject_records = Subjects.objects.filter(branch=branch_id)
    form = AssignSubjectForm()
    if request.method == "POST":
        form = AssignSubjectForm(request.POST)
        if form.is_valid():
            form.save()
            messages.success(request, "Record Saved Successfully")
            return HttpResponseRedirect("/assign_subject")
        else:
            messages.error(request, "Record not saved")
            return redirect("assign_subject")

    context = {
        "form": form,
        "records": records,
        "subject_records": subject_records,
        "marks_grade": "active",
    }
    return render(request, "Examinations/assign_subject.html", context)


@login_required
@user_type_required("Staff")
def assign_subject_edit(request, pk):
    records = AssignSubject.objects.filter(branch=branch_id)
    record = AssignSubject.objects.get(id=pk)
    form = AssignSubjectForm(instance=record)
    if request.method == "POST":
        form = AssignSubjectForm(request.POST, instance=record)
        if form.is_valid():
            form.save()
            return HttpResponseRedirect("/assign_subject")
    context = {"form": form, "records": records, "marks_grade": "active"}
    return render(request, "Examinations/assign_subject_edit.html", context)


@login_required
@user_type_required("Staff")
def assign_subject_view(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    records = AssignSubject.objects.filter(branch=branch_id)
    record = AssignSubject.objects.get(id=pk)
    form = AssignSubjectForm(instance=record)
    context = {"form": form, "records": records, "marks_grade": "active", "view": True}
    return render(request, "Examinations/assign_subject_edit.html", context)


@login_required
@user_type_required("Staff")
def assign_subject_delete(request, pk):
    AssignSubject.objects.get(id=pk).delete()
    return HttpResponseRedirect("/assign_subject")


@login_required
@user_type_required("Staff")
def online_exam(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    records = OnlineExam.objects.filter(branch=branch_id)
    form = OnlineExamForm()
    if request.method == "POST":
        form = OnlineExamForm(request.POST)
        if form.is_valid():
            form.save()
            return HttpResponseRedirect("/online_exam")
        else:
            print(form.errors)
    context = {"form": form, "records": records, "online_exam": "active"}
    return render(request, "OnlineExamination/online_exam.html", context)


@login_required
@user_type_required("Staff")
def online_exam_edit(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    records = OnlineExam.objects.filter(branch=branch_id)
    record = OnlineExam.objects.get(id=pk)
    form = OnlineExamForm(instance=record)
    if request.method == "POST":
        form = OnlineExamForm(request.POST, instance=record)
        if form.is_valid():
            form.save()
            return HttpResponseRedirect("/online_exam")
    context = {"form": form, "records": records, "online_exam": "active"}
    return render(request, "OnlineExamination/online_exam_edit.html", context)


@login_required
@user_type_required("Staff")
def online_exam_view(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    records = OnlineExam.objects.filter(branch=branch_id)
    record = OnlineExam.objects.get(id=pk)
    form = OnlineExamForm(instance=record)
    context = {"form": form, "records": records, "online_exam": "active", "view": True}
    return render(request, "OnlineExamination/online_exam_edit.html", context)


@login_required
@user_type_required("Staff")
def online_exam_delete(request, pk):
    OnlineExam.objects.get(id=pk).delete()
    return HttpResponseRedirect("/online_exam")


@login_required
@user_type_required("Staff")
def question_bank(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "online_admission_view" in request.permissions
        or "online_admission_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = QuestionBank.objects.filter(branch=branch_id)
            form = QuestionBankForm()
            if request.method == "POST":
                form = QuestionBankForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/question_bank")
            context = {"form": form, "records": records, "question_bank": "active"}
            return render(request, "OnlineExamination/question_bank.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return render(request, "error.html")


@login_required
@user_type_required("Staff")
def question_bank_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "online_admission_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)

            records = QuestionBank.objects.filter(branch=branch_id)
            record = QuestionBank.objects.get(id=pk)
            question_bank = record.branch.id
            form = QuestionBankForm(instance=record)
            if request.method == "POST":
                form = QuestionBankForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == question_bank:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/question_bank")
            context = {
                "form": form,
                "records": records,
                "question_bank": "active",
                "edit": True,
            }
            return render(request, "OnlineExamination/question_bank.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return render(request, "error.html")


@login_required
@user_type_required("Staff")
def question_bank_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "online_admission_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = QuestionBank.objects.filter(branch=branch_id)
            record = QuestionBank.objects.get(id=pk)
            form = QuestionBankForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "question_bank": "active",
                "view": True,
            }
            return render(request, "OnlineExamination/question_bank.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return render(request, "error.html")


@login_required
@user_type_required("Staff")
def question_bank_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "online_admission_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            question_bank=QuestionBank.objects.get(id=pk)
            question_bank_school_id = question_bank.branch.id
            if int(question_bank_school_id) == int(branch_id):                        
                QuestionBank.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/question_bank")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return render(request, "error.html")


# Lesson Plan


def get_week_dates(year, week_number):
    # Calculate the date of the first day of the year
    first_day_of_year = datetime(year, 1, 1)

    # Calculate the date of the first day of the requested week
    days_offset = (week_number - 1) * 7
    first_day_of_week = first_day_of_year + timedelta(days=days_offset)

    # Create a list to hold all the dates of the week
    week_dates = []

    # Calculate the dates for the rest of the week
    for i in range(1, 8):
        next_day = first_day_of_week + timedelta(days=i)
        week_dates.append(next_day)

    return week_dates


@login_required
@user_type_required("Staff")  # manage_lesson_plan Pending
def manage_lesson_plan(request):
    if request.user.is_superuser or request.user.is_school_admin or "online_admission_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            staff_records = AddStaff.objects.filter(roles__name__icontains="teacher")
            if request.method == "POST":
                lesson_records = Lesson.objects.filter(branch=branch_id)
                topic_records = topic.objects.filter(branch=branch_id)
                teacher = request.POST.get("teacher")
                week = request.POST.get("week_days")
                week_split = week.split("-")
                print("week_split---",week_split)
                year = int(week_split[0])
                print("year---",year)
                week_number = int(week_split[1][1:])
                print("week_number---",week_number)
                dates_in_week = get_week_dates(year, week_number)
                print("dates_in_week---",dates_in_week)
                TimeTable_records = TimeTable.objects.filter(
                    teacher=teacher, session=request.Session,branch_id = branch_id
                )
                week_days = [
                    "Monday",
                    "Tuesday",
                    "Wednesday",
                    "Thursday",
                    "Friday",
                    "Saturday",
                    "Sunday",
                ]
                Monday = []
                Tuesday = []
                Wednesday = []
                Thursday = []
                Friday = []
                Saturday = []
                Sunday = []
                week_no = 0
                for days in week_days:
                    time_table_record = TimeTable_records.filter(day=days,branch_id = branch_id)
                    for data in time_table_record:
                        lesson_plan = LessonPlan.objects.filter(
                            time_table=data, date=dates_in_week[week_no].date(),branch_id = branch_id).last()
                        if week_no == 0:
                            if lesson_plan:
                                Monday.append(["Edit", lesson_plan])
                            else:
                                Monday.append(["Add", data])
                        elif week_no == 1:
                            if lesson_plan:
                                Tuesday.append(["Edit", lesson_plan])
                            else:
                                Tuesday.append(["Add", data])
                        elif week_no == 2:
                            if lesson_plan:
                                Wednesday.append(["Edit", lesson_plan])
                            else:
                                Wednesday.append(["Add", data])
                        elif week_no == 3:
                            if lesson_plan:
                                Thursday.append(["Edit", lesson_plan])
                            else:
                                Thursday.append(["Add", data])
                        elif week_no == 4:
                            if lesson_plan:
                                Friday.append(["Edit", lesson_plan])
                            else:
                                Friday.append(["Add", data])
                        elif week_no == 5:
                            if lesson_plan:
                                Saturday.append(["Edit", lesson_plan])
                            else:
                                Saturday.append(["Add", data])
                        elif week_no == 6:
                            if lesson_plan:
                                Sunday.append(["Edit", lesson_plan])
                            else:
                                Sunday.append(["Add", data])
                    print(Monday)
                    week_no += 1
                context = {
                    "manage_lesson_plan": "active",
                    "staff_records": staff_records,
                    "TimeTable_records": TimeTable_records,
                    "lesson_records": lesson_records,
                    "topic_records": topic_records,
                    "dates_in_week": dates_in_week,
                    "Monday": Monday,
                    "Tuesday": Tuesday,
                    "Wednesday": Wednesday,
                    "Thursday": Thursday,
                    "Friday": Friday,
                    "Saturday": Saturday,
                    "Sunday": Sunday,
                    "teacher": int(teacher),
                    "week": week,
                }
                return render(request, "Lesson_plan/manage_lesson_plan.html", context)
            context = {"manage_lesson_plan": "active", "staff_records": staff_records}
            return render(request, "Lesson_plan/manage_lesson_plan.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return render(request, "error.html")


@login_required
def manage_lesson_topic_js(request):
    records = topic.objects.filter(lesson_name=request.GET.get("lesson_id"))
    print(records)
    return JsonResponse(data=list(records.values("id", "topic_name")), safe=False)


@login_required
def edit_manage_lesson_js(request):
    records = LessonPlan.objects.get(id=request.GET.get("pk"))
    data = {
        "id": records.id,
        "lesson": records.lesson.id,
        "topic": records.topic.id,
        "lesson_name": records.lesson.lesson_name,
        "topic_name": records.topic.topic_name,
        "sub_topic": records.sub_topic,
        "time_from": records.time_table.time_from,
        "time_to": records.time_table.time_to,
        "time_table": records.time_table.id,
        "date": records.date,
        "teaching_method": records.teaching_method,
        "general_objectives": records.general_objectives,
        "pervious_knowledge": records.pervious_knowledge,
        "comprehensive_questions": records.comprehensive_questions,
        "presentation": records.presentation,
        "class": records.time_table.Class.Class,
        "section": records.time_table.section.section_name,
        "subject": records.time_table.subject.subject_name,
    }
    return JsonResponse(data)


@login_required
@user_type_required("Staff")
def manage_lesson_save(request):
    lesson_plan_id = request.POST.get("lesson_plan_id")
    print(lesson_plan_id)
    if lesson_plan_id:
        record = LessonPlan.objects.get(id=lesson_plan_id)
        record.lesson_id = request.POST.get("lesson")
        record.topic_id = request.POST.get("topic")
        record.time_table_id = request.POST.get("timetable_id")
        record.sub_topic = request.POST.get("sub_topic")
        record.lecture_youtube_url = request.POST.get("lecture_youtube_url")
        if request.FILES.get("lecture_vedio"):
            record.lecture_vedio = request.FILES.get("lecture_vedio")
        if request.FILES.get("attachment"):
            record.attachment = request.FILES.get("attachment")
        record.teaching_method = request.POST.get("teaching_method")
        record.general_objectives = request.POST.get("general_objectives")
        record.pervious_knowledge = request.POST.get("pervious_knowledge")
        record.comprehensive_questions = request.POST.get("comprehensive_questions")
        record.presentation = request.POST.get("presentation")
        record.date = request.POST.get("date")
        record.save()
    else:
        print("else")
        LessonPlan.objects.create(
            lesson_id=request.POST.get("lesson"),
            topic_id=request.POST.get("topic"),
            time_table_id=request.POST.get("timetable_id"),
            sub_topic=request.POST.get("sub_topic"),
            lecture_youtube_url=request.POST.get("lecture_youtube_url"),
            lecture_vedio=request.FILES.get("lecture_vedio"),
            attachment=request.FILES.get("attachment"),
            teaching_method=request.POST.get("teaching_method"),
            general_objectives=request.POST.get("general_objectives"),
            pervious_knowledge=request.POST.get("pervious_knowledge"),
            comprehensive_questions=request.POST.get("comprehensive_questions"),
            presentation=request.POST.get("presentation"),
            date=request.POST.get("date"),
            created_by=request.user,
        )
    return redirect("manage_lesson_plan")


@login_required
@user_type_required("Staff")
def manage_lesson_delete(request, pk):
    LessonPlan.objects.get(id=pk).delete()
    return redirect("manage_lesson_plan")


@login_required
@user_type_required("Staff")
def lesson(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "lesson_view" in request.permissions
        or "lesson_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            class_records = Class.objects.filter(branch=branch_id)
            records = Lesson.objects.filter(branch=branch_id).order_by("subject")
            if request.method == "POST":
                classs = request.POST.get("Class")
                section = request.POST.get("section")
                subject_groups = request.POST.get("subject_group")
                subject = request.POST.get("subject")
                lesson_list = request.POST.getlist("lesson_name")
                for i in range(len(lesson_list)):
                    Lesson.objects.get_or_create(
                        Class_id=classs,
                        section_id=section,
                        subject_group_id=subject_groups,
                        subject_id=subject,
                        lesson_name=lesson_list[i],
                        branch_id = branch_id
                    )
                messages.success(request, "Record Saved Successfully")
                return HttpResponseRedirect("/lesson")

            context = {
                "records": records,
                "lesson": "active",
                "class_records": class_records,
            }
            return render(request, "Lesson_plan/lesson.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def lesson_edit(request, sub):
    if request.user.is_superuser or request.user.is_school_admin or "lesson_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            class_records = Class.objects.filter(branch=branch_id)
            record = Lesson.objects.filter(subject=sub)
            records = Lesson.objects.filter(branch=branch_id).order_by("subject")
            if request.method == "POST":
                classs = request.POST.get("Class")
                section = request.POST.get("section")
                subject_groups = request.POST.get("subject_group")
                subject = request.POST.get("subject")
                lesson_list = request.POST.getlist("lesson_name")
                new_lesson_list = request.POST.getlist("new_lesson_name")
                ids = request.POST.getlist("ids")
                for i in range(len(lesson_list)):
                    data = Lesson.objects.get(id=ids[i])
                    data.Class_id = classs
                    data.section_id = section
                    data.subject_group_id = subject_groups
                    data.subject_id = subject
                    data.lesson_name = lesson_list[i]
                    data.branch_id = branch_id
                    data.save()
                for i in range(len(new_lesson_list)):
                    Lesson.objects.get_or_create(
                        Class_id=classs,
                        section_id=section,
                        subject_group_id=subject_groups,
                        subject_id=subject,
                        lesson_name=new_lesson_list[i],
                        branch_id = branch_id
                    )
                messages.warning(request, "Record Updated Successfully")
                return HttpResponseRedirect("/lesson")
            context = {
                "record": record,
                "lesson": "active",
                "class_records": class_records,
                "records": records,
            }
            return render(request, "Lesson_plan/lesson_edit.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def lesson_view(request, sub):
    if request.user.is_superuser or request.user.is_school_admin or "lesson_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            class_records = Class.objects.filter(branch=branch_id)
            records = Lesson.objects.filter(branch=branch_id).order_by("subject")
            record = Lesson.objects.filter(subject=sub).order_by("subject")
            context = {
                "record": record,
                "lesson": "active",
                "view": True,
                "class_records": class_records,
                "records": records,
            }
            return render(request, "Lesson_plan/lesson_edit.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def lesson_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "lesson_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            data = Lesson.objects.get(id=pk)
            data_branch_id = data.branch.id
            if int(data_branch_id) == int(branch_id):  
                sub = data.subject.id
                data.delete()                      
            else:
                messages.error(request, "School id Doesn't match record no delete")           
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect(f"/lesson_edit/{sub}")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def lesson_bulk_delete(request, sub):
    Lesson.objects.filter(subject=sub).delete()
    return HttpResponseRedirect("/lesson")


@login_required
@user_type_required("Staff")
def topicc(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "topic_view" in request.permissions
        or "topic_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            class_records = Class.objects.filter(branch=branch_id)
            records = topic.objects.filter(branch=branch_id).order_by("lesson_name")
            if request.method == "POST":
                classs = request.POST.get("Class")
                section = request.POST.get("section")
                subject_groups = request.POST.get("subject_group")
                subject = request.POST.get("subject")
                lesson = request.POST.get("lesson")
                topic_list = request.POST.getlist("topic_name")
                for i in range(len(topic_list)):
                    topic.objects.get_or_create(
                        Class_id=classs,
                        section_id=section,
                        subject_group_id=subject_groups,
                        subject_id=subject,
                        lesson_name_id=lesson,
                        topic_name=topic_list[i],
                        branch_id = branch_id

                    )
                return HttpResponseRedirect("/topicc")
            context = {
                "records": records,
                "topicc": "active",
                "class_records": class_records,
            }
            return render(request, "Lesson_plan/topicc.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def topicc_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "topic_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            class_records = Class.objects.filter(branch=branch_id)
            records = topic.objects.filter(lesson_name=pk)
            if request.method == "POST":
                classs = request.POST.get("Class")
                section = request.POST.get("section")
                subject_groups = request.POST.get("subject_group")
                subject = request.POST.get("subject")
                lesson = request.POST.get("lesson")
                topic_list = request.POST.getlist("topic_name")
                ids = request.POST.getlist("ids")
                new_topic_list = request.POST.getlist("new_topic_name")
                for i in range(len(topic_list)):
                    obj = topic.objects.get(id=ids[i])
                    obj.Class_id = classs
                    obj.section_id = section
                    obj.subject_group_id = subject_groups
                    obj.subject_id = subject
                    obj.lesson_name_id = lesson
                    obj.topic_name = topic_list[i]
                    obj.branch_id = branch_id
                for i in range(len(new_topic_list)):
                    topic.objects.get_or_create(
                        Class_id=classs,
                        section_id=section,
                        subject_group_id=subject_groups,
                        subject_id=subject,
                        lesson_name_id=lesson,
                        topic_name=new_topic_list[i],
                        branch_id = branch_id
                    )
                return HttpResponseRedirect("/topicc")
            context = {
                "records": records,
                "topicc": "active",
                "class_records": class_records,
            }
            return render(request, "Lesson_plan/topicc_edit.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def topicc_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "topic_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            class_records = Class.objects.filter(branch=branch_id)
            records = topic.objects.filter(lesson_name=pk)
            context = {
                "records": records,
                "topic": "active",
                "view": True,
                "class_records": class_records,
            }
            return render(request, "Lesson_plan/topicc_edit.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def topicc_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "topic_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
                
            data = topic.objects.get(id=pk)
            topic_branch_id = data.branch.id
            if int(topic_branch_id) == int(branch_id):                        
                topic.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete") 
                return HttpResponseRedirect(f"/topicc_edit/{pk}")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def topic_bulk_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "topic_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            
            topiccc=topic.objects.filter(lesson_name=pk)
            topic_school_id = topiccc.branch.id
            if int(topic_school_id) == int(branch_id):                        
                topic.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            return HttpResponseRedirect("/topicc")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


# Academics


@login_required
@user_type_required("Staff")
def promote_students(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    class_records = Class.objects.filter(branch=branch_id)
    # PromoteStudent.objects.filter(branch=branch_id).delete()
    session_records = Session.objects.filter(branch=branch_id)
    if request.POST.get("search") == "search":
        classs = request.POST.get("class")
        section = request.POST.get("section")
        filters = {}
        if classs:
            filters["Class"] = classs
        if section:
            filters["section"] = section
        records = StudentAdmission.objects.filter(**filters, session=request.Session,branch_id=branch_id)
        print("records", records)
        student_list = []
        for stu in records:
            attendance_records = StudentAttendance.objects.filter(student_id=stu,branch_id=branch_id).last()
            if attendance_records:
                student_list.append([attendance_records, "1"])
            else:
                student_list.append([stu, "0"])
        context = {
            "promote_students": "active",
            "records": records,
            "class_records": class_records,
            "student_list": student_list,
            "session_records": session_records,
        }
        return render(request, "Academics/promote_students.html", context)
    if request.POST.get("all_save") == "all_save":
        print('saveeewe')
        student_id = request.POST.getlist("student_id")
        for data in student_id:
            print('data==',data)
            if request.POST.get(f"next_session_status{data}") == "continue":
                promoto_student = PromoteStudent.objects.filter(
                    student=data, session=request.POST.get("session"),branch_id=branch_id
                ).last()
                print('promoto_student',promoto_student)
                if not promoto_student:
                    PromoteStudent.objects.get_or_create(
                        student_id=data,
                        Class_id=request.POST.get("class"),
                        section_id=request.POST.get("section"),
                        session_id=request.POST.get("session"),
                        currrent_result=request.POST.get(f"current_result{data}"),
                        next_session_status=request.POST.get(
                            f"next_session_status{data}"
                        ),
                        branch_id=branch_id
                    )
                    obj = StudentAdmission.objects.get(id=data)
                    print('session ====',request.POST.get("session"))
                    StudentAdmission.objects.get_or_create(
                        admission_no=obj.admission_no,
                        roll_number=obj.roll_number,
                        Class_id=request.POST.get("class"),
                        section_id=request.POST.get("section"),
                        first_name=obj.first_name,
                        last_name=obj.last_name,
                        gender=obj.gender,
                        date_of_birth=obj.date_of_birth,
                        category=obj.category,
                        religion=obj.religion,
                        Caste=obj.Caste,
                        mobile_number=obj.mobile_number,
                        email=obj.email,
                        admission_date=obj.admission_date,
                        student_photo=obj.student_photo,
                        Blood_group=obj.Blood_group,
                        height=obj.height,
                        weight=obj.weight,
                        as_on_date=obj.as_on_date,
                        bank_account_number=obj.bank_account_number,
                        bank_name=obj.bank_name,
                        ifsc_code=obj.ifsc_code,
                        national_identification_number=obj.national_identification_number,
                        local_identification_number=obj.local_identification_number,
                        rte=obj.rte,
                        previous_school_detail=obj.previous_school_detail,
                        note=obj.note,
                        title_1=obj.title_1,
                        documents_1=obj.documents_1,
                        title_2=obj.title_2,
                        documents_2=obj.documents_2,
                        title_3=obj.title_3,
                        documents_3=obj.documents_3,
                        title_4=obj.title_4,
                        documents_4=obj.documents_4,
                        disable_date=obj.disable_date,
                        diable_reson=obj.diable_reson,
                        disable_note=obj.disable_note,
                        status=obj.status,
                        session_id=request.POST.get("session"),
                        user_student=obj.user_student,
                        user_parent=obj.user_parent,
                        created_by=obj.created_by,
                        created_at=obj.created_at,
                        branch_id = branch_id
                    )
        return redirect("promote_students")
    context = {"promote_students": "active", "class_records": class_records}
    return render(request, "Academics/promote_students.html", context)


# assign class teacher
@login_required
@user_type_required("Staff")
def assign_class_teacher(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "assign_class_teacher_view" in request.permissions
        or "assign_class_teacher_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            class_records = Class.objects.filter(branch=branch_id)
            class_teacher = AddStaff.objects.filter(branch=branch_id)
            records = AssignClassTeacher.objects.filter(session=request.Session,branch_id=branch_id)
            teacher = AddStaff.objects.filter(roles__name__icontains="teacher",branch_id=branch_id)
            form = AssignClassTeacherForm()
            if request.method == "POST":
                form = AssignClassTeacherForm(request.POST)
                if form.is_valid():
                    form.save()
                    obj = form.save(commit=False)
                    obj.session = request.Session
                    obj.branch_id=branch_id
                    obj.save()
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/assign_class_teacher")
            context = {
                "form": form,
                "records": records,
                "assign_class_teacher": "active",
                "teacher": teacher,
                "class_records": class_records,
                "class_teacher": class_teacher,
            }
            return render(request, "Academics/assign_class_teacher.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def assign_class_teacher_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "assign_class_teacher_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            class_records = Class.objects.filter(branch=branch_id)
            class_teacher = AddStaff.objects.filter(branch=branch_id)
            records = AssignClassTeacher.objects.filter(session=request.Session,branch_id=branch_id)
            teacher = AddStaff.objects.filter(roles__name__icontains="teacher",branch_id=branch_id)
            record = AssignClassTeacher.objects.get(id=pk)
            data_branch_id = record.branch.id
            lists = record.class_teacher.filter(branch=branch_id)
            list = [data.id for data in lists]
            assign_teacher = record.class_teacher.filter(branch=branch_id)
            form = AssignClassTeacherForm(instance=record)
            if request.method == "POST":
                form = AssignClassTeacherForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/assign_class_teacher")
            context = {
                "form": form,
                "records": records,
                "assign_class_teacher": "active",
                "teacher": teacher,
                "assign_teacher": assign_teacher,
                "edit": True,
                "list": list,
                "class_records": class_records,
                "class_teacher": class_teacher,
                "record": record,
            }
            return render(request, "Academics/assign_class_teacher.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def assign_class_teacher_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "assign_class_teacher_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            class_records = Class.objects.filter(branch=branch_id)
            class_teacher = AddStaff.objects.filter(branch=branch_id)
            records = AssignClassTeacher.objects.filter(session=request.Session)
            teacher = AddStaff.objects.filter(roles__name__icontains="teacher")
            record = AssignClassTeacher.objects.get(id=pk)
            lists = record.class_teacher.filter(branch=branch_id)
            list = [data.id for data in lists]
            form = AssignClassTeacherForm(instance=record)
            assign_teacher = record.class_teacher.filter(branch=branch_id)
            context = {
                "form": form,
                "AssignClassTeacher": "active",
                "view": True,
                "assign_teacher": assign_teacher,
                "teacher": teacher,
                "records": records,
                "class_records": class_records,
                "class_teacher": class_teacher,
                "list": list,
                "record": record,
            }
            return render(request, "Academics/assign_class_teacher.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def assign_class_teacher_delete(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "assign_class_teacher_delete" in request.permissions
    ):
        try:
            AssignClassTeacher.objects.get(id=pk).delete()
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/assign_class_teacher")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


# assign subject teacher
@login_required
@user_type_required("Staff")
def assign_subject_teacher(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "assign_class_teacher_view" in request.permissions
        or "assign_class_teacher_add" in request.permissions
    ):
        try:
            
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)         
            class_records = Class.objects.filter(branch=branch_id)
            class_teacher = AddStaff.objects.filter(branch=branch_id)
            subject_records = Subjects.objects.filter(branch=branch_id)
            records = AssignSubjectTeacher.objects.filter(session=request.Session)
            teacher = AddStaff.objects.filter(roles__name__icontains="teacher")
            form = AssignSubjectTeacherForm()
            if request.method == "POST":
                form = AssignSubjectTeacherForm(request.POST)
                if form.is_valid():
                    form.save()
                    obj = form.save(commit=False)
                    obj.session = request.Session
                    obj.save()
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/assign_subject_teacher")
            context = {
                "form": form,
                "records": records,
                "assign_class_teacher": "active",
                "teacher": teacher,
                "class_records": class_records,
                "subject_records": subject_records,
                "class_teacher": class_teacher,
            }
            return render(request, "Academics/assign_subject_teacher.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def assign_subject_teacher_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "assign_class_teacher_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            class_records = Class.objects.filter(branch=branch_id)
            class_teacher = AddStaff.objects.filter(branch=branch_id)
            records = AssignClassTeacher.objects.filter(session=request.Session)
            teacher = AddStaff.objects.filter(roles__name__icontains="teacher")
            record = AssignClassTeacher.objects.get(id=pk)
            lists = record.class_teacher.filter(branch=branch_id)
            list = [data.id for data in lists]
            assign_teacher = record.class_teacher.filter(branch=branch_id)
            form = AssignClassTeacherForm(instance=record)
            if request.method == "POST":
                form = AssignClassTeacherForm(request.POST, instance=record)
                if form.is_valid():
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/assign_class_teacher")
            context = {
                "form": form,
                "records": records,
                "assign_class_teacher": "active",
                "teacher": teacher,
                "assign_teacher": assign_teacher,
                "edit": True,
                "list": list,
                "class_records": class_records,
                "class_teacher": class_teacher,
                "record": record,
            }
            return render(request, "Academics/assign_class_teacher.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def assign_subject_teacher_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "assign_class_teacher_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            class_records = Class.objects.filter(branch=branch_id)
            class_teacher = AddStaff.objects.filter(branch=branch_id)
            records = AssignClassTeacher.objects.filter(session=request.Session)
            teacher = AddStaff.objects.filter(roles__name__icontains="teacher")
            record = AssignClassTeacher.objects.get(id=pk)
            lists = record.class_teacher.filter(branch=branch_id)
            list = [data.id for data in lists]
            form = AssignClassTeacherForm(instance=record)
            assign_teacher = record.class_teacher.filter(branch=branch_id)
            context = {
                "form": form,
                "AssignClassTeacher": "active",
                "view": True,
                "assign_teacher": assign_teacher,
                "teacher": teacher,
                "records": records,
                "class_records": class_records,
                "class_teacher": class_teacher,
                "list": list,
                "record": record,
            }
            return render(request, "Academics/assign_class_teacher.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def assign_subject_teacher_delete(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "assign_class_teacher_delete" in request.permissions
    ):
        try:
            AssignClassTeacher.objects.get(id=pk).delete()
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/assign_class_teacher")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
def section_js(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    class_id = request.GET.get("class_id")
    classs = Class.objects.get(id=class_id)
    section = classs.section.filter(branch=branch_id)
    return JsonResponse(data=list(section.values("id", "section_name")), safe=False)


def demo_js(request):
    role_id = request.GET.get("role_id")
    if not role_id:
        return JsonResponse({"error": "role_id parameter is required"}, status=400)

    classs = AddStaff.objects.filter(roles=role_id).select_related("department")
    return JsonResponse(
        data=list(classs.values("id", "first_name", "staff_id", "department__name")),
        safe=False
    )


@login_required
def subject_grp_js(request):
    classs = request.GET.get("class_id")
    suction_id = request.GET.get("section_id")
    subjectt = SubjectGroup.objects.filter(Class_id=classs, section_id=suction_id)
    return JsonResponse(data=list(subjectt.values("id", "name")), safe=False)


@login_required
def subject_js(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    classs = request.GET.get("class_id")
    suction_id = request.GET.get("section_id")
    subject_grp = request.GET.get("subject_grp_id")
    subjectss = SubjectGroup.objects.get(
        Class_id=classs, section_id=suction_id, id=subject_grp
    )
    subjecttt = subjectss.subject.filter(branch=branch_id)
    return JsonResponse(data=list(subjecttt.values("id", "subject_name")), safe=False)


@login_required
def topic_js(request):
    classs = request.GET.get("class_id")
    suction_id = request.GET.get("section_id")
    subject_grp = request.GET.get("subject_grp_id")
    subjectt = request.GET.get("subject")
    lessones = Lesson.objects.filter(
        Class_id=classs,
        section_id=suction_id,
        subject_group_id=subject_grp,
        subject_id=subjectt,
    )
    response_data = [
        {"id": lesson.id, "lesson_name": lesson.lesson_name} for lesson in lessones
    ]    
    return JsonResponse(response_data, safe=False)


@login_required
def student_report_js(request):
    classs = request.GET.get("class_id")
    suction_id = request.GET.get("section_id")
    category = request.GET.get("id_category")
    gender = request.GET.get("id_gender")
    subject = StudentAdmission.objects.filter(
        Class_id=classs, section_id=suction_id, category_id=category, gender_id=gender
    )
    return JsonResponse(data=list(subject.values("id", "rte")), safe=False)


@login_required
def leave_type_js(request):
    name = request.GET.get("name")
    leaves = StaffLeave.objects.filter(staff=name)
    available_leaves = AvailableLeave.objects.filter(
        staff_leave__in=leaves.values("id"), session=request.Session
    )
    if not available_leaves:
        for data in leaves:
            AvailableLeave.objects.get_or_create(
                staff_leave=data,
                available_leave=data.total_leave,
                total_leave=data.total_leave,
                session=request.Session,
            )
    record = available_leaves.filter(available_leave__gt=0)
    return JsonResponse(
        data=list(
            record.values(
                "staff_leave__leave_type_id",
                "staff_leave__leave_type__name",
                "available_leave",
            )
        ),
        safe=False,
    )


@login_required
@user_type_required("Staff")
def class_timetable_view(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "class_time_table_view" in request.permissions
        or "class_time_table_edit" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            class_records = Class.objects.filter(branch=branch_id)
            section_records = Section.objects.filter(branch=branch_id)
            if request.method == "POST":
                classs = request.POST.get("class")
                section = request.POST.get("section")
                TimeTable_records = TimeTable.objects.filter(
                    Class=classs, section=section, session=request.Session,branch_id=branch_id
                )

                context = {
                    "class_records": class_records,
                    "section_records": section_records,
                    "classs": int(classs),
                    "section": int(section),
                    "TimeTable_records": TimeTable_records,
                    "class_timetablee": "active",
                }
                return render(request, "Academics/class_timetable_view.html", context)
            context = {
                "class_records": class_records,
                "section_records": section_records,
                "class_timetablee": "active",
            }
            return render(request, "Academics/class_timetable_view.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def class_timetable(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "class_time_table_view" in request.permissions
        or "class_time_table_edit" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            class_records = Class.objects.filter(branch=branch_id)
            subject_group_records = SubjectGroup.objects.filter(branch=branch_id)
            if request.POST.get("search") == "search":
                classs = request.POST.get("class")
                section = request.POST.get("section")
                subject_group = request.POST.get("subject_group")
                print('subject_group',subject_group)
                section_records = Section.objects.filter(branch=branch_id)
                subject_group_record = SubjectGroup.objects.get(id=subject_group,branch_id=branch_id)
                print('subject_group_record',subject_group_record)
                subject_records = Subjects.objects.filter(
                    id__in=subject_group_record.subject.filter(branch=branch_id),branch_id=branch_id
                )
                print('subject_records',subject_records)
                assign_teacher = AssignClassTeacher.objects.filter(
                    Class=classs, section=section, session=request.Session,branch_id=branch_id
                ).last()
                print("assign_teacher", assign_teacher)
                teacher_records = assign_teacher.class_teacher.filter(branch=branch_id)
                print("teacher_records", teacher_records)
                TimeTable_records = TimeTable.objects.filter(
                    Class=classs,
                    section=section,
                    subject_group=subject_group,
                    session=request.Session,
                    branch_id=branch_id
                )
                context = {
                    "class_records": class_records,
                    "class_timetablee": "active",
                    "subject_group_records": subject_group_records,
                    "subject_records": subject_records,
                    "teacher_records": teacher_records,
                    "classs": int(classs),
                    "section": int(section),
                    "subject_group": int(subject_group),
                    "TimeTable_records": TimeTable_records,
                    "section_records": section_records,
                }
                return render(request, "Academics/class_timetable.html", context)
            context = {
                "class_records": class_records,
                "class_timetablee": "active",
                "subject_group_records": subject_group_records,
            }
            return render(request, "Academics/class_timetable.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
def timetable_save_js(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    subject_list = request.GET.getlist("subject[]")
    teacher_list = request.GET.getlist("teacher[]")
    from_time_list = request.GET.getlist("from_time[]")
    to_time_list = request.GET.getlist("to_time[]")
    room_nolist = request.GET.getlist("room_no[]")
    class_list = request.GET.get("class")
    section_list = request.GET.get("section")
    subject_groups_list = request.GET.get("subject_group")
    day = request.GET.get("day")
    for i in range(len(subject_list)):
        TimeTable.objects.get_or_create(
            Class_id=class_list,
            section_id=section_list,
            subject_group_id=subject_groups_list,
            subject_id=subject_list[i],
            teacher_id=teacher_list[i],
            time_from=from_time_list[i],
            time_to=to_time_list[i],
            room_no=room_nolist[i],
            day=day,
            session=request.Session,
            branch_id = branch_id 
        )
    return JsonResponse(data="success", safe=False)


@login_required
@user_type_required("Staff")
def timetable_delete(request):
    TimeTable.objects.get(id=request.GET.get("pk")).delete()
    return JsonResponse(data="success", safe=False)


@login_required
@user_type_required("Staff")
def teacher_timetable(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    teacher_records = AddStaff.objects.filter(roles__name__icontains="teacher")
    if request.method == "POST":
        teacher = request.POST.get("teacher")
        TimeTable_records = TimeTable.objects.filter(
            teacher=teacher, session=request.Session,branch_id=branch_id
        )

        context = {
            "teacher_records": teacher_records,
            "teacher": int(teacher),
            "TimeTable_records": TimeTable_records,
            "teacher_timetable": "active",
        }
        return render(request, "Academics/teacher_timetable.html", context)
    context = {"teacher_records": teacher_records, "teacher_timetable": "active"}
    return render(request, "Academics/teacher_timetable.html", context)


#  HR


@login_required
@user_type_required("Staff")
def add_staff(request):
    if request.user.is_superuser or request.user.is_school_admin or "staff_add" in request.permissions:
        try:
            token = request.session['user_token']
            branch_name = request.session.get('branch_id', None)
            buyer_name = request.session.get('buyer_id', None)
            if buyer_name:
                buyer_id = buyer_name
            else:
                buyer_id = None  
                print("branch_name@@@",branch_name) 
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            endpoint = 'finance/user/'    
            system_fields = SystemFields.objects.filter(branch=branch_id)
            system_field = (
                system_fields.last().staff_fields if system_fields.last() else None
            )
            custom_fields = CustomFields.objects.filter(field_belongs_to="Staff")
            staffs = AddStaff.objects.filter(branch=branch_id)
            admin_value=request.user.is_superuser or request.user.is_school_admin
            print('staffs===',request.user.is_superuser or request.user.is_school_admin)
            school_registration = SchoolRegistration.objects.all()

            print("school_registration",school_registration)
            leave_type = AddLeaveType.objects.filter(branch=branch_id)
            
            school_name=Branch.objects.get(id=branch_id)
            print("school_name===",school_name.school)
            form = AddStaffForm()
            if request.method == "POST":
                form = AddStaffForm(request.POST)
                if form.is_valid():
                    staff = form.save(commit=False)
                    staff.branch = branch_id
                    staff.school = school_name.school
                    staff.save()
                    password = generate_password()
                    if staff.last_name:
                        last_name = staff.last_name
                    else:
                        last_name = " "
                    user = User.objects.create_user(
                        username=staff.email,
                        email=staff.email,
                        first_name=staff.first_name,
                        last_name=last_name,
                        dob=staff.date_of_birth,
                        phone_number=staff.phone_no,
                        user_type="Staff",
                        buyer_id = buyer_id

                    )
                    user.set_password(password)
                    print(password)
                    user.save()
                    staff.user = user
                    staff.created_by = request.user
                    staff.save()
                    branch = Branch.objects.get(id=branch_id)
                    print("branch+++", branch.school.reference_id)            

                    data = {
                        'password': password,
                        'first_name': form.cleaned_data["first_name"],
                        'middle_name': form.cleaned_data["last_name"],
                        'last_name': form.cleaned_data["last_name"],
                        'email': form.cleaned_data["email"],
                        'phone_number': form.cleaned_data["phone_no"],
                        'company_name': branch.school.reference_id,  
                        'branch_name': branch.reference_id  
                    }
                    print("++++++++++++++++++")

                    json_data = json.dumps(data)
                    print("=========", json_data)

                    response = call_post_method(BASE_URL, endpoint, json_data, token)
                    print("response+++", response)
                    if response.status_code != 200:
                        print('Response Status Code:', response.content)
                    staff_leave = AddLeaveType.objects.filter(branch=branch_id)    
                    print("")    
                    for data in staff_leave:
                        leave_count = request.POST.get(data.name)
                        if leave_count:
                            StaffLeave.objects.create(
                                staff_id=staff.pk,
                                leave_type=data,
                                total_leave=leave_count,
                                branch_id=branch_id
                            )

                    recipient_name = staff.first_name
                    to = staff.email
                    new_staff_account_email(recipient_name, to, password)
                    #  customs fields                  
                    
                    for data in custom_fields:
                        if data.field_type == "multiselect":
                            value = request.POST.getlist(f"{data.field_name}")
                        else:
                            value = request.POST.get(f"{data.field_name}")
                        print(value)
                        if value:
                            print("===========", value)
                            StaffCustomFieldValues.objects.create(
                                field=data, staff_id=staff.pk, value=value,branch_id=branch_id
                            )
                            
                    staff_school=request.POST.getlist("staff_school")
                    staff_degree=request.POST.getlist("degree")
                    staff_study=request.POST.getlist("study")
                    staff_st_date=request.POST.getlist("start_date")
                    staff_end_date=request.POST.getlist("end_date")
                    Staff_grade=request.POST.getlist("grade")

                    print('staff_school',type(staff_school),staff_degree,staff_study,staff_st_date,staff_end_date,Staff_grade)
                    print('len(staff_degree)',len(staff_study))
                    for i in range(len(staff_school)):            
                        print('staff_st_date',staff_study[i])   
                        print('Staff_grade',Staff_grade)                        
                        StaffEducationQualification.objects.get_or_create(
                            staff_id=staff.id,
                            staff_school=staff_school[i],
                            degree=staff_degree[i],
                            study=staff_study[i],
                            start_date=staff_st_date[i],
                            end_date=staff_end_date[i],
                            grade=Staff_grade[i],
                            branch_id=branch_id
                        )     

                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/add_staff")
                else:
                    print(form.errors)
            context = {
                "form": form,
                "staffs": staffs,
                "add_staff": "active",
                "view": True,
                "leave_type": leave_type,
                "custom_fields": custom_fields,
                "system_fields": system_field,
                "school_registration":school_registration,
                "admin_value":admin_value
            }
            return render(request, "Human_Resource/add_staff.html", context)

        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def approve_leave_request(request):
    # if (
    #     request.user.is_superuser or request.user.is_school_admin
    #     or "approve_leave_request_view" in request.permissions
    #     or "approve_leave_request_add" in request.permissions
    # ):
    #     try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = ApproveLeave.objects.filter(branch=branch_id)
            roles_records = Role.objects.filter(branch=branch_id)
            if request.method == "POST":
                lop = int(request.POST.get("lop"))
                dates_str = request.POST.get("dates")
                leave_dates = dates_str.split(", ")
                leave_type = request.POST.get("available_leave")
                if lop:
                    leave_days = len(leave_dates) - lop
                    if leave_type:
                        lop_dates = leave_dates[leave_days:]
                    else:
                        lop_dates = leave_dates
                else:
                    leave_days = len(leave_dates)
                    lop_dates = []

                ApproveLeave.objects.create(
                    role_id=request.POST.get("role"),
                    name_id=request.POST.get("staff"),
                    apply_date=request.POST.get("apply_date"),
                    leave_type_id=request.POST.get("available_leave"),
                    leave_dates=leave_dates[:leave_days],
                    number_of_days=leave_days,
                    LOP_leave_dates=lop_dates,
                    LOP_number_of_days=lop,
                    reason=request.POST.get("reason"),
                    note=request.POST.get("notes"),
                    attach_document=request.FILES.get("document"),
                    status=request.POST.get("status"),
                    created_by=request.user,
                    branch_id=branch_id
                )
                available_leave = AvailableLeave.objects.filter(
                    staff_leave__leave_type=request.POST.get("available_leave"),
                    session=request.Session,branch_id=branch_id
                ).last()
                available_leave.available_leave = (
                    available_leave.available_leave - leave_days
                )
                available_leave.save()
                return redirect("approve_leave_request")

            context = {
                "approve_leave_request": "active",
                "records": records,
                "roles_records": roles_records,
            }
            return render(request, "Human_Resource/approve_leave_request.html", context)
    #     except Exception as error:
    #         return render(request, "error.html", {"error": error})
    # else:
    #     return redirect("dashboard")


@login_required
@user_type_required("Staff")
def approve_leave_request_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "approve_leave_request_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = ApproveLeave.objects.filter(branch=branch_id)
            record = ApproveLeave.objects.get(id=pk)
            if request.method == "POST":
                record.status = request.POST.get("status")
                record.save()
                return HttpResponseRedirect("/approve_leave_request")
            context = {
                "records": records,
                "approve_leave_request": "active",
                "record": record,
                "edit": True,
            }
            return render(
                request, "Human_Resource/approve_leave_request_edit.html", context
            )
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def approve_leave_request_delete(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "approve_leave_request_delete" in request.permissions
    ):
        try:
            ApproveLeave.objects.get(id=pk).delete()
            return HttpResponseRedirect("/approve_leave_request")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


# apply leave


@login_required
@user_type_required("Staff")
def apply_leave(request):
    # if (
    #     request.user.is_superuser or request.user.is_school_admin
    #     or "apply_leave_view" in request.permissions
    #     or "apply_leave_add" in request.permissions
    # ):  
    #     try:
            if True:
                branch_name = request.session.get('branch_id', None)
                if branch_name:
                    branch_id = branch_name       
                else:
                    branch_id = None  
                    print("branch_name@@@",branch_name)
                print('ggggsgsggsgsg',request.user)
                staff = AddStaff.objects.get(user=request.user) if request.user.user_type == 'Staff' else None       
                leaves = StaffLeave.objects.filter(staff=staff)
                available_leaves = AvailableLeave.objects.filter(
                    staff_leave__in=leaves.values("id"), session=request.Session,branch_id=branch_id
                )
                print("request.Session",request.Session)
                if not available_leaves:
                    for data in leaves:
                        AvailableLeave.objects.get_or_create(
                            staff_leave=data,
                            available_leave=data.total_leave,
                            total_leave=data.total_leave,
                            session=request.Session,
                            branch_id=branch_id
                        )
                approval_leaves = ApproveLeave.objects.filter(name=staff)
                if request.method == "POST":
                    lop = int(request.POST.get("lop"))
                    dates_str = request.POST.get("dates")
                    leave_dates = dates_str.split(", ")
                    leave_type = request.POST.get("available_leave")
                    if lop:
                        leave_days = len(leave_dates) - lop
                        if leave_type:
                            lop_dates = leave_dates[leave_days:]
                        else:
                            lop_dates = leave_dates
                    else:
                        leave_days = len(leave_dates)
                        lop_dates = []

                    ApproveLeave.objects.create(
                        role=staff.roles,
                        name=staff,
                        apply_date=request.POST.get("apply_date"),
                        leave_type_id=request.POST.get("available_leave"),
                        leave_dates=leave_dates[:leave_days],
                        number_of_days=leave_days,
                        LOP_leave_dates=lop_dates,
                        LOP_number_of_days=lop,
                        reason=request.POST.get("reason"),
                        note=" ",
                        attach_document=request.FILES.get("document"),
                        status="Pending",
                        created_by=request.user,
                        branch_id=branch_id
                    )
                    available_leave = AvailableLeave.objects.filter(
                        staff_leave__leave_type=request.POST.get("available_leave"),
                        session=request.Session,branch_id=branch_id
                    ).last()
                    available_leave.available_leave = (
                        available_leave.available_leave - leave_days
                    )
                    available_leave.save()
                    return redirect("apply_leave")

                context = {
                    "leaves": leaves,
                    "apply_leave": "active",
                    "available_leaves": available_leaves.filter(available_leave__gt=0),
                    "approval_leaves": approval_leaves,
                }
                return render(request, "Human_Resource/apply_leave.html", context)
    #     except Exception as error:
    #        return render(request,'error.html',{'error':error})
    # else:
    #     return redirect("dashboard")


@login_required
@user_type_required("Staff")
def apply_leave_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "apply_leave_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = ApplyLeave.objects.filter(branch=branch_id)
            record = ApplyLeave.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = ApplyLeaveForm(instance=record)
            if request.method == "POST":
                form = ApplyLeaveForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save() 
                    return HttpResponseRedirect("/apply_leave")
            context = {"form": form, "leaves": records, "apply_leave": "active"}
            return render(request, "Human_Resource/apply_leave_edit.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def apply_leave_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "apply_leave_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            approve_leave=ApproveLeave.objects.get(id=pk)
            approve_leave_branch_id = approve_leave.branch.id
            if int(approve_leave_branch_id) == int(branch_id):                        
                ApproveLeave.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def add_leave_type(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "leave_types_view" in request.permissions
        or "leave_types_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            form = AddLeaveTypeForm()
            leaves = AddLeaveType.objects.filter(branch=branch_id)
            if request.method == "POST":
                form = AddLeaveTypeForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()
                    messages.success(request, "Record Saved Successfully")
                    return redirect("add_leave_type")
                else:
                    messages.success(request, "Record Saved Successfully")
                    return redirect("add_leave_type")
            context = {
                "form": form,
                "leaves": leaves,
                "add_leave_type": "active",
            }
            return render(request, "Human_Resource/add_leave_type.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def add_leave_type_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "leave_types_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            leaves = AddLeaveType.objects.filter(branch=branch_id)
            record = AddLeaveType.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = AddLeaveTypeForm(instance=record)
            if request.method == "POST":
                form = AddLeaveTypeForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/add_leave_type")
            context = {
                "form": form,
                "leaves": leaves,
                "add_leave_type": "active",
                "edit": True,
            }
            return render(request, "Human_Resource/add_leave_type.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def add_leave_type_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "leave_types_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            add_leave_type=AddLeaveType.objects.get(id=pk)
            add_leave_type_branch_id = add_leave_type.branch.id
            if int(add_leave_type_branch_id) == int(branch_id):                        
                AddLeaveType.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/add_leave_type")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def teachers_rating_list(request):
    if request.user.is_superuser or request.user.is_school_admin or "teacher_reating_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = TeacherRating.objects.filter(branch=branch_id)
            context = {"teachers_rating_list": "active", "records": records}
            return render(request, "Human_Resource/teachers_rating_list.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def teacher_rating_approval(request, pk):
    obj = TeacherRating.objects.get(id=pk)
    obj.status = "approval"
    obj.save()
    return redirect("teachers_rating_list")


@login_required
@user_type_required("Staff")
def teacher_rating_delete(request, pk):
    obj = TeacherRating.objects.get(id=pk).delete()
    return redirect("teachers_rating_list")


# department
@login_required
@user_type_required("Staff")
def department(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "department_view" in request.permissions
        or "department_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            form = DepartmentForm()
            departments = Department.objects.filter(branch=branch_id)
            if request.method == "POST":
                form = DepartmentForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save() 
                    messages.success(request, "Record Saved Successfully")
                    return redirect("department")
                else:
                    messages.success(request, "Record Saved Successfully")
                    return redirect("department")
            context = {"form": form, "departments": departments, "department": "active"}
            return render(request, "Human_Resource/department.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def department_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "department_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            departments = Department.objects.filter(branch=branch_id)
            department = Department.objects.get(id=pk)
            data_branch_id = department.branch.id
            form = DepartmentForm(instance=department)
            if request.method == "POST":
                form = DepartmentForm(request.POST, instance=department)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/department")
            context = {
                "form": form,
                "departments": departments,
                "department": "active",
                "edit": True,
            }
            return render(request, "Human_Resource/department_edit.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def department_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "department_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)

            department = Department.objects.get(id=pk)
            department_branch_id = department.branch.id
            if int(department_branch_id) == int(branch_id):                        
                Department.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("department", {"department": department})
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


# company
@login_required
@user_type_required("Staff")
def company(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "company_view" in request.permissions
        or "company_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            form = CompanyForm()
            companys = Company.objects.filter(branch=branch_id)
            if request.method == "POST":
                form = CompanyForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()   
                    messages.success(request, "Record Saved Successfully")
                    return redirect("company")
                else:
                    messages.success(request, "Record Saved Successfully")
                    return redirect("company")
            context = {"form": form, "companys": companys, "company": "active"}
            return render(request, "Structure/company.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def company_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "company_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            companys = Company.objects.filter(branch=branch_id)
            company = Company.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = CompanyForm(instance=company)
            if request.method == "POST":
                form = CompanyForm(request.POST, instance=company)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/company")
            context = {
                "form": form,
                "companys": companys,
                "company": "active",
                "edit": True,
            }
            return render(request, "Structure/company_edit.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def company_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "company_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            company = Company.objects.get(id=pk)
            company_branch_id = company.branch.id
            if int(company_branch_id) == int(branch_id):                        
                Company.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/company", {"company": company})
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


# curriculum
@login_required
@user_type_required("Staff")
def curriculums(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "curriculum_view" in request.permissions
        or "curriculum_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            form = CurriculumForm()
            curriculums = Curriculum.objects.filter(branch=branch_id)
            if request.method == "POST":
                form = CurriculumForm(request.POST)
                if form.is_valid():
                    form.save()
                    messages.success(request, "Record Saved Successfully")
                    return redirect("curriculums")
                else:
                    messages.success(request, "Record Saved Successfully")
                    return redirect("curriculums")
            context = {"form": form, "curriculums": curriculums, "curriculum": "active"}
            return render(request, "Structure/curriculum.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def curriculum_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "curriculum_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            curriculums = Curriculum.objects.filter(branch=branch_id)
            curriculum = Curriculum.objects.get(id=pk)
            form = CurriculumForm(instance=department)
            if request.method == "POST":
                form = CurriculumForm(request.POST, instance=department)
                if form.is_valid():
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/curriculums")
            context = {
                "form": form,
                "curriculums": curriculums,
                "curriculum": "active",
                "edit": True,
            }
            return render(request, "Structure/curriculum.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def curriculum_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "department_delete" in request.permissions:
        try:
            department = Department.objects.get(id=pk).delete()
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("department", {"department": department})
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def designation(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "designation_view" in request.permissions
        or "designation_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            form = DesignationForm()
            designations = Designation.objects.filter(branch=branch_id)
            if request.method == "POST":
                form = DesignationForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()  
                    messages.success(request, "Record Saved Successfully")
                    return redirect("designation")
                else:
                    messages.success(request, "Record Saved Successfully")
                    return redirect("designation")
            context = {
                "form": form,
                "designations": designations,
                "designation": "active",
            }
            return render(request, "Human_Resource/designation.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def designation_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "designation_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            designations = Designation.objects.filter(branch=branch_id)
            designation = Designation.objects.get(id=pk)
            data_branch_id = designation.branch.id
            form = DesignationForm(instance=designation)
            if request.method == "POST":
                form = DesignationForm(request.POST, instance=designation)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/designation")
            context = {
                "form": form,
                "designations": designations,
                "designation": "active",
                "edit": True,
            }
            return render(request, "Human_Resource/designation.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def designation_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "designation_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            designation = Designation.objects.get(id=pk)
            designation_branch_id = designation.branch.id
            if int(designation_branch_id) == int(branch_id):                        
                Designation.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/designation", {"designation": designation})
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def notice_board(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "notice_borad_view" in request.permissions
        or "notice_borad_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            form = noticeBoardForm()
            forms = Role.objects.filter(branch=branch_id)
            notices = noticeBoard.objects.filter(branch=branch_id)
            if request.method == "POST":
                titels = request.POST.get("title")
                notice_dates = request.POST.get("notice_date")
                massage = request.POST.get("message")
                publish = request.POST.get("publish_on")
                student = request.POST.getlist("noties_all")
                noticeBoard.objects.create(
                    title=titels,
                    notice_date=notice_dates,
                    message=massage,
                    publish_on=publish,
                    message_to=student,
                    branch_id=branch_id
                )
                messages.success(request, "Record Saved Successfully")
                return HttpResponseRedirect("/notice_board")
            context = {
                "form": form,
                "forms": forms,
                "records": notices,
                "notices": "active",
            }
            return render(request, "Communicate/notice_board.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def notice_board_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "notice_borad_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name4444",branch_name)
            notices = noticeBoard.objects.filter(branch=branch_id)
            notice = noticeBoard.objects.get(id=pk)
            print("noticebranch_id",notice)
            form = noticeBoardForm(instance=notice)
            if request.method == "POST":
                print("request.POST",request.POST)
                form = noticeBoardForm(request.POST, instance=notice)
                print("form",form.is_valid())
                if form.is_valid():
                    form.save(commit=False)
                    form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/notice_board")
                print("form.errors",form.errors)
            context = {
                "form": form,
                "records": notices,
                "notices": "active",
                "edit": True,
            }
            return render(request, "Communicate/notice_board_edit.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def notice_board_delete(request, pk):
    noticeBoard.objects.get(id=pk).delete()
    messages.error(request, "Record Deleted Successfully")
    return HttpResponseRedirect("/notice_board")


@login_required
@user_type_required("Staff")
def email_sms_log(request):
    if request.user.is_superuser or request.user.is_school_admin or "email_sms_log_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = EmailSmsLog.objects.filter(branch=branch_id)
            return render(
                request,
                "Communicate/email_sms_log.html",
                {"records": records, "email_sms_log": "active"},
            )
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def assignment_list(request):
    if request.user.is_superuser or request.user.is_school_admin or "assigment_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = UploadContent.objects.filter(content_type="assignments",branch_id=branch_id)
            context = {"records": records, "assignment_list": "active"}
            return render(request, "Download_center/assignment_list.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def assignment_list_delete(request, pk):
    UploadContent.objects.get(id=pk).delete()
    return HttpResponseRedirect("/assignment_list")


@login_required
@user_type_required("Staff")
def study_material(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
    print("branch_name@@@",branch_name)
    records = UploadContent.objects.filter(content_type="study_material",branch_id=branch_id)
    context = {"records": records, "study_material": "active"}

    return render(request, "Download_center/study_material.html", context)


@login_required
@user_type_required("Staff")
def study_material_delete(request, pk):
    UploadContent.objects.get(id=pk).delete()
    return HttpResponseRedirect("/study_material")

 
@login_required
@user_type_required("Staff")
def syllabus(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
    print("branch_name@@@",branch_name)
    records = UploadContent.objects.filter(content_type="syllabus",branch_id=branch_id)
    context = {"records": records, "syllabus": "active"}
    return render(request, "Download_center/syllabus.html", context)


@login_required
@user_type_required("Staff")
def syllabus_delete(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
    print("branch_name@@@",branch_name)
    upload_content=UploadContent.objects.get(id=pk)
    upload_content_branch_id = upload_content.branch.id
    if int(upload_content_branch_id) == int(branch_id):                        
        UploadContent.objects.get(id=pk).delete()
    else:
        messages.error(request, "School id Doesn't match record no delete")
    messages.error(request, "Record Deleted Successfully")
    return HttpResponseRedirect("/syllabus")


@login_required
@user_type_required("Staff")
def other_download_list(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
    print("branch_name@@@",branch_name)
    records = UploadContent.objects.filter(content_type="other_download",branch_id=branch_id)
    context = {"records": records, "other_download_list": "active"}

    return render(request, "Download_center/other_download_list.html", context)


@login_required
@user_type_required("Staff")
def other_download_list_delete(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
    print("branch_name@@@",branch_name)
    upload_content=UploadContent.objects.get(id=pk)
    upload_content_branch_id = upload_content.branch.id
    if int(upload_content_branch_id) == int(branch_id):                        
        UploadContent.objects.get(id=pk).delete()
    else:
        messages.error(request, "School id Doesn't match record no delete")
    messages.error(request, "Record Deleted Successfully")
    return HttpResponseRedirect("/other_download_list")


@login_required
@user_type_required("Staff")  # Homework
def book_list(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "books_list_view" in request.permissions
        or "books_list_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            form = AddBookForm()
            books = AddBook.objects.filter(branch=branch_id)
            if request.method == "POST":
                form = AddBookForm(request.POST)
                if form.is_valid():
                    data = form.save(commit=False)
                    data.available_qty = request.POST.get("qty")
                    data.branch_id = branch_id
                    data.save()
                    messages.success(request, "Record Saved Successfully")
                    return redirect("book_list")
                else:
                    print(form.errors)
            context = {"form": form, "books": books, "book_list": "active"}
            return render(request, "Library/book_list.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def book_list_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "books_list_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            books = AddBook.objects.filter(branch=branch_id)
            book = AddBook.objects.get(id=pk)
            data_branch_id = book.branch.id
            form = AddBookForm(instance=book)
            if request.method == "POST":
                form = AddBookForm(request.POST, instance=book)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/book_list")
            context = {"form": form, "books": books, "book_list": "active"}
            return render(request, "Library/book_list_edit.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def book_list_delete(request, pk):
    if "books_list_delete" in request.permissions or request.user.is_superuser or request.user.is_school_admin:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)

            add_book=AddBook.objects.get(id=pk)
            add_book_branch_id = add_book.branch.id
            if int(add_book_branch_id) == int(branch_id):                        
                AddBook.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/book_list")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def add_staff_member(request):
    if "add_staff_member_view" in request.permissions or request.user.is_superuser or request.user.is_school_admin:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            staff = AddStaff.objects.filter(branch=branch_id)
            records = []
            for data in staff:
                dict = {}
                member = LibrayMember.objects.filter(
                    staff=data.id, status="active",branch_id=branch_id
                ).last()
                if member:
                    dict["staff_id"] = None
                    dict["member_id"] = member.id
                    dict["library_card_no"] = member.library_card_no
                    dict["staff_name"] = (
                        member.staff.first_name + member.staff.first_name
                    )
                    dict["email"] = member.staff.email
                    dict["date_of_birth"] = member.staff.date_of_birth
                    dict["phone_no"] = member.staff.phone_no
                else:
                    dict["staff_id"] = data.id
                    dict["member_id"] = " "
                    dict["library_card_no"] = " "
                    dict["staff_name"] = data.first_name + data.first_name
                    dict["email"] = data.email
                    dict["date_of_birth"] = data.date_of_birth
                    dict["phone_no"] = data.phone_no
                records.append(dict)
            if request.method == "POST":
                staff_id = request.POST.get("staff_id")
                card_no = request.POST.get("card_no")
                staff = AddStaff.objects.get(id=staff_id)
                LibrayMember.objects.create(
                    staff_id=staff.id,
                    library_card_no=card_no,
                    member_type="Staff",
                    branch_id=branch_id
                )
                return redirect("add_staff_member")
            context = {"records": records, "add_staff_member": "active"}
            return render(request, "Library/add_staff_member.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def libary_surrender_card(request, pk):
    data = LibrayMember.objects.get(id=pk)
    data.status = "deactive"
    data.save()
    return redirect("add_staff_member")


@login_required
@user_type_required("Staff")
def stu_libary_surrender_card(request, pk):
    data = LibrayMember.objects.get(id=pk)
    data.status = "deactive"
    data.save()
    return redirect("add_student_member")


@login_required
@user_type_required("Staff")
def add_student_member(request):
    if "add_student_view" in request.permissions or request.user.is_superuser or request.user.is_school_admin:
        try:
            if True:
                branch_name = request.session.get('branch_id', None)
                if branch_name:
                    branch_id = branch_name       
                else:
                    branch_id = None  
                    print("branch_name@@@",branch_name)
                class_records = Class.objects.filter(branch=branch_id)
                if request.POST.get("search") == "search":
                    student = StudentAdmission.objects.filter(
                        Class=request.POST.get("class"),
                        section=request.POST.get("section"),
                        session=request.Session,branch_id=branch_id
                    )
                    records = []
                    for data in student:
                        dict = {}
                        member = LibrayMember.objects.filter(
                            student=data.id, status="active",branch_id=branch_id
                        ).last()
                        print("====", member)
                        if member:
                            dict["staff_id"] = None
                            dict["member_id"] = member.id
                            dict["library_card_no"] = member.library_card_no
                            dict["staff_name"] = (
                                member.student.first_name + " " + member.student.first_name
                            )
                            dict["email"] = member.student.email
                            dict["date_of_birth"] = member.student.date_of_birth
                            dict["phone_no"] = member.student.mobile_number
                        else:
                            dict["staff_id"] = data.id
                            dict["member_id"] = " "
                            dict["library_card_no"] = " "
                            dict["staff_name"] = data.first_name + " " + data.first_name
                            dict["email"] = data.email
                            dict["date_of_birth"] = data.date_of_birth
                            dict["phone_no"] = data.mobile_number
                        records.append(dict)
                    print(records)
                    context = {
                        "records": records,
                        "add_student_member": "active",
                        "class_records": class_records,
                    }
                    return render(request, "Library/add_student_member.html", context)
                if request.POST.get("save") == "save":
                    staff_id = request.POST.get("staff_id")
                    card_no = request.POST.get("card_no")
                    staff = StudentAdmission.objects.get(id=staff_id)
                    LibrayMember.objects.create(
                        student_id=staff.id,
                        library_card_no=card_no,
                        member_type="Student",
                        branch_id=branch_id
                    )
                    return redirect("add_student_member")
                context = {"add_student_member": "active", "class_records": class_records}
                return render(request, "Library/add_student_member.html", context)
        except Exception as error:
           return render(request,'error.html',{'error':error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def book_issuse_return(request):
    if "issue_return_view" in request.permissions or request.user.is_superuser or request.user.is_school_admin:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = LibrayMember.objects.filter(status="active",branch_id=branch_id)
            context = {"records": records, "book_issuse_return": "active"}
            return render(request, "Library/book_issuse_return.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def member_book_issued(request, pk):
    if "issue_return_view" in request.permissions or request.user.is_superuser or request.user.is_school_admin:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            member = LibrayMember.objects.get(id=pk)
            book = AddBook.objects.filter(branch=branch_id)
            issue_records = IssueBook.objects.filter(member=pk)
            if request.method == "POST":
                book_id = request.POST.get("book")
                IssueBook.objects.create(
                    book_id=book_id,
                    branch_id=branch_id,    
                    member_id=pk,
                    due_return_date=request.POST.get("return_date"),
                    status="Issued",
                )
                book = book.get(id=book_id)
                book.available_qty -= 1
                book.save()
                return HttpResponseRedirect(f"/member_book_issue/{pk}")
            context = {
                "book": book,
                "book_issuse_return": "active",
                "issue_records": issue_records,
                "member": member,
            }
            return render(request, "Library/member_book_issued.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def book_return(request, pk):
    if "issue_return_view" in request.permissions or request.user.is_superuser or request.user.is_school_admin:
        try:
            book = AddBook.objects.get(id=request.POST.get("book_id"))
            book.available_qty += 1
            book.save()
            issue_records = IssueBook.objects.get(id=request.POST.get("issue_id"))
            issue_records.status = "Returned"
            issue_records.return_date = request.POST.get("return_date")
            issue_records.save()
            return HttpResponseRedirect(f"/member_book_issue/{pk}")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
def book_qty_js(request):
    book_id = request.GET.get("book_id")
    book = AddBook.objects.get(id=book_id)
    return JsonResponse(data=book.available_qty, safe=False)


@login_required
@user_type_required("Staff")  # Inventory
def issue_item(request):
    if (
        "issue_item_view" in request.permissions
        or "issue_item_add" in request.permissions
        or request.user.is_superuser or request.user.is_school_admin
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = IssueItem.objects.filter(branch=branch_id)
            if request.method == "POST":
                issue = IssueItem.objects.get(id=request.POST.get("id"))
                issue.status = "retured"
                ItemReturn.objects.create(
                    return_date=request.POST.get("item_return_date"),
                    remark=request.POST.get("remark"),
                    item_category_id=issue.item_category.id,
                    item_id=issue.item.id,
                    quantity=request.POST.get("item_qty"),
                    branch_id=branch_id
                )
                stock = ItemStockDeatail.objects.filter(
                    item_category=issue.item_category.id, item=issue.item.id,branch_id=branch_id
                ).last()
                stock.available_quantity = stock.available_quantity + int(
                    request.POST.get("item_qty")
                )
                issue.save()
                stock.save()
                return HttpResponseRedirect("/issue_item")
            print("records",records.values())
            context = {"records": records, "issue_item": "active"}
            return render(request, "Inventory/issue_item.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
def item_js(request):
    cat_id = request.GET.get("cat_id")
    item_records = AddItem.objects.filter(item_category=cat_id)
    return JsonResponse(data=list(item_records.values("id", "item")), safe=False)


@login_required
def item_available_js(request):
    item_id = request.GET.get("item_id")
    item_records = ItemStockDeatail.objects.filter(item=item_id).last()
    return JsonResponse(data=item_records.available_quantity, safe=False)


@login_required
@user_type_required("Staff")
def add_issue_item(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    records = IssueItem.objects.filter(branch=branch_id)
    form = IssueItemForm()
    if request.method == "POST":
        form = IssueItemForm(request.POST)
        if form.is_valid():
            item_records = ItemStockDeatail.objects.filter(
                item=request.POST.get("item")
            ).last()
            item_records.available_quantity = item_records.available_quantity - int(
                request.POST.get("quantity")
            )
            item_records.save()
            obj=form.save(commit=False)
            obj.branch_id = branch_id
            obj.save()
            messages.success(request, "Record Saved Successfully")
            return HttpResponseRedirect("/issue_item")
    context = {"form": form, "records": records, "issue_item": "active"}
    return render(request, "Inventory/add_issue_item.html", context)


@login_required
@user_type_required("Staff")
def issue_item_delete(request, pk):
    if "issue_item_delete" in request.permissions or request.user.is_superuser or request.user.is_school_admin:
        try:
            IssueItem.objects.get(id=pk).delete()
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/issue_item")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")  # You need to define user_type_required decorator
def non_returnable_items_view(request):
    if (
        "non_returnable_item_view" in request.permissions
        or "non_returnable_item_add" in request.permissions
        or request.user.is_superuser or request.user.is_school_admin
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = NonReturnableItem.objects.filter(branch=branch_id)

            if request.method == "POST":
                # Handle POST request if needed
                pass

            # Check if the user has exceeded the maximum quantity within the fixed duration
            for record in records:
                total_quantity_issued = NonReturnableItem.objects.filter(
                    staff=record.staff,
                    item=record.item,
                    duration_in_days__gte=record.duration_in_days, branch_id=branch_id # Check within the fixed duration
                ).aggregate(Sum("max_quantity"))["max_quantity__sum"]

                if (
                    total_quantity_issued is not None
                    and total_quantity_issued >= record.max_quantity
                ):
                    # Add logic to handle the case where the maximum quantity is exceeded
                    # For example, you can set a flag and use it in the template to display a message.
                    record.exceeded_max_quantity = True
                else:
                    record.exceeded_max_quantity = False

            context = {"records": records, "non_returnable_item": "active"}
            return render(request, "Inventory/non_returnable_item.html", context)

        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


# @login_required
# @user_type_required("Staff")
# def add_item_stock(request):
#     if (
#         "add_item_stock_view" in request.permissions
#         or "add_item_stock_add" in request.permissions
#         or request.user.is_superuser or request.user.is_school_admin
#     ):
#         try:
#             branch_name = request.session.get('branch_id', None)
#             if branch_name:
#                 branch_id = branch_name       
#             else:
#                 branch_id = None  
#                 print("branch_name@@@",branch_name)
#             records = ItemStock.objects.filter(branch=branch_id)
#             form = ItemStockForm()
#             if request.method == "POST":
#                 form = ItemStockForm(request.POST, request.FILES)
#                 if form.is_valid():                   
#                     obj=form.save()
#                     obj.branch_id = branch_id
#                     obj.save()  
#                     detail_stock = ItemStockDeatail.objects.filter(
#                         item_category=request.POST.get("item_category"),
#                         item=request.POST.get("item"),branch_id=branch_id
#                     ).last()
#                     if detail_stock:
#                         detail_stock.quantity = detail_stock.quantity + int(
#                             request.POST.get("quantity")
#                         )
#                         detail_stock.available_quantity = (
#                             detail_stock.available_quantity
#                             + int(request.POST.get("quantity"))
#                         )
#                         detail_stock.save()
#                     else:
#                         detail_form = ItemStockDeatailForm(request.POST)
#                         data = detail_form.save(commit=False)
#                         data.available_quantity = request.POST.get("quantity")
#                         data.branch_id = branch_id
#                         data.save()
#                     messages.success(request, "Record Saved Successfully")
#                     return HttpResponseRedirect("/add_item_stock")
#                 else:
#                     print(form.errors)
#             context = {"form": form, "records": records, "add_item_stock": "active"}
#             return render(request, "Inventory/add_item_stock.html", context)
#         except Exception as error:
#             return render(request, "error.html", {"error": error})
#     else:
#         return redirect("dashboard")


# @login_required
# @user_type_required("Staff")
# def add_item_stock_edit(request, pk):
#     if "add_item_stock_edit" in request.permissions or request.user.is_superuser or request.user.is_school_admin:
#         try:
#             branch_name = request.session.get('branch_id', None)
#             if branch_name:
#                 branch_id = branch_name       
#             else:
#                 branch_id = None  
#                 print("branch_name@@@",branch_name)
#             records = ItemStock.objects.filter(branch=branch_id)
#             record = ItemStock.objects.get(id=pk)
#             data_branch_id = record.branch.id
#             form = ItemStockForm(instance=record)
#             if request.method == "POST":
#                 form = ItemStockForm(request.POST, instance=record)
#                 if form.is_valid():
#                     if branch_id == data_branch_id:
#                         form.save()
#                     else:
#                         form.instance.branch_id = branch_id
#                     form.save()
#                     messages.warning(request, "Record Updated Successfully")
#                     return HttpResponseRedirect("/add_item_stock")
#             context = {
#                 "form": form,
#                 "records": records,
#                 "add_item_stock": "active",
#                 "edit": True,
#             }
#             return render(request, "Inventory/add_item_stock_edit.html", context)
#         except Exception as error:
#             return render(request, "error.html", {"error": error})
#     else:
#         return redirect("dashboard")


# @login_required
# @user_type_required("Staff")
# def view_item_stock(request, pk):
#     if "add_item_stock_edit" in request.permissions or request.user.is_superuser or request.user.is_school_admin:
#         try:
#             branch_name = request.session.get('branch_id', None)
#             if branch_name:
#                 branch_id = branch_name       
#             else:
#                 branch_id = None  
#                 print("branch_name@@@",branch_name)
#             records = ItemStock.objects.filter(branch=branch_id)
#             record = ItemStock.objects.get(id=pk)
#             data_branch_id = record.branch.id
#             form = ItemStockForm(instance=record)
           
#             context = {
#                 "form": form,
#                 "records": records,
#                 "add_item_stock": "active",
#                 "view": True,
#             }
#             return render(request, "Inventory/add_item_stock.html", context)
#         except Exception as error:
#             return render(request, "error.html", {"error": error})
#     else:
#         return redirect("dashboard")

from django.shortcuts import render, redirect, get_object_or_404
from django.http import HttpResponseRedirect
from django.contrib import messages
from django.contrib.auth.decorators import login_required

@login_required
@user_type_required("Staff")
def add_item_stock(request):
    if (
        "add_item_stock_view" in request.permissions
        or "add_item_stock_add" in request.permissions
        or request.user.is_superuser
        or request.user.is_school_admin
    ):
        try:
            branch_id = request.session.get("branch_id")
            records = ItemStock.objects.filter(branch_id=branch_id)
            form = ItemStockForm()

            if request.method == "POST":
                form = ItemStockForm(request.POST, request.FILES)
                if form.is_valid():
                    obj = form.save(commit=False)
                    obj.branch_id = branch_id
                    obj.save()

                    detail_stock = ItemStockDeatail.objects.filter(
                        item_category=request.POST.get("item_category"),
                        item=request.POST.get("item"),
                        branch_id=branch_id,
                    ).last()

                    qty = int(request.POST.get("quantity"))

                    if detail_stock:
                        detail_stock.quantity += qty
                        detail_stock.available_quantity += qty
                        detail_stock.save()
                    else:
                        detail = ItemStockDeatailForm(request.POST).save(commit=False)
                        detail.available_quantity = qty
                        detail.branch_id = branch_id
                        detail.save()

                    messages.success(request, "Record Saved Successfully")
                    return redirect("add_item_stock")

            return render(
                request,
                "Inventory/add_item_stock.html",
                {
                    "form": form,
                    "records": records,
                    "add_item_stock": "active",
                },
            )
        except Exception as e:
            return render(request, "error.html", {"error": e})
    return redirect("dashboard")


@login_required
@user_type_required("Staff")
def add_item_stock_edit(request, pk):
    if (
        "add_item_stock_edit" in request.permissions
        or request.user.is_superuser
        or request.user.is_school_admin
    ):
        try:
            branch_id = request.session.get("branch_id")
            record = get_object_or_404(ItemStock, pk=pk)
            records = ItemStock.objects.filter(branch_id=branch_id)
            form = ItemStockForm(instance=record)

            if request.method == "POST":
                form = ItemStockForm(request.POST, instance=record)
                if form.is_valid():
                    obj = form.save(commit=False)
                    obj.branch_id = branch_id
                    obj.save()
                    messages.warning(request, "Record Updated Successfully")
                    return redirect("add_item_stock")

            return render(
                request,
                "Inventory/add_item_stock.html",
                {
                    "form": form,
                    "records": records,
                    "edit": True,
                    "add_item_stock": "active",
                },
            )
        except Exception as e:
            return render(request, "error.html", {"error": e})
    return redirect("dashboard")


@login_required
@user_type_required("Staff")
def view_item_stock(request, pk):
    if (
        "add_item_stock_view" in request.permissions
        or request.user.is_superuser
        or request.user.is_school_admin
    ):
        try:
            branch_id = request.session.get("branch_id")
            record = get_object_or_404(ItemStock, pk=pk)
            records = ItemStock.objects.filter(branch_id=branch_id)
            form = ItemStockForm(instance=record)

            #  Disable all fields (backend safety)
            # for field in form.fields:
            #     form.fields[field].disabled = True

            return render(
                request,
                "Inventory/add_item_stock.html",
                {
                    "form": form,
                    "records": records,
                    "view": True,
                    "add_item_stock": "active",
                },
            )
        except Exception as e:
            return render(request, "error.html", {"error": e})
    return redirect("dashboard")

# @login_required
# @user_type_required("Staff")
# def add_item_stock_delete(request, pk):
#     if "add_item_stock_delete" in request.permissions or request.user.is_superuser or request.user.is_school_admin:
#         try:
#             branch_name = request.session.get('branch_id', None)
#             if branch_name:
#                 branch_id = branch_name       
#             else:
#                 branch_id = None  
#                 print("branch_name@@@",branch_name)
#             record = ItemStock.objects.get(id=pk)
#             detail_stock = ItemStockDeatail.objects.get(
#                 item_category=record.item_category.id, item=record.item.id,branch_id=branch_id
#             )
#             if detail_stock:
#                 detail_stock.quantity = detail_stock.quantity - record.quantity
#                 detail_stock.available_quantity = (
#                     detail_stock.available_quantity - record.quantity,
#                 )
                
#                 detail_stock.save()
#             record.delete()
#             messages.error(request, "Record Deleted Successfully")
#             return HttpResponseRedirect("/add_item_stock")
#         except Exception as error:
#             return render(request, "error.html", {"error": error})
#     else:
#         return redirect("dashboard")

@login_required
@user_type_required("Staff")
def add_item_stock_delete(request, pk):
    if (
        "add_item_stock_delete" in request.permissions
        or request.user.is_superuser
        or request.user.is_school_admin
    ):
        try:
            branch_id = request.session.get("branch_id")

            record = ItemStock.objects.get(id=pk)

            #  SAFELY GET DETAIL STOCK
            detail_stock = ItemStockDeatail.objects.filter(
                item_category=record.item_category_id,
                item=record.item_id,
                branch_id=branch_id
            ).first()

            if detail_stock:
                #  Prevent negative stock
                detail_stock.quantity = max(
                    0, detail_stock.quantity - record.quantity
                )
                detail_stock.available_quantity = max(
                    0, detail_stock.available_quantity - record.quantity
                )
                detail_stock.save()

            record.delete()

            messages.success(request, "Record Deleted Successfully")
            return redirect("add_item_stock")

        except Exception as error:
            return render(request, "error.html", {"error": error})

    return redirect("dashboard")

@login_required
@user_type_required("Staff")  # Assign To Raji
def add_item(request):
    if (
        "item_add_view" in request.permissions
        or "item_add_add" in request.permissions
        or request.user.is_superuser or request.user.is_school_admin
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = AddItem.objects.filter(branch=branch_id)
            form = AddItemForm()
            if request.method == "POST":
                form = AddItemForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()  
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/add_item")
                else:
                    print(form.errors)
            context = {"form": form, "records": records, "add_item": "active"}
            return render(request, "Inventory/add_item.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def add_item_edit(request, pk):
    if "item_add_edit" in request.permissions or request.user.is_superuser or request.user.is_school_admin:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)

            records = AddItem.objects.filter(branch=branch_id)
            record = AddItem.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = AddItemForm(instance=record)
            if request.method == "POST":
                form = AddItemForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/add_item")
            context = {"form": form, "records": records, "add_item": "active"}
            return render(request, "Inventory/add_item.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def add_item_view(request, pk):
    if "item_add_view" in request.permissions or request.user.is_superuser or request.user.is_school_admin:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = AddItem.objects.filter(branch=branch_id)
            record = AddItem.objects.get(id=pk)
            form = AddItemForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "add_item": "active",
                "view": True,
            }
            return render(request, "Inventory/add_item.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def add_item_delete(request, pk):
    if "item_add_delete" in request.permissions or request.user.is_superuser or request.user.is_school_admin:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            add_item=AddItem.objects.get(id=pk)
            add_item_branch_id = add_item.branch.id
            if int(add_item_branch_id) == int(branch_id):                        
                AddItem.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/add_item")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def add_item_category(request):
    if (
        "item_category_view" in request.permissions
        or "item_category_add" in request.permissions
        or request.user.is_superuser or request.user.is_school_admin
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = ItemCategory.objects.filter(branch=branch_id)
            form = ItemCategoryForm()
            if request.method == "POST":
                form = ItemCategoryForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()  
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/add_item_category")
                else:
                    print(form.errors)
            context = {"form": form, "records": records, "add_item_category": "active"}
            return render(request, "Inventory/add_item_category.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def add_item_category_edit(request, pk):
    if "item_category_edit" in request.permissions or request.user.is_superuser or request.user.is_school_admin:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = ItemCategory.objects.filter(branch=branch_id)
            record = ItemCategory.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = ItemCategoryForm(instance=record)
            if request.method == "POST":
                form = ItemCategoryForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                        form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/add_item_category")
            context = {
                "form": form,
                "records": records,
                "add_item_category": "active",
                "edit": True,
            }
            return render(request, "Inventory/add_item_category.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def add_item_category_view(request, pk):
    if "item_category_view" in request.permissions or request.user.is_superuser or request.user.is_school_admin:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = ItemCategory.objects.filter(branch=branch_id)
            record = ItemCategory.objects.get(id=pk)
            form = ItemCategoryForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "add_item_category": "active",
                "view": True,
            }
            return render(request, "Inventory/add_item_category.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def add_item_category_delete(request, pk):
    if "item_category_delete" in request.permissions or request.user.is_superuser or request.user.is_school_admin:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            item_category=ItemCategory.objects.get(id=pk)
            item_category_branch_id = item_category.branch.id
            if int(item_category_branch_id) == int(branch_id):                        
                ItemCategory.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/add_item_category")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def item_store(request):
    if (
        "item_store_view" in request.permissions
        or "item_store_add" in request.permissions
        or request.user.is_superuser or request.user.is_school_admin
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = ItemStore.objects.filter(branch=branch_id)
            form = ItemStoreForm()
            if request.method == "POST":
                form = ItemStoreForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/item_store")
                else:
                    print(form.errors)
            context = {"form": form, "records": records, "item_store": "active"}
            return render(request, "Inventory/item_store.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def item_store_edit(request, pk):
    if "item_store_edit" in request.permissions or request.user.is_superuser or request.user.is_school_admin:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = ItemStore.objects.filter(branch=branch_id)
            record = ItemStore.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = ItemStoreForm(instance=record)
            if request.method == "POST":
                form = ItemStoreForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/item_store")
            context = {
                "form": form,
                "records": records,
                "item_store": "active",
                "edit": True,
            }
            return render(request, "Inventory/item_store.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def item_store_view(request, pk):
    if "item_store_view" in request.permissions or request.user.is_superuser or request.user.is_school_admin:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = ItemStore.objects.filter(branch=branch_id)
            record = ItemStore.objects.get(id=pk)
            form = ItemStoreForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "item_store": "active",
                "view": True,
            }
            return render(request, "Inventory/item_store.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def item_store_delete(request, pk):
    if "item_store_delete" in request.permissions or request.user.is_superuser or request.user.is_school_admin:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            item_store=ItemStore.objects.get(id=pk)
            data_branch_id = item_store.branch.id
            if int(data_branch_id) == int(branch_id):                        
                ItemStore.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/item_store")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def item_supplier(request):
    if (
        "item_supplier_view" in request.permissions
        or "item_supplier_add" in request.permissions
        or request.user.is_superuser or request.user.is_school_admin
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = ItemSupplier.objects.filter(branch=branch_id)
            form = ItemSupplierForm()
            if request.method == "POST":
                form = ItemSupplierForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/item_supplier")
                else:
                    print(form.errors)
            context = {"form": form, "records": records, "item_supplier": "active"}
            return render(request, "Inventory/item_supplier.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def item_supplier_edit(request, pk):
    if "item_supplier_edit" in request.permissions or request.user.is_superuser or request.user.is_school_admin:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = ItemSupplier.objects.filter(branch=branch_id)
            record = ItemSupplier.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = ItemSupplierForm(instance=record)
            if request.method == "POST":
                form = ItemSupplierForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/item_supplier")
            context = {
                "form": form,
                "records": records,
                "item_supplier": "active",
                "edit": True,
            }
            return render(request, "Inventory/item_supplier.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def item_supplier_view(request, pk):
    if "item_supplier_view" in request.permissions or request.user.is_superuser or request.user.is_school_admin:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = ItemSupplier.objects.filter(branch=branch_id)
            record = ItemSupplier.objects.get(id=pk)
            form = ItemSupplierForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "item_supplier": "active",
                "view": True,
            }
            return render(request, "Inventory/item_supplier.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def item_supplier_delete(request, pk):
    if "item_supplier_delete" in request.permissions or request.user.is_superuser or request.user.is_school_admin:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            item_supplier=ItemSupplier.objects.get(id=pk)
            item_supplier_branch_id = item_supplier.branch.id
            if int(item_supplier_branch_id) == int(branch_id):                        
                ItemSupplier.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            return HttpResponseRedirect("/item_supplier")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")  # Transport
def routes(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "routes_view" in request.permissions
        or "routes_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Route.objects.filter(branch=branch_id)
            form = RouteForm()
            if request.method == "POST":
                form = RouteForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()  
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/routes")
                else:
                    print(form.errors)
            context = {"form": form, "records": records, "routes": "active"}
            return render(request, "Transport/routes.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def routes_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "routes_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Route.objects.filter(branch=branch_id)
            record = Route.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = RouteForm(instance=record)
            if request.method == "POST":
                form = RouteForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/routes")
            context = {
                "form": form,
                "records": records,
                "routes": "active",
                "edit": True,
            }
            return render(request, "Transport/routes.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def routes_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "routes_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Route.objects.filter(branch=branch_id)
            record = Route.objects.get(id=pk)
            form = RouteForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "routes": "active",
                "view": True,
            }
            return render(request, "Transport/routes.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def routes_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "routes_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            route=Route.objects.get(id=pk)
            route_branch_id = route.branch.id
            if int(route_branch_id) == int(branch_id):                        
                Route.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/routes")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")



@login_required
@user_type_required("Staff")
def vehicle(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "vehicle_view" in request.permissions
        or "vehicle_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Vehicle.objects.filter(branch=branch_id)
            form = VehicleForm()
            if request.method == "POST":
                form = VehicleForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()    
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/vehicle")
                else:
                    print(form.errors)
            context = {"form": form, "records": records, "vehicle": "active"}
            return render(request, "Transport/vehicle.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def vehicle_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "vehicle_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Vehicle.objects.filter(branch=branch_id)
            record = Vehicle.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = VehicleForm(instance=record)
            if request.method == "POST":
                form = VehicleForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/vehicle")
            context = {
                "form": form,
                "records": records,
                "vehicle": "active",
                "edit": True,
            }
            return render(request, "Transport/vehicle.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def vehicle_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "vehicle_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Vehicle.objects.filter(branch=branch_id)
            record = Vehicle.objects.get(id=pk)
            form = VehicleForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "vehicle": "active",
                "view": True,
            }
            return render(request, "Transport/vehicle.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def vehicle_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "vehicle_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            vehicle=Vehicle.objects.get(id=pk)
            vehicle_branch_id = vehicle.branch.id
            if int(vehicle_branch_id) == int(branch_id):                        
                Vehicle.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/vehicle")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def assign_vehicle(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "assign_vehicle_view" in request.permissions
        or "assign_vehicle_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            Route_name = Route.objects.filter(branch=branch_id)
            vehicle_numbers = Vehicle.objects.filter(branch=branch_id)
            records = AssignVehicle.objects.filter(branch=branch_id)
            form = AssignVehicleForm()
            if request.method == "POST":
                form = AssignVehicleForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()        
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/assign_vehicle")
                else:
                    print(form.errors)
            context = {
                "form": form,
                "records": records,
                "assign_vehicle": "active",
                "vehicle_numbers": vehicle_numbers,
                "Route_name": Route_name,
            }
            return render(request, "Transport/assign_vehicle.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def assign_vehicle_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "assign_vehicle_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            Route_name = Route.objects.filter(branch=branch_id)
            records = AssignVehicle.objects.filter(branch=branch_id)
            vehicle_numbers = Vehicle.objects.filter(branch=branch_id)
            record = AssignVehicle.objects.get(id=pk)
            data_branch_id = record.branch.id
            lists = record.vehicle.filter(branch=branch_id)
            list = [data.id for data in lists]
            form = AssignVehicleForm(instance=record)
            if request.method == "POST":
                form = AssignVehicleForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/assign_vehicle")
            context = {
                "form": form,
                "records": records,
                "assign_vehicle": "active",
                "edit": True,
                "list": list,
                "record": record,
                "Route_name": Route_name,
                "vehicle_numbers": vehicle_numbers,
            }
            return render(request, "Transport/assign_vehicle.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def assign_vehicle_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "assign_vehicle_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            vehicle_numbers = Vehicle.objects.filter(branch=branch_id)
            Route_name = Route.objects.filter(branch=branch_id)
            records = AssignVehicle.objects.filter(branch=branch_id)
            record = AssignVehicle.objects.get(id=pk)
            lists = record.vehicle.filter(branch=branch_id)
            list = [data.id for data in lists]
            form = AssignVehicleForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "assign_vehicle": "active",
                "view": True,
                "record": record,
                "vehicle_numbers": vehicle_numbers,
                "Route_name": Route_name,
                "list": list,
            }
            return render(request, "Transport/assign_vehicle.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def assign_vehicle_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "assign_vehicle_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            assign_vehicle=AssignVehicle.objects.get(id=pk)
            assign_vehicle_branch_id = assign_vehicle.branch.id
            if int(assign_vehicle_branch_id) == int(branch_id):                        
                AssignVehicle.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/assign_vehicle")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")  # Hostel
def hostel_room(request):
    if (
        "hostel_rooms_view" in request.permissions
        or "hostel_rooms_add" in request.permissions
        or request.user.is_superuser or request.user.is_school_admin
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)

            records = HostelRoom.objects.filter(branch=branch_id)
            form = HostelRoomForm()
            if request.method == "POST":
                form = HostelRoomForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()       
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/hostel_room")
                else:
                    print(form.errors)
            context = {"form": form, "records": records, "hostel_room": "active"}
            return render(request, "Hostel/hostel_room.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def hostel_room_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "hostel_rooms_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = HostelRoom.objects.filter(branch=branch_id)
            record = HostelRoom.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = HostelRoomForm(instance=record)
            if request.method == "POST":
                form = HostelRoomForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/hostel_room")
            context = {
                "form": form,
                "records": records,
                "hostel_room": "active",
                "edit": True,
            }
            return render(request, "Hostel/hostel_room.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def hostel_room_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "hostel_rooms_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = HostelRoom.objects.filter(branch=branch_id)
            record = HostelRoom.objects.get(id=pk)
            form = HostelRoomForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "hostel_room": "active",
                "view": True,
            }
            return render(request, "Hostel/hostel_room.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def hostel_room_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "hostel_rooms_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)

            hostel_room=HostelRoom.objects.get(id=pk)
            hostel_room_branch_id = hostel_room.branch.id
            if int(hostel_room_branch_id) == int(branch_id):                        
                HostelRoom.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/hostel_room")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def room_type(request):
    if (
        "room_type_view" in request.permissions
        or "room_type_add" in request.permissions
        or request.user.is_superuser or request.user.is_school_admin
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = RoomType.objects.filter(branch=branch_id)
            form = RoomTypeForm()
            if request.method == "POST":
                form = RoomTypeForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()        
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/room_type")
                else:
                    print(form.errors)
            context = {"form": form, "records": records, "room_type": "active"}
            return render(request, "Hostel/room_type.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def room_type_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "room_type_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)

            records = RoomType.objects.filter(branch=branch_id)
            record = RoomType.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = RoomTypeForm(instance=record)
            if request.method == "POST":
                form = RoomTypeForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/room_type")
            context = {
                "form": form,
                "records": records,
                "room_type": "active",
                "edit": True,
            }
            return render(request, "Hostel/room_type.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def room_type_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "room_type_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = RoomType.objects.filter(branch=branch_id)
            record = RoomType.objects.get(id=pk)
            form = RoomTypeForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "room_type": "active",
                "view": True,
            }
            return render(request, "Hostel/room_type.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def room_type_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "room_type_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            room_type=RoomType.objects.get(id=pk)
            room_type_branch_id = room_type.branch.id
            if int(room_type_branch_id) == int(branch_id):                        
                RoomType.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/room_type")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def hostel(request):
    if (
        "hostel_view" in request.permissions
        or "hostel_add" in request.permissions
        or request.user.is_superuser or request.user.is_school_admin
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Hostel.objects.filter(branch=branch_id)
            form = HostelForm()
            if request.method == "POST":
                form = HostelForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/hostel")
                else:
                    print(form.errors)
            context = {"form": form, "records": records, "hostel": "active"}
            return render(request, "Hostel/hostel.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def hostel_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "hostel_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Hostel.objects.filter(branch=branch_id)
            record = Hostel.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = HostelForm(instance=record)
            if request.method == "POST":
                form = HostelForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/hostel")
            context = {
                "form": form,
                "records": records,
                "hostel": "active",
                "edit": True,
            }
            return render(request, "Hostel/hostel.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def hostel_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "hostel_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Hostel.objects.filter(branch=branch_id)
            record = Hostel.objects.get(id=pk)
            form = HostelForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "hostel": "active",
                "view": True,
            }
            return render(request, "Hostel/hostel.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def hostel_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "hostel_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            hostel=Hostel.objects.get(id=pk)
            hostel_branch_id = hostel.branch.id
            if int(hostel_branch_id) == int(branch_id):                        
                Hostel.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/hostel")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")  # Certificate
def student_certificate(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "student_certificate_view" in request.permissions
        or "student_certificate_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = StudentCertificate.objects.filter(branch=branch_id)
            form = StudentCertificateForm()
            if request.method == "POST":
                form = StudentCertificateForm(request.POST, request.FILES)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()        
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/student_certificate")
                else:
                    print(form.errors)
            context = {
                "form": form,
                "records": records,
                "student_certificate": "active",
            }
            return render(request, "Certificate/student_certificate.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def student_certificate_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "student_certificate_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = StudentCertificate.objects.filter(branch=branch_id)
            record = StudentCertificate.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = StudentCertificateForm(instance=record)
            if request.method == "POST":
                form = StudentCertificateForm(
                    request.POST, request.FILES, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/student_certificate")
            context = {
                "form": form,
                "records": records,
                "student_certificate": "active",
                "edit": True,
            }
            return render(request, "Certificate/student_certificate.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def student_certificate_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "student_certificate_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = StudentCertificate.objects.filter(branch=branch_id)
            record = StudentCertificate.objects.get(id=pk)
            form = StudentCertificateForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "student_certificate": "active",
                "view": True,
            }
            return render(request, "Certificate/student_certificate.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def student_certificate_delete(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)

    student_certificate=StudentCertificate.objects.get(id=pk)
    student_certificate_branch_id = student_certificate.branch.id
    if int(student_certificate_branch_id) == int(branch_id):                        
        StudentCertificate.objects.get(id=pk).delete()
    else:
        messages.error(request, "School id Doesn't match record no delete")
    messages.error(request, "Record Deleted Successfully")
    return HttpResponseRedirect("/student_certificate")


@login_required
@user_type_required("Staff")
def student_id_card(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "student_id_card_view" in request.permissions
        or "student_id_card_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = StudentId.objects.filter(branch=branch_id)
            form = StudentIdForm()
            if request.method == "POST":
                form = StudentIdForm(request.POST, request.FILES)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()   
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/student_id_card")
                else:
                    print(form.errors)
            context = {"form": form, "records": records, "student_id_card": "active"}
            return render(request, "Certificate/student_id_card.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def student_id_card_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "student_id_card_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = StudentId.objects.filter(branch=branch_id)
            record = StudentId.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = StudentIdForm(instance=record)
            if request.method == "POST":
                form = StudentIdForm(request.POST, request.FILES, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/student_id_card")
            context = {
                "form": form,
                "records": records,
                "student_id_card": "active",
                "record": record,
                "edit": True,
            }
            return render(request, "Certificate/student_id_card_edit.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def student_id_card_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "student_id_card_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = StudentId.objects.filter(branch=branch_id)
            record = StudentId.objects.get(id=pk)
            form = StudentIdForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "student_id_card": "active",
                "view": True,
                "record": record,
            }
            return render(request, "Certificate/student_id_card_view.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def student_id_card_delete(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
    print("branch_name@@@",branch_name)
    student_id=StudentId.objects.get(id=pk)
    student_id_branch_id = student_id.branch.id
    if int(student_id_branch_id) == int(branch_id):                        
        StudentId.objects.get(id=pk).delete()
    else:
        messages.error(request, "School id Doesn't match record no delete")
    messages.error(request, "Record Deleted Successfully")
    return HttpResponseRedirect("/student_id_card")


@login_required
@user_type_required("Staff")
def event_view(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    records = Event.objects.filter(branch=branch_id)
    record = Event.objects.get(id=pk)
    form = EventForm(instance=record)
    context = {"form": form, "records": records, "event": "active", "view": True}
    return render(request, "Front_cms/event_edit.html", context)


@login_required
@user_type_required("Staff")
def event_delete(request, pk):
    Event.objects.get(id=pk).delete()
    messages.error(request, "Record Deleted Successfully")
    return HttpResponseRedirect("/event")


@login_required
@user_type_required("Staff")
def media_manager(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    records = MediaManager.objects.filter(branch=branch_id)
    form = MediaManagerForm()
    if request.method == "POST":
        form = MediaManagerForm(request.POST)
        if form.is_valid():
            form.save()
            return HttpResponseRedirect("/media_manager")
        else:
            print(form.errors)
    context = {"form": form, "records": records, "media_manager": "active"}
    return render(request, "Front_cms/media_manager.html", context)


@login_required
@user_type_required("Staff")
def media_manager_edit(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    records = MediaManager.objects.filter(branch=branch_id)
    record = MediaManager.objects.get(id=pk)
    form = MediaManagerForm(instance=record)
    if request.method == "POST":
        form = MediaManagerForm(request.POST, instance=record)
        if form.is_valid():
            form.save()
            return HttpResponseRedirect("/media_manager")
    context = {"form": form, "records": records, "media_manager": "active"}
    return render(request, "Front_cms/media_manager_edit.html", context)


@login_required
@user_type_required("Staff")
def media_manager_view(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    records = MediaManager.objects.filter(branch=branch_id)
    record = MediaManager.objects.get(id=pk)
    form = MediaManagerForm(instance=record)
    context = {
        "form": form,
        "records": records,
        "media_manmenusager": "active",
        "view": True,
    }
    return render(request, "Front_cms/media_manager_edit.html", context)


@login_required
@user_type_required("Staff")
def media_manager_delete(request, pk):
    MediaManager.objects.get(id=pk).delete()
    return HttpResponseRedirect("/media_manager")


@login_required
@user_type_required("Staff")
def menus(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    records = Menu.objects.filter(branch=branch_id)
    form = MenuForm()
    if request.method == "POST":
        form = MenuForm(request.POST)
        if form.is_valid():
            form.save()
            return HttpResponseRedirect("/menus")
        else:
            print(form.errors)
    context = {"form": form, "records": records, "menus": "active"}
    return render(request, "Front_cms/menus.html", context)


@login_required
@user_type_required("Staff")
def menus_edit(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    records = Menu.objects.filter(branch=branch_id)
    record = Menu.objects.get(id=pk)
    form = MenuForm(instance=record)
    if request.method == "POST":
        form = MenuForm(request.POST, instance=record)
        if form.is_valid():
            form.save()
            return HttpResponseRedirect("/menus")
    context = {"form": form, "records": records, "menus": "active"}
    return render(request, "Front_cms/menus_edit.html", context)


@login_required
@user_type_required("Staff")
def menus_view(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    records = Menu.objects.filter(branch=branch_id)
    record = Menu.objects.get(id=pk)
    form = MenuForm(instance=record)
    context = {"form": form, "records": records, "menus": "active", "view": True}
    return render(request, "Front_cms/menus_edit.html", context)


@login_required
@user_type_required("Staff")
def menus_delete(request, pk):
    Menu.objects.get(id=pk).delete()
    return HttpResponseRedirect("/menus")


@login_required
@user_type_required("Staff")
def alumni_events(request):
    if (
        "Alumni_events_view" in request.permissions
        or "Alumni_events_add" in request.permissions
        or request.user.is_superuser or request.user.is_school_admin
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = AlumniEvent.objects.filter(branch=branch_id)
            form = AlumniEventForm()
            if request.method == "POST":
                form = AlumniEventForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()        
                    messages.success(request, "Record Saved Successfully")

                    return HttpResponseRedirect("/alumni_events")
                else:
                    print(form.errors)
            context = {"form": form, "records": records, "alumni_events": "active"}
            return render(request, "Alumni/alumni_events.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def alumni_events_add(request):
    if request.user.is_superuser or request.user.is_school_admin or "Alumni_events_add" in request.permissions:
        try:
            form = AlumniEventForm()
            context = {
                "form": form,
            }
            return render(request, "Alumni/alumni_events_add.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def alumni_events_edit(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "Alumni_events_edit" in request.permissions
        or "Alumni_events_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = AlumniEvent.objects.filter(branch=branch_id)
            record = AlumniEvent.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = AlumniEventForm(instance=record)
            if request.method == "POST":
                form = AlumniEventForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/alumni_events")
            context = {
                "form": form,
                "records": records,
                "alumni_events": "active",
                "record": record,
            }
            return render(request, "Alumni/alumni_events_edit.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def alumni_events_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "Alumni_events_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = AlumniEvent.objects.filter(branch=branch_id)
            record = AlumniEvent.objects.get(id=pk)
            form = AlumniEventForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "alumni_events": "active",
                "view": True,
            }
            return render(request, "Alumni/alumni_events_edit.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def alumni_events_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "Alumni_events_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            alumni_event=AlumniEvent.objects.get(id=pk)
            alumni_event_branch_id = alumni_event.branch.id
            if int(alumni_event_branch_id) == int(branch_id):                        
                AlumniEvent.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/alumni_events")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def session(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    records = Session.objects.filter(branch=branch_id)
    form = SessionForm()
    if request.method == "POST":
        form = SessionForm(request.POST)
        if form.is_valid():
            obj=form.save()
            obj.branch_id = branch_id
            obj.save()
            messages.success(request, "Record Saved Successfully")
            return HttpResponseRedirect("/session")
        else:
            print(form.errors)
    context = {"form": form, "records": records, "session": "active"}
    return render(request, "System_setting/session.html", context)


@login_required
@user_type_required("Staff")
def session_edit(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    records = Session.objects.filter(branch=branch_id)
    record = Session.objects.get(id=pk)
    data_branch_id = record.branch.id
    form = SessionForm(instance=record)
    if request.method == "POST":
        form = SessionForm(request.POST, instance=record)
        if form.is_valid():
            if branch_id == data_branch_id:
                form.save()
            else:
                form.instance.branch_id = branch_id
            form.save()
            messages.warning(request, "Record Updated Successfully")
            return HttpResponseRedirect("/session")
    context = {"form": form, "records": records, "session": "active", "edit": True}
    return render(request, "System_setting/session.html", context)


@login_required
@user_type_required("Staff")
def session_view(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    records = Session.objects.filter(branch=branch_id)
    record = Session.objects.get(id=pk)
    form = SessionForm(instance=record)
    context = {"form": form, "records": records, "session": "active", "view": True}
    return render(request, "System_setting/session.html", context)


@login_required
@user_type_required("Staff")
def session_delete(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    session=Session.objects.get(id=pk)
    session_branch_id = session.branch.id
    if int(session_branch_id) == int(branch_id):                        
        Session.objects.get(id=pk).delete()
    else:
        messages.error(request, "School id Doesn't match record no delete")
    messages.error(request, "Record Deleted Successfully")
    return HttpResponseRedirect("/session")


@login_required
@user_type_required("Staff")
def role(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    records = Role.objects.filter(branch=branch_id)
    form = RoleForm()
    if request.method == "POST":
        form = RoleForm(request.POST)
        if form.is_valid():
            obj=form.save()
            obj.branch_id = branch_id
            obj.save() 
            messages.success(request, "Record Saved Successfully")

            return HttpResponseRedirect("/role")
        else:
            print(form.errors)
    context = {"form": form, "records": records, "role": "active"}
    return render(request, "System_setting/role.html", context)


@login_required
@user_type_required("Staff")
def assign_permission(request, pk):
    record = Role.objects.get(id=pk)
    if request.method == "POST":
        record.permissions = request.POST.getlist("access")
        record.save()
        return redirect("/role")
    context = {
        "role": "active",
        "record": record,
    }
    return render(request, "System_setting/assign_permission.html", context)


@login_required
@user_type_required("Staff")
def role_edit(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    records = Role.objects.filter(branch=branch_id)
    record = Role.objects.get(id=pk)
    data_branch_id = record.branch.id
    form = RoleForm(instance=record)
    if request.method == "POST":
        form = RoleForm(request.POST, instance=record)
        if form.is_valid():
            if branch_id == data_branch_id:
                form.save()
            else:
                form.instance.branch_id = branch_id
            form.save()
            messages.warning(request, "Record Updated Successfully")

            return HttpResponseRedirect("/role")
    context = {"form": form, "records": records, "role": "active", "edit": True}
    return render(request, "System_setting/role.html", context)


@login_required
@user_type_required("Staff")
def role_view(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    records = Role.objects.filter(branch=branch_id)
    record = Role.objects.get(id=pk)
    form = RoleForm(instance=record)
    context = {"form": form, "records": records, "role": "active", "view": True}
    return render(request, "System_setting/role.html", context)


@login_required
@user_type_required("Staff")
def role_delete(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    role=Role.objects.get(id=pk)
    role_branch_id = role.branch.id
    if int(role_branch_id) == int(branch_id):                        
        Role.objects.get(id=pk).delete()
    else:
        messages.error(request, "School id Doesn't match record no delete")
    messages.error(request, "Record Deleted Successfully")
    return HttpResponseRedirect("/role")


@login_required
@user_type_required("Staff")
def student_list_view(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    toady_date = datetime.now().date()
    fees_records = FeesAssign.objects.filter(student=pk, session=request.Session)
    # fees_discount=FeesTypeDiscount.objects.filter(branch=branch_id)
    fees_discount = DiscountAssign.objects.filter(student=pk, session=request.Session)
    paid_record = StudentFess.objects.filter(student=pk, session=request.Session)

    student = StudentAdmission.objects.get(id=pk)
    custom = CustomFields.objects.filter(field_belongs_to="Student")
    custom_fields = []
    for data in custom:
        obj = StudentCustomFieldValues.objects.filter(field=data, student=pk).last()
        dict = {}
        dict["custome_fields"] = data.field_name
        if obj:
            dict["value"] = obj.value
        else:
            dict["value"] = ""
        custom_fields.append(dict)

    records = Timeline.objects.filter(student=pk)
    document_records = StudentDocuments.objects.filter(student=pk)
    reason = DisableReason.objects.filter(branch=branch_id)
    login_records = LoginCredentials.objects.filter(
        student__admission_no=student.admission_no,
        student__Class=student.Class,
        student__section=student.section,
        student__date_of_birth=student.date_of_birth,
    ).last()
    form = TimelineForm()
    document_form = StudentDocumentsForm()
    if request.method == "POST":
        if request.POST.get("doc_btn"):
            print("aaa")
            document_form = StudentDocumentsForm(request.POST, request.FILES)
            if document_form.is_valid():
                doc_obj = document_form.save(commit=False)
                doc_obj.student_id = pk
                doc_obj.session = request.Session
                doc_obj.created_by = request.user
                doc_obj.save()
                return HttpResponseRedirect(f"/student_list_view/{pk}")
            else:
                print(document_form.errors)
        else:
            form = TimelineForm(request.POST, request.FILES)
            if form.is_valid():
                obj = form.save(commit=False)
                obj.student_id = pk
                obj.session = request.Session
                obj.created_by = request.user
                obj.save()
                return HttpResponseRedirect(f"/student_list_view/{pk}")

    context = {
        "form": form,
        "records": records,
        "student_details": "active",
        "student": student,
        "reason": reason,
        "login_records": login_records,
        "custom_fields": custom_fields,
        "document_form": document_form,
        "document_records": document_records,
        "fees_records": fees_records,
        "toady_date": toady_date,
        "fees_discount": fees_discount,
        "paid_record": paid_record,
    }
    return render(request, "Student_information/student_list_view.html", context)


@login_required
@user_type_required("Staff")
def student_list_delete(request, pk):
    Timeline.objects.get(id=pk).delete()
    return HttpResponseRedirect("/student_list_view")


@login_required
@user_type_required("Staff")
def student_doc_delete(request, pk):
    StudentDocuments.objects.get(id=pk).delete()
    return redirect(request.META.get("HTTP_REFERER"))


@login_required
@user_type_required("Staff")  # Report
def student_information_report(request):
    if request.user.is_superuser or request.user.is_school_admin or "student_report_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            class_records = Class.objects.filter(branch=branch_id)
            section_records = Section.objects.filter(branch=branch_id)
            category_records = StudentCategory.objects.filter(branch=branch_id)

            if request.method == "POST":
                classs = request.POST.get("class")
                section = request.POST.get("section")
                category = request.POST.get("category")
                gender = request.POST.get("gender")
                rte = request.POST.get("rte")

                filters = {}

                if classs:
                    filters["Class_id"] = classs

                if section:
                    filters["section_id"] = section

                if category:
                    filters["category_id"] = category

                if gender:
                    filters["gender"] = gender

                if rte:
                    filters["rte"] = rte

                if branch_id:
                    filters["branch_id"] = branch_id    

                records = StudentAdmission.objects.filter(**filters)

                context = {
                    "student_information_report": "active",
                    "records": records,
                    "class_records": class_records,
                    "section_records": section_records,
                    "category_records": category_records,
                }

                return render(
                    request, "Reports/student_information_report.html", context
                )

            context = {
                "student_information_report": "active",
                "class_records": class_records,
                "section_records": section_records,
                "category_records": category_records,
            }

            return render(request, "Reports/student_information_report.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def guardian_report(request):
    if request.user.is_superuser or request.user.is_school_admin or "student_report_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            class_records = Class.objects.filter(branch=branch_id)
            section_records = Section.objects.filter(branch=branch_id)

            if request.method == "POST":
                classs = request.POST.get("class")
                section = request.POST.get("section")
                filters = {}
                if classs:
                    filters["Class_id"] = classs

                if section:
                    filters["section_id"] = section
                if branch_id:
                    filters["branch_id"] = branch_id    

                records = StudentAdmission.objects.filter(**filters)

                context = {
                    "student_information_report": "active",
                    "records": records,
                    "class_records": class_records,
                    "section_records": section_records,
                }

                return render(request, "Reports/guardian_report.html", context)

            context = {
                "student_information_report": "active",
                "class_records": class_records,
                "section_records": section_records,
            }

            return render(request, "Reports/guardian_report.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def student_history_report(request):
    if request.user.is_superuser or request.user.is_school_admin or "student_report_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            class_records = Class.objects.filter(branch=branch_id)
            section_records = Section.objects.filter(branch=branch_id)
            today = datetime.today()
            year = today.year
            print(year)

            if request.method == "POST":
                classs = request.POST.get("class")
                yearr = request.POST.get("yearr")
                filters = {}
                if classs:
                    filters["Class_id"] = classs

                if yearr:
                    filters["admission_date__year"] = yearr

                if branch_id:
                    filters["branch_id"] = branch_id    

                records = StudentAdmission.objects.filter(**filters)

                context = {
                    "student_information_report": "active",
                    "records": records,
                    "class_records": class_records,
                    "section_records": section_records,
                    "year": year,
                }

                return render(request, "Reports/student_history_report.html", context)

            context = {
                "student_information_report": "active",
                "class_records": class_records,
                "section_records": section_records,
                "year": year,
            }

            return render(request, "Reports/student_history_report.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def disable_enable(request):
    id = request.POST.get("student_id")
    reason = request.POST.get("reason")
    disable_date = request.POST.get("disable_date")
    disable_note = request.POST.get("disable_note")
    record = StudentAdmission.objects.get(id=id)
    if record.status == "Enable":
        record.status = "Disable"
        record.disable_date = disable_date
        record.diable_reson_id = reason
        record.disable_note = disable_note
        DisableHistroy.objects.create(
            student_id=id,
            disable_date=disable_date,
            diable_reson_id=reason,
            disable_note=disable_note,
        )
    elif record.status == "Disable":
        record.status = "Enable"
    record.save()

    return HttpResponseRedirect(f"/student_list_view/{id}")


@login_required
@user_type_required("Staff")
def addexamlist(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "student_report_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name    
                print('the branch is ',branch_id)   
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            exam_group = examGroup.objects.get(id=pk)
            print('exam_group11111',exam_group)
            records = AddExam.objects.filter(exam_group=exam_group, session=request.Session,branch_id=branch_id)
            form = AddExamForm()
            if request.method == "POST":
                print('asdfgtrew',request.POST)
                form = AddExamForm(request.POST)
                print('the form is valid or not ',form.is_valid())
                if form.is_valid():
                    data = form.save(commit=False)
                    data.exam_group = exam_group
                    data.branch_id = branch_id
                    data.save()
                    return HttpResponseRedirect(f"/addexamlist/{pk}")
                else:
                    print(form.errors)  
            context = {
                "form": form,
                "addexamlist": "active",
                "records": records,
                "exam_groups": exam_group,
                "exam_group": "active",
            }
            return render(request, "Examinations/addexamlist.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def addexamlist_edit(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    record = AddExam.objects.get(id=pk)
    data_branch_id = record.branch.id
    form = AddExamForm(instance=record)
    if request.method == "POST":
        form = AddExamForm(request.POST, instance=record)
        if form.is_valid():
            if branch_id == data_branch_id:
                form.save()
            else:
                form.instance.branch_id = branch_id
            form.save()
            return HttpResponseRedirect(f"/addexamlist/{record.exam_group.id}")
    context = {"form": form, "addexamlist_edit": "active"}
    return render(request, "Examinations/addexamlist_edit.html", context)


@login_required
@user_type_required("Staff")
def addexamlist_delete(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    time_line=Timeline.objects.get(id=pk)
    expense_head_branch_id = time_line.branch.id
    if int(expense_head_branch_id) == int(branch_id):                        
        Timeline.objects.get(id=pk).delete()
    else:
        messages.error(request, "School id Doesn't match record no delete")
    messages.error(request, "Record Deleted Successfully")
    return HttpResponseRedirect("/addexamlist")


@login_required
@user_type_required("Staff")
def assign_view_student(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    exam = AddExam.objects.get(id=pk)
    class_records = Class.objects.filter(branch=branch_id)
    section_records = Section.objects.filter(branch=branch_id)
    if request.POST.get("search_btn") == "search_btn":
        classs = request.POST.get("class")
        section = request.POST.get("section")
        exam_student = ExamStudent.objects.filter(
            Class_id=classs,
            section_id=section,
            exam=exam,
            student__session=request.Session,
            branch_id=branch_id
        )
        records = StudentAdmission.objects.filter(
            Class_id=classs, section_id=section, session=request.Session,branch_id=branch_id
        ).exclude(id__in=exam_student.values("student_id"))

        context = {
            "exam_group": "active",
            "records": records,
            "class_records": class_records,
            "section_records": section_records,
            "exam_student": exam_student,
        }
        return render(request, "Examinations/assign_view_student.html", context)
    if request.POST.get("save_btn") == "save_btn":
        ids = request.POST.getlist("student_ids")
        for id in ids:
            stu = StudentAdmission.objects.get(id=id)
            ExamStudent.objects.get_or_create(
                exam_id=pk,
                student_id=id,
                Class=stu.Class,
                section=stu.section,
                branch_id=branch_id
            )
        rem_ids = request.POST.getlist("rem_ids")
        exits_ids = request.POST.getlist("exits_ids")
        temp = [x for x in exits_ids if x not in rem_ids]
        ExamStudent.objects.filter(id__in=temp).delete()
    context = {
        "exam_group": "active",
        "class_records": class_records,
        "section_records": section_records,
    }
    return render(request, "Examinations/assign_view_student.html", context)


@login_required
@user_type_required("Staff")
# def addexamsubject(request):
#     subject_records=Subjects.objects.filter(branch=branch_id)
#     context={
#         'subject_records':subject_records,
#     }

#     return render(request,'Examinations/addexamsubject.html',context)


@login_required
@user_type_required("Staff")
def addexamsubject(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    exam_record = AddExam.objects.get(id=pk)
    subject_records = Subjects.objects.filter(branch=branch_id)
    exam_subjects_records = AddExamSubject.objects.filter(exam=exam_record,branch_id=branch_id)

    if request.method == "POST":
        subject_data = request.POST.getlist("subject")
        date_data = request.POST.getlist("date")
        time_data = request.POST.getlist("time")
        duration_data = request.POST.getlist("duration")
        credit_hours_data = request.POST.getlist("credit_hours")
        room_number_data = request.POST.getlist("room_number")
        marks_max_data = request.POST.getlist("marks_max")
        marks_min_data = request.POST.getlist("marks_min")

        # Process the form data as needed
        for i in range(len(subject_data)):
            subject = subject_data[i]
            date = date_data[i]
            time = time_data[i]
            duration = duration_data[i]
            credit_hours = credit_hours_data[i]
            room_number = room_number_data[i]
            marks_max = marks_max_data[i]
            marks_min = marks_min_data[i]

            AddExamSubject.objects.create(
                subject_id=subject,
                date=date,
                time=time,
                duration=duration,
                credit_hours=credit_hours,
                room_number=room_number,
                marks_max=marks_max,
                marks_min=marks_min,
                exam=exam_record,
                branch_id=branch_id
            )
        messages.success(request, "Record Saved Successfully")
        return HttpResponseRedirect(f"/addexamsubject/{pk}")

    context = {
        "exam_group": "active",
        "subject_records": subject_records,
        "exam_record": exam_record,
        "exam_subjects_records": exam_subjects_records,
    }
    return render(request, "Examinations/addexamsubject.html", context)


@login_required
@user_type_required("Staff")
def delete_exam_subjects(request, pk):
    records = AddExamSubject.objects.get(id=pk)
    exam = records.exam.id
    records.delete()
    messages.error(request, "Record Deleted Successfully")
    return HttpResponseRedirect(f"/addexamsubject/{exam}")


@login_required
@user_type_required("Staff")
def addexammark(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    records = AddExamSubject.objects.filter(exam=pk,branch_id=branch_id)
    return render(
        request,
        "Examinations/addexammark.html",
        {"records": records, "exam_group": "active"},
    )


@login_required
@user_type_required("Staff")
def enter_mark(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    exam_subject = AddExamSubject.objects.get(id=pk)
    class_records = Class.objects.filter(branch=branch_id)
    section_records = Section.objects.filter(branch=branch_id)
    session_records = Session.objects.filter(branch=branch_id)
    if request.POST.get("search") == "search":
        classs = request.POST.get("class")
        section = request.POST.get("sectionn")
        session = request.POST.get("session")
        exist_records = EntryMarks.objects.filter(
            student__Class_id=classs,
            student__section_id=section,
            exam_subject=exam_subject,
            student__session=session,
        )
        print("exist_records---",exist_records)
        records = ExamStudent.objects.filter(
            student__Class_id=classs,
            student__section_id=section,
            exam=exam_subject.exam,
            student__session=session,
        )
        print("records---",records)
        context = {
            "exam_group": "active",
            "records": records,
            "class_records": class_records,
            "session_records": session_records,
            "section_records": section_records,
            "exam_subject": exam_subject,
            "pk": pk,
            "exist_records": exist_records,
        }
        return render(request, "Examinations/enter_mark.html", context)
    context = {
        "exam_group": "active",
        "class_records": class_records,
        "session_records": session_records,
        "section_records": section_records,
        "exam_subject": exam_subject,
    }
    return render(request, "Examinations/enter_mark.html", context)


@login_required
@user_type_required("Staff")
def mark_save(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    exam_subject = AddExamSubject.objects.get(id=pk)
    student_list = request.POST.getlist("student_id")
    assign_list = request.POST.getlist("assign_list")
    mark_id_list = request.POST.getlist("mark_id")
    marks_list = request.POST.getlist("marks")
    notes_list = request.POST.getlist("notes")
    count = request.POST.get("count")
    attendance_list = []
    for i in range(1, int(count) + 1):
        if f"attendance{i}" in request.POST:
            attendance_list.append(True)
        else:
            attendance_list.append(False)
    if len(mark_id_list) > 0:
        for i in range(len(mark_id_list)):
            data = EntryMarks.objects.get(id=mark_id_list[i])
            data.attendance = attendance_list[i]
            data.marks = marks_list[i]
            data.note = notes_list[i]
            branch_id = branch_id
            data.save()
    else:
        for i in range(len(student_list)):
            EntryMarks.objects.get_or_create(
                exam=exam_subject.exam,
                exam_subject=exam_subject,
                exam_student_id=assign_list[i],
                subject=exam_subject.subject,
                student_id=student_list[i],
                attendance=attendance_list[i],
                marks=marks_list[i],
                note=notes_list[i],
                branch_id = branch_id,
            )
    return HttpResponseRedirect(f"/enter_mark/{pk}")


@login_required
# @user_type_required("Staff")
def staff_directory(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "staff_view" in request.permissions
        or "staff_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            roels = Role.objects.filter(branch=branch_id)
            # User.objects.filter(branch=branch_id).last().delete()
            records = AddStaff.objects.filter(branch=branch_id)
            if request.method == "POST":
                role = request.POST.get("role")
                records = AddStaff.objects.filter(roles=role,branch_id=branch_id)
                context = {
                    "records": records,
                    "staff_directory": "active",
                    "roels": roels,
                }
                return render(request, "Human_Resource/staff_directory.html", context)
            context = {"roels": roels, "staff_directory": "active", "records": records}
            return render(request, "Human_Resource/staff_directory.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def Staff_details_show(request, pk):
    record = AddStaff.objects.get(id=pk)
    # payroll
    payroll_records = PayrollSummary.objects.filter(Frist_name=pk)
    total_net_salary = payroll_records.aggregate(Sum("net_salary"))["net_salary__sum"]
    total_gross_salary = payroll_records.aggregate(Sum("gross_salary"))[
        "gross_salary__sum"
    ]
    total_earning = payroll_records.aggregate(Sum("earning"))["earning__sum"]
    total_deduction = payroll_records.aggregate(Sum("deduction"))["deduction__sum"]
    staff_leaves = ApproveLeave.objects.filter(name=pk)
    available_leaves = AvailableLeave.objects.filter(
        staff_leave__staff__id=pk, session=request.Session
    )
    custom = CustomFields.objects.filter(field_belongs_to="Staff")
    custom_fields = []
    for data in custom:
        obj = StaffCustomFieldValues.objects.filter(field=data, staff=pk).last()
        dict = {}
        dict["custome_fields"] = data.field_name
        if obj:
            dict["value"] = obj.value
        else:
            dict["value"] = ""
        custom_fields.append(dict)
    #  document upload
    document_records = StaffDocument.objects.filter(staff=pk)
    document_form = StaffDocumentForm()
    if request.POST.get("doc_btn"):
        document_form = StaffDocumentForm(request.POST, request.FILES)
        if document_form.is_valid():
            obj = document_form.save(commit=False)
            obj.staff_id = pk
            obj.created_by = request.user
            obj.save()
            return redirect(f"/Staff_details_show/{pk}")
    #  Timeline
    timeline_records = StaffTimeline.objects.filter(staff=pk)
    timeline_form = StaffTimelineForm()
    if request.POST.get("timeline_btn"):
        timeline_form = StaffTimelineForm(request.POST, request.FILES)
        if timeline_form.is_valid():
            obj = timeline_form.save(commit=False)
            obj.staff_id = pk
            obj.created_by = request.user
            obj.save()
            return redirect(f"/Staff_details_show/{pk}")
        else:
            print(timeline_form.errors)
    context = {
        "record": record,
        "staff_directory": "active",
        "custom_fields": custom_fields,
        "payroll_records": payroll_records,
        "document_records": document_records,
        "document_form": document_form,
        "staff_leaves": staff_leaves,
        "available_leaves": available_leaves,
        "timeline_records": timeline_records,
        "timeline_form": timeline_form,
        "total_net_salary": total_net_salary,
        "total_gross_salary": total_gross_salary,
        "total_earning": total_earning,
        "total_deduction": total_deduction,
    }
    return render(request, "Human_Resource/Staff_details_show.html", context)


@login_required
@user_type_required("Staff")
def delete_staff_document(request, pk):
    StaffDocument.objects.get(id=pk).delete()
    return redirect(request.META.get("HTTP_REFERER"))


@login_required
@user_type_required("Staff")
def delete_staff_timeline(request, pk):
    StaffTimeline.objects.get(id=pk).delete()
    return redirect(request.META.get("HTTP_REFERER"))


@login_required
@user_type_required("Staff")
def staff_disable_enable(request):
    pk = request.POST.get("staff_id")
    record = AddStaff.objects.get(id=pk)
    if record.status == "Disable":
        record.status = "Enable"
    else:
        record.status = "Disable"
        record.disable_date = request.POST.get("disable_date")
    record.save()
    return HttpResponseRedirect(f"/Staff_details_show/{pk}")


@login_required
@user_type_required("Staff")
def add_staffs_edit(request, pk):
    system_fields = SystemFields.objects.last()
    custom_fields = CustomFields.objects.filter(field_belongs_to="Staff")
    staff_custom = StaffCustomFieldValues.objects.filter(staff=pk)
    custom_fileds_records = []
    for data in custom_fields:
        dict = {}
        dict["custom_fields"] = data
        dict["student_custom"] = staff_custom.filter(field=data.id).last()
        custom_fileds_records.append(dict)
    print(custom_fileds_records)
    record = AddStaff.objects.get(id=pk)
    form = AddStaffForm(instance=record)
    leave_type = AddLeaveType.objects.all()
    staff_leave_records = StaffLeave.objects.filter(staff=pk)
    staff = StaffEducationQualification.objects.filter(
            staff=record
        )
    try:
        staff_leave_count = StaffLeave.objects.get(staff=pk)
        staff_leave_count=StaffLeave.objects.get(staff=pk)
        print("staff_leave_count---",staff_leave_count.total_leave)
        staff_leave_counts=staff_leave_count.total_leave
        # Perform actions with staff_leave_count
    except StaffLeave.DoesNotExist:
        # Handle the case where the record does not exist
        staff_leave_count = None
        print("No matching StaffLeave record found for the given staff ID.")
    
    print('staff',staff)
    leave_list = []
    for data in leave_type:
        dict = {}
        obj = staff_leave_records.filter(leave_type=data).last()
        if obj:
            dict["name"] = data.name
            dict["count"] = obj.total_leave
        else:
            dict["name"] = data.name
            dict["count"] = ""
        leave_list.append(dict)
    if request.method == "POST":
        form = AddStaffForm(request.POST, instance=record)
        if form.is_valid():
            form.save()
            for data in leave_type:
                leave_count = request.POST.get(data.name)
                assign_leave = staff_leave_records.filter(leave_type=data).last()
                if assign_leave:
                    assign_leave.total_leave = int(leave_count)
                    assign_leave.save()
                    available_leaves = AvailableLeave.objects.filter(
                        session=request.Session
                    )
                    if available_leaves:
                        available_leave = available_leaves.filter(
                            staff_leave=assign_leave
                        ).last()
                        if available_leave:
                            add_leave = int(leave_count) - available_leave.total_leave
                            available_leave.available_leave = (
                                available_leave.available_leave + add_leave
                            )
                            available_leave.total_leave = int(leave_count)
                            available_leave.save()
                        else:
                            AvailableLeave.objects.create(
                                staff_leave=assign_leave,
                                available_leave=leave_count,
                                total_leave=leave_count,
                                session=request.Session,
                            )
                else:
                    if leave_count:
                        StaffLeave.objects.create(
                            staff_id=record.id, leave_type=data, total_leave=leave_count
                        )
            
            staff_list = request.POST.getlist("staff_id")
            print('guradian_list',staff_list)
            for data in staff_list:
                print('data',data)
                satff_exclude = StaffEducationQualification.objects.filter(staff=record).exclude(id__in = staff_list)
                satff_exclude.delete()
                staff_schools = request.POST.get(f"staff_school{data}")
                print('staff_schools',staff_schools)
                degree = request.POST.get(f"degree{data}")
                study = request.POST.get(f"study{data}")
                start_date = request.POST.get(f"start_date{data}")
                end_date = request.POST.get(f"end_date{data}")
                grade = request.POST.get(f"grade{data}")
                
                edit =  StaffEducationQualification.objects.filter(id=data).last()
                print('edit',edit)
                if edit:                        
                    edit.staff_school = staff_schools
                    edit.degree = degree
                    edit.study = study
                    edit.start_date = start_date
                    edit.end_date = end_date
                    edit.grade = grade
                    edit.save()
                    
            staff_school_edit=request.POST.getlist("staff_school_edit")
            degree_edit=request.POST.getlist("degree_edit")
            study_edit=request.POST.getlist("study_edit")
            start_date_edit=request.POST.getlist("start_date_edit")
            end_date_edit=request.POST.getlist("end_date_edit")
            grade_edit=request.POST.getlist("grade_edit")
            staff_edit_list = request.POST.getlist("staff_edit_id")
            print('staff_school',type(staff_school_edit),degree_edit,study_edit)
            print('len(staff_degree)',len(end_date_edit))
            print('staff_edit_list',staff_edit_list)
            for i in range(len(staff_edit_list)):            
                print('staff_st_date',staff_school_edit[i])   
                print('Staff_grade',end_date_edit)    
                if staff_edit_list[i] !='':                    
                    StaffEducationQualification.objects.create(
                        staff_id=record.id,
                        staff_school=staff_school_edit[i],
                        degree=degree_edit[i],
                        study=study_edit[i],
                        start_date=start_date_edit[i],
                        end_date=end_date_edit[i],
                        grade=grade_edit[i],
                    )        
            #  customs fields
            for data in custom_fields:
                if data.field_type == "multiselect":
                    value = request.POST.getlist(f"{data.field_name}")
                else:
                    value = request.POST.get(f"{data.field_name}")
                if value:
                    edit = staff_custom.filter(field=data.id).last()
                    if edit:
                        edit.value = value
                        edit.save()
                    else:
                        StaffCustomFieldValues.objects.create(
                            field=data, staff_id=pk, value=value
                        )
            messages.warning(request, "Record Updated Successfully")
            return HttpResponseRedirect("/staff_directory")
        else:
            print(form.errors)
    context = {
        "form": form,
        "records": record,
        "add_staff": "active",
        "leave_list": leave_list,
        "custom_fields": custom_fields,
        "student_custom": staff_custom,
        "custom_fileds_records": custom_fileds_records,
        "system_fields": system_fields,
        "staff":staff,
        "leave_type":leave_type
    }
    return render(request, "Human_Resource/add_staffs_edit.html", context)


@login_required
@user_type_required("Staff")
def staff_attendance_view(request):
    if request.user.is_superuser or request.user.is_school_admin or "staff_attendance_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            roless = Role.objects.filter(branch=branch_id)
            if request.POST.get("search") == "search":
                roles = request.POST.get("role")
                attendance_datee = request.POST.get("from_date")
                records = AddStaff.objects.filter(roles=roles,branch_id=branch_id)
                record = StaffAttendance.objects.filter(
                    staff_id__in=records.values("id"), attendance_date=attendance_datee,branch_id=branch_id
                )
                print("records", records)
                print("record", record)

                context = {
                    "staff_attendance_view": "active",
                    "records": records,
                    "record": record,
                    "attendance_datee": attendance_datee,
                    "roles": roless,
                }
                return render(
                    request, "Human_Resource/staff_attendance_view.html", context
                )

            if request.POST.get("all_save") == "all_save":
                staff_id = request.POST.getlist("staff_id")
                print('staff_attendance_view',staff_id)
                for data in staff_id:
                    holiday = request.POST.get("holiday")
                    if request.POST.get(f"attendance{data}") or holiday:
                        edit_staff = StaffAttendance.objects.filter(
                            staff_id=data,
                            attendance_date=request.POST.get("attendance_datee"),
                        ).last()
                        if holiday:
                            attendance_status = "Holiday"
                        else:
                            attendance_status = request.POST.get(f"attendance{data}")

                        if edit_staff:
                            edit_staff.attendance_status = attendance_status
                            edit_staff.note = request.POST.get(f"note{data}")
                            edit_staff.save()
                        else:
                            StaffAttendance.objects.create(
                                staff_id=data,
                                attendance_status=attendance_status,
                                attendance_date=request.POST.get("attendance_datee"),
                                note=request.POST.get(f"note{data}"),
                                branch_id = branch_id
                            )
                return redirect("staff_attendance_view")
            context = {"staff_attendance_view": "active", "roles": roless}
            return render(request, "Human_Resource/staff_attendance_view.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def payroll(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
    print("branch_name@@@",branch_name)
    teacher = request.POST.get("class")
    months = request.POST.get("months")
    years = request.POST.get("years")
    request.session["months"] = months
    request.session["years"] = years
    header = PrintHeaderFooter.objects.filter(branch=branch_id).first()
    record = PayrollSummary.objects.filter(Months=months, year=years,branch_id=branch_id)
    roles = Role.objects.filter(branch=branch_id)
    listt = []
    for data in record:
        listt.append(data.Frist_name.id)
    if request.method == "POST":
        records = AddStaff.objects.filter(roles=teacher).exclude(id__in=listt)
        context = {
            "records": records,
            "record": record,
            "roles": roles,
            "payroll": "active",
            "header": header,
        }
        print('records',records)
        return render(request, "Human_Resource/payroll.html", context)
    context = {"payroll": "active", "roles": roles}
    return render(request, "Human_Resource/payroll.html", context)


@login_required
@user_type_required("Staff")
def payroll_view(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
    print("branch_name@@@",branch_name)
    months = request.session["months"]
    years = request.session["years"]
    record = AddStaff.objects.get(id=pk)
    month = 3
    month_2 = 4
    month_3 = 5
    staff = StaffAttendance.objects.filter(
        attendance_date__month__gte=month, staff_id=record.id
    )
    staff = StaffAttendance.objects.filter(
        attendance_date__month__gte=month_2, staff_id=record.id
    )
    staff = StaffAttendance.objects.filter(
        attendance_date__month__gte=month_3, staff_id=record.id
    )

    staffs = staff.filter(attendance_status="present")
    staffss = staff.filter(attendance_status="Late")
    staffsss = staff.filter(attendance_status="Absent")
    half = staff.filter(attendance_status="half")

    present_2 = staff.filter(attendance_status="present")
    Late_2 = staff.filter(attendance_status="Late")
    Absent_2 = staff.filter(attendance_status="Absent")
    half = staff.filter(attendance_status="half")

    present_3 = staff.filter(attendance_status="present")
    Late_3 = staff.filter(attendance_status="Late")
    Absent_3 = staff.filter(attendance_status="Absent")
    half = staff.filter(attendance_status="half")

    if request.method == "POST":
        PayrollSummary.objects.create(
            basic_salary=request.POST.get("basicsalary"),
            earning=float(request.POST.get("earning")),
            gross_salary=float(request.POST.get("gross_salary")),
            deduction=float(request.POST.get("deduction")),
            Tax=float(request.POST.get("tax")),
            net_salary=float(request.POST.get("net_salary")),
            status="Generated",
            Frist_name_id=pk,
            Months=months,
            year=years,
            branch_id=branch_id
        )
        return HttpResponseRedirect("/payroll")

    context = {
        "record": record,
        "payroll_view": "active",
        "view": True,
        "staff": staff,
        "staffs": staffs.count(),
        "staffss": staffss.count(),
        "staffsss": staffsss.count(),
        "present_2": present_2.count(),
        "Late_2": Late_2.count(),
        "Absent_2": Absent_2.count(),
        "Absent_2": Absent_2.count(),
        "present_3": present_3.count(),
        "Late_3": Late_3.count(),
        "Absent_3": Absent_3.count(),
        "half": half.count(),
        "payroll": "active",
    }
    return render(request, "Human_Resource/payroll_view.html", context)


@login_required
@user_type_required("Staff")
def payroll_piad(request, pk):
    token = request.session['user_token'] 
    endpoint = 'finance/transaction-type/'
    endpoint_transaction = 'finance/all-transaction/'
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    records = PayrollSummary.objects.get(id=pk)
    if request.method == "POST":
        # response = call_get_method(BASE_URL, endpoint, token)
        # transaction_data = response.json()
        # print("transaction_data", transaction_data)

        # # Extract 'name' and 'transaction_type_id' into a list of dictionaries
        # transaction_list = [{'name': item['name'], 'transaction_type_id': item['transaction_type_id']} for item in transaction_data]

        # print("transaction_list", transaction_list)
        # payroll_transaction = next((transaction for transaction in transaction_list if transaction['name'] == 'Payroll'), None)
        # if payroll_transaction:
        #     transaction_name = payroll_transaction['name']
        #     transaction_type_id = payroll_transaction['transaction_type_id']
        #     print("Transaction Name:", transaction_name)
        #     print("Transaction Type ID:", transaction_type_id)
        # else:
        #     print("No 'Payroll' transaction found.")
        # if response.status_code != 200:
        #     return render(request, 'error500.html', {'error': str(response.json())})
        branch = Branch.objects.get(id=branch_id)
        print("branch+++", branch.school.reference_id)             
            
        student_information = {
            "student_name": f"{records.Frist_name.first_name}",
            "roll_no": f"{records.Frist_name.staff_id}"
        }
        transaction_type=FinanceTransactionType.objects.get(name='Salary Payment') 
        print('transaction_type',transaction_type.pk)      
        total_amount=str(records.net_salary)
        check = post_receivable_and_payable_transaction_ms(transaction_type.pk,records,records,None,total_amount,request.user.pk)
        print('check',check)

            # converting student_information to JSON format
            # student_information_json = json.dumps(student_information)
            # print("++++tudent",type(student_information_json))

            # using it in the data dictionary
        data = {
            # 'transaction_type_id': str(transaction_type_id),
            'company_id': str(branch.school.reference_id),
            'amount': int(records.net_salary),
            'input_params_values': student_information 
        }
        print("++++++++++++++++++",type(data))

        json_data = json.dumps(data)
        print("=========", type(json_data))

        response = call_post_method(BASE_URL, endpoint_transaction, json_data, token)
        print("response+++", response)
        if response.status_code != 200:
            print('Response Status Code:', response.content)
        response_data = json.loads(response.content.decode('utf-8')) 
        # transaction_id=response_data['record_id']    
        # print("transaction_id",transaction_id)
        # Transaction.objects.create(
        #     student_id=None,
        #     reference_id=transaction_id,                   
        #     branch_id = branch_id
        # )
        records.payment_date = request.POST.get("from_date")
        records.Payment_mode = request.POST.get("staffs")
        records.status = "Paid"
        records.save()
        return HttpResponseRedirect("/payroll")
    context = {"records": records, "payroll": "active"}
    return render(request, "Human_Resource/payroll_piad.html", context)


@login_required
@user_type_required("Staff")
def Payroll_payslip(request, pk):
    record = PayrollSummary.objects.get(id=pk)
    context = {"records": record, "payroll": "active"}
    return render(request, "Human_Resource/Payroll_payslip.html", context)


@login_required
@user_type_required("Staff")
def Human_Resource(request):
    if request.user.is_superuser or request.user.is_school_admin or "human_resource_report_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            designation_records = Designation.objects.filter(branch=branch_id)
            records = AddStaff.objects.filter(branch=branch_id)
            roles_records = Role.objects.filter(branch=branch_id)
            if request.method == "POST":
                roles = request.POST.get("roles")
                date_from = request.POST.get("from_date")
                date_to = request.POST.get("to_date")
                desingation = request.POST.get("designation")
                status = request.POST.get("status")
                filters = {}
                if date_from and date_to:
                    filters["date_of_joining__range"] = [date_from, date_to]
                if date_from:
                    filters["date_of_joining__gte"] = date_from
                if date_to:
                    filters["date_of_joining__lte"] = date_to
                if desingation:
                    filters["designation_id"] = desingation
                if status:
                    filters["status"] = status
                if roles:
                    filters["roles"] = roles
                if branch_id:
                    filters["branch_id"] = branch_id    

                records = AddStaff.objects.filter(**filters)
                print(records)
                context = {
                    "records": records,
                    "designation_records": designation_records,
                    "roles_records": roles_records,
                    "Human_Resource_report": "active",
                }
                return render(request, "Human_Resource/Human_Resource.html", context)
            context = {
                "records": records,
                "Human_Resource_report": "active",
                "designation_records": designation_records,
                "roles_records": roles_records,
            }
            return render(request, "Human_Resource/Human_Resource.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return render(request, "page_not_found.html", {"error": error})


@login_required
@user_type_required("Staff")
def payroll_report(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    roles_records = Role.objects.filter(branch=branch_id)
    if request.POST.get("search") == "search":
        teacher = request.POST.get("class")
        months = request.POST.get("months")
        years = request.POST.get("years")
        filters = {}
        if teacher:
            filters["Frist_name__roles"] = teacher
        if months:
            filters["Months"] = months
        if branch_id:
            filters["branch_id"] = branch_id    
        records = PayrollSummary.objects.filter(**filters, year=years)
        context = {
            "records": records,
            "roles_records": roles_records,
            "Human_Resource_report": "active",
        }
        return render(request, "Human_Resource/payroll_report.html", context)

    context = {"roles_records": roles_records, "Human_Resource_report": "active"}
    return render(request, "Human_Resource/payroll_report.html", context)


@login_required
@user_type_required("Staff")
def mange_alumini(request):
    if request.user.is_superuser or request.user.is_school_admin or "manage_alumni_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)

            class_records = Class.objects.filter(branch=branch_id)
            section_records = Section.objects.filter(branch=branch_id)
            session_recods = Session.objects.filter(branch=branch_id)

            if request.method == "POST":
                classs = request.POST.get("class")
                section = request.POST.get("section")
                session = request.POST.get("session")
                recordss = Managealumini.objects.filter(students_id=session)
                list = []
                for data in recordss:
                    list.append(data.students_id.id)
                record = StudentAdmission.objects.filter(
                    Class_id=classs, section_id=section, session=session,branch_id=branch_id
                ).exclude(id__in=list)

                context = {
                    "class_records": class_records,
                    "section_records": section_records,
                    "mange_alumini": "active",
                    "record": record,
                    "recordss": recordss,
                    "session_recods": session_recods,
                }
                return render(request, "Alumni/Mange_alumini.html", context)

            context = {
                "class_records": class_records,
                "section_records": section_records,
                "mange_alumini": "active",
                "session_recods": session_recods,
            }
            return render(request, "Alumni/Mange_alumini.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def Mange_alumini_add(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "manage_alumni_add" in request.permissions:
        try:
            record = StudentAdmission.objects.get(id=pk)
            form = ManagealuminiForm()
            if request.method == "POST":
                form = ManagealuminiForm(request.POST, request.FILES)
                if form.is_valid():
                    student = form.save(commit=False)
                    student.students_id = record
                    student.save()
                    return HttpResponseRedirect("/mange_alumini")
                else:
                    print(form.errors)
            context = {"form": form, "view": True, "record": record}
            return render(request, "Alumni/Mange_alumini_add.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def Mange_alumini_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "manage_alumni_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Managealumini.objects.filter(branch=branch_id)
            record = Managealumini.objects.get(id=pk)
            form = ManagealuminiForm(instance=record)
            if request.method == "POST":
                form = ManagealuminiForm(request.POST, request.FILES, instance=record)
                if form.is_valid():
                    student = form.save()
                    return HttpResponseRedirect("/mange_alumini")
            context = {
                "form": form,
                "records": records,
            }
            return render(request, "Alumni/Mange_alumini_edit.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def Mange_alumini_delete(request, pk):
    Managealumini.objects.get(id=pk).delete()
    return HttpResponseRedirect("/mange_alumini")


@login_required
@user_type_required("Staff")
def mange_alumini_report(request):
    if request.user.is_superuser or request.user.is_school_admin or "Alumini_report_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            class_records = Class.objects.filter(branch=branch_id)
            section_records = Section.objects.filter(branch=branch_id)
            session_records = Session.objects.filter(branch=branch_id)
            recordss = Managealumini.objects.filter(branch=branch_id)
            if request.method == "POST":
                classs = request.POST.get("class")
                section = request.POST.get("section")
                session = request.POST.get("session")
                print(classs, section)
                filters = {}
                if classs:
                    filters["Class_id"] = classs
                if section:
                    filters["section_id"] = section
                if session:
                    filters["session_id"] = session
                if branch_id:
                    filters["branch_id"] = branch_id    
                record = StudentAdmission.objects.filter(**filters).values("id")
                records = Managealumini.objects.filter(students_id__in=record,branch_id=branch_id)
                context = {
                    "class_records": class_records,
                    "section_records": section_records,
                    "records": records,
                    "mange_alumini_report": "active",
                    "session_records": session_records,
                }
                return render(request, "Reports/Mange_alumini_report.html", context)

            context = {
                "mange_alumini_report": "active",
                "session_records": session_records,
                "class_records": class_records,
                "section_records": section_records,
                "recordss": recordss,
            }
            return render(request, "Reports/Mange_alumini_report.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def hostel_repoert(request):
    if request.user.is_superuser or request.user.is_school_admin or "hostel_report_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            class_records = Class.objects.filter(branch=branch_id)
            section_records = Section.objects.filter(branch=branch_id)
            hostel_room = Hostel.objects.filter(branch=branch_id)
            if request.method == "POST":
                classs = request.POST.get("class")
                section = request.POST.get("section")
                hostell = request.POST.get("hostel_room")
                filters = {}
                if classs:
                    filters["Class_id"] = classs
                if section:
                    filters["section_id"] = section
                if hostell:
                    filters["hostel_id"] = hostell
                if branch_id:
                    filters["branch_id"] = branch_id    

                record = StudentAdmission.objects.filter(
                    **filters, hostel__isnull=False
                )

                context = {
                    "hostel_repoert": "active",
                    "class_records": class_records,
                    "section_records": section_records,
                    "record": record,
                    "hostel_room": hostel_room,
                }
                return render(request, "Reports/hostel_repoert.html", context)
            context = {
                "hostel_room": hostel_room,
                "hostel_repoert": "active",
                "class_records": class_records,
                "section_records": section_records,
            }
            return render(request, "Reports/hostel_repoert.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return render(request, "page_not_found.html", {"error": error})


@login_required
@user_type_required("Staff")
def transport_report(request):
    if request.user.is_superuser or request.user.is_school_admin or "transport_report_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            class_records = Class.objects.filter(branch=branch_id)
            section_records = Section.objects.filter(branch=branch_id)
            route = Route.objects.filter(branch=branch_id)
            vehicle = Vehicle.objects.filter(branch=branch_id)
            if request.method == "POST":
                classs = request.POST.get("class")
                section_id = request.POST.get("section")
                route_id = request.POST.get("route")
                vechicle_id = request.POST.get("vechicle")
                filters = {}
                if vechicle_id:
                    filters["vehicle_number_id"] = vechicle_id
                if classs:
                    filters["Class_id"] = classs
                if section_id:
                    filters["section_id"] = section_id
                if route_id:
                    filters["route_list_id"] = route_id
                if branch_id:
                    filters["branch_id"] = branch_id    
                record = StudentAdmission.objects.filter(
                    **filters, route_list__isnull=False
                )
                context = {
                    "hostel_repoert": "active",
                    "class_records": class_records,
                    "section_records": section_records,
                    "record": record,
                    "route": route,
                    "vehicle": vehicle,
                }
                return render(request, "Reports/transport_report.html", context)

            context = {
                "view": True,
                "transport_report": "active",
                "route": route,
                "vehicle": vehicle,
                "section_records": section_records,
                "class_records": class_records,
            }
            return render(request, "Reports/transport_report.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return render(request, "page_not_found.html", {"error": error})


@login_required
@user_type_required("Staff")
def library(request):
    if request.user.is_superuser or request.user.is_school_admin or "library_report_view" in request.permissions:
        try:
            context = {"libary_report": "active"}
            return render(request, "Reports/library.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return render(request, "page_not_found.html", {"error": error})


@login_required
@user_type_required("Staff")
def book_isseu_report(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    if request.method == "POST":
        from_date = request.POST.get("from_date")
        to_date = request.POST.get("to_date")
        member_type = request.POST.get("staffs")
        filters = {}
        if from_date and to_date:
            print("=====2")
            filters["issued_date__range"] = [from_date, to_date]
        if from_date:
            print("=====3")
            filters["issued_date__gte"] = from_date
        if to_date:
            print("=====4")
            filters["issued_date__lte"] = to_date
        if member_type:
            filters["member__member_type__icontains"] = member_type
        if branch_id:
            filters["branch_id"] = branch_id
        print(filters)
        records = IssueBook.objects.filter(**filters)
        context = {"records": records, "libary_report": "active"}
        return render(request, "Reports/book_isseu_report.html", context)
    context = {"libary_report": "active"}
    return render(request, "Reports/book_isseu_report.html", context)


@login_required
@user_type_required("Staff")
def book_inventory_report(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    records = AddBook.objects.filter(branch=branch_id)

    context = {"libary_report": "active", "records": records}
    return render(request, "Reports/book_inventory_report.html", context)


@login_required
@user_type_required("Staff")
def book_due_report(request):
    if request.method == "POST":
        from_date = request.POST.get("from_date")
        to_date = request.POST.get("to_date")
        member_type = request.POST.get("staffs")
        filters = {}
        if from_date and to_date:
            filters["due_return_date__range"] = [from_date, to_date]
        if member_type:
            filters["member__member_type__icontains"] = member_type

        records = IssueBook.objects.filter(**filters)
        print("re", records)
        context = {"records": records, "libary_report": "active"}
        return render(request, "Reports/book_due_report.html", context)
    context = {"libary_report": "active"}
    return render(request, "Reports/book_due_report.html", context)


@login_required
@user_type_required("Staff")
def book_issue_return_report(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    record = IssueBook.objects.filter(return_date__isnull=False,branch_id=branch_id)
    context = {"libary_report": "active", "record": record}
    return render(request, "Reports/book_issue_return_report.html", context)


@login_required
@user_type_required("Staff")
def Inventory(request):
    if request.user.is_superuser or request.user.is_school_admin or "inventory_report_view" in request.permissions:
        try:
            context = {"issue_item_report": "active"}
            return render(request, "Reports/Inventory.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return render(request, "page_not_found.html", {"error": error})


@login_required
@user_type_required("Staff")
def stock_report(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    records = ItemStockDeatail.objects.filter(branch=branch_id)
    context = {"records": records, "issue_item_report": "active"}
    return render(request, "Reports/stock_report.html", context)


@login_required
@user_type_required("Staff")
def issue_item_report(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    if request.method == "POST":
        from_date = request.POST.get("from_date")
        to_date = request.POST.get("to_date")
        filters = {}
        if from_date and to_date:
            filters["issue_date__range"] = [from_date, to_date]
        elif from_date:
            filters["issue_date__gte"] = from_date
        elif to_date:
            filters["issue_date__lte"] = to_date
        if branch_id:
            filters["branch_id"] = branch_id  

        records = IssueItem.objects.filter(**filters)
        print("re", records)
        context = {"records": records, "issue_item_report": "active"}
        return render(request, "Reports/issue_item_report.html", context)

    context = {"issue_item_report": "active"}
    return render(request, "Reports/issue_item_report.html", context)


@login_required
@user_type_required("Staff")
def Add_item_report(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    if request.method == "POST":
        from_date = request.POST.get("from_date")
        to_date = request.POST.get("to_date")
        filters = {}
        if from_date and to_date:
            filters["date__range"] = [from_date, to_date]
        elif from_date:
            filters["date__gte"] = from_date
        elif to_date:
            filters["date__lte"] = to_date
        if branch_id:
            filters["branch_id"] = branch_id

        records = ItemStock.objects.filter(**filters)
        context = {"records": records, "issue_item_report": "active"}
        return render(request, "Reports/Add_item_report.html", context)

    context = {"issue_item_report": "active"}
    return render(request, "Reports/Add_item_report.html", context)


@login_required
@user_type_required("Staff")
def attendence(request):
    if request.user.is_superuser or request.user.is_school_admin or "attendance_report_view" in request.permissions:
        try:
            context = {"attendence_report": "active"}
            return render(request, "Reports/attendence.html", context)

        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return render(request, "page_not_found.html", {"error": error})


@login_required
@user_type_required("Staff")
def date_iter(year, month):
    from datetime import date

    for i in range(1, calendar.monthlen(year, month) + 1):
        yield date(year, month, i)


@login_required
@user_type_required("Staff")
def attendence_report(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)    
    class_records = Class.objects.filter(branch=branch_id)
    section_records = Section.objects.filter(branch=branch_id)
    if request.method == "POST":
        classs = request.POST.get("class")
        section = request.POST.get("section")
        months = request.POST.get("months")
        years = request.POST.get("years")
        if classs and section and months and years:
            records = StudentAttendance.objects.filter(
                student__Class=classs,
                student__section=section,
                attendance_date__month=months,
                attendance_date__year=years,
                branch_id=branch_id
            )
            header = []
            body = []
            print(int(months), int(years))
            cal = calendar.monthcalendar(int(years), int(months))
            # List of day names for header
            days = [
                "Monday",
                "Tuesday",
                "Wednesday",
                "Thursday",
                "Friday",
                "Saturday",
                "Sunday",
            ]
            student_rcords = StudentAdmission.objects.filter(
                Class=classs, section=section, session=request.Session,branch_id=branch_id
            )
            # Iterate through each week in the calendar
            count = 0
            for student in student_rcords:
                count += 1
                records = StudentAttendance.objects.filter(
                    student=student,
                    student__Class=classs,
                    student__section=section,
                    attendance_date__month=months,
                    attendance_date__year=years,
                    branch_id=branch_id
                )
                day_list = []
                dict = {}
                for week in cal:
                    # Iterate through each day in the week
                    for day in week:
                        # If the day is 0, it means it's a day outside the month, so skip it
                        if day == 0:
                            continue
                        else:
                            # Get the day name for the current date
                            day_name = days[
                                calendar.weekday(int(years), int(months), day)
                            ]
                            # Display the date and day
                            if count == 1:
                                header.append(f"{day} {day_name[:3]}")
                            student_attn = records.filter(
                                attendance_date__day=day
                            ).last()
                            if student_attn:
                                day_list.append(
                                    student_attn.attendance_status[:1].capitalize()
                                )
                            else:
                                day_list.append("")
                dict["attendace"] = day_list
                dict["student"] = student
                dict["present"] = records.filter(attendance_status="present").count()
                dict["absent"] = records.filter(attendance_status="Absent").count()
                dict["late"] = records.filter(attendance_status="Late").count()
                dict["half_day"] = records.filter(attendance_status="Half Day").count()
                body.append(dict)
            context = {"header": header, "body": body, "attendence_report": "active"}
            return render(request, "Reports/attendence_report.html", context)
    context = {
        "class_records": class_records,
        "section_records": section_records,
        "attendence_report": "active",
    }
    return render(request, "Reports/attendence_report.html", context)


@login_required
@user_type_required("Staff")
def daily_attendance_report(request):
    if request.user.is_superuser or request.user.is_school_admin or "attendance_by_date_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            if request.POST.get("search") == "search":
                attendance_date = request.POST.get("attendance_date")
                attendance_records = StudentAttendance.objects.filter(
                    attendance_date=attendance_date,branch_id=branch_id
                )

                if not attendance_records:
                    context = {
                        "attendence_report": "active",
                        "attendance_records": attendance_records,
                        "attendance_date": attendance_date,
                        "error_message": "No attendance records found for the selected date.",
                    }
                    return render(
                        request, "Reports/daily_attendance_report.html", context
                    )

                class_totals = {}
                total_present = 0
                total_absent = 0
                total_students = 0

                for record in attendance_records:
                    student = record.student
                    class_key = f"{student.Class} ({student.section})"

                    if class_key not in class_totals:
                        class_totals[class_key] = {
                            "total_present": 0,
                            "total_absent": 0,
                            "total_students": 0,
                        }

                    class_totals[class_key]["total_students"] += 1

                    if record.attendance_status in ["present", "Late"]:
                        class_totals[class_key]["total_present"] += 1
                        total_present += 1
                    elif record.attendance_status == "Absent":
                        class_totals[class_key]["total_absent"] += 1
                        total_absent += 1

                    total_students += 1

                overall_present_percentage = (total_present / total_students) * 100
                overall_absent_percentage = (total_absent / total_students) * 100

                # Format the percentages
                overall_present_percentage_formatted = floatformat(
                    overall_present_percentage, 2
                )
                overall_absent_percentage_formatted = floatformat(
                    overall_absent_percentage, 2
                )

                for class_total in class_totals.values():
                    class_total["present_percentage"] = floatformat(
                        (class_total["total_present"] / class_total["total_students"])
                        * 100,
                        2,
                    )
                    class_total["absent_percentage"] = floatformat(
                        (class_total["total_absent"] / class_total["total_students"])
                        * 100,
                        2,
                    )

                context = {
                    "attendence_report": "active",
                    "attendance_records": attendance_records,
                    "attendance_date": attendance_date,
                    "class_totals": class_totals,
                    "total_present": total_present,
                    "total_absent": total_absent,
                    "total_students": total_students,
                    "overall_present_percentage": overall_present_percentage_formatted,
                    "overall_absent_percentage": overall_absent_percentage_formatted,
                }
                return render(request, "Reports/daily_attendance_report.html", context)

            context = {
                "attendence_report": "active",
                "attendance_records": [],
            }
            return render(request, "Reports/daily_attendance_report.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return render(request, "error.html")


@login_required
@user_type_required("Staff")
def student_attendance_type_report(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    class_records = Class.objects.filter(branch=branch_id)
    section_records = Section.objects.filter(branch=branch_id)
    if request.method == "POST":
        classs = request.POST.get("class")
        section = request.POST.get("section")
        presentt = request.POST.get("present")
        from_date = request.POST.get("from_date")
        to_date = request.POST.get("to_date")
        filters = {}
        if section:
            filters["student__section"] = section
        if from_date and to_date:
            filters["attendance_date__range"] = [from_date, to_date]
        if from_date:
            filters["attendance_date__gte"] = from_date
        if to_date:
            filters["attendance_date__lte"] = to_date
        if branch_id:
            filters["branch_id"] = branch_id    

        records = StudentAttendance.objects.filter(
            student__Class=classs, attendance_status=presentt, **filters
        )

        context = {
            "record": records,
            "class_records": class_records,
            "section_records": section_records,
            "attendence_report": "active",
        }
        return render(request, "Reports/student_attendance_type_report.html", context)

    context = {
        "class_records": class_records,
        "section_records": section_records,
        "attendence_report": "active",
    }
    return render(request, "Reports/student_attendance_type_report.html", context)


@login_required
@user_type_required("Staff")
def staff_attendance_report(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    roles_records = Role.objects.filter(branch=branch_id)
    if request.method == "POST":
        roles = request.POST.get("roles")
        months = request.POST.get("months")
        years = request.POST.get("years")
        if roles and months and years:
            header = []
            body = []
            print(int(months), int(years))
            cal = calendar.monthcalendar(int(years), int(months))
            # List of day names for header
            days = [
                "Monday",
                "Tuesday",
                "Wednesday",
                "Thursday",
                "Friday",
                "Saturday",
                "Sunday",
            ]
            student_rcords = AddStaff.objects.filter(roles=roles,branch_id=branch_id)
            # Iterate through each week in the calendar
            print("student_rcords", student_rcords)
            count = 0
            for student in student_rcords:
                count += 1
                records = StaffAttendance.objects.filter(
                    staff__id=student.id,
                    attendance_date__month=months,
                    attendance_date__year=years,
                    branch_id=branch_id
                )
                day_list = []
                dict = {}
                for week in cal:
                    # Iterate through each day in the week
                    for day in week:
                        # If the day is 0, it means it's a day outside the month, so skip it
                        if day == 0:
                            continue
                        else:
                            # Get the day name for the current date
                            day_name = days[
                                calendar.weekday(int(years), int(months), day)
                            ]
                            # Display the date and day
                            if count == 1:
                                header.append(f"{day} {day_name[:3]}")
                            student_attn = records.filter(
                                attendance_date__day=day
                            ).last()
                            if student_attn:
                                day_list.append(
                                    student_attn.attendance_status[:1].capitalize()
                                )
                            else:
                                day_list.append("")
                dict["attendace"] = day_list
                dict["student"] = student
                dict["present"] = records.filter(attendance_status="present").count()
                dict["absent"] = records.filter(attendance_status="Absent").count()
                dict["late"] = records.filter(attendance_status="Late").count()
                dict["half_day"] = records.filter(attendance_status="Half Day").count()
                body.append(dict)
        context = {
            "roles_records": roles_records,
            "header": header,
            "body": body,
            "attendence_report": "active",
        }
        return render(request, "Reports/staff_attendance_report.html", context)
    context = {"roles_records": roles_records, "attendence_report": "active"}
    return render(request, "Reports/staff_attendance_report.html", context)


@login_required
@user_type_required("Staff")
def general_setting(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    records = GeneralSetting.objects.filter(branch=branch_id)
    if records:
        record = GeneralSetting.objects.filter(branch=branch_id).last()
        form = GeneralSettingForm(instance=record , branch=branch_id)
        if request.method == "POST":
            form = GeneralSettingForm(request.POST, request.FILES, instance=record)
            if form.is_valid():
                obj=form.save()
                obj.branch_id = branch_id
                obj.save()
                return HttpResponseRedirect("/general_setting")
            else:
                print(form.errors)
        context = {"record": record, "general_setting_setting": "active", "form": form}
        return render(request, "System_setting/general.html", context)

    else:
        form = GeneralSettingForm()
        if request.method == "POST":
            form = GeneralSettingForm(request.POST, request.FILES)
            if form.is_valid():
                obj=form.save()
                obj.branch_id = branch_id
                obj.save()
                return HttpResponseRedirect("/general_setting")

    context = {"records": records, "general_setting_setting": "active", "form": form}
    return render(request, "System_setting/general.html", context)


@login_required
def student_js(request):
    class_id = request.GET.get("class_id")
    section_id = request.GET.get("id_section")
    student = StudentAdmission.objects.filter(
        Class=class_id, section=section_id, session=request.Session
    )
    return JsonResponse(
        data=list(student.values("id", "first_name", "last_name")), safe=False
    )


@login_required
@user_type_required("Staff")
def manage_syllabus_status(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "manage_syllabus_status_view" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            class_records = Class.objects.filter(branch=branch_id)
            if request.POST.get("search") == "search":
                classs = request.POST.get("Class")
                section = request.POST.get("section")
                subject_groups = request.POST.get("subject_group")
                subject = request.POST.get("subject")
                record = topic.objects.filter(
                    Class_id=classs,
                    section_id=section,
                    subject_group_id=subject_groups,
                    subject_id=subject,
                    branch_id = branch_id

                )
                context = {
                    "manage_syllabus_status": "active",
                    "class_records": class_records,
                    "record": record,
                }
                return render(
                    request, "Lesson_plan/manage_syllabus_status.html", context
                )

            if request.POST.get("save") == "save":
                date_save = request.POST.get("from_date")
                date_idd = request.POST.get("date_id")
                record = topic.objects.get(id=date_idd)
                record.date_save = date_save
                record.status = "complete"
                record.branch_id = branch_id
                record.save()
            context = {
                "manage_syllabus_status": "active",
                "class_records": class_records,
            }
            return render(request, "Lesson_plan/manage_syllabus_status.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return render(request, "error.html", {"error": error})


# ----------------------------------------- website part----------------------------------------


@login_required
@user_type_required("Staff")
def web_index(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    records = BasicWebPageDetails.objects.filter(branch=branch_id)
    carosel_records = CaroselImage.objects.filter(branch=branch_id)
    infrastructure_record = Infrastructure.objects.filter(branch=branch_id)
    school_staff_record = SchoolStaff.objects.filter(branch=branch_id)
    school_heads = SchoolHeads.objects.filter(branch=branch_id)
    events_record = Events.objects.filter(branch=branch_id)
    news_record = News.objects.filter(branch=branch_id)
    offers_record = Offers.objects.filter(branch=branch_id)
    if request.method == "POST":
        contact_form = ContactForm(request.POST)
        web_enquiry_form = WebEnquiryForm(request.POST)
        if contact_form.is_valid() and web_enquiry_form.is_valid():
            print("1")
            contact_form.save()
            web_enquiry_form.save()
            print("2")
            messages.success(
                request, "Thank you for your message! We will get back to you soon."
            )
            return redirect(
                "/web_index#contact"
            )  # Redirect to the same page after successful submission
        else:
            print("3", web_enquiry_form.errors)
            messages.error(
                request,
                "Failed to submit the form. Please check the details and try again.",
            )
            return redirect("/web_index#contact")
    else:
        contact_form = ContactForm()
        web_enquiry_form = WebEnquiryForm()

    context = {
        "records": records,
        "carosel_records": carosel_records,
        "events_record": events_record,
        "infrastructure_record": infrastructure_record,
        "school_staff_record": school_staff_record,
        "school_heads": school_heads,
        "news_record": news_record,
        "offers_record": offers_record,
        "contact_form": contact_form,
        "web_enquiry_form": web_enquiry_form,
    }

    return render(request, "Website/web_index.html", context)


@login_required
@user_type_required("Staff")
# def web_index(request):
#     records=BasicWebPageDetails.objects.filter(branch=branch_id)
#     carosel_records=CaroselImage.objects.filter(branch=branch_id)
#     infrastructure_record=Infrastructure.objects.filter(branch=branch_id)
#     school_staff_record=SchoolStaff.objects.filter(branch=branch_id)
#     school_heads=SchoolHeads.objects.filter(branch=branch_id)
#     events_record=Events.objects.filter(branch=branch_id)
#     news_record=News.objects.filter(branch=branch_id)
#     offers_record=Offers.objects.filter(branch=branch_id)
#     if request.method == 'POST':
#         form = ContactForm(request.POST)
#         if form.is_valid():
#             form.save()
#             messages.success(request, 'Thank you for your message! We will get back to you soon.')
#             return redirect('/web_index#contact')
#         else:
#             messages.error(request, 'Failed to submit the form. Please Check the Details and try Again ')
#             return redirect('/web_index#contact')
#     else:
#         form = ContactForm()

#     context = {
#         'records': records,
#         'carosel_records': carosel_records,
#         'events_record': events_record,
#         'infrastructure_record': infrastructure_record,
#         'school_staff_record': school_staff_record,
#         'school_heads': school_heads,
#         'news_record': news_record,
#         'offers_record': offers_record,
#         'form': form,
#     }

#     return render(request, 'Website/web_index.html', context)


# if request.method == 'POST':
#     form = ContactForm(request.POST)
#     if form.is_valid():
#         print('1')
#         form.save()
#         print('2')
#         return redirect('success')  # Redirect to success page
# else:
#     form = ContactForm()
#     print('3')
# context={
#         'records':records,'carosel_records':carosel_records,
#         'events_record':events_record,'infrastructure_record':infrastructure_record,
#         'school_staff_record':school_staff_record,'school_heads':school_heads,
#         'news_record':news_record,'offers_record':offers_record
#         }
# return render(request,'Website/web_index.html',context)


@login_required
@user_type_required("Staff")
def basic_detail(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "banner_image_view" in request.permissions
        or "banner_image_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)

            records = BasicWebPageDetails.objects.filter(branch=branch_id)
            if records:
                record = BasicWebPageDetails.objects.filter(branch=branch_id).last()
                form = BasicWebPageDetailsForm(instance=record)
                if request.method == "POST":
                    form = BasicWebPageDetailsForm(
                        request.POST, request.FILES, instance=record
                    )
                    if form.is_valid():
                        obj=form.save()
                        obj.branch_id = branch_id
                        obj.save()
                        messages.warning(request, "Record Updated Successfully")
                        return HttpResponseRedirect("/basic_detail")
                context = {"record": record, "basic_detail": "active", "form": form}
                return render(request, "Front_cms/basic_detail.html", context)

            else:
                form = BasicWebPageDetailsForm()
                if request.method == "POST":
                    form = BasicWebPageDetailsForm(request.POST, request.FILES)
                    if form.is_valid():
                        obj=form.save()
                        obj.branch_id = branch_id
                        obj.save()
                        messages.warning(request, "Record Updated Successfully")
                        return HttpResponseRedirect("/basic_detail")

                context = {"records": records, "basic_detail": "active", "form": form}
                return render(request, "Front_cms/basic_detail.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def carousel(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "carosel_view" in request.permissions
        or "carosel_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = CaroselImage.objects.filter(branch=branch_id)
            if request.method == "POST":
                form = CaroselImageForm(request.POST, request.FILES)

                carosel_images = request.FILES.getlist("carosel_image")
                for carosel_imagee in carosel_images:
                    CaroselImage.objects.create(carosel_image=carosel_imagee,branch_id=branch_id)
                return redirect("carousel")
            else:
                form = CaroselImageForm()
            return render(
                request,
                "Front_cms/carousel.html",
                {"form": form, "carousel": "active", "records": records},
            )
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def carousel_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "carosel_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            record = CaroselImage.objects.get(id=pk)
            record.image_title = request.POST.get("image_title")
            record.image_description = request.POST.get("image_description")
            record.branch_id=branch_id
            record.save()
            return redirect("carousel")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def carousel_delete(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
    print("branch_name@@@",branch_name)
    carosel_image=CaroselImage.objects.get(id=pk)
    carosel_image_branch_id = carosel_image.branch.id
    if int(carosel_image_branch_id) == int(branch_id):                        
        CaroselImage.objects.get(id=pk).delete()
    else:
        messages.error(request, "School id Doesn't match record no delete")
    messages.error(request, "Record Deleted Successfully")
    return HttpResponseRedirect("/carousel")


@login_required
@user_type_required("Staff")
def infrastructure(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "banner_image_view" in request.permissions
        or "banner_image_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Infrastructure.objects.filter(branch=branch_id)
            form = InfrastructureForm()
            if request.method == "POST":
                form = InfrastructureForm(request.POST, request.FILES)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save() 
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/infrastructure")
            context = {"infrastructure": "active", "form": form, "records": records}
            return render(request, "Front_cms/infrastructure.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def infrastructure_edit(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "banner_image_view" in request.permissions
        or "banner_image_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Infrastructure.objects.filter(branch=branch_id)
            record = Infrastructure.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = InfrastructureForm(instance=record)
            if request.method == "POST":
                form = InfrastructureForm(request.POST, request.FILES, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/infrastructure")
            context = {"form": form, "records": records, "infrastructure": "active"}
            return render(request, "Front_cms/infrastructure_edit.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def infrastructure_delete(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    infra_structure=Infrastructure.objects.get(id=pk)
    infra_structure_branch_id = infra_structure.branch.id
    if int(infra_structure_branch_id) == int(branch_id):                        
        Infrastructure.objects.get(id=pk).delete()
    else:
        messages.error(request, "School id Doesn't match record no delete")
    messages.error(request, "Record Deleted Successfully")
    return HttpResponseRedirect("/infrastructure")


@login_required
@user_type_required("Staff")
def event(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "event_view" in request.permissions
        or "event_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Events.objects.filter(branch=branch_id)
            form = EventsForm()
            if request.method == "POST":
                form = EventsForm(request.POST, request.FILES)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()  
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/event")

                else:
                    print(form.errors)
            context = {"form": form, "records": records, "event": "active"}
            return render(request, "Front_cms/event.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def event_edit(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "event_view" in request.permissions
        or "event_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Events.objects.filter(branch=branch_id)
            record = Events.objects.get(id=pk)
            form = EventsForm(instance=record)
            if request.method == "POST":
                form = EventsForm(request.POST, request.FILES, instance=record)
                if form.is_valid():
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/event")
            context = {"form": form, "records": records, "event": "active"}
            return render(request, "Front_cms/event_edit.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def event_view(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "event_view" in request.permissions
        or "event_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Events.objects.filter(branch=branch_id)
            record = Events.objects.get(id=pk)
            form = EventsForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "event": "active",
                "view": True,
            }
            return render(request, "Front_cms/event.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def event_delete(request, pk):
    Events.objects.get(id=pk).delete()
    messages.error(request, "Record Deleted Successfully")
    return HttpResponseRedirect("/event")


@login_required
@user_type_required("Staff")
def add_event(request):
    if request.user.is_superuser or request.user.is_school_admin or "event_add" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Events.objects.filter(branch=branch_id)
            form = EventsForm()
            if request.method == "POST":
                form = EventsForm(request.POST, request.FILES)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/event")
                else:
                    print(form.errors)
            context = {"form": form, "records": records, "add_event": "active"}
            return render(request, "Front_cms/add_event.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def school_staff(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "school_staff_view" in request.permissions
        or "school_staff_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = SchoolStaff.objects.filter(branch=branch_id)
            form = SchoolStaffForm()
            if request.method == "POST":
                form = SchoolStaffForm(request.POST, request.FILES)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/school_staff")
                else:
                    print(form.errors)
            context = {"form": form, "records": records, "school_staff": "active"}
            return render(request, "Front_cms/school_staff.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def school_staff_edit(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "school_staff_view" in request.permissions
        or "school_staff_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = SchoolStaff.objects.filter(branch=branch_id)
            record = SchoolStaff.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = SchoolStaffForm(instance=record)
            if request.method == "POST":
                form = SchoolHeadsForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/school_staff")
            context = {"form": form, "records": records, "school_head": "active"}
            return render(request, "Front_cms/school_staff_edit.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def school_staff_delete(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    school_staff=SchoolStaff.objects.get(id=pk).delete()
    school_staff_branch_id = school_staff.branch.id
    if int(school_staff_branch_id) == int(branch_id):                        
        SchoolStaff.objects.get(id=pk).delete()
    else:
        messages.error(request, "School id Doesn't match record no delete")
    messages.error(request, "Record Deleted Successfully")
    return HttpResponseRedirect("/school_staff")


@login_required
@user_type_required("Staff")
def school_head(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "school_head_view" in request.permissions
        or "school_head_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = SchoolHeads.objects.filter(branch=branch_id)
            form = SchoolHeadsForm()
            if request.method == "POST":
                form = SchoolHeadsForm(request.POST, request.FILES)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save() 
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/school_head")
                else:
                    print(form.errors)
            context = {"form": form, "records": records, "school_head": "active"}
            return render(request, "Front_cms/school_head.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def school_head_edit(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "school_head_view" in request.permissions
        or "banner_image_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = SchoolHeads.objects.filter(branch=branch_id)
            record = SchoolHeads.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = SchoolHeadsForm(instance=record)
            if request.method == "POST":
                form = SchoolHeadsForm(request.POST, request.FILES, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/school_head")
            context = {"form": form, "records": records, "school_head": "active"}
            return render(request, "Front_cms/school_head_edit.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def school_head_delete(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    school_heads=SchoolHeads.objects.get(id=pk)
    school_heads_branch_id = school_heads.branch.id
    if int(school_heads_branch_id) == int(branch_id):                        
        SchoolHeads.objects.get(id=pk).delete()
    else:
        messages.error(request, "School id Doesn't match record no delete")
    messages.error(request, "Record Deleted Successfully")
    return HttpResponseRedirect("/school_head")


@login_required
@user_type_required("Staff")
def news(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "news_view" in request.permissions
        or "news_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = News.objects.filter(branch=branch_id)
            form = NewsForm()
            if request.method == "POST":
                form = NewsForm(request.POST, request.FILES)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()  
                    messages.success(request, "Record Saved Successfully")
                    return redirect("news")
                else:
                    print(form.errors)

            context = {"form": form, "records": records, "news": "active"}

            return render(request, "Front_cms/news.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
# def news_edit(request,pk):
#     news = News.objects.get(id=pk)
#     return HttpResponseRedirect('/news')


@login_required
@user_type_required("Staff")
def news_edit(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "news_view" in request.permissions
        or "news_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = News.objects.filter(branch=branch_id)
            record = News.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = NewsForm(instance=record)
            if request.method == "POST":
                form = NewsForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/news")
            context = {"form": form, "records": records, "news": "active"}
            return render(request, "Front_cms/news_edit.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def news_delete(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    news=News.objects.get(id=pk)
    news_branch_id = news.branch.id
    if int(news_branch_id) == int(branch_id):                        
        News.objects.get(id=pk).delete()
    else:
        messages.error(request, "School id Doesn't match record no delete")
    messages.error(request, "Record Deleted Successfully")
    return HttpResponseRedirect("/news")


@login_required
@user_type_required("Staff")
def offers(request):
    if request.user.is_superuser or request.user.is_school_admin or "offers_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Offers.objects.filter(branch=branch_id)
            if records:
                record = Offers.objects.filter(branch=branch_id).last()
                form = OffersForm(instance=record)
                if request.method == "POST":
                    form = OffersForm(request.POST, request.FILES, instance=record)
                    if form.is_valid():
                        obj=form.save()
                        obj.branch_id = branch_id
                        obj.save()     
                        return HttpResponseRedirect("/offers")
                context = {"record": record, "offers": "active", "form": form}
                return render(request, "Front_cms/offers.html", context)

            else:
                form = OffersForm()
                if request.method == "POST":
                    form = OffersForm(request.POST, request.FILES)
                    if form.is_valid():
                        form.save()
                        return HttpResponseRedirect("/offers")

            context = {"records": records, "offers": "active", "form": form}
            return render(request, "Front_cms/offers.html")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def offers_edit(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "offers_view" in request.permissions
        or "offers_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Offers.objects.filter(branch=branch_id)
            record = Offers.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = OffersForm(instance=record)
            if request.method == "POST":
                form = OffersForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    return HttpResponseRedirect("/offers")
            context = {"form": form, "records": records, "offers": "active"}
            return render(request, "Front_cms/offers.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def offers_delete(request, pk):
    
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    offerss=Offers.objects.get(id=pk)
    offerss_branch_id = offerss.branch.id
    if int(offerss_branch_id) == int(branch_id):                        
        Offers.objects.get(id=pk).delete()
    else:
        messages.error(request, "School id Doesn't match record no delete")
    messages.error(request, "Record Deleted Successfully")
    return HttpResponseRedirect("/offers")


# -------------------------------  website part end ---------------------------------------


@login_required
@user_type_required("Staff")
def subject_group(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "subject_group_view" in request.permissions
        or "subject_group_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            class_records = Class.objects.filter(branch=branch_id)
            subject_all = Subjects.objects.filter(branch=branch_id)
            records = SubjectGroup.objects.filter(branch=branch_id)
            form = SubjectGroupForm()
            if request.method == "POST":
                form = SubjectGroupForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()  
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/subject_group")
                else:
                    print(form.errors)
            context = {
                "form": form,
                "records": records,
                "subject_group": "active",
                "subject_all": subject_all,
                "class_records": class_records,
            }
            return render(request, "Academics/subject_group.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def subject_group_edit(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "subject_group_edit" in request.permissions
        or "subject_group_view" in request.permissions
    ):
        try:
            if True:
                branch_name = request.session.get('branch_id', None)
                if branch_name:
                    branch_id = branch_name       
                else:
                    branch_id = None  
                    print("branch_name@@@",branch_name)
                class_records = Class.objects.filter(branch=branch_id)
                subject_all = Subjects.objects.filter(branch=branch_id)
                records = SubjectGroup.objects.filter(branch=branch_id)
                record = SubjectGroup.objects.get(id=pk)
                data_branch_id = record.branch.id
                lists = record.subject.filter(branch=branch_id)
                list = [data.id for data in lists]
                print("lists", list)
                form = SubjectGroupForm(instance=record)
                if request.method == "POST":
                    form = SubjectGroupForm(request.POST, instance=record)
                    if form.is_valid():
                        if branch_id == data_branch_id:
                            form.save()
                        else:
                            form.instance.branch_id = branch_id
                        form.save()
                        messages.warning(request, "Record Updated Successfully")
                        return HttpResponseRedirect("/subject_group")
                context = {
                    "form": form,
                    "record": record,
                    "records": records,
                    "subject_group": "active",
                    "edit": True,
                    "lists": list,
                    "subject_all": subject_all,
                    "class_records": class_records,
                }
                return render(request, "Academics/subject_group.html", context)
        except Exception as error:
           return render(request,'error.html',{'error':error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def subject_group_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "subject_group_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            class_records = Class.objects.filter(branch=branch_id)
            subject_all = Subjects.objects.filter(branch=branch_id)
            records = SubjectGroup.objects.filter(branch=branch_id)
            record = SubjectGroup.objects.get(id=pk)
            lists = record.subject.filter(branch=branch_id)
            list = [data.id for data in lists]
            form = SubjectGroupForm(instance=record)
            context = {
                "subject_all": subject_all,
                "form": form,
                "records": records,
                "record": record,
                "lists": list,
                "SubjectGroup": "active",
                "view": True,
                "class_records": class_records,
            }
            return render(request, "Academics/subject_group.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def subject_group_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "subject_group_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            subject_group=SubjectGroup.objects.get(id=pk)
            subject_group_branch_id = subject_group.branch.id
            if int(subject_group_branch_id) == int(branch_id):                        
                SubjectGroup.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/subject_group")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def subjects(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "subject_view" in request.permissions
        or "subject_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Subjects.objects.filter(branch=branch_id)
            form = SubjectsForm()
            if request.method == "POST":
                form = SubjectsForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()        
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/subjects")
            context = {"form": form, "records": records, "subjects": "active"}
            return render(request, "Academics/subjects.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def subjects_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "subject_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)

            records = Subjects.objects.filter(branch=branch_id)
            record = Subjects.objects.get(id=pk)
            subjects_branch_id = record.branch.id
            form = SubjectsForm(instance=record)
            if request.method == "POST":
                form = SubjectsForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == subjects_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/subjects")
            context = {
                "form": form,
                "records": records,
                "subjects": "active",
                "edit": True,
            }
            return render(request, "Academics/subjects.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def subjects_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "subject_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Subjects.objects.filter(branch=branch_id)
            record = Subjects.objects.get(id=pk)
            form = SubjectsForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "subjects": "active",
                "view": True,
            }
            return render(request, "Academics/subjects.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def subjects_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "subject_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            subjects=Subjects.objects.get(id=pk)
            subjects_branch_id = subjects.branch.id
            if int(subjects_branch_id) == int(branch_id):                        
                Subjects.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/subjects")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def Classes(request):
    print('teh classes is coming ')
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "class_view" in request.permissions
        or "class_add" in request.permissions
    ):
        print('rthe if is')
        try:
            print('the try is worinking')
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
            print("branxxch_name@@@",branch_name)
            section_records = Section.objects.filter(branch=branch_id)
            records = Class.objects.filter(branch=branch_id)
            form = ClassForm()

            if request.method == "POST":
                print('the post is working on the class ')
                form = ClassForm(request.POST)
                print('the form is valid or not ',form.is_valid())
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()    
                    print('the form saved successfully') 
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/Classes")
            context = {
                "form": form,
                "records": records,
                "Classes": "active",
                "section_records": section_records,
            }
            return render(request, "Academics/Classes.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def Classes_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "class_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            section_records = Section.objects.filter(branch=branch_id)
            records = Class.objects.filter(branch=branch_id)
            record = Class.objects.get(id=pk)
            form = ClassForm(instance=record)
            lists = record.section.filter(branch=branch_id)
            list = [data.id for data in lists]
            if request.method == "POST":
                form = ClassForm(request.POST, instance=record)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/Classes")
            context = {
                "form": form,
                "list": list,
                "records": records,
                "Classes": "active",
                "edit": True,
                "section_records": section_records,
                "record": record,
            }
            return render(request, "Academics/Classes.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def Classes_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "class_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Class.objects.filter(branch=branch_id)
            record = Class.objects.get(id=pk)
            form = ClassForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "Classes": "active",
                "view": True,
            }
            return render(request, "Academics/Classes.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def Classes_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "class_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            classs=Class.objects.get(id=pk)
            classs_branch_id = classs.branch.id
            if int(classs_branch_id) == int(branch_id):                        
                Class.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/Classes")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def sections(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "section_view" in request.permissions
        or "section_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Section.objects.filter(branch=branch_id)
            print(records)
            form = SectionForm()
            if request.method == "POST":
                form = SectionForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/sections")
                else:
                    print(form.errors)
            context = {"form": form, "sections": "active", "records": records}
            return render(request, "Academics/sections.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def sections_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "section_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Section.objects.filter(branch=branch_id)
            record = Section.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = SectionForm(instance=record)
            if request.method == "POST":
                form = SectionForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/sections")
            context = {
                "form": form,
                "records": records,
                "sections": "active",
                "edit": True,
            }
            return render(request, "Academics/sections.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def sections_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "section_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Section.objects.filter(branch=branch_id)
            record = Section.objects.get(id=pk)
            form = SectionForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "sections": "active",
                "view": True,
            }
            return render(request, "Academics/sections.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def sections_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "section_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            sectionn=Section.objects.get(id=pk)
            sectionn_branch_id = sectionn.branch.id
            if int(sectionn_branch_id) == int(branch_id):                        
                Section.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/sections")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")

    # class_register


@login_required
@user_type_required("Staff")
def class_register(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "class_view" in request.permissions
        or "class_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name) 
            section_records = Section.objects.filter(branch=branch_id)
            staff_records = AddStaff.objects.filter(branch=branch_id)
            class_records = Class.objects.filter(branch=branch_id)
            records = ClassRegister.objects.filter(branch=branch_id)
            form = ClassRegisterForm()

            if request.method == "POST":
                form = ClassRegisterForm(request.POST)
                if form.is_valid():
                    form.save()
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/class_register")
            context = {
                "form": form,
                "records": records,
                "Classes": "active",
                "section_records": section_records,
                "staff_records": staff_records,
                "class_records": class_records,
            }
            return render(request, "Academics/Classes.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def class_register_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "class_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            section_records = Section.objects.filter(branch=branch_id)
            records = Class.objects.filter(branch=branch_id)
            record = Class.objects.get(id=pk)
            form = ClassForm(instance=record)
            lists = record.section.filter(branch=branch_id)
            list = [data.id for data in lists]
            if request.method == "POST":
                form = ClassForm(request.POST, instance=record)
                if form.is_valid():
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/Classes")
            context = {
                "form": form,
                "list": list,
                "records": records,
                "Classes": "active",
                "edit": True,
                "section_records": section_records,
                "record": record,
            }
            return render(request, "Academics/Classes.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def class_register_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "class_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = ClassRegister.objects.filter(branch=branch_id)
            record = ClassRegister.objects.get(id=pk)
            form = ClassRegisterForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "Classes": "active",
                "view": True,
            }
            return render(request, "Academics/Classes.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def class_register_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "class_delete" in request.permissions:
        try:
            Class.objects.get(id=pk).delete()
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/Classes")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


# School Composition
# @login_required
# @user_type_required("Staff")
# def school_compositions(request):
#     compositions = SchoolComposition.objects.filter(branch=branch_id)
#     return render(
#         request, "Academics/school_composition.html", {"compositions": compositions}
#     )


# School Composition Views
# shool composition
# @login_required
# @user_type_required("Staff")
def school_compositions(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "school_view" in request.permissions
        or "school_add" in request.permissions
    ):
        branch_name = request.session.get('branch_id', None)
        if branch_name:
            branch_id = branch_name       
        else:
            branch_id = None  
            print("branch_name@@@",branch_name)
        form = SchoolCompositionForm()
        school_composition = SchoolCompositions.objects.filter(branch=branch_id)
        if request.method == "POST":
            form = SchoolCompositionForm(request.POST)
            if form.is_valid():
                obj=form.save()
                obj.branch_id = branch_id
                obj.save()    
                messages.success(request, "Record Saved Successfully")
                return redirect("school_compositions")
            else:
                messages.success(request, "Record Saved Successfully")
                return redirect("school_compositions")
        context = {
            "form": form,
            "school_composition": school_composition,
            "school_compositions": "active",
        }
        return render(request, "Structure/school_composition.html", context)

        return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def school_composition1(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "class_view" in request.permissions
        or "class_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            branch_records = Branch.objects.filter(branch=branch_id)
            staff_records = AddStaff.objects.filter(branch=branch_id)
            records = Department.objects.filter(branch=branch_id)
            form = DepartmentForm()

            if request.method == "POST":
                form = DepartmentForm(request.POST)
                if form.is_valid():
                    form.save()
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/schools")
            context = {
                "form": form,
                "records": records,
                "Classes": "active",
                "staff_records": staff_records,
                "branch_records": branch_records,
            }
            return render(request, "Structure/school.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


# @login_required
# @user_type_required("Staff")
# def school_composition_edit(request, pk):
#     if request.user.is_superuser or request.user.is_school_admin or "school_edit" in request.permissions:
#         try:
#             record = get_object_or_404(Department, id=pk)
#             form = DepartmentForm(instance=record)

#             if request.method == "POST":
#                 form = DepartmentForm(request.POST, instance=record)
#                 if form.is_valid():
#                     form.save()
#                     messages.warning(request, "Record Updated Successfully")
#                     return redirect("schools")

#             context = {
#                 "form": form,
#                 "records": School.objects.filter(branch=branch_id),
#                 "schools": "active",
#                 "edit": True,
#                 "record": record,
#             }
#             return render(request, "Structure/school_composition_edit.html", context)
#         except Exception as error:
#             return render(request, "error.html", {"error": error})
#     else:
#         return redirect("dashboard")
    
    
def school_composition_edit(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
    print("branch_name@@@",branch_name)
    records = SchoolCompositions.objects.filter(branch=branch_id)
    record = SchoolCompositions.objects.get(id=pk)
    data_branch_id = record.branch.id
    form = SchoolCompositionForm(instance=record)
    if request.method == "POST":
        form = SchoolCompositionForm(request.POST, instance=record)
        if form.is_valid():
            if branch_id == data_branch_id:
                form.save()
            else:
                form.instance.branch_id = branch_id
            form.save()
            messages.warning(request, "Record Updated Successfully")
            return HttpResponseRedirect("/school_compositions")
    context = {
        "form": form,
        "records": records,
        "guardianmaster": "active",
        "edit": True,
    }
    return render(request, "Structure/school_composition_edit.html", context)
     


# @login_required
# @user_type_required("Staff")
# def school_composition_view(request, pk):
#     if request.user.is_superuser or request.user.is_school_admin or "school_view" in request.permissions:
#         try:
#             record = get_object_or_404(School, id=pk)
#             form = DepartmentForm(instance=record)
#             context = {
#                 "form": form,
#                 "records": School.objects.filter(branch=branch_id),
#                 "school": "active",
#                 "view": True,
#             }
#             return render(request, "Structure/school_composition.html", context)
#         except Exception as error:
#             return render(request, "error.html", {"error": error})
#     else:
#         return redirect("dashboard")



    
    
def school_composition_view(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    records = SchoolCompositions.objects.filter(branch=branch_id)
    record = SchoolCompositions.objects.get(id=pk)
    form = SchoolCompositionForm(instance=record)
    context = {
        "form": form,
        "records": records,
        "guardianmaster": "active",
        "view": True,
    }
    return render(request, "Structure/school_composition_edit.html", context)    

@login_required
@user_type_required("Staff")
def school_composition_delete(request, pk):
        branch_name = request.session.get('branch_id', None)
        if branch_name:
            branch_id = branch_name       
        else:
            branch_id = None  
        print("branch_name@@@",branch_name)
        school_compositions=SchoolCompositions.objects.get(id=pk)
        school_compositions_branch_id = school_compositions.branch.id
        if int(school_compositions_branch_id) == int(branch_id):                        
            SchoolCompositions.objects.get(id=pk).delete()
        else:
            messages.error(request, "School id Doesn't match record no delete")
        messages.error(request, "Record Deleted Successfully")
        return HttpResponseRedirect("/school_compositions")

    # level of Education


# @login_required
# @user_type_required("Staff")
def education_levels(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "education_level_view" in request.permissions
        or "education_levels" in request.permissions
    ):
        branch_name = request.session.get('branch_id', None)
        if branch_name:
            branch_id = branch_name       
        else:
            branch_id = None  
            print("branch_name@@@",branch_name)
        form = EducationLevelForm()
        education_level = EducationLevel.objects.filter(branch=branch_id)
        composition = SchoolCompositions.objects.filter(branch=branch_id)
        if request.method == "POST":
            form = EducationLevelForm(request.POST)
            if form.is_valid():
                obj=form.save()
                obj.branch_id = branch_id
                obj.save()  
                messages.success(request, "Record Saved Successfully")
                return redirect("education_levels")
            else:
                messages.success(request, "Record Saved Successfully")
                return redirect("education_levels")
        context = {
            "form": form,
            "education_level": education_level,
            "composition": composition,
            "education_levels": "active",
        }
        return render(request, "Structure/education_level.html", context)

        return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def education_level1(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "class_view" in request.permissions
        or "class_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            branch_records = Branch.objects.filter(branch=branch_id)
            staff_records = AddStaff.objects.filter(branch=branch_id)
            records = Department.objects.filter(branch=branch_id)
            form = DepartmentForm()

            if request.method == "POST":
                form = DepartmentForm(request.POST)
                if form.is_valid():
                    form.save()
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/education_levels")
            context = {
                "form": form,
                "records": records,
                "Classes": "active",
                "staff_records": staff_records,
                "branch_records": branch_records,
            }
            return render(request, "Structure/education_level.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def education_level_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "school_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            record = get_object_or_404(EducationLevel, id=pk)
            data_branch_id = record.branch.id
            form = EducationLevelForm(instance=record)
            if request.method == "POST":
                form = EducationLevelForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return redirect("education_levels")

            context = {
                "form": form,
                "records": EducationLevel.objects.filter(branch=branch_id),
                "schools": "active",
                "edit": True,
                "record": record,
            }
            return render(request, "Structure/education_level_edit.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")

#===========================================
@login_required
@user_type_required("Staff")
def education_level_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "school_view" in request.permissions:
        try:
            record = get_object_or_404(EducationLevel, id=pk)
            form = EducationLevelForm(instance=record)
            context = {
                "form": form,
                "records": EducationLevel.objects.filter(branch=branch_id),
                "school": "active",
                "view": True,
            }
            return render(request, "Structure/education_level.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")

@login_required
@user_type_required("Staff")
def education_level_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "education_level_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            education_level=EducationLevel.objects.get(id=pk)
            data_branch_id = education_level.branch.id
            if int(data_branch_id) == int(branch_id):                        
                EducationLevel.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/education_levels")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")

#===========================================
# @login_required
# @user_type_required("Staff")
# def education_level_delete(request, pk):
#     if request.user.is_superuser or request.user.is_school_admin or "education_level_delete" in request.permissions:
#         try:
#             School.objects.get(id=pk).delete()
#             messages.error(request, "Record Deleted Successfully")
#             return HttpResponseRedirect("/schools")
#         except Exception as error:
#             return render(request, "error.html", {"error": error})
#     else:
#         return redirect("dashboard")


# Structure
# dept
# @login_required
# @user_type_required("Staff")
# def departments(request):
#     if (
#         request.user.is_superuser or request.user.is_school_admin
#         or "department_view" in request.permissions
#         or "department_add" in request.permissions
#     ):
#         try:
#             records = Department.objects.filter(branch=branch_id)
#             form = DepartmentForm()

#             if request.method == "POST":
#                 form = DepartmentForm(request.POST)
#                 if form.is_valid():
#                     form.save()
#                     messages.success(request, "Record Saved Successfully")
#                     return redirect("departments")

#             context = {"form": form, "records": records, "departments": "active"}
#             return render(request, "Structure/departments.html", context)
#         except Exception as error:
#             return render(request, "error.html", {"error": error})
#     else:
#         return redirect("dashboard")


# @login_required
# @user_type_required("Staff")
# def department1(request):
#     if (
#         request.user.is_superuser or request.user.is_school_admin
#         or "class_view" in request.permissions
#         or "class_add" in request.permissions
#     ):
#         try:
#             branch_records = Branch.objects.filter(branch=branch_id)
#             staff_records = AddStaff.objects.filter(branch=branch_id)
#             records = Department.objects.filter(branch=branch_id)
#             form = DepartmentForm()

#             if request.method == "POST":
#                 form = DepartmentForm(request.POST)
#                 if form.is_valid():
#                     form.save()
#                     messages.success(request, "Record Saved Successfully")
#                     return HttpResponseRedirect("/Classes")
#             context = {
#                 "form": form,
#                 "records": records,
#                 "Classes": "active",
#                 "staff_records": staff_records,
#                 "branch_records": branch_records,
#             }
#             return render(request, "Structure/department1.html", context)
#         except Exception as error:
#             return render(request, "error.html", {"error": error})
#     else:
#         return redirect("dashboard")


# @login_required
# @user_type_required("Staff")
# def department_edit(request, pk):
#     if request.user.is_superuser or request.user.is_school_admin or "department_edit" in request.permissions:
#         try:
#             record = get_object_or_404(Department, id=pk)
#             form = DepartmentForm(instance=record)

#             if request.method == "POST":
#                 form = DepartmentForm(request.POST, instance=record)
#                 if form.is_valid():
#                     form.save()
#                     messages.warning(request, "Record Updated Successfully")
#                     return redirect("departments")

#             context = {
#                 "form": form,
#                 "records": Department.objects.filter(branch=branch_id),
#                 "departments": "active",
#                 "edit": True,
#                 "record": record,
#             }
#             return render(request, "Structure/departments.html", context)
#         except Exception as error:
#             return render(request, "error.html", {"error": error})
#     else:
#         return redirect("dashboard")


# @login_required
# @user_type_required("Staff")
# def department_view(request, pk):
#     if request.user.is_superuser or request.user.is_school_admin or "department_view" in request.permissions:
#         try:
#             record = get_object_or_404(Department, id=pk)
#             form = DepartmentForm(instance=record)
#             context = {
#                 "form": form,
#                 "records": Department.objects.filter(branch=branch_id),
#                 "departments": "active",
#                 "view": True,
#             }
#             return render(request, "Structure/departments.html", context)
#         except Exception as error:
#             return render(request, "error.html", {"error": error})
#     else:
#         return redirect("dashboard")


# @login_required
# @user_type_required("Staff")
# def department_delete(request, pk):
#     if request.user.is_superuser or request.user.is_school_admin or "department_delete" in request.permissions:
#         try:
#             Department.objects.get(id=pk).delete()
#             messages.error(request, "Record Deleted Successfully")
#             return HttpResponseRedirect("/departments")
#         except Exception as error:
#             return render(request, "error.html", {"error": error})
#     else:
#         return redirect("dashboard")

# Branch


@login_required
@user_type_required("Staff")
def branch(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "branch_view" in request.permissions
        or "branch_add" in request.permissions
    ):
        try:
            token = request.session['user_token']
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            endpoint = 'finance/branch/'    
            form = BranchForm()
            branches = Branch.objects.filter(branch=branch_id)
            if request.method == "POST":
                form = BranchForm(request.POST)
                if form.is_valid():
                    data = {
                    'branch_name' : form.cleaned_data['name'],
                    'description':form.cleaned_data['description'],
                    'company_name':form.cleaned_data['currency_code'],
                    }
                    print("++++++++++++++++++",data)                        
                    json_data = json.dumps(data)
                    print("=========",json_data)                    
                    response = call_post_method(BASE_URL,endpoint,json_data,token)
                    print("response",response)
                    if response.status_code != 200:              
                        print('Response Status Code:', response.content)
                        
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()
                    messages.success(request, "Record Saved Successfully")
                    return redirect("branch")
                else:
                    messages.success(request, "Record Saved Successfully")
                    return redirect("branch")
            context = {"form": form, "branches": branches, "branch": "active"}
            return render(request, "Structure/branch.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def branch1(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "department_view" in request.permissions
        or "department_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Branch.objects.filter(branch=branch_id)
            form = BranchForm()

            if request.method == "POST":
                form = BranchForm(request.POST)
                if form.is_valid():
                    form.save()
                    messages.success(request, "Record Saved Successfully")
                    return redirect("branch")

            context = {"form": form, "records": records, "departments": "active"}
            return render(request, "Structure/departments.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def branch_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "department_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            record = get_object_or_404(Branch, id=pk)
            data_branch_id = record.branch.id
            form = BranchForm(instance=record)
            if request.method == "POST":
                form = BranchForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return redirect("branch")

            context = {
                "form": form,
                "records": Branch.objects.filter(branch=branch_id),
                "branch": "active",
                "edit": True,
                "record": record,
            }
            return render(request, "Structure/branch.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def branch_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "department_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            record = get_object_or_404(Department, id=pk)
            form = DepartmentForm(instance=record)
            context = {
                "form": form,
                "records": Department.objects.filter(branch=branch_id),
                "departments": "active",
                "view": True,
            }
            return render(request, "Structure/departments.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def branch_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "department_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            deparment=Department.objects.get(id=pk)
            deparment_branch_id = deparment.branch.id
            if int(deparment_branch_id) == int(branch_id):                        
                Department.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/branch")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")

    # school


# @login_required
# @user_type_required("Staff")
# def schools(request):
#     if (
#         request.user.is_superuser or request.user.is_school_admin
#         or "school_view" in request.permissions
#         or "school_add" in request.permissions
#     ):
#         try:
#             form = SchoolForm()
#             schools = School.objects.filter(branch=branch_id)
#             if request.method == "POST":
#                 form = SchoolForm(request.POST)
#                 if form.is_valid():
#                     form.save()
#                     messages.success(request, "Record Saved Successfully")
#                     return redirect("schools")
#                 else:
#                     messages.success(request, "Record Saved Successfully")
#                     return redirect("schools")
#             context = {"form": form, "schools": schools, "school": "active"}
#             return render(request, "Structure/school.html", context)
#         except Exception as error:
#             return render(request, "error.html", {"error": error})
#     else:
#         return redirect("dashboard")


# views.py
# @login_required
# @user_type_required("Staff")
# def schools(request):
#     try:
#         branch_name = request.session.get('branch_id', None)
#         if branch_name:
#             branch_id = branch_name       
#         else:
#             branch_id = None   
#         print("school_name@@@",branch_id)
#         form = SchoolForm()
#         schools = School.objects.filter(branch=branch_id)
#         school_account = None
#         if request.method == "POST":
#             form = SchoolForm(request.POST)
#             if form.is_valid():
#                 school_instance = form.save(commit=False)
#                 school_instance.branch_id = branch_id
#                 school_instance.save()
#                 school_account = create_school_account(school_instance,branch_id)

#                 messages.success(request, "Record Saved Successfully")
#                 return redirect("schools")
#             else:
#                 messages.success(request, "Record Saved Successfully")
#                 return redirect("schools")

#         context = {
#             "form": form,
#             "schools": schools,
#             "school_account": school_account,
#             "school": "active",
#         }
#         return render(request, "Structure/school.html", context)

#     except Exception as error:
#         return render(request, "error.html", {"error": error})
   

@login_required
@user_type_required("Staff")
def school1(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "class_view" in request.permissions
        or "class_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            branch_records = Branch.objects.filter(branch=branch_id)
            staff_records = AddStaff.objects.filter(branch=branch_id)
            records = Department.objects.filter(branch=branch_id)
            form = DepartmentForm()

            if request.method == "POST":
                form = DepartmentForm(request.POST)
                if form.is_valid():
                    form.save()
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/schools")
            context = {
                "form": form,
                "records": records,
                "Classes": "active",
                "staff_records": staff_records,
                "branch_records": branch_records,
            }
            return render(request, "Structure/school.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


# @login_required
# @user_type_required("Staff")
# def school_edit(request, pk):
#     if request.user.is_superuser or request.user.is_school_admin or "school_edit" in request.permissions:
#         try:
#             record = get_object_or_404(School, id=pk)
#             form = SchoolForm(instance=record)

#             if request.method == "POST":
#                 form = SchoolForm(request.POST, instance=record)
#                 if form.is_valid():
#                     form.save()
#                     messages.warning(request, "Record Updated Successfully")
#                     return redirect("schools")

#             context = {
#                 "form": form,
#                 "records": School.objects.filter(branch=branch_id),
#                 "schools": "active",
#                 "edit": True,
#                 "record": record,
#             }
#             return render(request, "Structure/school_edit.html", context)
#         except Exception as error:
#             return render(request, "error.html", {"error": error})
#     else:
#         return redirect("dashboard")


# @login_required
# @user_type_required("Staff")
# def school_view(request, pk):
#     if request.user.is_superuser or request.user.is_school_admin or "school_view" in request.permissions:
#         try:
#             record = get_object_or_404(School, id=pk)
#             form = School(instance=record)
#             context = {
#                 "form": form,
#                 "records": School.objects.filter(branch=branch_id),
#                 "school": "active",
#                 "view": True,
#             }
#             return render(request, "Structure/school.html", context)
#         except Exception as error:
#             return render(request, "error.html", {"error": error})
#     else:
#         return redirect("dashboard")


# @login_required
# @user_type_required("Staff")
# def school_delete(request, pk):
#     if request.user.is_superuser or request.user.is_school_admin or "school_delete" in request.permissions:
#         try:
#             School.objects.get(id=pk).delete()
#             messages.error(request, "Record Deleted Successfully")
#             return HttpResponseRedirect("/schools")
#         except Exception as error:
#             return render(request, "error.html", {"error": error})
#     else:
#         return redirect("dashboard")

    # shool year


@login_required
def school_years(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "school_view" in request.permissions
        or "school_add" in request.permissions
    ):
        branch_name = request.session.get('branch_id', None)
        if branch_name:
            branch_id = branch_name       
        else:
            branch_id = None  
            print("branch_name@@@",branch_name)
        form = SchoolYearForm()
        school_years = SchoolYear.objects.filter(branch=branch_id)
        print("school_years+++",school_years)
        school_terms = Term.objects.filter(branch=branch_id)
        print(f"school years {school_years}")
        if request.method == "POST":
            form = SchoolYearForm(request.POST)
            print(f"data {form.data}")
            if form.is_valid():
                obj=form.save()
                obj.branch_id = branch_id
                obj.save() 
                messages.success(request, "Record Saved Successfully")
                return redirect("school_years")
            else:
                messages.error(request, "Record not saved")
                return redirect("school_years")
        context = {
            "form": form,
            "school_years": school_years,
            "school_terms": school_terms,
            "school_years_all": "active"
        }
        return render(request, "Structure/school_year.html", context)

        # return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")
    
    



# @login_required
# @user_type_required("Staff")
# def school_year(request):
#     if (
#         request.user.is_superuser or request.user.is_school_admin
#         or "class_view" in request.permissions
#         or "class_add" in request.permissions
#     ):
#         try:
#             branch_records = Branch.objects.filter(branch=branch_id)
#             staff_records = AddStaff.objects.filter(branch=branch_id)
#             records = Department.objects.filter(branch=branch_id)
#             form = DepartmentForm()

#             if request.method == "POST":
#                 form = DepartmentForm(request.POST)
#                 if form.is_valid():
#                     form.save()
#                     messages.success(request, "Record Saved Successfully")
#                     return HttpResponseRedirect("/school_years")
#             context = {
#                 "form": form,
#                 "records": records,
#                 "Classes": "active",
#                 "staff_records": staff_records,
#                 "branch_records": branch_records,
#             }
#             return render(request, "Structure/school.html", context)
#         except Exception as error:
#             return render(request, "error.html", {"error": error})
#     else:
#         return redirect("dashboard")


def school_year1(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "school_view" in request.permissions
        or "school_add" in request.permissions
    ):
        branch_name = request.session.get('branch_id', None)
        if branch_name:
            branch_id = branch_name       
        else:
            branch_id = None  
            print("branch_name@@@",branch_name)
        form = SchoolYearForm()
        school_years_data = SchoolYear.objects.filter(branch=branch_id)
        school_terms = Term.objects.filter(branch=branch_id)

        if request.method == "POST":
            form = SchoolYearForm(request.POST)
            if form.is_valid():
                form.save()
                messages.success(request, "Record Saved Successfully")
                return redirect("school_years")
            else:
                messages.success(request, "Record Not Saved. Please check the form.")
                return redirect("school_years")

        context = {
            "form": form,
            "school_years": school_years_data,
            "school_terms": school_terms,
            "school_years_active": "active",
        }
        return render(request, "Structure/school_year1.html", context)
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def school_year_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "school_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            record = get_object_or_404(SchoolYear, id=pk)
            data_branch_id = record.branch.id
            form = SchoolYearForm(instance=record)

            if request.method == "POST":
                form = SchoolYearForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return redirect("school_years")

            context = {
                "form": form,
                "school_years": SchoolYear.objects.filter(branch=branch_id),
                "school_years_active": "active",
                "edit": True,
                "record": record,
            }
            return render(request, "Structure/school_year.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def school_year_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "school_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            record = get_object_or_404(SchoolYear, id=pk)
            form = SchoolYearForm(instance=record)
            context = {
                "form": form,
                "records": SchoolYear.objects.filter(branch=branch_id),
                "school": "active",
                "view": True,
            }
            return render(request, "Structure/school.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def school_year_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "school_year_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            school_year = SchoolYear.objects.get(id=pk)
            school_year_branch_id = school_year.branch.id
            if int(school_year_branch_id) == int(branch_id):                        
                SchoolYear.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/school_years")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")

    # shool year


@login_required
# @user_type_required("Staff")
def school_terms(request):
    # if (
    #     request.user.is_superuser or request.user.is_school_admin
    #     or "school_terms_view" in request.permissions
    #     or "school_terms_add" in request.permissions
    # ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            form = TermForm()
            school_term = Term.objects.filter(branch=branch_id)
            if request.method == "POST":
                form = TermForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()  
                    messages.success(request, "Record Saved Successfully")
                    return redirect("school_terms")
                else:
                    messages.success(request, "Record Saved Successfully")
                    return redirect("school_terms")
            context = {"form": form, "school_term": school_term, "school_terms": "active"}
            return render(request, "Structure/school_term.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    # else:
    #     return redirect("dashboard")


@login_required
@user_type_required("Staff")
def school_term1(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "class_view" in request.permissions
        or "class_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            branch_records = Branch.objects.filter(branch=branch_id)
            staff_records = AddStaff.objects.filter(branch=branch_id)
            records = Department.objects.filter(branch=branch_id)
            form = DepartmentForm()
            if request.method == "POST":
                form = DepartmentForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/school_terms")
            context = {
                "form": form,
                "records": records,
                "Classes": "active",
                "staff_records": staff_records,
                "branch_records": branch_records,
            }
            return render(request, "Structure/school.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def school_term_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "school_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None                  
                print("branch_name@@@",branch_name)
            record = get_object_or_404(Term, id=pk)
            data_branch_id = record.branch.id
            form = TermForm(instance=record)
            if request.method == "POST":
                form = TermForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return redirect("school_terms")
            context = {
                "form": form,
                "records": Term.objects.filter(branch=branch_id),
                "school_terms": "active",
                "edit": True,
                "record": record,
            }
            return render(request, "Structure/school_term.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def school_term_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "school_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            record = get_object_or_404(Term, id=pk)
            form = TermForm(instance=record)
            context = {
                "form": form,
                "records": Term.objects.filter(branch=branch_id),
                "school": "active",
                "view": True,
            }
            return render(request, "Structure/school_term.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def school_term_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "school_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            terms=Term.objects.get(id=pk)
            term_branch_id = terms.branch.id
            if int(term_branch_id) == int(branch_id):                        
                Term.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/school_terms")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")

    # Grading System


@login_required
# @user_type_required("Staff")
def grading_systems(request):
    # if (
    #     request.user.is_superuser or request.user.is_school_admin
    #     or "school_view" in request.permissions
    #     or "school_add" in request.permissions
    # ):
    #     try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            form = GradingSystemForm()
            grading_system = GradingSystem.objects.filter(branch=branch_id)
            if request.method == "POST":
                form = GradingSystemForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()        
                    messages.success(request, "Record Saved Successfully")
                    return redirect("grading_systems")
                else:
                    messages.success(request, "Record Saved Successfully")
                    return redirect("grading_systems")
            context = {
                "form": form,
                "grading_system": grading_system,
                "grading_system_act": "active",
            }
            return render(request, "Academics/grading_system.html", context)
    #     except Exception as error:
    #         return render(request, "error.html", {"error": error})
    # else:
    #     return redirect("dashboard")


# @login_required
# @user_type_required("Staff")
# def grading_system1(request):
#     if (
#         request.user.is_superuser or request.user.is_school_admin
#         or "class_view" in request.permissions
#         or "class_add" in request.permissions
#     ):
#         try:
#             branch_records = Branch.objects.filter(branch=branch_id)
#             staff_records = AddStaff.objects.filter(branch=branch_id)
#             records = Department.objects.filter(branch=branch_id)
#             form = DepartmentForm()

#             if request.method == "POST":
#                 form = DepartmentForm(request.POST)
#                 if form.is_valid():
#                     form.save()
#                     messages.success(request, "Record Saved Successfully")
#                     return HttpResponseRedirect("/schools")
#             context = {
#                 "form": form,
#                 "records": records,
#                 "Classes": "active",
#                 "staff_records": staff_records,
#                 "branch_records": branch_records,
#             }
#             return render(request, "Academics/school.html", context)
#         except Exception as error:
#             return render(request, "error.html", {"error": error})
#     else:
#         return redirect("dashboard")


@login_required
@user_type_required("Staff")
def grading_system_edit(request, pk):
    # if request.user.is_superuser or request.user.is_school_admin or "school_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            record = GradingSystem.objects.get(id=pk)
            print("record+++",record)
            data_branch_id = record.branch.id
            form = GradingSystemForm(instance=record)

            if request.method == "POST":
                form = GradingSystemForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return redirect("grading_systems")

            context = {
                "form": form,
                "grading_system": GradingSystem.objects.filter(branch=branch_id),
                "grading_system_act": "active",
                "edit": True,
                "record": record,
            }
            return render(request, "Academics/grading_system.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    # else:
    #     return redirect("dashboard")


@login_required
@user_type_required("Staff")
def grading_system_view(request, pk):
    # if request.user.is_superuser or request.user.is_school_admin or "school_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            record = get_object_or_404(GradingSystem, id=pk)
            grading_system = GradingSystem.objects.filter(branch=branch_id)
            form = GradingSystemForm(instance=record)
            context = {
                "form": form,               
                "grading_system_act": "active",
                "view": True,
                "grading_system":grading_system
            }
           
            return render(request, "Academics/grading_system.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    # else:
    #     return redirect("dashboard")


@login_required
@user_type_required("Staff")
def grading_system_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "school_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)

            school=GradingSystem.objects.get(id=pk)
            school_branch_id = school.branch.id
            if int(school_branch_id) == int(branch_id):                        
                GradingSystem.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/grading_systems")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


# Education Level Views
@login_required
@user_type_required("Staff")
def EducationLevelsListView(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    levels = EducationLevel.objects.filter(branch=branch_id)
    return render(request, "Academics/education_levels_list.html", {"levels": levels})


@login_required
@user_type_required("Staff")
def EducationLevelDetailView(request, pk):
    level = get_object_or_404(EducationLevel, pk=pk)
    return render(request, "Academics/education_level_detail.html", {"level": level})


@login_required
@user_type_required("Staff")
def EducationLevelCreateView(request):
    if request.method == "POST":
        form = EducationLevelForm(request.POST)
        if form.is_valid():
            form.save()
            messages.success(request, "Education Level added successfully.")
            return HttpResponseRedirect("/education_levels")
    else:
        form = EducationLevelForm()

    return render(request, "Academics/education_level_form.html", {"form": form})


@login_required
@user_type_required("Staff")
def EducationLevelUpdateView(request, pk):
    level = get_object_or_404(EducationLevel, pk=pk)

    if request.method == "POST":
        form = EducationLevelForm(request.POST, instance=level)
        if form.is_valid():
            form.save()
            messages.success(request, "Education Level updated successfully.")
            return HttpResponseRedirect("/education_levels")
    else:
        form = EducationLevelForm(instance=level)

    return render(request, "Academics/education_level_form.html", {"form": form})


@login_required
@user_type_required("Staff")
def EducationLevelDeleteView(request, pk):
    level = get_object_or_404(EducationLevel, pk=pk)

    if request.method == "POST":
        level.delete()
        messages.success(request, "Education Level deleted successfully.")
        return HttpResponseRedirect("/education_levels")

    return render(
        request, "Academics/education_level_confirm_delete.html", {"level": level}
    )


@login_required
@user_type_required("Staff")  # Download Center
def upload_content(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "upload_content_view" in request.permissions
        or "upload_content_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            class_records = Class.objects.filter(branch=branch_id)
            form = UploadContentForm()
            contents = UploadContent.objects.filter(branch=branch_id)
            if request.method == "POST":
                form = UploadContentForm(request.POST, request.FILES)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()
                    print(form.errors)
                    messages.success(request, "Record Saved Successfully")
                    return redirect("upload_content")
                else:
                    messages.success(request, "Record Saved Successfully")
                    return redirect("upload_content")
            context = {
                "form": form,
                "contents": contents,
                "upload_content": "active",
                "class_records": class_records,
            }
            return render(request, "Download_center/upload_content.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def upload_content_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "upload_content_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            class_records = Class.objects.filter(branch=branch_id)
            contents = UploadContent.objects.filter(branch=branch_id)
            content = UploadContent.objects.get(id=pk)
            data_branch_id = content.branch.id
            form = UploadContentForm(instance=content)
            if request.method == "POST":
                form = UploadContentForm(request.POST, instance=content)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/upload_content")
            context = {
                "form": form,
                "contents": contents,
                "upload_content": "active",
                "content": content,
                "edit": True,
                "class_records": class_records,
            }
            return render(request, "Download_center/upload_content.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def upload_content_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "upload_content_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            upload_content=UploadContent.objects.get(id=pk)
            upload_content_branch_id = upload_content.branch.id
            if int(upload_content_branch_id) == int(branch_id):                        
                UploadContent.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/upload_content")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


#  home work


@login_required
@user_type_required("Staff")
def add_homework(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "homework_view" in request.permissions
        or "homework_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = AddHomeWork.objects.filter(branch=branch_id)
            form = AddHomeWorkForm()
            if request.method == "POST":
                form = AddHomeWorkForm(request.POST, request.FILES)
                if form.is_valid():
                    homework = form.save(commit=False)
                    homework.created_by = request.user
                    homework.branch_id = branch_id
                    homework.save()
                    student = StudentAdmission.objects.filter(
                        Class=request.POST.get("Class"),
                        section=request.POST.get("section"),
                        session=request.Session,
                        branch_id=branch_id
                    )
                    for data in student:
                        AssingHomeWork.objects.get_or_create(
                            home_work_id=homework.pk,
                            student_id=data.id,
                            status="Pending",
                            branch_id=branch_id
                        )
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/add_homework")
                else:
                    print(form.errors)
            context = {"form": form, "records": records, "add_homework": "active"}
            return render(request, "Home_work/add_homework.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def add_homework_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "homework_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = AddHomeWork.objects.filter(branch=branch_id)
            record = AddHomeWork.objects.get(id=pk)
            recordss = AssingHomeWork.objects.filter(home_work=pk)
            if request.POST.get("save") == "save":
                record.evaluation_date = request.POST.get("evaluation_date")
                student_list = request.POST.getlist("student_ids")
                for data in student_list:
                    obj = recordss.get(id=data)
                    obj.evaluation_date = request.POST.get("evaluation_date")
                    obj.status = "Submitted"
                    obj.save()
                record.save()
                return HttpResponseRedirect("/add_homework")
            context = {
                "record": record,
                "records": records,
                "homework": "active",
                "recordss": recordss,
                "view": True,
            }
            return render(request, "Home_work/add_homework_view.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def add_homework_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "homework_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = AddHomeWork.objects.filter(branch=branch_id)
            record = AddHomeWork.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = AddHomeWorkForm(instance=record)
            if request.method == "POST":
                form = AddHomeWorkForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/add_homework")
            context = {"form": form, "records": records, "homework": "active"}

            return render(request, "Home_work/add_homework_edit.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def add_homework_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "homework_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            addHome_work=AddHomeWork.objects.get(id=pk)
            addHome_work_branch_id = addHome_work.branch.id
            if int(addHome_work_branch_id) == int(branch_id):                        
                AddHomeWork.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/add_homework")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


# Front office


@login_required
@user_type_required("Staff")
def visitor_book(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "visitor_book_view" in request.permissions
        or "visitor_book_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = VisitorBook.objects.filter(branch=branch_id)
            form = VisitorBookForm()
            if request.method == "POST":
                form = VisitorBookForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()                    
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/visitor_book")
            context = {"form": form, "records": records, "visitor_book": "active"}

            return render(request, "Front_Office/visitor_book.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def visitor_book_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "visitor_book_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)

            records = VisitorBook.objects.filter(branch=branch_id)
            record = VisitorBook.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = VisitorBookForm(instance=record)
            if request.method == "POST":
                form = VisitorBookForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/visitor_book")
            context = {
                "form": form,
                "records": records,
                "visitor_book": "active",
                "edit": True,
            }

            return render(request, "Front_Office/visitor_book.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def visitor_book_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "visitor_book_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = VisitorBook.objects.filter(branch=branch_id)
            record = VisitorBook.objects.get(id=pk)
            form = VisitorBookForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "visitor_book": "active",
                "view": True,
            }
            return render(request, "Front_Office/visitor_book.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def visitor_book_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "visitor_book_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            visit_sch_id=VisitorBook.objects.get(id=pk)
            visit_branch_id = visit_sch_id.branch.id
            if int(visit_branch_id) == int(branch_id):                        
                VisitorBook.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            return HttpResponseRedirect("/visitor_book")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def disabled_staff(request):
    if request.user.is_superuser or request.user.is_school_admin or "disable_staff_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            roles = Role.objects.filter(branch=branch_id)
            records = AddStaff.objects.filter(status="Disable",branch_id=branch_id)
            if request.method == "POST":
                records = AddStaff.objects.filter(
                    roles=request.POST.get("roles"), status="Disable",branch_id=branch_id
                )
            context = {
                "disabled_staff": "active",
                "roles": roles,
                "records": records,
            }
            return render(request, "Human_Resource/disabled_staff.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def generate_ID_card(request):
    if request.user.is_superuser or request.user.is_school_admin or "generate_id_card_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)

            ID_card_records = StudentId.objects.filter(branch=branch_id)
            class_records = Class.objects.filter(branch=branch_id)
            if request.method == "POST":
                section_records = Section.objects.filter(branch=branch_id)
                classs = request.POST.get("class")
                section = request.POST.get("section")
                id_card = request.POST.get("ID_card")
                records = StudentAdmission.objects.filter(
                    Class=classs,
                    section=section,
                    session=request.Session,
                    branch_id=branch_id
                )
                context = {
                    "generate_ID_card": "active",
                    "ID_card_records": ID_card_records,
                    "class_records": class_records,
                    "classs": int(classs),
                    "section": int(section),
                    "id_card": int(id_card),
                    "records": records,
                    "section_records": section_records,
                }
                return render(request, "Certificate/generate_ID_card.html", context)
            context = {
                "generate_ID_card": "active",
                "ID_card_records": ID_card_records,
                "class_records": class_records,
            }
            return render(request, "Certificate/generate_ID_card.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def print_ID_card(request):
    id_card = StudentId.objects.get(id=request.POST.get("id_card"))
    records = StudentAdmission.objects.filter(id__in=request.POST.getlist("checkbox"))
    context = {"generate_ID_card": "active", "data": id_card, "records": records}
    return render(request, "Certificate/print_ID_card.html", context)


@login_required
@user_type_required("Staff")
def admission_report(request):
    if request.user.is_superuser or request.user.is_school_admin or "student_report_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            if request.method == "POST":
                from_date = request.POST.get("from_date")
                to_date = request.POST.get("to_date")
                filters = {}
                if from_date and to_date:
                    filters["admission_date__range"] = [from_date, to_date]
                if branch_id:
                    filters["branch_id"] = branch_id

                records = StudentAdmission.objects.filter(**filters)
                context = {
                    "records": records,
                }
                return render(request, "Reports/admission_report.html", context)

            context = {"student_information_report": "active"}
            return render(request, "Reports/admission_report.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def balances_fees_report(request):
    if request.user.is_superuser or request.user.is_school_admin or "search_due_fees_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            Classs = Class.objects.filter(branch=branch_id)
            if request.method == "POST":
                records = FeesAssign.objects.filter(
                    session=request.Session,
                    student__Class=request.POST.get("class"),
                    student__section=request.POST.get("section"),
                    student__session=request.Session,branch_id=branch_id
                ).exclude(status="fully paid")

                context = {"fees_type": fees_type, "Classs": Classs, "records": records}
                return render(request, "Reports/balances_fees_report.html", context)
            context = {"Classs": Classs, "Finances_report": "active"}
            return render(request, "Reports/balances_fees_report.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def class_subject_report(request):
    if request.user.is_superuser or request.user.is_school_admin or "student_report_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            class_records = Class.objects.filter(branch=branch_id)
            section_records = Section.objects.filter(branch=branch_id)

            if request.method == "POST":
                classs = request.POST.get("class")
                section = request.POST.get("section")
                filters = {}
                if classs:
                    filters["Class_id"] = classs

                if section:
                    filters["section_id"] = section

                if branch_id:
                    filters["branch_id"] = branch_id

                records = TimeTable.objects.filter(**filters)

                context = {
                    "student_information_report": "active",
                    "records": records,
                    "class_records": class_records,
                    "section_records": section_records,
                }

                return render(request, "Reports/class_subject_report.html", context)

            context = {
                "student_information_report": "active",
                "class_records": class_records,
                "section_records": section_records,
            }

            return render(request, "Reports/class_subject_report.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def examinations_report(request):
    if request.user.is_superuser or request.user.is_school_admin or "exanmination_report_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            exam_group = examGroup.objects.filter(branch=branch_id)
            class_records = Class.objects.filter(branch=branch_id)
            session_records = Session.objects.filter(branch=branch_id)
            if request.method == "POST":
                exams = AddExamSubject.objects.filter(exam=request.POST.get("exam"))
                student = ExamStudent.objects.filter(
                    Class=request.POST.get("class"),
                    section=request.POST.get("section"),
                    exam=request.POST.get("exam"),
                    exam__session=request.POST.get("session"),
                )
                records = EntryMarks.objects.filter(
                    student__Class=request.POST.get("class"),
                    student__section=request.POST.get("section"),
                    exam=request.POST.get("exam"),
                    branch_id=branch_id
                )
                listt = []
                for data in student:
                    total_mark = 0
                    total = 0
                    mark_list = []
                    results = []
                    for sub in exams:
                        dict = {}
                        mark = EntryMarks.objects.filter(
                            exam_subject=sub, exam_student=data
                        ).last()
                        dic = {}
                        if mark:
                            dic["subject"] = mark.subject
                            total_mark += mark.marks
                            if mark.marks <= sub.marks_min:
                                results.append("Fail")
                                dic["marks"] = f"{mark.marks} (F)"
                            else:
                                results.append("Pass")
                                dic["marks"] = mark.marks
                        else:
                            dic["subject"] = sub.subject
                            dic["marks"] = ""
                            results.append(None)
                        total += sub.marks_max
                        mark_list.append(dic)

                    dict["mark_list"] = mark_list
                    dict["obj"] = data
                    dict["total"] = f"{total_mark}/{int(total)}"
                    dict["percentage"] = int(total_mark * 100 / int(total))
                    dict["result"] = results
                    listt.append(dict)
                context = {
                    "examinations_report": "active",
                    "exam_group": exam_group,
                    "class_records": class_records,
                    "session_records": session_records,
                    "exams": exams,
                    "records": records,
                    "listt": listt,
                }
                return render(request, "Reports/examinations_report.html", context)
            context = {
                "examinations_report": "active",
                "exam_group": exam_group,
                "class_records": class_records,
                "session_records": session_records,
            }
            return render(request, "Reports/examinations_report.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return render(request, "page_not_found.html", {"error": error})


@login_required
@user_type_required("Staff")
def expense_group_report(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "expense_group_report_view" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            expense_head_records = ExpenseHead.objects.filter(branch=branch_id)
            if request.method == "POST":
                from_date = request.POST.get("from_date")
                to_date = request.POST.get("to_date")
                expense_head = request.POST.get("expense_head")
                filters = {}
                if from_date and to_date:
                    filters["date__range"] = [from_date, to_date]
                elif from_date:
                    filters["date__gte"] = from_date
                elif to_date:
                    filters["date__lte"] = to_date
                if expense_head:
                    filters["expense_head__id"] = expense_head
                if branch_id:
                    filters["branch_id"] = branch_id    

                records = AddExpense.objects.filter(**filters)

                expense_totals = {}
                for record in records:
                    expense_head = record.expense_head
                    amount = record.amount
                    if expense_head in expense_totals:
                        expense_totals[expense_head] += amount
                    else:
                        expense_totals[expense_head] = amount

                total_amount = sum(expense_totals.values())

                context = {
                    "expense_head_records": expense_head_records,
                    "expense_group_report": "active",
                    "records": records,
                    "expense_totals": expense_totals,
                    "total_amount": total_amount,
                }
                return render(request, "Reports/expense_group_report.html", context)

            context = {
                "expense_head_records": expense_head_records,
                "Finances_report": "active",
            }
            return render(request, "Reports/expense_group_report.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def expense_report(request):
    if request.method == "POST":
        branch_name = request.session.get('branch_id', None)
        if branch_name:
            branch_id = branch_name       
        else:
            branch_id = None  
            print("branch_name@@@",branch_name)
        from_date = request.POST.get("from_date")
        to_date = request.POST.get("to_date")

        # Filter expenses based on date range
        expenses = AddExpense.objects.filter(date__range=[from_date, to_date],branch_id=branch_id)

        # Calculate grand total
        grand_total = expenses.aggregate(total_amount=models.Sum("amount")).get(
            "total_amount", 0
        )

        context = {
            "expenses": expenses,
            "from_date": from_date,
            "to_date": to_date,
            "grand_total": grand_total,
            "Finances_report": "active",
        }
        return render(request, "Reports/expense_report.html", context)

    return render(request, "Reports/expense_report.html")


@login_required
@user_type_required("Staff")
def fees_collection_report(request):
    roles_rcords = AddStaff.objects.filter(branch=branch_id)
    class_records = Class.objects.filter(branch=branch_id)
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    if request.method == "POST":
        from_date = request.POST.get("from_date")
        to_date = request.POST.get("to_date")
        role = request.POST.get("role")
        filters = {}
        if role:
            filters["created_by"] = role
        if from_date and to_date:
            filters["created_at__range"] = [from_date, to_date]
        if from_date:
            filters["created_at__gte"] = from_date
        if to_date:
            filters["created_at__lte"] = to_date
        if branch_id:
            filters["branch_id"] = branch_id
        records = StudentFess.objects.filter(**filters)
        total_amount = records.aggregate(Sum("paid_amount"))["paid_amount__sum"]
        total_dicount = records.aggregate(Sum("amount_discount"))[
            "amount_discount__sum"
        ]
        total_fine = records.aggregate(Sum("amount_fine"))["amount_fine__sum"]
        print("records", records)
        context = {
            "records": records,
            "class_records": class_records,
            "roles_rcords": roles_rcords,
            "total_amount": total_amount,
            "total_dicount": total_dicount,
            "total_fine": total_fine,
        }
        return render(request, "Reports/fees_collection_report.html", context)

    context = {
        "class_records": class_records,
        "fees_collection_report": "active",
        "Finances_report": "active",
        "roles_rcords": roles_rcords,
    }
    return render(request, "Reports/fees_collection_report.html", context)


@login_required
@user_type_required("Staff")
def Finances_report(request):
    if request.user.is_superuser or request.user.is_school_admin or "finance_report_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            class_records = Class.objects.filter(branch=branch_id)
            if request.method == "POST":
                student_name = request.POST.get("student_name")
                print("student_name", student_name)
                record = StudentAdmission.objects.get(id=student_name,branch_id=branch_id)

                fees_records = FeesAssign.objects.filter(
                    student_id=request.POST.get("student_name"),branch_id=branch_id
                )
                # fees_discount=FeesTypeDiscount.objects.filter(branch=branch_id)
                fees_discount = DiscountAssign.objects.filter(
                    student=request.POST.get("student_name"),branch_id=branch_id
                )

                paid_record = StudentFess.objects.filter(
                    student=request.POST.get("student_name"),branch_id=branch_id
                )

                context = {
                    "records": record,
                    "Finances_report": "active",
                    "fees_records": fees_records,
                    "fees_discount": fees_discount,
                    "paid_record": paid_record,
                    "class_records": class_records,
                }
                return render(request, "Reports/Finances_report.html", context)

            context = {"Finances_report": "active", "class_records": class_records}
            return render(request, "Reports/Finances_report.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return render(request, "page_not_found.html", {"error": error})


@login_required
@user_type_required("Staff")
def homework_evaluation_report(request):
    if request.user.is_superuser or request.user.is_school_admin or "student_report_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            class_records = Class.objects.filter(branch=branch_id)
            if request.method == "POST":
                classs = request.POST.get("Class")
                section = request.POST.get("section")
                subject_groups = request.POST.get("subject_group")
                subject = request.POST.get("subject")
                records = AddHomeWork.objects.filter(
                    Class_id=classs,
                    section_id=section,
                    subject_group_id=subject_groups,
                    subject_id=subject,
                    branch_id=branch_id
                )
                list = []
                for data in records:
                    dict = {}
                    assign_homework = AssingHomeWork.objects.filter(home_work=data)
                    complete = assign_homework.filter(
                        evaluation_date__isnull=False
                    ).count()
                    incompelete = assign_homework.filter(
                        evaluation_date__isnull=True
                    ).count()
                    total_student = assign_homework.count()
                    percentage = int(complete * 100 / total_student)
                    dict["obj"] = data
                    dict["complete"] = complete
                    dict["incomplete"] = incompelete
                    dict["percentage"] = percentage
                    list.append(dict)
                    print(dict)
                print(list)
                context = {
                    "records": records,
                    "class_records": class_records,
                    "list": list,
                }
                return render(
                    request, "Reports/homework_evaluation_report.html", context
                )
            context = {
                "class_records": class_records,
                "student_information_report": "active",
            }
            return render(request, "Reports/homework_evaluation_report.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def income_group_report(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "income_group_report_view" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            income_head_records = Incomehead.objects.filter(branch=branch_id)
            if request.method == "POST":
                from_date = request.POST.get("from_date")
                to_date = request.POST.get("to_date")
                income_head_id = request.POST.get("Income_head")
                filters = {}
                if from_date and to_date:
                    filters["date__range"] = [from_date, to_date]
                elif from_date:
                    filters["date__gte"] = from_date
                elif to_date:
                    filters["date__lte"] = to_date
                if income_head_id:
                    filters["Income_head__id"] = income_head_id
                if branch_id:
                    filters["branch_id"] = branch_id    

                records = AddIncome.objects.filter(**filters)

                income_totals = {}
                for record in records:
                    income_head = record.Income_head
                    amount = record.amount
                    if income_head in income_totals:
                        income_totals[income_head] += int(amount)
                    else:
                        income_totals[income_head] = int(amount)

                total_amount = sum(income_totals.values())

                context = {
                    "income_head_records": income_head_records,
                    "income_group_report": "active",
                    "records": records,
                    "income_totals": income_totals,
                    "total_amount": total_amount,
                }
                return render(request, "Reports/income_group_report.html", context)

            context = {
                "income_head_records": income_head_records,
                "Finances_report": "active",
            }
            return render(request, "Reports/income_group_report.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def income_report(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    if request.method == "POST":
        from_date = request.POST.get("from_date")
        to_date = request.POST.get("to_date")

        income = AddIncome.objects.filter(date__range=[from_date, to_date],branch_id=branch_id)

        grand_total = income.aggregate(total_amount=models.Sum("amount")).get(
            "total_amount", 0
        )

        context = {
            "income": income,
            "from_date": from_date,
            "to_date": to_date,
            "grand_total": grand_total,
            "Finances_report": "active",
        }
        return render(request, "Reports/income_report.html", context)

    return render(request, "Reports/income_report.html")


# @login_required
# @user_type_required("Staff")
# def net_profit_loss_report(request):
#     if request.method == "POST":
#         from_date = request.POST.get("from_date")
#         to_date = request.POST.get("to_date")

#         income = AddIncome.objects.filter(date__range=[from_date, to_date])
#         net_result = calculate_net_gains_losses()

#         grand_total = income.aggregate(total_amount=models.Sum("amount")).get(
#             "total_amount", 0
#         )

#         context = {
#             "income": income,
#             "net_result": net_result,
#             "from_date": from_date,
#             "to_date": to_date,
#             "grand_total": grand_total,
#             "Finances_report": "active",
#             "Net_Gains_Losses_report": "active",
#         }
#         return render(request, "Reports/net_profit_loss.html", context)

#     return render(request, "Reports/net_profit_loss.html")

def net_profit_loss_report(request):
    if request.method == "POST":
        from_date = request.POST.get("from_date")
        to_date = request.POST.get("to_date")

        # Call the function with the date range
        income_total, expense_total, net_result = calculate_net_gains_losses(
            from_date=from_date, to_date=to_date
        )

        context = {
            "income_total": income_total,
            "expense_total": expense_total,
            "net_result": net_result,
            "from_date": from_date,
            "to_date": to_date,
        }
        return render(request, "Reports/net_profit_loss.html", context)

    return render(request, "Reports/net_profit_loss.html")


@login_required
@user_type_required("Staff")
def Report_payroll_report(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    if request.method == "POST":
        from_date = request.POST.get("from_date")
        to_date = request.POST.get("to_date")
        filters = {}
        if branch_id:
            filters["branch_id"] = branch_id
        if from_date and to_date:
            filters["payment_date__range"] = [from_date, to_date]
        records = PayrollSummary.objects.filter(**filters)

        grand_total_basic_salary = records.aggregate(
            total_amount=models.Sum("basic_salary")
        ).get("total_amount", 0)
        grand_total_net_salary = records.aggregate(
            total_amount=models.Sum("net_salary")
        ).get("total_amount", 0)
        grand_total_earning = records.aggregate(total_amount=models.Sum("earning")).get(
            "total_amount", 0
        )
        grand_total_deduction = records.aggregate(
            total_amount=models.Sum("deduction")
        ).get("total_amount", 0)
        grand_total_gross_salary = records.aggregate(
            total_amount=models.Sum("gross_salary")
        ).get("total_amount", 0)
        grand_total_Tax = records.aggregate(total_amount=models.Sum("Tax")).get(
            "total_amount", 0
        )

        context = {
            "records": records,
            "grand_total_basic_salary": grand_total_basic_salary,
            "grand_total_net_salary": grand_total_net_salary,
            "grand_total_earning": grand_total_earning,
            "grand_total_deduction": grand_total_deduction,
            "grand_total_gross_salary": grand_total_gross_salary,
            "grand_total_Tax": grand_total_Tax,
        }
        return render(request, "Reports/Report_payroll_report.html", context)
    context = {"Finances_report": "active"}
    return render(request, "Reports/Report_payroll_report.html", context)


@login_required
@user_type_required("Staff")
def sibling_report(request):
    if request.user.is_superuser or request.user.is_school_admin or "sibling_report_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            class_records = Class.objects.filter(branch=branch_id)
            section_records = Section.objects.filter(branch=branch_id)
            if request.method == "POST":
                classs = request.POST.get("class")
                section = request.POST.get("section")
                filters = {}
                if classs:
                    filters["Class_id"] = classs
                if section:
                    filters["section_id"] = section
                records = StudentAdmission.objects.filter(**filters)
                context = {
                    "student_details": "active",
                    "records": records,
                    "class_records": class_records,
                    "section_records": section_records,
                }
                return render(request, "Reports/sibling_report.html", context)
            context = {
                "student_information_report": "active",
                "class_records": class_records,
                "section_records": section_records,
            }
            return render(request, "Reports/sibling_report.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def student_gender_ratio_report(request):
    if request.user.is_superuser or request.user.is_school_admin or "student_report_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            # Retrieve the student admission data
            student_admissions = StudentAdmission.objects.filter(branch=branch_id)
            # Perform aggregation to calculate the counts of boys and girls per class/section
            gender_counts = student_admissions.values("Class", "section").annotate(
                total_boys=Count("id", filter=Q(gender="Male")),
                total_girls=Count("id", filter=Q(gender="Female")),
                total_students=Count("id"),
            )

            # Calculate the boys-girls ratio for each class/section
            print(gender_counts)

            # Calculate the grand total
            grand_total_boys = gender_counts.aggregate(Sum("total_boys"))[
                "total_boys__sum"
            ]
            grand_total_girls = gender_counts.aggregate(Sum("total_girls"))[
                "total_girls__sum"
            ]
            grand_total_students = gender_counts.aggregate(Sum("total_students"))[
                "total_students__sum"
            ]

            context = {
                "student_information_report": "active",
                "gender_counts": gender_counts,
                "grand_total_boys": grand_total_boys,
                "grand_total_girls": grand_total_girls,
                "grand_total_students": grand_total_students,
            }

            return render(request, "Reports/student_gender_ratio_report.html", context)

        except Exception as error:
            return render(request, "error.html", {"error": error})

    else:
        return render(request, "page_not_found.html")


@login_required
@user_type_required("Staff")
def student_teacher_ratio_report(request):
    if request.user.is_superuser or request.user.is_school_admin or "student_report_view" in request.permissions:
        try:
            # Retrieve the student admission data
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            student_admissions = StudentAdmission.objects.filter(branch=branch_id)

            # Perform aggregation to calculate the counts of students per class/section
            student_counts = student_admissions.values("Class", "section").annotate(
                total_students=Count("id")
            )

            # Retrieve the assigned teachers data
            assigned_teachers = AssignClassTeacher.objects.filter(branch=branch_id)

            # Perform aggregation to calculate the counts of assigned teachers per class/section
            teacher_counts = assigned_teachers.values("Class", "section").annotate(
                total_assigned_teachers=Count("class_teacher", distinct=True)
            )

            # Combine the student and teacher counts per class/section
            class_section_counts = {}
            grand_total = {"total_students": 0, "total_assigned_teachers": 0}

            for student_count in student_counts:
                class_key = (student_count["Class"], student_count["section"])
                class_section_counts[class_key] = {
                    "Class": student_count["Class"],
                    "section": student_count["section"],
                    "total_students": student_count["total_students"],
                    "total_assigned_teachers": 0,
                }
                grand_total["total_students"] += student_count["total_students"]

            for teacher_count in teacher_counts:
                class_key = (teacher_count["Class"], teacher_count["section"])
                if class_key in class_section_counts:
                    class_section_counts[class_key][
                        "total_assigned_teachers"
                    ] = teacher_count["total_assigned_teachers"]
                else:
                    class_section_counts[class_key] = {
                        "Class": teacher_count["Class"],
                        "section": teacher_count["section"],
                        "total_students": 0,
                        "total_assigned_teachers": teacher_count[
                            "total_assigned_teachers"
                        ],
                    }
                grand_total["total_assigned_teachers"] += teacher_count[
                    "total_assigned_teachers"
                ]

            # Calculate the student-teacher ratio for each class/section
            for count in class_section_counts.values():
                total_students = count["total_students"]
                total_assigned_teachers = count["total_assigned_teachers"]
                if total_assigned_teachers > 0:
                    count[
                        "student_teacher_ratio"
                    ] = f"{total_students}:{total_assigned_teachers}"
                else:
                    count["student_teacher_ratio"] = "N/A"

            # Calculate the grand total ratio
            grand_total_students = grand_total["total_students"]
            grand_total_assigned_teachers = grand_total["total_assigned_teachers"]
            if grand_total_assigned_teachers > 0:
                grand_total[
                    "student_teacher_ratio"
                ] = f"{grand_total_students}:{grand_total_assigned_teachers}"
            else:
                grand_total["student_teacher_ratio"] = "N/A"

            context = {
                "class_section_counts": class_section_counts,
                "grand_total": grand_total,
                "student_information_report": "active",
            }

            return render(request, "Reports/student_teacher_ratio_report.html", context)

        except Exception as error:
            return render(request, "error.html", {"error": error})

    else:
        return render(request, "page_not_found.html")


@login_required
@user_type_required("Staff")
def student_profile_report(request):
    if request.user.is_superuser or request.user.is_school_admin or "student_report_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            class_records = Class.objects.filter(branch=branch_id)
            if request.method == "POST":
                from_date = request.POST.get("from_date")
                to_date = request.POST.get("to_date")
                classs = request.POST.get("class")
                section = request.POST.get("section")

                filters = {}
                if from_date and to_date:
                    filters["admission_date__range"] = [from_date, to_date]

                elif classs:
                    filters["Class_id"] = classs

                elif section:
                    filters["section_id"] = section
                    
                elif branch_id:
                    filters["branch_id"] = branch_id    

                records = StudentAdmission.objects.filter(**filters)
                context = {
                    "records": records,
                    "class_records": class_records,
                }
                return render(request, "Reports/student_profile_report.html", context)

            context = {
                "class_records": class_records,
                "student_information_report": "active",
            }
            return render(request, "Reports/student_profile_report.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def send_email(request):
    if (request.user.is_superuser or request.user.is_school_admin or "email_view" in request.permissions):
            
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            form = SendEmailForm()
            forms = Role.objects.filter(branch=branch_id)
            classes = Class.objects.filter(branch=branch_id)
            sections = Section.objects.filter(branch=branch_id)
            email = SendEmail.objects.filter(branch=branch_id)
            emails = None  # Initialize classs variable
            roles_records = Role.objects.filter(branch=branch_id)

            if request.method == "POST":
                # Get the form data
                title = request.POST.get("title")
                message = request.POST.get("message")
                recipients = request.POST.getlist("noties_all[]")
                print("recipients00",recipients)
                attachments = request.FILES.getlist("attachment")
                class_id = request.POST.get("class_id")
                selected_sections = request.POST.getlist("sectionss")
                print("selected_sections", selected_sections)
                individual_send_by = request.POST.get("individual_send_by")

                # Print the values for debugging
                print("Class ID:", class_id)
                print("Selected Sections:", selected_sections)

                # selected_class = Class.objects.get(id=class_id)
                # Retrieve selected class and sections

                # classs = Class.objects.get(id=class_id)
                # Construct the email subject and message
                email_subject = "Title: {}".format(title)
                email_message = """
                Message: {}
                Regards,
                Yours bharathbrands
                """.format(
                    message
                )
                print("recipients00inside",recipients)
                # Check if there is any digit in the list
                if any(item.isdigit() for item in recipients):
                    # This part executes if there is at least one digit in the list
                    EmailSmsLog.objects.create(
                        Title=title,
                        send_by="Email",
                        sent_to="Group",
                        created_by=request.user,
                        branch_id=branch_id
                    )
                    
                    for i in recipients:
                        print("recipientsisdigitorstring", type(i),i)
                        if i.isdigit():
                            user_email = AddStaff.objects.filter(
                                roles=int(i)
                            ).values_list("email", flat=True)
                            print("staffmailthisplaceuser_email", user_email)
                            send_email_notification(
                                email_subject, email_message, user_email, attachments,
                            )
                        elif i == "student":
                            print("Studentinsidetahtpart")

                            # Retrieve student email addresses and add them to recipient_emails
                            emails = (
                                StudentAdmission.objects.exclude(email__isnull=True)
                                .exclude(email__exact="")
                                .values_list("email", flat=True)
                            )
                            send_email_notification(
                                email_subject, email_message, emails, attachments
                            )
                        elif i == "parent":
                            # Retrieve parent email addresses and add them to recipient_emails
                            email_tuples = (
                                StudentGuardianDetails.objects.exclude(
                                    guardian_email__isnull=True
                                )
                                .exclude(guardian_email__exact="")
                                .values_list("guardian_email", flat=True)
                            )
                            emails = list(email_tuples)  # Flatten the tuple into a list of strings
                            print("StudentGuardianDetails----", emails)
                            send_email_notification(
                                email_subject, email_message, emails, attachments
                            )
                else:
                    # This part executes if the list contains only strings (no digits)
                    for recipient in recipients:
                        EmailSmsLog.objects.create(
                            Title=title,
                            send_by="Email",
                            sent_to="Group",
                            created_by=request.user,
                            branch_id=branch_id
                        )
                        if recipient == "student":
                            # Retrieve student email addresses and add them to recipient_emails
                            emails = (
                                StudentAdmission.objects.exclude(email__isnull=True)
                                .exclude(email__exact="")
                                .values_list("email", flat=True)
                            )
                            send_email_notification(
                                email_subject, email_message, emails, attachments
                            )
                        elif recipient == "parent":
                            # Retrieve parent email addresses and add them to recipient_emails
                            email_tuples = (
                                StudentGuardianDetails.objects.exclude(
                                    guardian_email__isnull=True
                                )
                                .exclude(guardian_email__exact="")
                                .values_list("guardian_email", flat=True)
                            )
                            emails = list(email_tuples)  # Flatten the tuple into a list of strings
                            print("StudentGuardianDetails----", emails)
                            send_email_notification(
                                email_subject, email_message, emails, attachments
                            )
                        
                            print("Hellowwwwwwwwwwww")

                print("hiiiiiiiiiiiiiiiiiiiiiiiii")
                if class_id and selected_sections:
                    EmailSmsLog.objects.create(
                        Title=title,
                        send_by="Email",
                        sent_to="Class",
                        created_by=request.user,
                        branch_id=branch_id
                    )
                    emails = (
                        StudentAdmission.objects.filter(
                            Class=class_id, section__in=selected_sections
                        )
                        .exclude(email__isnull=True)
                        .exclude(email__exact="")
                        .values_list("email", flat=True)
                    )
                    send_email_notification(
                        email_subject, email_message, emails, attachments
                    )

                return redirect("/send_email")

            context = {
                "form": form,
                "forms": forms,
                "classes": classes,
                # 'classs':classs,
                "sections": sections,
                "email": email,
                "roles_records": roles_records,
                "send_email": "active"
                # 'selected_sections': selected_sections,
                # 'selected_class': selected_class
            }
            return render(request, "Communicate/send_email.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


# @login_required
# # @user_type_required("Staff")
# def indvidula_send_mail(request):
#     if request.user.is_superuser or request.user.is_school_admin or "email_view" in request.permissions:
#         try:
#             branch_name = request.session.get('branch_id', None)
#             if branch_name:
#                 branch_id = branch_name       
#             else:
#                 branch_id = None  
#                 print("branch_name@@@",branch_name)
#             print("indvidula_send_mail")
#             if request.method == "POST":
#                 title = request.POST.get("individual_title")
#                 message = request.POST.get("individual_message")
#                 attachments = request.FILES.getlist("individual_attachment")
#                 subject = "Title: {}".format(title)
#                 message = """
#                 Message: {}
#                 Regards,
#                 Yours bharathbrands
#                 """.format(
#                     message
#                 )
#                 mail_for = MailSearchTemp.objects.filter(branch=branch_id)
#                 emails = []
#                 print("emails0090-------------------",emails)
#                 for data in mail_for:
#                     if data.type == "Student":
#                         emails.append(data.Student.email)
#                     elif data.type == "Guardian":
#                         emails.append(data.Parent.guardian_email)
#                     elif data.type == "Staff":
#                         emails.append(data.Staff.email)
#                 print("emailsemailsemails",emails)
#                 send_email_notification1(subject, message, emails, attachments)

#                 return redirect("/indvidula_send_mail")
#             roles_records = Role.objects.filter(branch=branch_id)
#             MailSearchTemp.objects.filter(branch=branch_id).delete()
#             context = {"roles_records": roles_records, "send_email": "active"}
#             return render(request, "Communicate/indvidula_send_mail.html", context)
#         except Exception as error:
#             return render(request, "error.html", {"error": error})
#     else:
#         return redirect("dashboard")

@login_required
def indvidula_send_mail(request):
    if not (request.user.is_superuser or request.user.is_school_admin or "email_view" in request.permissions):
        return redirect("dashboard")

    branch_id = request.session.get('branch_id')

    if request.method == "POST":
        title = request.POST.get("individual_title")
        body = request.POST.get("individual_message")
        attachments = request.FILES.getlist("individual_attachment")

        recipients = MailSearchTemp.objects.filter(branch=branch_id)
        emails = []

        for r in recipients:
            if r.type == "Student" and r.Student and r.Student.email:
                emails.append(r.Student.email)
            elif r.type == "Guardian" and r.Parent and r.Parent.guardian_email:
                emails.append(r.Parent.guardian_email)
            elif r.type == "Staff" and r.Staff and r.Staff.email:
                emails.append(r.Staff.email)

        emails = list(set(emails))

        if not emails:
            messages.error(request, "No valid email recipients selected")
            return redirect("indvidula_send_mail")

        subject = f"Title: {title}"
        message = f"Message:\n{body}\n\nRegards,\nBharathbrands"

        send_email_notification1(subject, message, emails, attachments)

        MailSearchTemp.objects.filter(branch=branch_id).delete()
        messages.success(request, "Email sent successfully")
        return redirect("indvidula_send_mail")

    roles_records = Role.objects.filter(branch=branch_id)
    MailSearchTemp.objects.filter(branch=branch_id).delete()

    return render(request, "Communicate/indvidula_send_mail.html", {
        "roles_records": roles_records
    })

@login_required
@user_type_required("Staff")
def get_sections(request):
    class_id = request.GET.get("class_id")
    sections = Section.objects.filter(class__id=class_id)
    section_list = []

    for section_obj in sections:
        section_data = {"id": section_obj.id, "section_name": section_obj.section_name}
        section_list.append(section_data)

    return JsonResponse(section_list, safe=False)


@login_required
@user_type_required("Staff")
def syllabus_status_report(request):
    if request.user.is_superuser or request.user.is_school_admin or "lesson_plan_report_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            class_records = Class.objects.filter(branch=branch_id)
            if request.method == "POST":
                classs = request.POST.get("class")
                section = request.POST.get("section")
                subject_groups = request.POST.get("subject_group")
                subject = SubjectGroup.objects.filter(id=subject_groups,branch_id=branch_id).last()
                records = []
                chart_percent = []
                for sub in subject.subject.filter(branch=branch_id):
                    subj = {}
                    lesson_records = Lesson.objects.filter(
                        Class_id=classs, section_id=section, subject=sub.id,branch_id=branch_id
                    )
                    record = []
                    total = 0
                    percent = 1
                    for data in lesson_records:
                        dict = {}
                        topic_records = topic.objects.filter(lesson_name=data.id,branch_id=branch_id)
                        if topic_records.count() > 0:
                            percentage = int(
                                topic_records.filter(status="complete").count()
                                * 100
                                / topic_records.count()
                            )
                            percent *= percentage / 100
                            total += 1
                            dict["percentage"] = f"{percentage}% Complete"
                        else:
                            dict["percentage"] = "No Status"
                        dict["lesson"] = data
                        dict["topic"] = topic_records
                        record.append(dict)
                    if total > 0:
                        chart_percent.append([percent * 100, sub.subject_name])
                        subj["percentage"] = f"{percent*100}% Complete"
                    else:
                        chart_percent.append([0, sub.subject_name])
                        subj["percentage"] = "0% Complete"
                    subj["subject"] = sub
                    subj["record"] = record
                    records.append(subj)
                context = {
                    "lesson_paln_report": "active",
                    "class_records": class_records,
                    "records": records,
                    "chart_percent": chart_percent,
                }
                return render(request, "Reports/syllabus_status_report.html", context)
            context = {"lesson_paln_report": "active", "class_records": class_records}
            return render(request, "Reports/syllabus_status_report.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return render(request, "page_not_found.html", {"error": error})


@login_required
def student_report_finances_js(request):
    classs = request.GET.get("class_id")
    suction_id = request.GET.get("section_id")
    subject = StudentAdmission.objects.filter(
        Class_id=classs, section_id=suction_id, session=request.Session
    )
    return JsonResponse(data=list(subject.values("id", "first_name")), safe=False)


@login_required
@user_type_required("Staff")
def import_student(request):
    form = StudentAdmissionForm()
    records = StudentAdmission.objects.filter(branch=branch_id)
    endpoint = 'finance/user/'
    token = request.session['user_token']
    if request.method == "POST" and request.FILES["file"]:
        file = request.FILES["file"]
        df = pd.read_excel(file)
        count = 1
        for index, row in df.iterrows():
            count += 1
            print('count_import_student',count)
            admission_no_name = str(row["admission_no"]).strip() if not pd.isna(row["admission_no"]) else ""
            roll_number = str(row["roll_number"]).strip() if not pd.isna(row["roll_number"]) else ""
            first_name_1 = str(row["first_name"]).strip() if not pd.isna(row["first_name"]) else ""
            Classs = str(row["Class"]).strip() if not pd.isna(row["Class"]) else ""
            section_id = str(row["section"]).strip() if not pd.isna(row["section"]) else ""
            gender = str(row["gender"]).strip() if not pd.isna(row["gender"]) else ""
            mobile_number = str(row["mobile_number"]).strip() if not pd.isna(row["mobile_number"]) else ""
            date_of_birth = pd.to_datetime(row["date_of_birth"], errors='coerce') if pd.notna(row["date_of_birth"]) else None
            date_of_birth = date_of_birth.strftime('%Y-%m-%d') if pd.notna(date_of_birth) and not pd.isnull(date_of_birth) else None
            guardian_name_1 = row["father_name"]
            guardian_name_2 = row["mother_name"]
            guardian_email_1 = row["guardian_email"]
            guardian_occupation_father = row["father_occupation"]
            guardian_occupation_mother = row["mother_occupation"]
            guardian_relation = row["guardian_relation"]
            last_name_1 = row["last_name"]
            email_1 = row["email"]
            religion = row["religion"]
            Caste = row["Caste"] if pd.notna(row["Caste"]) else None
            if pd.notna(row["admission_date"]):
                if isinstance(row["admission_date"], str):
                    admission_date = row["admission_date"]  # Already a string
                else:
                    admission_date = row["admission_date"].strftime('%Y-%m-%d')
            else:
                admission_date = None
            Blood_group = row["Blood_group"]
            height = row["height"]
            weight = row["weight"]
            as_on_date = row["as_on_date"].strftime('%Y-%m-%d') if pd.notna(row["as_on_date"]) else None
            bank_account_number = row["bank_account_number"]
            bank_name = row["bank_name"]
            ifsc_code = row["ifsc_code"]
            national_identification_number = row["national_identification_number"]
            local_identification_number = row["local_identification_number"]
            previous_school_detail = row["previous_school_detail"]
            note = row["note"]
            title_1 = row["title_1"]
            title_2 = row["title_2"]
            title_3 = row["title_3"]
            title_4 = row["title_4"]
            status = row["status"]
            session = row["session"]
            branch_id = row["branch"]
            buyer_id = row["buyer_id"]
            category_1 = str(row["category"]).strip() if not pd.isna(row["category"]) else ""
            diable_reson = str(row["diable_reson"]).strip() if not pd.isna(row["diable_reson"]) else ""
            account = str(row["account"]).strip() if not pd.isna(row["account"]) else ""
            vehicle_number = str(row["vehicle_number"]).strip() if not pd.isna(row["vehicle_number"]) else ""
            route_list = str(row["route_list"]).strip() if not pd.isna(row["route_list"]) else ""
            hostel = str(row["hostel"]).strip() if not pd.isna(row["hostel"]) else ""    
            
            category_1 = None if category_1 == "" else category_1
            diable_reson = None if diable_reson == "" else diable_reson
            account = None if account == "" else account
            vehicle_number = None if vehicle_number == "" else vehicle_number
            route_list = None if route_list == "" else route_list
            hostel = None if hostel == "" else hostel   
          
            data = {
                "admission_no_name": admission_no_name,
                "roll_number": roll_number,
                "first_name_1": first_name_1,
                "Classs": Classs,
                "section_id": section_id,
                "gender": gender,
                "category_1": category_1,
                "mobile_number": mobile_number,
                "date_of_birth": date_of_birth,
                "hostel": hostel,
                "route_list": route_list,
                "guardian_name_1": guardian_name_1,
                "guardian_email_1": guardian_email_1,
                "vehicle_number": vehicle_number,
                "last_name_1": last_name_1,
                "email_1": email_1,
                "religion": religion,
                "Caste": Caste,
                "admission_date": admission_date,
                "Blood_group": Blood_group,
                "height": height,
                "weight": weight,
                "as_on_date": as_on_date,
                "bank_account_number": bank_account_number,
                "bank_name": bank_name,
                "ifsc_code": ifsc_code,
                "national_identification_number": national_identification_number,
                "local_identification_number": local_identification_number,
                "previous_school_detail": previous_school_detail,
                "note": note,
                "title_1": title_1,
                "title_2": title_2,
                "title_3": title_3,
                "title_4": title_4,
                "diable_reson": diable_reson,
                "status": status,
                "session": session,
                "account":account,
                "branch_id":branch_id,
                "buyer_id":buyer_id
            }

            # Print each variable name and its value
            for key, value in data.items():
                print(f"{key}: {value}")
            # date_time_str = datetime.strptime(date_of_birth,"%Y-%m-%d %H:%M:%S")
            # as_on_date_str = datetime.strptime(as_on_date,"%Y %m %d %H:%M:%S")
            # admission_date_str = datetime.strptime(admission_date,"%Y %m %d %H:%M:%S")
            if first_name_1:
                password_student = generate_password()
                password_parent = generate_password()
                last_name = last_name_1
                if not last_name:
                    last_name = ""

                # Create a user account for the student
                first_name_1 = str(first_name_1).strip() if isinstance(first_name_1, (str, float)) else ""
                last_name_1 = str(last_name_1).strip() if isinstance(last_name_1, (str, float)) else ""
                email_1 = str(email_1).strip() if isinstance(email_1, (str, float)) else ""
                
                username_student = f"student{records.count()}"
                print('username_student+++',username_student)
                user_student = User.objects.create_user(
                    username=username_student,
                    first_name=first_name_1,
                    last_name=last_name_1,
                    email=email_1,
                    password=password_student,
                    user_type="Student",
                    buyer_id=buyer_id
                )
                user_student.save()
                print("+++",user_student.first_name)
                # Create a user account for the parent
                username_parent = f"parent{records.count()}"
                print('username_parent+++',password_parent)
                guardian_name_1 = str(guardian_name_1).strip() if isinstance(guardian_name_1, (str, float)) else ""
                guardian_email_1 = str(guardian_email_1).strip() if isinstance(guardian_email_1, (str, float)) else ""
                # Create the user
                user_parent = User.objects.create_user(
                    username=username_parent,
                    first_name=guardian_name_1,
                    email=guardian_email_1,
                    password=password_parent,
                    user_type="Parent",
                    buyer_id=buyer_id
                )
                user_parent.save()
                print("user_paren_id---",user_parent.id)

                student_obj = StudentAdmission.objects.create(
                    session=request.Session,
                    user_student_id=user_student.pk,
                    user_parent_id=user_parent.pk,
                    created_by=request.user,
                    admission_no=admission_no_name,
                    roll_number=roll_number,
                    first_name=first_name_1,
                    Class_id=Classs,
                    section_id=section_id,
                    date_of_birth=date_of_birth,
                    gender=gender,
                    category_id=category_1,
                    mobile_number=mobile_number,
                    vehicle_number_id=vehicle_number,
                    route_list_id=route_list,
                    hostel_id=hostel ,
                    last_name=last_name_1,
                    email=email_1,
                    religion=religion,
                    Caste=Caste,
                    Blood_group=Blood_group,
                    height=height,
                    weight=weight,
                    bank_account_number=bank_account_number,
                    bank_name=bank_name,
                    ifsc_code=ifsc_code,
                    national_identification_number=national_identification_number,
                    local_identification_number=local_identification_number,
                    previous_school_detail=previous_school_detail,
                    note=note,
                    title_1=title_1,
                    title_2=title_2,
                    title_3=title_3,
                    title_4=title_4,
                    diable_reson_id=diable_reson ,
                    status=status,
                    as_on_date=as_on_date,
                    admission_date=admission_date,
                    session_id = session,
                    account = account,
                    branch_id = branch_id
                    
                )
                branch = Branch.objects.get(id=branch_id)
                data = {
                    'password': password_parent,
                    'first_name': guardian_name_1,
                    'middle_name': guardian_name_1,
                    'last_name': guardian_name_1,
                    'email': guardian_email_1,
                    'phone_number': mobile_number,
                    'company_name': branch.school.reference_id,  
                    'branch_name': branch.reference_id  
                }
                print("++++++++++++++++++")
                
                json_data = json.dumps(data)
                print("=========", json_data)

                response = call_post_method(BASE_URL, endpoint, json_data,token)
                print("response+++", response)
                if response.status_code != 200:
                    print('Response Status Code:', response.content)
                
                stduent_main_record = StudentMain.objects.create(
                    admission_no=student_obj.admission_no,
                    roll_number=student_obj.roll_number,
                    account=student_obj.account,
                    first_name=student_obj.first_name,
                    last_name=student_obj.last_name,
                    gender=student_obj.gender,
                    date_of_birth=student_obj.date_of_birth,
                    category=student_obj.category,
                    religion=student_obj.religion,
                    Caste=getattr(student_obj, 'Caste', None),
                    mobile_number=student_obj.mobile_number,
                    email=student_obj.email,
                    admission_date=student_obj.admission_date,
                    student_photo=student_obj.student_photo,
                    Blood_group=getattr(student_obj, 'Blood_group', None),
                    height=student_obj.height,
                    weight=student_obj.weight,
                    as_on_date=student_obj.as_on_date,
                    bank_account_number=student_obj.bank_account_number,
                    bank_name=student_obj.bank_name,
                    ifsc_code=student_obj.ifsc_code,
                    national_identification_number=student_obj.national_identification_number,
                    local_identification_number=student_obj.local_identification_number,
                    rte=student_obj.rte,
                    previous_school_detail=student_obj.previous_school_detail,
                    note=student_obj.note,
                    title_1=student_obj.title_1,
                    documents_1=student_obj.documents_1,
                    title_2=student_obj.title_2,
                    documents_2=student_obj.documents_2,
                    title_3=student_obj.title_3,
                    documents_3=student_obj.documents_3,
                    title_4=student_obj.title_4,
                    documents_4=student_obj.documents_4,
                    disable_date=student_obj.disable_date,
                    diable_reson=student_obj.diable_reson,
                    disable_note=student_obj.disable_note,
                    status=student_obj.status,
                    user_student=student_obj.user_student,
                    user_parent=student_obj.user_parent,
                    created_by=student_obj.created_by,
                    created_at=student_obj.created_at,
                    student_health=student_obj.student_health,
                    student_health_description=student_obj.student_health_description,
                    name_of_last_school=student_obj.name_of_last_school,
                    leaving_last_school_reason=student_obj.leaving_last_school_reason,
                    grade_completed=student_obj.grade_completed,
                    suspended_or_not=student_obj.suspended_or_not,
                    is_suspension_resolved=student_obj.is_suspension_resolved,
                    suspension_reason=student_obj.suspension_reason,
                    county=student_obj.county,
                    sub_county=student_obj.sub_county,
                    ward=student_obj.ward,
                    branch=student_obj.branch,
                    source=student_obj.source,
                    vehicle_number=student_obj.vehicle_number,
                    route_list=student_obj.route_list,
                    hostel=student_obj.hostel,
                )                
                print("stduent_main+++",stduent_main_record)                                        
                student_admission_update = StudentAdmission.objects.get(id = student_obj.pk)  
                print("student_admission+++",student_admission_update)                                       
                student_admission_update.student_main = stduent_main_record
                student_admission_update.save()
                print("request.Session+++",request.Session)
                LoginCredentials.objects.create(
                    student_id=student_obj.pk,
                    student_username=username_student,
                    student_password=password_student,
                    parent_username=guardian_email_1 or None ,
                    parent_passwod=password_parent,
                    branch_id = branch_id
                )
                guardain_master=GuardianMaster.objects.create(
                    guardian_name=guardian_relation,
                    branch_id = branch_id
                )
                if guardian_name_1:
                    StudentGuardianDetails.objects.create(
                        student = student_obj,
                        guardianmaster = guardain_master,
                        name = guardian_name_1,
                        phone = mobile_number,
                        occupation = guardian_occupation_father,
                        guardian_email = guardian_email_1,
                        branch_id = branch_id
                    )
                if guardian_name_2: 
                    StudentGuardianDetails.objects.create(
                        student = student_obj,
                        guardianmaster = guardain_master,
                        name = guardian_name_2,
                        phone = mobile_number,
                        occupation = guardian_occupation_mother,
                        guardian_email = guardian_email_1,
                        branch_id = branch_id
                    )

                StudentSession.objects.create(
                    session=request.Session,
                    student_id=student_obj.pk,
                    status="Active",
                    branch_id = branch_id
                )


                StudentClass.objects.create(
                    session=request.Session,
                    student_id=student_obj.pk,
                    Class_id=Classs,
                    section_id=section_id,
                    status="Active",
                    branch_id = branch_id
                )
                StudentVaultAmount.objects.create(
                    student=stduent_main_record,
                    total_amount=0,
                    paid_amount=0,
                    balance_amount=0,
                    session=request.Session,
                    created_by=request.user,
                    branch_id=branch_id
                )
                short_description=f"{stduent_main_record.admission_no} vault"
                vault=account_creation_finance(stduent_main_record.pk,short_description)
                print('vault',vault)
        return HttpResponseRedirect("/import_student")
    else:
        print(form.errors)
    context = {}
    return render(request, "Student_information/import_student.html", context)




@login_required
@user_type_required("Staff")
def import_staff(request):
    form = AddStaffForm()
    if request.method == "POST" and request.FILES["staff_add_file"]:
        file = request.FILES["staff_add_file"]
        print("file+++",file)
        df = pd.read_excel(file)
        count = 1
        for index, row in df.iterrows():
            count += 1
            print('count_import_staff',count)
            user_name = row["user"]
            print("user_name---",user_name)
            basic_salary = row["basic_salary"]
            contract_type = row["contract_type"]
            work_shift = row["work_shift"]
            location = row["location"]
            instagram = row["instagram"]
            linkedin = row["linkedin"]
            twitter = row["twitter"]
            facebook = row["facebook"]
            bank_name = row["bank_name"]
            branch_name = row["branch_name"]
            ifsc_code = row["ifsc_code"]
            account_no = row["account_no"]
            bank_title = row["bank_title"]
            staff_id = row["staff_id"]
            first_name = row["first_name"]
            last_name = row["last_name"]
            father_name = row["father_name"]
            mother_name = row["mother_name"]
            gender = row["gender"]
            date_of_birth = row["date_of_birth"]
            date_of_joining = row["date_of_joining"]
            emergency_contact = row["emergency_contact"]
            marital_status = row["marital_status"]
            current_address = row["current_address"]
            permanent_address = row["permanent_address"]
            qualification = row["qualification"]
            work_experience = row["work_experience"]
            note = row["note"]
            status = row["status"]
            for key, value in row.items():
                print(f"{key}: {value}")    
            
            first_name_str = str(first_name) if isinstance(first_name, (str, float, int)) else ""
            last_name_str = str(last_name) if isinstance(last_name, (str, float, int)) else ""

            # Remove non-alphabet characters and convert to lowercase
            first_name_clean = re.sub(r'[^a-zA-Z]', '', first_name_str).lower()
            last_name_clean = re.sub(r'[^a-zA-Z]', '', last_name_str).lower()
                    
            phone_no_num = row["phone_no"]
            if not pd.isna(phone_no_num):
                phone_no_num = str(phone_no_num).strip()
                phone_no_num = int(float(phone_no_num)) if phone_no_num.replace('.', '', 1).isdigit() else None
            else:
                phone_no_num = None

            # Handle phone_no
            phone_no = row["phone_no"]
            if not pd.isna(phone_no):
                phone_no = str(phone_no).strip()
                phone_no = int(float(phone_no)) if phone_no.replace('.', '', 1).isdigit() else None
            else:
                phone_no = None
            
            roles = str(row["roles"]).strip() if not pd.isna(row["roles"]) else ""
            designation = str(row["designation"]).strip() if pd.notna(row["designation"]) else ""
            department = str(row["department"]).strip() if pd.notna(row["department"]) else ""
            branch = str(row["branch"]).strip() if not pd.isna(row["branch"]) else ""
            school = str(row["school"]).strip() if not pd.isna(row["school"]) else ""

            # Convert empty strings to None
            roles = None if roles == "" else roles
            designation = None if not designation else designation
            department = None if not department else department
            branch = None if branch == "" else branch
            school = None if school == "" else school
            
            dob1 = pd.to_datetime(date_of_birth, format="%d-%m-%Y", errors='coerce')
            doj = pd.to_datetime(date_of_joining, format="%d-%m-%Y", errors='coerce')
            dob1 = dob1.to_pydatetime().date() if not pd.isna(dob1) else None
            doj = doj.to_pydatetime().date() if not pd.isna(doj) else None

            password_staff = generate_password()
            user = User.objects.create(
                username=user_name,
                email = f"{first_name_clean}.{last_name_clean}@gmail.com" if first_name_clean and last_name_clean else "unknown@gmail.com",
                first_name=first_name,
                last_name=last_name,
                dob=dob1,
                phone_number=phone_no,
                user_type="Staff",
            )
            user.set_password(password_staff)  # Hash the password
            user.save()

            # dob1 = datetime.strptime(formatted_date,"%Y-%m-%d %H:%M:%S")

            AddStaff.objects.create(
                user_id=user.pk,
                phone_no=phone_no_num,
                basic_salary=basic_salary,
                contract_type=contract_type,
                work_shift=work_shift,
                location=location,
                bank_title=bank_title,
                account_no=account_no,
                ifsc_code=ifsc_code,
                branch_name=branch_name,
                bank_name=bank_name,
                facebook=facebook, 
                twitter=twitter,
                linkedin=linkedin,
                instagram=instagram,
                staff_id=staff_id,
                roles_id=roles,
                designation_id=designation,
                department_id=department,
                first_name=first_name,
                last_name=last_name,
                father_name=father_name,
                mother_name=mother_name,
                email = f"{first_name_clean}.{last_name_clean}@gmail.com" if first_name_clean and last_name_clean else "unknown@gmail.com",
                gender=gender,
                date_of_birth=dob1,
                date_of_joining=doj,
                emergency_contact=emergency_contact,
                marital_status=marital_status,
                current_address=current_address,
                permanent_address=permanent_address,
                qualification=qualification,
                work_experience=work_experience,
                note=note,
                status=status,
                branch_id = branch,
                school_id = school,
            )
        return HttpResponseRedirect("/import_staff")
    else:
        print(form.errors)
    context = {"add_staff": "active"}
    return render(request, "Human_Resource/import_staff.html", context)




@login_required
@user_type_required("Staff")
def student_login_credentials(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    class_records = Class.objects.filter(branch=branch_id)
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)

    if request.method == "POST":
        classs = request.POST.get("class")
        section = request.POST.get("section")
        filters = {}
        if classs:
            filters["Class_id"] = classs
        if section:
            filters["section_id"] = section
        if branch_id:
            filters["branch_id"] = branch_id    

        record = StudentAdmission.objects.filter(**filters).values("id")
        print('record+++',record)
        records = LoginCredentials.objects.filter(student__id__in=record)
        print('records+++',records)

        context = {
            "student_information_report": "active",
            "records": records,
            "class_records": class_records,
        }
        return render(request, "Reports/student_login_credentials.html", context)

    context = {
        "student_information_report": "active",
        "class_records": class_records,
    }

    return render(request, "Reports/student_login_credentials.html", context)


@login_required
@user_type_required("Staff")
def subject_lesson_paln_report(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    class_records = Class.objects.filter(branch=branch_id)
    if request.method == "POST":
        classs = request.POST.get("class")
        suction = request.POST.get("section")
        subject_grp = request.POST.get("subject_group")
        subject = request.POST.get("subject")
        subjects_name = Subjects.objects.get(id=subject,branch_id=branch_id)
        Lesson_plan = LessonPlan.objects.filter(
            time_table__Class=classs,
            time_table__section=suction,
            time_table__subject_group=subject_grp,
            time_table__subject=subject,
            branch_id=branch_id
        )

        lesson_records = Lesson.objects.filter(
            Class_id=classs, section_id=suction, subject=subject,branch_id=branch_id
        )
        total = 0
        percent = 1
        for data in lesson_records:
            topic_records = topic.objects.filter(lesson_name=data.id)
            if topic_records.count() > 0:
                percentage = int(
                    topic_records.filter(status="complete").count()
                    * 100
                    / topic_records.count()
                )
                percent *= percentage / 100
                total += 1
        if total > 0:
            percentage = f"{subjects_name.subject_name} Complete {percent*100}%"
        context = {
            "class_records": class_records,
            "Lesson_plan": Lesson_plan,
            "lesson_paln_report": "active",
            "percentage": percentage,
        }
        return render(request, "Reports/subject_lesson_paln_report.html", context)
    context = {"class_records": class_records, "lesson_paln_report": "active"}
    return render(request, "Reports/subject_lesson_paln_report.html", context)


@login_required
@user_type_required("Staff")
def generate_student_certificate(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "generate_certificate_view" in request.permissions
        or "generate_certificate_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            student_certificate_records = StudentCertificate.objects.filter(branch=branch_id)
            class_records = Class.objects.filter(branch=branch_id)
            if request.method == "POST":
                classs = request.POST.get("class")
                section = request.POST.get("section")
                certificate_name = request.POST.get("certificate_name")
                records = StudentAdmission.objects.filter(
                    Class=classs,
                    section=section,
                    session=request.Session,
                    branch_id=branch_id
                )
                context = {
                    "generate_student_certificate": "active",
                    "student_certificate_records": student_certificate_records,
                    "class_records": class_records,
                    "classs": int(classs),
                    "section": int(section),
                    "certificate_name": int(certificate_name),
                    "records": records,
                }
                return render(
                    request, "Certificate/generate_student_certificate.html", context
                )
            context = {
                "generate_student_certificate": "active",
                "student_certificate_records": student_certificate_records,
                "class_records": class_records,
            }
            return render(
                request, "Certificate/generate_student_certificate.html", context
            )
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def printing_student_certificate(request):
    cretificate_obj = StudentCertificate.objects.get(
        id=request.POST.get("certificate_name")
    )
    records = StudentAdmission.objects.filter(id__in=request.POST.getlist("checkbox"))
    print("recordss---------------",records)
    body_text = []
    string = cretificate_obj.body_text
    for data in records:
        new_string = string

        new_string = (
            new_string.replace("[name]", data.first_name)
            if data.first_name
            else new_string.replace("[name]", "")
        )
        new_string = (
            new_string.replace("[admission_no]", data.admission_no)
            if data.admission_no
            else new_string.replace("[admission_no]", "")
        )
        new_string = (
            new_string.replace("[dob]", str(data.date_of_birth))
            if data.date_of_birth
            else new_string.replace("[dob]", "")
        )

        new_string = (
            new_string.replace("[created_at]", str(data.created_at.date()))
            if data.created_at.date()
            else new_string.replace("[created_at]", "")
        )
        new_string = (
            new_string.replace("[roll_no]", data.roll_number)
            if data.roll_number
            else new_string.replace("[roll_no]", "")
        )
        new_string = (
            new_string.replace("[class]", data.Class.Class)
            if data.Class
            else new_string.replace("[class]", "")
        )
        new_string = (
            new_string.replace("[section]", data.section.section_name)
            if data.section
            else new_string.replace("[section]", "")
        )
        new_string = (
            new_string.replace("[gender]", data.gender)
            if data.gender
            else new_string.replace("[gender]", "")
        )
        new_string = (
            new_string.replace("[admission_date]", str(data.as_on_date))
            if data.as_on_date
            else new_string.replace("[admission_date]", "")
        )
        new_string = (
            new_string.replace("[category]", data.category.category)
            if data.category
            else new_string.replace("[category]", "")
        )
        new_string = (
            new_string.replace("[email]", data.email)
            if data.email
            else new_string.replace("[email]", "")
        )
        new_string = (
            new_string.replace("[phone]", data.mobile_number)
            if data.mobile_number
            else new_string.replace("[phone]", "")
        )

        new_string = (
            new_string.replace("[cast]", data.Caste)
            if data.Caste
            else new_string.replace("[cast]", "")
        )

        if data.religion:
            new_string = new_string.replace("[religion]", data.religion)
        else:
            new_string = new_string.replace("[religion]", "")
        body_text.append(new_string)

    context = {
        "generate_student_certificate": "active",
        "data": cretificate_obj,
        "body_text": body_text,
    }
    return render(request, "Certificate/printing_student_certificate.html", context)


@login_required
@user_type_required("Staff")  # To change Password
def change_password(request):
    if request.method == "POST":
        form = PasswordChangeForm(request.user, request.POST)
        if form.is_valid():
            user = form.save()
            update_session_auth_hash(
                request, user
            )  # Update the session with the new password
            messages.success(request, "Password changed successfully.")
            return redirect(reverse("/"))  # Redirect to the dashboard page
    else:
        form = PasswordChangeForm(request.user)
    print(form.errors)  # Debug statement
    return render(request, "change_password.html", {"form": form})


@login_required
@user_type_required("Staff")
def profile(request):
    record = AddStaff.objects.get(user=request.user)
    context = {"record": record}
    return render(request, "System_setting/profile.html", context)


def send_mail_search_js(request):
    value = request.GET.get("selected_val")
    print("selected_valvalue",value)
    if value == "Students":
        records = StudentAdmission.objects.filter(session=request.Session)
        data = list(records.values("first_name", "admission_no", "id"))
    elif value == "Guardians":
        records = StudentGuardianDetails.objects.filter(branch=branch_id)
        data = list(records.values("name", "id"))
    else:
        staff = AddStaff.objects.filter(roles=value)
        data = list(staff.values("first_name", "id"))
    return JsonResponse(data, safe=False)


@login_required
def mail_search_save_js(request):
    id = request.GET.get("id")
    print("mail_search_save_jsid",id)
    type = request.GET.get("type")
    print("mail_search_save_jstype",type)
    if type == "Staff":
        MailSearchTemp.objects.get_or_create(
            Staff_id=id,
            type=type,
        )
    elif type == "Guardian":
        MailSearchTemp.objects.get_or_create(
            Parent_id=id,
            type=type,
        )
    else:
        MailSearchTemp.objects.get_or_create(
            Student_id=id,
            type=type,
        )
    data = list(
        MailSearchTemp.objects.values(
            "id",
            "Staff__first_name",
            "Student__first_name",
            "Parent__name",
            "type",
        )
    )
    print("datatatta",data)
    return JsonResponse(data, safe=False)


@login_required
def mail_search_delete_js(request):
    id = request.GET.get("id")
    MailSearchTemp.objects.get(id=id).delete()
    data = list(
        MailSearchTemp.objects.values(
            "id",
            "Staff__first_name",
            "Student__first_name",
            "Parent__name",
            "type",
        )
    )
    return JsonResponse(data, safe=False)


@login_required
@user_type_required("Staff")

# def online_class(request):
#     # if (
#     #     request.user.is_superuser or request.user.is_school_admin
#     #     or "online_live_class_view" in request.permissions
#     #     or "online_live_class_add" in request.permissions
#     # ):
#     #     try:
#             branch_name = request.session.get('branch_id', None)
#             if branch_name:
#                 branch_id = branch_name       
#             else:
#                 branch_id = None  
#                 print("branch_name@@@",branch_name)
            
#             records = OnlineClass.objects.filter(branch=branch_id)
#             meeting_links = MeetingLinkMaster.objects.filter(branch=branch_id)

#             if request.method == "POST":
#                 form = OnlineClassForm(request.POST)
#                 print("form===if")
#                 meeting_link_id = request.POparent_meetingST.get('meeting_link')
#                 print('meeting_link_id---',meeting_link_id)
#                 if meeting_link_id == 'new':
#                     # If "New" is selected, get the input from the user
#                     meeting_url = request.POST.get('meeting_url')
#                     print('meeting_url---',meeting_url)
#                 else:
#                     # Otherwise, get the selected link from MeetingLinkMaster
#                     meeting_link = MeetingLinkMaster.objects.get(id=meeting_link_id)
#                     meeting_url = meeting_link.link
#                 if form.is_valid():
#                     print("form===if_is_valid")
#                     # Save the form with the updated meeting_url
#                     obj = form.save()
#                     obj.created_by = request.user
#                     obj.meeting_url = meeting_url
#                     obj.branch_id = branch_id
#                     obj.save()

#                     messages.success(request, "Record Saved Successfully")
#                     return redirect("/online_class")  
#                 else:                    
#                     print("error+=+",form.errors)
#             else:
#                 form =  OnlineClassForm()
#                 print("error",form.errors)
              

#             context = {"records": records,
#                        "form": form,
#                        "online_class": "active",
#                        "meeting_links": meeting_links
#                        }
#             return render(request, "Livesession/online_class.html", context)
    #     except Exception as error:
    #         return render(request, "error.html", {"error": error})
    # else:
    #     return render(request, "page_not_found.html")

def online_class(request):
    branch_name = request.session.get('branch_id')
    branch_id = branch_name if branch_name else None

    records = OnlineClass.objects.filter(branch=branch_id)
    meeting_links = MeetingLinkMaster.objects.filter(branch=branch_id)

    if request.method == "POST":
        form = OnlineClassForm(request.POST, request.FILES)

        meeting_link_id = request.POST.get('meeting_link')

        if meeting_link_id == 'new':
            meeting_url = request.POST.get('meeting_url')
        else:
            meeting_link = MeetingLinkMaster.objects.get(id=meeting_link_id)
            meeting_url = meeting_link.link

        if form.is_valid():
            obj = form.save(commit=False)
            obj.created_by = request.user
            obj.meeting_url = meeting_url
            obj.branch_id = branch_id
            obj.save()

            messages.success(request, "Record Saved Successfully")
            return redirect("/online_class")
        else:
            print("Form Errors:", form.errors)

    else:
        form = OnlineClassForm()

    context = {
        "records": records,
        "form": form,
        "online_class": "active",
        "meeting_links": meeting_links
    }

    return render(request, "Livesession/online_class.html", context)

@login_required
@user_type_required("Staff")
def online_class_edit(request, pk):
    # if (
    #     request.user.is_superuser or request.user.is_school_admin
    #     or "online_live_class_edit" in request.permissions
    #     or "online_live_class_view" in request.permissions
    # ):
    #     try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name
                print("branch_name@@@if", branch_id)
            else:
                branch_id = None  
                print("branch_name@@@else", branch_id)

            # Fetch the specific OnlineClass instance
            try:
                online_class = OnlineClass.objects.get(id=pk)
                data_branch_id = online_class.branch.id  # Only access this if online_class exists
            except OnlineClass.DoesNotExist:
                online_class = None
                data_branch_id = None
                print("OnlineClass instance not found")

            print("from_school_id---", data_branch_id)

            records = OnlineClass.objects.filter(branch=branch_id)
            online_classs = OnlineClass.objects.filter(branch=branch_id)

            if request.method == "POST":
                # Populate the form with the instance data
                form = OnlineClassForm(request.POST, instance=online_class)
                print("form===", form)            
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.instance.branch_id = branch_id
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                        form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/online_class")
                else:
                    print("Form is not valid")
            else:
                # If it's a GET request, create the form with instance data
                form = OnlineClassForm(instance=online_class)

            context = {
                "form": form,
                "online_classs": online_classs,
                "records": records,
                "online_class": "active",
                "edit": True,
                "meeting_links": MeetingLinkMaster.objects.filter(branch=branch_id)  # Pass meeting links to the template
            }
            return render(request, "Livesession/online_class_edit.html", context)
    #     except Exception as error:
    #         return render(request, "error.html", {"error": error})
    # else:
    #     return render(request, "page_not_found.html")

def finish_class(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "online_live_class_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            online_class = OnlineClass.objects.get(id=pk)
            online_class.status = "Finished"
            online_class.branch_id=branch_id
            online_class.save()
            messages.success(request, "Status updated to Finished")
            return HttpResponseRedirect("/online_class")
        except OnlineClass.DoesNotExist:
            messages.error(request, "Online class does not exist")
    else:
        messages.error(request, "You do not have permission to update class status")
    
    return HttpResponseRedirect("/online_class")


@login_required
@user_type_required("Staff")
def online_class_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "online_live_class_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            online_class = OnlineClass.objects.get(id=pk)
            data_branch_id = online_class.branch.id 
            if int(data_branch_id) == int(branch_id):                        
                OnlineClass.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/online_class")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return render(request, "page_not_found.html")


@login_required
@user_type_required("Staff")
def staff_meeting(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "staff_meeting_view" in request.permissions
        or "staff_meeting_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None 
            print("branch_id@@@",branch_id)
            addstaff = AddStaff.objects.filter(branch=branch_id)
            records = StaffMeeting.objects.filter(branch=branch_id)
            if request.method == "POST":
                form = StaffMeetingForm(request.POST)
                if form.is_valid():
                    form.save()
                    obj = form.save(commit=False)
                    obj.created_by = request.user
                    obj.branch_id = branch_id
                    obj.save()
                    messages.success(request, "Record Saved Successfully")
                    return redirect(
                        "/staff_meeting"
                    )  # Redirect to a view showing the list of all online classes
            else:
                form = StaffMeetingForm()
                print(form.errors)
            context = {
                "records": records,
                "form": form,
                "staff_meeting": "active",
                "addstaff": addstaff,
            }

            return render(request, "Livesession/staff_meeting.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return render(request, "page_not_found.html")


@login_required
@user_type_required("Staff")
def staff_meeting_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "staff_meeting_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None    
            addstaff = AddStaff.objects.filter(branch=branch_id)
            records = StaffMeeting.objects.filter(branch=branch_id)
            staff_meetings = StaffMeeting.objects.filter(branch=branch_id)
            data = StaffMeeting.objects.get(id=pk)
            data_branch_id = data.branch.id 
            print('data',data_branch_id)
            form = StaffMeetingForm(instance=data)
            if request.method == "POST":
                form = StaffMeetingForm(request.POST, instance=data)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        # Save the form with from_branch_id
                        form.instance.branch_id = branch_id
                        form.save()
                    else:
                        # Save the form with the session value
                        form.instance.branch_id= branch_id
                    form.save()
                    obj = form.save(commit=False)                  
                    obj.branch_id = branch_id
                    obj.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/staff_meeting")
            context = {
                "form": form,
                "staff_meetings": staff_meetings,
                "staff_meeting": "active",
                "edit": True,
                "addstaff": addstaff,
                "data": data,
                "records": records,
            }
            return render(request, "Livesession/staff_meeting_edit.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return render(request, "page_not_found.html")


@login_required
@user_type_required("Staff")
def staff_meeting_delete(request, pk):
    # if request.user.is_superuser or request.user.is_school_admin or 'staff_meeting_delete' in request.permissions:
    try:
        branch_name = request.session.get('branch_id', None)
        if branch_name:
            branch_id = branch_name       
        else:
            branch_id = None  
        staff_meeting = StaffMeeting.objects.get(id=pk)
        school_delete = staff_meeting.branch.id   
        print('fff',school_delete)
        if int(school_delete) == int(branch_id):                        
            StaffMeeting.objects.get(id=pk).delete()
        else:
            messages.error(request, "School id Doesn't match record no delete")
        messages.error(request, "Record Deleted Successfully")
        return HttpResponseRedirect("/staff_meeting")
    except Exception as error:
        return render(request, "error.html", {"error": error})


@login_required
@user_type_required("Staff")
def parent_meeting(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "parent_meeting_view" in request.permissions
        or "parent_meeting_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name 
            else:
                branch_id = None   
            print("school_name@@@",branch_id)
            section_record = Section.objects.filter(branch=branch_id)
            class_record = Class.objects.filter(branch=branch_id)
            addstaff = AddStaff.objects.filter(branch=branch_id)
            addstudent = StudentAdmission.objects.filter(branch=branch_id)
            records = ParentMeeting.objects.filter(branch=branch_id)
            form1 = StudentAdmissionForm()

            if request.method == "POST":
                form = ParentMeetingForm(request.POST)
                if form.is_valid():
                    form.save()

                    obj = form.save(commit=False)
                    obj.created_by = request.user
                    obj.branch_id = branch_id
                    obj.save()
                    messages.success(request, "Record Saved Successfully")
                    return redirect("/parent_meeting")
            else:
                form = ParentMeetingForm()
                print(form.errors)
            context = {
                "records": records,
                "form": form,
                "form1": form1,
                "parent_meeting": "active",
                "addstaff": addstaff,
                "section_record": section_record,
                "addstudent": addstudent,
                "class_record": class_record,
            }

            return render(request, "Livesession/parent_meeting.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return render(request, "page_not_found.html")


@login_required
@user_type_required("Staff")
def parent_meeting_edit(request, pk):
    # if request.user.is_superuser or request.user.is_school_admin or "parent_meeting_edit" in request.permissions:
    #     try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
            print("school_name@@@",branch_name)
            records = ParentMeeting.objects.filter(branch=branch_id)
            section_record = Section.objects.filter(branch=branch_id)
            class_record = Class.objects.filter(branch=branch_id)
            addstaff = AddStaff.objects.filter(branch=branch_id)
            addstudent = StudentAdmission.objects.filter(branch=branch_id)
            parent_meeting = ParentMeeting.objects.filter(branch=branch_id)
            data = ParentMeeting.objects.get(id=pk)
            data_branch_id = data.branch.id
            print("data_school_id,,,",data_branch_id)
            form = ParentMeetingForm(instance=data)
            form1 = StudentAdmissionForm(instance=data)

            if request.method == "POST":
                form = ParentMeetingForm(request.POST, instance=data)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        # Save the form with from_school_id
                        form.instance.branch_id = branch_id
                        form.save()
                    else:
                        # Save the form with the session value
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/parent_meeting")
            context = {
                "form": form,
                "parent_meeting": parent_meeting,
                "parent_meeting": "active",
                "addstaff": addstaff,
                "data": data,
                "section_record": section_record,
                "class_record": class_record,
                "addstudent": addstudent,
                "form1": form1,
                "edit": True,
                "records": records,
            }
            return render(request, "Livesession/parent_meeting_edit.html", context)
    #     except Exception as error:
    #         return render(request, "error.html", {"error": error})
    # else:
    #     return render(request, "page_not_found.html")


@login_required
@user_type_required("Staff")
def parent_meeting_delete(request, pk):
    # if request.user.is_superuser or request.user.is_school_admin or 'parent_meeting_delete' in request.permissions:
    try:
        branch_name = request.session.get('branch_id', None)
        if branch_name:
            branch_id = branch_name       
        else:
            branch_id = None
        parent_meeting = ParentMeeting.objects.get(id=pk)
        parent_branch_id = parent_meeting.branch.id
        if int(parent_branch_id) == int(branch_id):                        
            ParentMeeting.objects.get(id=pk).delete()
        else:
            messages.error(request, "School id Doesn't match record no delete")
        messages.error(request, "Record Deleted Successfully")
        return HttpResponseRedirect("/parent_meeting")
    except Exception as error:
        return render(request, "error.html", {"error": error})


@login_required
@user_type_required("Staff")
def staff_meetimg_backup(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    records = StaffMeetingNote.objects.filter(branch=branch_id)
    form = StaffMeetingNoteForm()
    record = StaffMeeting.objects.get(id=pk)
    data_branch_id = record.branch.id
    if request.method == "POST":
        form = StaffMeetingNoteForm(request.POST)
        if form.is_valid():
            if branch_id == data_branch_id:
                form.save()
            else:
                form.instance.branch_id = branch_id
            form.save()
            messages.success(request, "Record Saved Successfully")
            return HttpResponseRedirect("/staff_meeting")

    context = {
        "form": form,
        "records": records,
        "staff_meeting": "active",
        "record": record,
    }
    return render(request, "Livesession/staff_meetimg_backup.html", context)


@login_required
@user_type_required("Staff")
def staff_meeting_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "staff_meeting_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = StaffMeetingNote.objects.filter(branch=branch_id)
            form = StaffMeetingNoteForm()
            record = StaffMeeting.objects.get(id=pk)

            context = {
                "form": form,
                "records": records,
                "staff_meeting": "active",
                "record": record,
            }
            return render(request, "Livesession/staff_meeting_view.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return render(request, "page_not_found.html")


@login_required
@user_type_required("Staff")
def student_details_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "student_information_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            guardian_master = GuardianMaster.objects.filter(branch=branch_id)
            system_field = SystemFields.objects.last() 
            
            if system_field:
                system_fields=system_field.student_fields
            else:
                system_fields=None    
            
            custom_fields = CustomFields.objects.filter(field_belongs_to="Student")
            student_custom = StudentCustomFieldValues.objects.filter(student=pk)
            custom_fileds_records = []
            for data in custom_fields:
                dict = {}
                dict["custom_fields"] = data
                dict["student_custom"] = student_custom.filter(field=data.id).last()
                custom_fileds_records.append(dict)
            print(custom_fileds_records)
            records = StudentAdmission.objects.filter(branch=branch_id)
            online_class = StudentAdmission.objects.get(id=pk)
            print('online_class',online_class)
            guardian = StudentGuardianDetails.objects.filter(
                student=online_class
            )
            print('guardian',guardian)

            form = StudentAdmissionForm(instance=online_class)
            if request.method == "POST":
                guradian_list = request.POST.getlist("guardian_id")
                guardian_exclude = StudentGuardianDetails.objects.filter(student=online_class).exclude(id__in = guradian_list)
                guardian_exclude.delete()
                print('guradian_list',guradian_list)
                for data in guradian_list:
                    print('data',data)
                    name = request.POST.get(f"name{data}")
                    print('name',name)
                    phone = request.POST.get(f"phone{data}")
                    guardianmasters = request.POST.get(f"guardianmaster_id{data}")
                    occupation = request.POST.get(f"occupation{data}")
                    guardain_email = request.POST.get(f"guardian_email{data}")
                   
                    edit =  StudentGuardianDetails.objects.filter(id=data).last()
                    print('edit',edit)
                    if edit:                        
                        edit.guardianmaster_id = int(guardianmasters)
                        edit.name = name
                        edit.phone = phone
                        edit.occupation = occupation
                        edit.guardian_email = guardain_email
                        edit.save()
                        
                guardianmaster_edit=request.POST.getlist("guardianmaster_edit_id")
                print('guardianmaster_edit',guardianmaster_edit)
                names_edit=request.POST.getlist("name_edit")
                phone_edit=request.POST.getlist("phone_edit")
                eamil_edit=request.POST.getlist("guardian_email_edit")
                occupation_edit=request.POST.getlist("occupation_edit")
                print('names_gureadian',type(guardianmaster_edit),names_edit)
                for i in range(len(names_edit)):

                    print('names_list',i)
                    print('guardianmaster_id[i]',list(guardianmaster_edit)[i])
                    print('names_list[i]',phone_edit[i])
                    print('phone_list[i]',eamil_edit[i])
                    print('occupation_list[i]',occupation_edit[i])
                    if guardianmaster_edit[i] !='':
                        StudentGuardianDetails.objects.create(
                            student_id=online_class.id,
                            guardianmaster_id=int(guardianmaster_edit[i]),
                            name=names_edit[i],
                            phone=phone_edit[i],
                            guardian_email=eamil_edit[i],
                            occupation=occupation_edit[i],
                        )   
                        
                print('student_list',guradian_list)
                form = StudentAdmissionForm(request.POST, instance=online_class)
                student_healths=request.POST.get("student_health")
                print('student_healths',student_healths)
                suspended_or_nots= request.POST.get("suspended_or_not")
                print('suspended_or_nots',suspended_or_nots)
                is_suspension_resolveds= request.POST.get("is_suspension_resolved")
                print('is_suspension_resolveds',is_suspension_resolveds)
                if form.is_valid():                    
                    obj = form.save(commit=False)
                    obj.student_health = student_healths
                    obj.suspended_or_not = suspended_or_nots
                    obj.is_suspension_resolved = is_suspension_resolveds
                    obj.branch_id = branch_id
                    obj.save()

                    #  customs fields
                    for data in custom_fields:
                        if data.field_type == "multiselect":
                            value = request.POST.getlist(f"{data.field_name}")
                        else:
                            value = request.POST.get(f"{data.field_name}")
                        if value:
                            edit = student_custom.filter(field=data.id).last()
                            if edit:
                                edit.value = value
                                edit.save()
                            else:
                                StudentCustomFieldValues.objects.create(
                                    field=data, student_id=pk, value=value
                                )                              
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/student_details")

            else:
                print(form.errors)
            context = {
                "form": form,
                "records": records,
                "student_details": "active",
                "edit": True,
                "custom_fields": custom_fields,
                "student_custom": student_custom,
                "custom_fileds_records": custom_fileds_records,
                "system_fields": system_fields,
                "guardian_master":guardian_master,
                "guardian":guardian,
                "online_class":online_class
            }
            return render(
                request, "Student_information/student_details_edit.html", context
            )
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def student_details_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "student_information_delete" in request.permissions:
        try:
            StudentAdmission.objects.get(id=pk).delete()
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/student_details")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return render(request, "page_not_found.html")


@login_required
@user_type_required("Staff")
def payment_method(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    last_record = PaymentKeys.objects.filter(branch=branch_id).last()
    if last_record:
        if request.POST.get("payment_gateway_btn") == "payment_gateway_btn":
            last_record.seleted_payment = request.POST.get("payment_gateway")
            last_record.branch_id=branch_id
            last_record.save()
            return redirect("payment_method")
        else:
            if request.POST.get("btn_type") == "india":
                last_record.razorpay_key_id = request.POST.get("razorpay_key_id")
                last_record.razorpay_key_secret = request.POST.get(
                    "razorpay_key_secret"
                )
                last_record.branch_id=branch_id
                last_record.save()
                return redirect("payment_method")
            elif request.POST.get("btn_type") == "kenya":
                last_record.mpesa_passkey = request.POST.get("mpesa_passkey")
                last_record.mpesa_consumer_key = request.POST.get("mpesa_consumer_key")
                last_record.mpesa_consumer_secret = request.POST.get(
                    "mpesa_consumer_secret"
                )
                last_record.branch_id=branch_id
                last_record.save()
                return redirect("payment_method")

    else:                                         
        if request.POST.get("payment_gateway_btn") == "payment_gateway_btn":
            PaymentKeys.objects.create(
                seleted_payment=request.POST.get("payment_gateway"),branch_id=branch_id
            )
            return redirect("payment_method")
        else:
            if request.POST.get("btn_type") == "india":
                PaymentKeys.objects.create(
                    razorpay_key_id=request.POST.get("razorpay_key_id"),
                    razorpay_key_secret=request.POST.get("razorpay_key_secret"),
                    branch_id=branch_id
                )
                return redirect("payment_method")
            elif request.POST.get("btn_type") == "kenya":
                PaymentKeys.objects.create(
                    mpesa_passkey=request.POST.get("mpesa_passkey"),
                    mpesa_consumer_key=request.POST.get("mpesa_consumer_key"),
                    mpesa_consumer_secret=request.POST.get("mpesa_consumer_secret"),
                    branch_id=branch_id
                )
                return redirect("payment_method")
    context = {"payment_method": "active", "last_record": last_record}
    return render(request, "System_setting/payment_method.html", context)


@login_required
@user_type_required("Staff")
def email_setting(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    last_record = EmailSetting.objects.filter(branch=branch_id).last()
    if request.method == "POST":
        if last_record:
            last_record.gmail = request.POST.get("gmail")
            last_record.password = request.POST.get("password")
            last_record.default_from_email = request.POST.get("default_from_email")
            last_record.email_port = request.POST.get("email_port")
            last_record.email_host = request.POST.get("email_host")
            last_record.branch_id=branch_id
            last_record.save()
            return redirect("email_setting")
        else:
            EmailSetting.objects.create(
                gmail=request.POST.get("gmail"),
                password=request.POST.get("password"),
                default_from_email=request.POST.get("default_from_email"),
                email_port=request.POST.get("email_port"),
                email_host=request.POST.get("email_host"),
                branch_id=branch_id
            )
            return redirect("email_setting")
    context = {"last_record": last_record, "email_setting": "active"}
    return render(request, "System_setting/email_setting.html", context)


@login_required
@user_type_required("Staff")  # =================================================
def chat_index(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
    print("branch_name@@@",branch_name)
    staff_records = AddStaff.objects.filter(branch=branch_id)
    student_records = StudentAdmission.objects.filter(session=request.Session)
    contact_record = AddContact.objects.filter(user=request.user)
    records = []
    for data in contact_record:
        dict = {}
        count = ContanctMessage.objects.filter(status="sended", contact=data).count()
        dict["obj"] = data
        dict["unread_count"] = count
        records.append(dict)
    context = {
        "staff_records": staff_records,
        "student_records": student_records,
        "contact_record": contact_record,
        "records": records,
    }
    return render(request, "Chat/chat_index1.html", context)


@login_required
@user_type_required("Staff")
def save_contact(request):
    usertype = request.POST.get("usertype")
    user_id = request.POST.get("user_id")
    if usertype == "Staff":
        staff_obj = AddStaff.objects.get(id=user_id)
        AddContact.objects.get_or_create(
            user=request.user,
            staff_id=user_id,
            contact_user=staff_obj.user,
            usertype=usertype,
        )
        AddContact.objects.get_or_create(
            user=staff_obj.user,
            staff_id=user_id,
            contact_user=request.user,
            usertype="Staff",
        )
    else:
        if usertype == "Student":
            user_obj = StudentAdmission.objects.get(id=user_id)
            user_obj_id = user_obj.user_student
        elif usertype == "Parent":
            user_obj = StudentAdmission.objects.get(id=user_id)
            user_obj_id = user_obj.user_parent
        print("===", user_obj_id)
        AddContact.objects.get_or_create(
            user=request.user,
            student_id=user_id,
            contact_user=user_obj_id,
            usertype=usertype,
        )
        AddContact.objects.get_or_create(
            user=user_obj_id,
            student_id=user_id,
            contact_user=request.user,
            usertype="Staff",
        )
    return redirect("chat_index")


@login_required
@user_type_required("Staff")
def chat(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    staff_records = AddStaff.objects.filter(branch=branch_id)
    student_records = StudentAdmission.objects.filter(session=request.Session)
    contact_record = AddContact.objects.filter(user=request.user)
    contact_obj = AddContact.objects.get(id=pk)
    message_records = ContanctMessage.objects.filter(contact=contact_obj)
    message_records.filter(status="sended").update(status="readed")
    records = []
    for data in contact_record:
        dict = {}
        count = ContanctMessage.objects.filter(status="sended", contact=data).count()
        dict["obj"] = data
        dict["unread_count"] = count
        records.append(dict)
    context = {
        "staff_records": staff_records,
        "student_records": student_records,
        "contact_record": contact_record,
        "contact_obj": contact_obj,
        "pk": int(pk),
        "message_records": message_records,
        "records": records,
    }
    return render(request, "Chat/chat.html", context)


@login_required
def chat_msg_save_js(request):
    contact_obj = AddContact.objects.get(id=request.GET.get("pk"))
    to_contact = AddContact.objects.filter(
        user=contact_obj.contact_user, contact_user=contact_obj.user
    ).last()
    msg = request.GET.get("message")
    ContanctMessage.objects.create(
        contact_id=request.GET.get("pk"),
        from_message=msg,
        status="readed",
    )
    ContanctMessage.objects.create(
        contact=to_contact,
        to_message=msg,
        status="sended",
    )
    return JsonResponse(data="", safe=False)


@login_required
def chat_view_js(request):
    id = request.GET.get("pk")
    last_msg_id = request.GET.get("last_msg_id")
    if last_msg_id:
        record = ContanctMessage.objects.filter(contact=id, id__gt=last_msg_id).first()
        record.status = "readed"
        record.save()
        if record:
            data = {
                "id": record.id,
                "from_message": record.from_message,
                "to_message": record.to_message,
                "created_at": record.created_at.strftime("%I:%M %p"),
            }
        else:
            data = ""
    else:
        record = ContanctMessage.objects.filter(contact=id).first() if id else None
        if record:
            record.status = "readed"
            record.save()
            data = {
                "id": record.id,
                "from_message": record.from_message,
                "to_message": record.to_message,
                "created_at": record.created_at.strftime("%I:%M %p"),
            }
        else:
            data = ""
    return JsonResponse(data, safe=False)


#  ================ sms =============


@login_required
@user_type_required("Staff")
def sms_setting(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    last_record = SMSSetting.objects.filter(branch=branch_id).last()
    print("======", last_record)

    if request.method == "POST":
        if request.POST.get("btn_type") == "twilio":
            if last_record:
                last_record.twilio_account_SID = request.POST.get("twilio_account_SID")
                last_record.twilio_auth_token = request.POST.get("twilio_auth_token")
                last_record.twilio_regeister_phone_no = request.POST.get(
                    "twilio_regeister_phone_no"
                )
                last_record.branch_id=branch_id
                last_record.save()
                return redirect("sms_setting")

            else:
                SMSSetting.objects.create(
                    twilio_account_SID=request.POST.get("twilio_account_SID"),
                    twilio_auth_token=request.POST.get("twilio_auth_token"),
                    twilio_regeister_phone_no=request.POST.get(
                        "twilio_regeister_phone_no"
                    ),
                    branch_id=branch_id
                )
                return redirect("sms_setting")
    if request.POST.get("sms_gateway_btn") == "sms_gateway_btn":
        if last_record:
            last_record.status = request.POST.get("sms_gateway")
            last_record.branch_id=branch_id
            last_record.save()
            return redirect("sms_setting")

        else:
            SMSSetting.objects.create(
                status=request.POST.get("sms_gateway"),
                branch_id=branch_id
            )
            return redirect("sms_setting")
    context = {"last_record": last_record, "sms_setting": "active"}
    return render(request, "System_setting/sms_setting.html", context)


@login_required
@user_type_required("Staff")
def send_sms(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    form = SendEmailForm()
    forms = Role.objects.filter(branch=branch_id)
    classes = Class.objects.filter(branch=branch_id)
    sections = Section.objects.filter(branch=branch_id)
    roles_records = Role.objects.filter(branch=branch_id)
   
    

    if request.method == "POST":
        # Get the form data
        title = request.POST.get("title")
        message = request.POST.get("message")
        recipients = request.POST.getlist("noties_all[]")
        attachments = request.FILES.getlist("attachment")
        class_id = request.POST.get("class_id")
        selected_sections = request.POST.getlist("sectionss")

        email_subject = "Title: {}".format(title)
        email_message = """
        Message: {}
        Regards,
        Yours bharathbrands
        """.format(
            message
        )

        if recipients and recipients[0].isdigit():
            EmailSmsLog.objects.create(
                Title=title, send_by="SMS", sent_to="Group", created_by=request.user,branch_id=branch_id
            )
            for i in recipients:
                if i.isdigit():
                    user_phone_num = AddStaff.objects.filter(roles=int(i)).values_list(
                        "phone_no", flat=True
                    )
                    send_sms_notification(
                        email_subject,
                        email_message,
                        user_phone_num,
                    )
        else:
            EmailSmsLog.objects.create(
                Title=title, send_by="SMS", sent_to="Group", created_by=request.user,branch_id=branch_id
            )
            for recipient in recipients:
                if recipient == "student":
                    # Retrieve student email addresses and add them to recipient_emails
                    mobile_numbers = (
                        StudentAdmission.objects.exclude(mobile_number__isnull=True)
                        .exclude(mobile_number__exact="")
                        .values_list("mobile_number", flat=True)
                    )
                    send_sms_notification(
                        email_subject,
                        email_message,
                        mobile_numbers,
                    )
                elif recipient == "parent":
                    # Retrieve parent mobile_number addresses and add them to recipient_mobile_numbers
                    mobile_numbers = (
                        StudentAdmission.objects.exclude(guardian_phone__isnull=True)
                        .exclude(guardian_phone__exact="")
                        .values_list("guardian_phone")
                    )
                    send_sms_notification(
                        email_subject,
                        email_message,
                        mobile_numbers,
                    )
        if class_id and selected_sections:
            EmailSmsLog.objects.create(
                Title=title, send_by="SMS", sent_to="Class", created_by=request.user
            )
            mobile_numbers = (
                StudentAdmission.objects.filter(
                    Class=class_id, section__in=selected_sections
                )
                .exclude(mobile_number__isnull=True)
                .exclude(mmobile_number__exact="")
                .values_list("mobile_number", flat=True)
            )
            send_sms_notification(
                email_subject,
                email_message,
                mobile_numbers,
            )

        return redirect("/send_sms")

    context = {
        "form": form,
        "forms": forms,
        "classes": classes,
        "sections": sections,
        "roles_records": roles_records,
        "send_sms": "active",
    }

    return render(request, "Communicate/send_sms.html", context)


@login_required
@user_type_required("Staff")
def indvidula_send_sms(request):
    if request.user.is_superuser or request.user.is_school_admin or "sms_view" in request.permissions:
        try:
            if request.method == "POST":
                title = request.POST.get("individual_title")
                message = request.POST.get("individual_message")
                email_subject = "Title: {}".format(title)
                email_message = """
                Message: {}
                Regards,
                Yours bharathbrands
                """.format(
                    message
                )
                EmailSmsLog.objects.create(
                    Title=title,
                    send_by="SMS",
                    sent_to="Individual",
                    created_by=request.user,
                )
                mail_for = MailSearchTemp.objects.filter(branch=branch_id)
                phone_num = []
                for data in mail_for:
                    if data.type == "Student":
                        phone_num.append(data.Student.mobile_number)
                    elif data.type == "Guardian":
                        phone_num.append(data.Student.guardian_phone)
                    elif data.type == "Staff":
                        phone_num.append(data.Staff.phone_no)
                send_sms_notification(
                    email_subject,
                    email_message,
                    phone_num,
                )
                return redirect("/indvidula_send_sms")
            roles_records = Role.objects.filter(branch=branch_id)
            MailSearchTemp.objects.filter(branch=branch_id).delete()
            context = {"roles_records": roles_records, "send_sms": "active"}
            return render(request, "Communicate/indvidula_send_sms.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return render(request, "page_not_found.html")


def eventcalendar(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "event_Calendar_view" in request.permissions
        or "event_Calendar_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = EventCalendar.objects.filter(branch=branch_id)
            record = Calendarnofication.objects.filter(branch=branch_id)
            form = CalendarnoficationForm()
            if request.method == "POST":
                form = CalendarnoficationForm(request.POST)
                if form.is_valid():
                        obj=form.save()
                        obj.branch_id = branch_id
                        obj.save()

                        EventCalendar.objects.create(
                            title=obj.title,
                            description=" ",
                            startstime=datetime.combine(obj.date, time.min),
                            endtime=datetime.combine(obj.date, time.max),
                            created_by=request.user,
                            branch_id=branch_id
                        )
                        messages.success(request, "Record Saved Successfully")
                return HttpResponseRedirect("/eventcalendar")
            context = {"form": form, "records": records, "record": record}
            return render(request, "System_setting/sample.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return render(request, "page_not_found.html")


def eventcalendar_edit(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    id = request.GET.get("eventId")
    title = request.GET.get("eventTitle")
    description = request.GET.get("description")
    startstime = request.GET.get("start")
    endtime = request.GET.get("end")
    parsed_datetime = datetime.strptime(startstime, "%Y-%b-%d %H:%M:%S")
    parsed_datetime1 = datetime.strptime(endtime, "%Y-%b-%d %H:%M:%S")
    obj = EventCalendar.objects.get(id=id)
    obj.title = title
    obj.description = description
    obj.startstime = parsed_datetime
    obj.endtime = parsed_datetime1
    obj.branch_id = branch_id 
    obj.save()

    return JsonResponse(data="", safe=False)


from django.utils import timezone


def event_calendar_save(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    title = request.GET.get("eventTitle")
    print("ddddd", title)
    description = request.GET.get("description")
    startstime = request.GET.get("start")
    endtime = request.GET.get("end")
    print("====", startstime)
    parsed_datetime = datetime.strptime(startstime, "%Y-%b-%d %H:%M:%S")
    parsed_datetime1 = datetime.strptime(endtime, "%Y-%b-%d %H:%M:%S")
    print("<<<<<<<<<<<startstime", startstime)
    EventCalendar.objects.create(
        title=title,
        description=description,
        startstime=parsed_datetime,
        endtime=parsed_datetime1,
        created_by=request.user,
        branch_id=branch_id
    )

    return JsonResponse(data="", safe=False)


def event_calendar_delete(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    event_calendar=EventCalendar.objects.get(id=request.GET.get("id"))    
    event_calendar_branch_id = event_calendar.branch.id
    if int(event_calendar_branch_id) == int(branch_id):                        
        EventCalendar.objects.get(id=pk).delete()
    else:
        messages.error(request, "School id Doesn't match record no delete")
    messages.error(request, "Record Deleted Successfully")
    return JsonResponse(data="", safe=False)


def calendarnofication_edit(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "event_Calendar_view" in request.permissions
        or "event_Calendar_add" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Calendarnofication.objects.filter(branch=branch_id)
            form = CalendarnoficationForm()
            record = Calendarnofication.objects.get(id=pk)
            form = CalendarnoficationForm(instance=record)
            if request.method == "POST":
                form = CalendarnoficationForm(request.POST, instance=record)
                if form.is_valid():
                    form.save()
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/eventcalendar")
            context = {
                "form": form,
                "records": records,
            }
            return render(
                request, "System_setting/calendarnofication_edit.html", context
            )
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def calendarnofication_delete(request, pk):
    # if request.user.is_superuser or request.user.is_school_admin or 'parent_meeting_delete' in request.permissions:
    try:
        Calendarnofication.objects.get(id=pk).delete()
        messages.error(request, "Record Deleted Successfully")
        return HttpResponseRedirect("/eventcalendar")
    except Exception as error:
        return render(request, "error.html", {"error": error})


@user_type_required("Staff")
def To_do_list(request):
    obj = Calendarnofication.objects.get(id=request.GET.get("id"))
    if obj.status == "completed":
        obj.status = "incompleted"
    else:
        obj.status = "completed"
        messages.success(request, "Task Completed Successfully")
    obj.save()
    return JsonResponse(data="", safe=False)


@login_required
@user_type_required("Staff")
def student_user(request):
    branch_name = request.session.get('branch_id', None)
    print("branch_name+++",branch_name)
    if branch_name:        
        branch_id = branch_name     
        print("branch_name==if",branch_name)  
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    student_login_id = LoginCredentials.objects.filter(branch=branch_id)
    staff_login_id = AddStaff.objects.filter(branch=branch_id)
    guardian_get = StudentGuardianDetails.objects.filter(branch=branch_id)
    user_list = User.objects.all()
    print("user_list",user_list)
    

    context = {
        "student_user": "active",
        "student_login_id": student_login_id,
        "staff_login_id": staff_login_id,
        "guardian_get":guardian_get,
        "user_list":user_list
    }
    return render(request, "System_setting/user.html", context)

from django.views.decorators.csrf import csrf_exempt
@csrf_exempt
def toggle_status(request):
    active_id = request.GET.get("active_id")
    admin_login_id = User.objects.get(id=active_id)
    a = admin_login_id
    b = User.objects.get(id=a.id)
    if b.is_active == True:
        b.is_active = False
        b.save()
    else:
        b.is_active == False
        b.is_active = True
        b.save()
    return JsonResponse(data="", safe=False)

def active_js(request):
    active_id = request.GET.get("active_id")
    student_login_id = LoginCredentials.objects.get(id=active_id)
    a = student_login_id.student.user_student
    b = User.objects.get(id=a.id)
    if b.is_active == True:
        b.is_active = False
        b.save()
    else:
        b.is_active == False
        b.is_active = True
        b.save()
    return JsonResponse(data="", safe=False)


def active_parent_js(request):
    active_id = request.GET.get("active_parent_id")
    print("active_idparent",active_id)
    student_login_id = StudentGuardianDetails.objects.get(id=active_id)
    print("student_login_id",student_login_id)
    a = student_login_id.student.user_parent
    b = User.objects.get(id=a.id)
    if b.is_active == True:
        b.is_active = False
        b.save()
    else:
        b.is_active == False
        b.is_active = True
        b.save()
    return JsonResponse(data="", safe=False)


def active_staff_js(request):
    active_id = request.GET.get("active_staff_id")
    print("active_id123",active_id)
    staff_login_id = AddStaff.objects.get(id=active_id)
    print("staff_login_id",staff_login_id)
    a = staff_login_id.user
    print("stafffaaastafffaaa",a)
    b = User.objects.get(id=a.id)
    print("bisavalable",b)
    if b.is_active == True:
        b.is_active = False
        b.save()
    else:
        b.is_active == False
        b.is_active = True
        b.save()
    return JsonResponse(data="", safe=False)


@login_required
@user_type_required("Staff")
def custom_fields(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    records = CustomFields.objects.filter(branch=branch_id)
    form = CustomFieldsForm()
    if request.method == "POST":
        form = CustomFieldsForm(request.POST)
        if form.is_valid():
            obj=form.save()
            obj.branch_id = branch_id
            obj.save()
            messages.success(request, "Record Saved Successfully")
            return HttpResponseRedirect("/custom_fields")
        else:
            print(form.errors)
    context = {"form": form, "records": records, "custom_fields": "active"}
    return render(request, "System_setting/custom_fields.html", context)


@login_required
@user_type_required("Staff")
def custom_fields_edit(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    records = CustomFields.objects.filter(branch=branch_id)
    obj = CustomFields.objects.get(id=pk)
    data_branch_id = obj.branch.id
    form = CustomFieldsForm(instance=obj)
    if request.method == "POST":
        form = CustomFieldsForm(request.POST, instance=obj)
        if form.is_valid():
            if branch_id == data_branch_id:
                form.save()
            else:
                form.instance.branch_id = branch_id
            form.save()
            messages.success(request, "Record updated Successfully")
            return HttpResponseRedirect("/custom_fields")
        else:
            print(form.errors)
    context = {
        "form": form,
        "records": records,
        "custom_fields": "active",
        "obj": obj,
        "edit": True,
    }
    return render(request, "System_setting/custom_fields.html", context)


@login_required
@user_type_required("Staff")
def custom_fields_delete(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    custom_fields=CustomFields.objects.get(id=pk)
    custom_fields_branch_id = custom_fields.branch.id
    if int(custom_fields_branch_id) == int(branch_id):                        
        CustomFields.objects.get(id=pk).delete()
    else:
        messages.error(request, "School id Doesn't match record no delete")
    messages.error(request, "Record Deleted Successfully")
    return HttpResponseRedirect("/custom_fields")


@login_required
@user_type_required("Staff")
def modules(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
        print(request.system_modules)
    permissions = request.POST.getlist("modules_val")
    records = Modules.objects.filter(branch=branch_id).first()
    if request.method == "POST":
        if records:
            records.system = permissions
            records.branch_id=branch_id
            records.save()
            return HttpResponseRedirect("/modules")

        else:
            Modules.objects.create(
                system=permissions,
                branch_id=branch_id
            )
            return HttpResponseRedirect("/modules")
    context = {"modules": "active", "records": records}
    return render(request, "System_setting/modules_system.html", context)


@login_required
@user_type_required("Staff")
def modules_parent(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    permissions_parent = request.POST.getlist("modules_val_parent")
    print(">>>>>>>>>>eeee<<<<<<<<<<<", permissions_parent)
    records = Modules.objects.filter(branch=branch_id).first()
    if request.method == "POST":
        if records:
            records.parent = permissions_parent
            records.branch_id=branch_id
            records.save()
            return HttpResponseRedirect("/modules_parent")

        else:
            permissions_parent = request.POST.getlist("modules_val_parent")
            print(">>>>>>>>>C<<<<<<<<<<", permissions_parent)
            Modules.objects.create(
                parent=permissions_parent,
                branch_id=branch_id
            )
            return HttpResponseRedirect("/modules_parent")
    context = {"modules": "active", "records": records}
    return render(request, "System_setting/modules_parent.html", context)


@login_required
@user_type_required("Staff")
def modules_student(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    permissions_student = request.POST.getlist("modules_val_student")
    records = Modules.objects.filter(branch=branch_id).first()
    if request.method == "POST":
        if records:
            records.student = permissions_student
            records.branch_id=branch_id
            records.save()
            return HttpResponseRedirect("/modules_student")

        else:
            Modules.objects.create(
                student=permissions_student,
                branch_id=branch_id
            )
            return HttpResponseRedirect("/modules_student")
    context = {"modules": "active", "records": records}
    return render(request, "System_setting/modules_student.html", context)


@login_required
@user_type_required("Staff")
def student_profile_update(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    permissions_fields = request.POST.getlist("fields_val")
    status_get = request.POST.get("status")
    records = Studentprofileupdate.objects.filter(branch=branch_id).first()
    if request.method == "POST":
        if records:
            records.fieldshide = permissions_fields
            records.status = status_get
            records.branch_id=branch_id
            records.save()
            return HttpResponseRedirect("/student_profile_update")
        else:
            Studentprofileupdate.objects.create(
                fieldshide=permissions_fields, status=status_get,
                branch_id=branch_id
            )
            return HttpResponseRedirect("/student_profile_update")

    context = {"student_profile_update": "active", "records": records}
    return render(request, "System_setting/student_profile_update.html", context)


# def system_fields_student(request):
#     obj = SystemFields.objects.first()
#     if request.method == "POST":
#         if obj:
#             obj.student_fields = request.POST.getlist("system_fields")
#             obj.save()
#             return redirect("system_fields_student")
#         else:
#             create = SystemFields(
#                 student_fields=request.POST.getlist("system_fields"),
#             )
#             create.save()
#             return redirect("system_fields_student")
#     context = {"obj": obj.student_fields}
#     return render(request, "System_setting/system_fields_student.html", context)

#===========================Murali=============================

def system_fields_student(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    obj = SystemFields.objects.first()
    if request.method == "POST":
        if obj:
            obj.student_fields = request.POST.getlist("system_fields")
            obj.branch_id=branch_id
            obj.save()
        else:
            create = SystemFields(
                student_fields=request.POST.getlist("system_fields"),
                branch_id=branch_id
            )
            create.save()
        return redirect("system_fields_student")
    
    context = {"obj": obj.student_fields if obj else None ,"system_fields_student":"active" }
    return render(request, "System_setting/system_fields_student.html", context)

#=========================================================================

def system_fields_staff(request):
    obj = SystemFields.objects.first()  
    print("obj:", obj)  
    
    if request.method == "POST":
        system_fields = request.POST.getlist("system_fields")
        
        if obj:
            obj.staff_fields = system_fields
            obj.save()
        else:
            create = SystemFields(staff_fields=system_fields)
            create.save()
        
        return redirect("system_fields_staff") 

    context = {"obj": obj.staff_fields if obj and obj.staff_fields else None}
    return render(request, "System_setting/system_fields_staff.html", context)


def student_search(request):
    print("search_txt", request.POST)
    search_txt = request.POST.get("search_txt")
    records = StudentAdmission.objects.filter(
        Q(admission_no__icontains=search_txt)
        | Q(roll_number__icontains=search_txt)
        | Q(first_name__icontains=search_txt)
        | Q(last_name__icontains=search_txt)
        | Q(roll_number__icontains=search_txt)
    )
    records = records.filter(session=request.Session)
    context = {"records": records}
    return render(request, "System_setting/student_search.html", context)


def print_header_footer(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    image_fees = request.FILES.get("image_fees_receipt")
    note_fees = request.POST.get("note_fees_receipt")
    image_payroll = request.FILES.get("image_payslip")
    note_payroll = request.POST.get("note_payslip")
    fees_receipt = request.POST.get("fees_receipt")
    pay_roll_receipt = request.POST.get("pay_roll_receipt")
    records = PrintHeaderFooter.objects.filter(branch=branch_id).first()
    if request.method == "POST":
        if fees_receipt:
            if records:
                records.image_fees_receipt = image_fees
                records.note_fees_receipt = note_fees
                records.branch_id=branch_id
                records.save()
                return HttpResponseRedirect("/print_header_footer")

            else:
                PrintHeaderFooter.objects.create(
                    image_fees_receipt=image_fees,
                    note_fees_receipt=note_fees,
                    image_payslip=image_payroll,
                    note_payslip=note_payroll,
                    branch_id=branch_id
                )
                return HttpResponseRedirect("/print_header_footer")
        if pay_roll_receipt:
            if records:
                records.image_payslip = image_payroll
                records.note_payslip = note_payroll
                records.branch_id=branch_id
                records.save()
                return HttpResponseRedirect("/print_header_footer")

            else:
                PrintHeaderFooter.objects.create(
                    image_fees_receipt=image_fees,
                    note_fees_receipt=note_fees,
                    image_payslip=image_payroll,
                    note_payslip=note_payroll,
                    branch_id=branch_id
                )
                return HttpResponseRedirect("/print_header_footer")
    else:
        print()

    context = {"print_header_footer": "active", "records": records}
    return render(request, "System_setting/print_header_footer.html", context)


def print_fees(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    header_img = PrintHeaderFooter.objects.filter(branch=branch_id).first()
    records = StudentFess.objects.get(id=pk)

    context = {"records": records, "header_img": header_img}
    return render(request, "Fees_Collection/print_fees.html", context)


def print_master_fees(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    header_img = PrintHeaderFooter.objects.filter(branch=branch_id).first()
    fees_records = FeesAssign.objects.get(id=pk, session=request.Session)
    master_fees = StudentFess.objects.filter(fess_id=fees_records)

    context = {
        "fees_records": fees_records,
        "master_fees": master_fees,
        "header_img": header_img,
    }
    return render(request, "Fees_Collection/print_master_fees.html", context)


def guardian_master(request):
    # if (
    #     request.user.is_superuser or request.user.is_school_admin
    #     or "meeting_link_master_view" in request.permissions
    #     or "meeting_link_master_add" in request.permissions
    # ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)

            records = GuardianMaster.objects.filter(branch=branch_id)
            form = GuardianMasterForm()
            if request.method == "POST":
                form = GuardianMasterForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.save()
                    messages.success(request, "Record Saved Successfully")
                    return  HttpResponseRedirect("/guardian_master")
            context = {"form": form, "records": records, "guardainmaster": "active"}
            return render(request, "Student_information/guardain_master.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    # else:
    #     return redirect("dashboard")


def guardian_master_edit(request, pk):
    # if (
    #     request.user.is_superuser or request.user.is_school_admin
    #     or "meeting_link_master_view" in request.permissions
    #     or "meeting_link_master_add" in request.permissions
    # ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = GuardianMaster.objects.filter(branch=branch_id)
            record = GuardianMaster.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = GuardianMasterForm(instance=record)
            if request.method == "POST":
                form = GuardianMasterForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    form.save()                   
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/guardian_master")
            context = {
                "form": form,
                "records": records,
                "guardainmaster": "active",
                "edit": True,
            }
            return render(request, "Student_information/guardain_master_edit.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    # else:
    #     return redirect("dashboard")
 
    
def guardian_master_view(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    records = GuardianMaster.objects.filter(branch=branch_id)
    record = GuardianMaster.objects.get(id=pk)
    form = GuardianMasterForm(instance=record)
    context = {
        "form": form,
        "records": records,
        "guardainmaster": "active",
        "view": True,
    }
    return render(request, "Student_information/guardain_master_edit.html", context)

    
def guardian_master_delete(request, pk):
    # if (
    #     request.user.is_superuser or request.user.is_school_admin
    #     or "meeting_link_master_view" in request.permissions
    #     or "meeting_link_master_add" in request.permissions
    # ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name) 
            guardian=GuardianMaster.objects.get(id=pk)
            guardian_branch_id = guardian.branch.id
            if int(guardian_branch_id) == int(branch_id):                        
                GuardianMaster.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/guardian_master")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    # else:
    #     return redirect("dashboard")


# def guardian_save_js(request):
#     student_list=request.GET.getlist('student_id[]')
#     name_list=request.GET.getlist('name[]')
#     phone_list=request.GET.getlist('phone[]')
#     occupation_list=request.GET.getlist('occupation[]')
#     guardian_master_list=request.GET.get('guardianmaster_id')

#     for i in range(len(student_list)):
#         StudentGuardianDetails.objects.get_or_create(
#             student_id=student_list,
#             guardianmaster_id=guardian_master_list,
#             name=name_list,
#             phone=phone_list[i],
#             occupation=occupation_list[i],
    
#         )
#     return JsonResponse(data='success', safe=False)

# def guardian_delete_js(request):
#     StudentGuardianDetails.objects.get(id=request.GET.get('pk')).delete()
#     return JsonResponse(data='success', safe=False)
    
           
@login_required
@user_type_required("Staff")  
def meeting_link_master(request):
    # if (
    #     request.user.is_superuser or request.user.is_school_admin
    #     or "meeting_link_master_view" in request.permissions
    #     or "meeting_link_master_add" in request.permissions
    # ):
    #     try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None    
            print("branch_name@@@",branch_name)
            records = MeetingLinkMaster.objects.filter(branch=branch_id)
            form = MeetingLinkMasterForm()
            if request.method == "POST":
                form = MeetingLinkMasterForm(request.POST)
                if form.is_valid():
                    obj=form.save(commit=False)
                    obj.branch_id=branch_id
                    obj.save()
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/meeting_link_master")
                else:
                    print(form.errors)
            context = {"form": form, "records": records, "meeting_link_master": "active"}
            return render(request, "Livesession/meeting_link_master.html", context)
    #     except Exception as error:
    #         return render(request, "error.html", {"error": error})
    # else:
    #     return redirect("dashboard")

    


@login_required
@user_type_required("Staff")
def meeting_link_master_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "meeting_link_masters_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None    
            print("branch_name@@@",branch_name)
            records = MeetingLinkMaster.objects.filter(branch=branch_id)
            record = MeetingLinkMaster.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = MeetingLinkMasterForm(instance=record)
            if request.method == "POST":
                form = MeetingLinkMasterForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        # Save the form with from_school_id
                        form.save()
                    else:
                        # Save the form with the session value
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/meeting_link_master")
            context = {
                "form": form,
                "records": records,
                "meeting_link_master": "active",
                "edit": True,
            }
            return render(request, "Livesession/meeting_link_master_edit.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def meeting_link_master_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "meeting_link_masters_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = MeetingLinkMaster.objects.filter(branch=branch_id)
            record = MeetingLinkMaster.objects.get(id=pk)
            form = MeetingLinkMasterForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "meeting_link_master": "active",
                "view": True,
            }
            return render(request, "Livesession/meeting_link_master.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def meeting_link_master_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "meeting_link_masters_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
            meeter_link=MeetingLinkMaster.objects.get(id=pk)
            meeter_branch_id = meeter_link.branch.id
            if int(meeter_branch_id) == int(branch_id):                        
                MeetingLinkMaster.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/meeting_link_master")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")
    
    
@login_required
@user_type_required("Staff")
def online_class_attendance(request, pk): 
        branch_name = request.session.get('branch_id', None)
        if branch_name:
            branch_id = branch_name       
        else:
            branch_id = None  
            print("branch_name@@@",branch_name)
        current_date = datetime.now()

        # Fetch the specific OnlineClass instance
        recordss = OnlineClass.objects.get(id=pk)
      
        student_list = StudentAdmission.objects.filter(
                Class=recordss.Class,section__in=recordss.section.filter(branch=branch_id),branch_id=branch_id          
            )
        student_present = OnlineClassAttendance.objects.filter(
            student__in=student_list,attendance_status='present',online=recordss,branch_id=branch_id
        )
        print('student_prensent',student_present)
        student_ids = [data.student_id for data in student_present] 
        student_records = student_list.exclude(id__in = student_ids)
        print('student_records',student_records)

        if request.method == "POST":
            student_list = request.POST.getlist("stu_att_id")
            print('student_list',student_list)
   
            for data in student_list:  
                stu_att_status = request.POST.get(f"attendance{data}")                
                print('stu_att_status',stu_att_status)                       
                student_att = OnlineClassAttendance.objects.filter(
                    student=data,online=recordss,branch_id=branch_id                 
                ).last()
                print('edit_staff',student_att)                  
         
                if student_att:
                    student_att.attendance_status = stu_att_status
                    student_att.branch_id=branch_id
                    student_att.save()
                else:
                    print('online_class_attendance',recordss.id)
                    print('data',data) 
                    OnlineClassAttendance.objects.create(
                        student_id=data,
                        online=recordss,
                        attendance_status=stu_att_status,
                        attendance_date=current_date,
                        branch_id=branch_id
                    ) 
            messages.success(request, "Record updated Successfully")
            return HttpResponseRedirect("/online_class")    


        context = {
            "recordss": student_present,
            'student_records':student_records,
            "online_class": "active",
        }
        return render(request, "Livesession/online_class_attendance.html", context)
    
    
@user_type_required("Staff")
def guardian_delete(request, pk):
    print('pk',pk)
    StudentGuardianDetails.objects.get(id=pk).delete()
    messages.error(request, "Record Deleted Successfully")
    return HttpResponseRedirect(f'/student_details_edit/{pk}')

def unique_id(pre, model_class):
    # Get the total count of records in the model (or specific filtering condition if needed)
    tot_rec_count = model_class.objects.count() + 1

    # Creating a unique ID based on the total record count and the provided prefix
    if len(str(tot_rec_count)) == 1:
        unique_id = pre + '000' + str(tot_rec_count)
    elif len(str(tot_rec_count)) == 2:
        unique_id = pre + '00' + str(tot_rec_count)
    elif len(str(tot_rec_count)) == 3:
        unique_id = pre + '0' + str(tot_rec_count)
    else:
        unique_id = pre + str(tot_rec_count)

    return unique_id

@login_required
@user_type_required("Staff")  
def school_registration(request):
    # if (
    #     request.user.is_superuser or request.user.is_school_admin
    #     or "" in request.permissions
    #     or "" in request.permissions
    # ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
            print("branch_name@@@",branch_name)
            token = request.session['user_token']
            endpoint = 'finance/company/'
            # endpoint_currency = 'finance/currency/'
            school_name = request.POST.get("school_name")
            print('school_name',school_name)
            address = request.POST.get("address")
            print('address',address)
            form = SchoolRegistrationForm()
            records = SchoolRegistration.objects.filter(branch_school=branch_id)
            # response = call_get_method(BASE_URL,endpoint_currency,token)
            # currency_data = response.json()
            # # Extract all currency_code values into a list
            # currency_codes = [item['currency_code'] for item in currency_data]

            # print("All currency_codes:", currency_codes)
            # if response.status_code != 200:
            #     return render(request, 'error500.html', {'error': str(response.json())})
            # response1 = call_get_method(BASE_URL,endpoint1,request.user)
            # if response1.status_code != 200:
            #     return render(request, 'error500.html', {'error': str(response.json())})
            if request.method == "POST":
                form = SchoolRegistrationForm(request.POST)
                if form.is_valid():
                    local_currency = form.cleaned_data['local_currency']
                    print("reference_id", local_currency.currency_id)
                    currency_value = sub_part_Currency.objects.get(currency_id=local_currency.currency_id)
                    print("currency_value", currency_value.reference_id)
                    data = {
                        'company_name': form.cleaned_data['school_name'],
                        'address': form.cleaned_data['address'],
                        'last_name': form.cleaned_data['last_name'],
                        'phone': form.cleaned_data['phone_number'],
                        'email': form.cleaned_data['email'],
                        'incorporation_number': form.cleaned_data['incorporation_number'],
                        'website': form.cleaned_data['website'],
                        'number_of_branches': form.cleaned_data['number_of_branches'],
                        'number_of_staffs': form.cleaned_data['number_of_staffs'],
                        'end_of_financial_year': form.cleaned_data['end_of_financial_year'].strftime('%Y-%m-%d'),
                        'end_of_month_date': form.cleaned_data['end_of_month_date'].strftime('%Y-%m-%d'),
                        'amount_rounded_to': form.cleaned_data['amount_rounded_to'],
                        'local_currency': currency_value.reference_id,
                    }

                    print("++++++++++++++++++")
                    json_data = json.dumps(data)
                    print("=========", json_data)
                    response = call_post_method(BASE_URL, endpoint, json_data, token)

                    if response.status_code != 200:
                        print('Response Status Code:', response.content)
                        messages.error(request, response.content)
                    response_data = json.loads(response.content.decode('utf-8'))
                    print("response_data",response_data)
                    record = form.save(commit=False)
                    print("record===", record)
                    # Assign branch_id and reference_id before saving
                    record.branch_id = branch_id
                    record.reference_id = response_data['record_id']
                    # Generate a unique school_id and assign it
                    record.school_id = unique_id("SCHREG", SchoolRegistration)
                    # Save the record to the database
                    record.save()
                    print('record',record.school_name)
                messages.success(request, "Record Saved Successfully")
                return HttpResponseRedirect("/school_registration")
            else:
                print("Not comes")
            context = {"records": records,"form":form, "school_registrations": "active",}
            return render(request, "System_setting/school_registration.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    # else:
    #     return redirect("dashboard")


@login_required
@user_type_required("Staff")  
def school_registration_edit(request,pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "" in request.permissions
        or "" in request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            school_name = request.POST.get("school_name")
            print('school_name',school_name)
            address = request.POST.get("address")
            print('address',address)
            record = SchoolRegistration.objects.filter(branch=branch_id)
            records = SchoolRegistration.objects.get(id=pk) 
            print('records',records)
            if request.method == "POST":
                records = SchoolRegistration.objects.get(id=pk) 

                records.school_name=school_name   
                records.address=address              
                records.school_id=unique_id("SCHREG",records)
                records.save()
                print('records',records.id)
                messages.success(request, "Record Saved Successfully")
                return HttpResponseRedirect("/school_registration")
            else:
                print("Not comes")
            context = {"records": records,"record":record, "school_registration": "active"}
            return render(request, "System_setting/school_registration_edit.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")        


@login_required
@user_type_required("Staff")
def school_registration_delete(request, pk):
    SchoolRegistration.objects.get(id=pk).delete()
    messages.error(request, "Record Deleted Successfully")
    return HttpResponseRedirect("/school_registration")


@login_required
@user_type_required("Staff")
def school_registration_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "admission_enquiry_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = SchoolRegistration.objects.filter(branch=branch_id)
            record = SchoolRegistration.objects.get(id=pk)
            print('record',record)
            context = {
                "records": records,
                "record":record,
                "school_registration": "active",
                "view": True,   
            }
            return render(request, "System_setting/school_registration.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard") 

@login_required
def select_school(request):
    if request.user.is_superuser  or "admission_enquiry_view" in request.permissions:
        # try:
            records = SchoolRegistration.objects.all()
            print('record',records)
            if request.method == "POST":
                school_name = request.POST.get("school_name") 
                print("school_name===",school_name)         
                return HttpResponseRedirect(f"select_branch/{school_name}") 
             
            else:               
                context = {
                    "records": records,
                    "school_registration": "active",
                    "view": True,   
                }
                return render(request, "Human_Resource/select_school.html", context)
        # except Exception as error:
        #     return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")   

#========================Murali=============
def create_school_registration(request):
 
    try:
        token = request.session['user_token']
        branch_name = request.session.get('branch_id', None)
        if branch_name:
            branch_id = branch_name       
        else:
            branch_id = None  
        print("branch_name@@@",branch_name)
        endpoint = 'finance/company/'
        # endpoint_currency = 'finance/currency/'
        school_name = request.POST.get("school_name")
        print('school_name',school_name)
        address = request.POST.get("address")
        print('address',address)
        form = SchoolRegistrationForm()
        records = SchoolRegistration.objects.filter(branch=branch_id)
        # response = call_get_method(BASE_URL,endpoint_currency,token)
        # currency_data = response.json()
        # # Extract all currency_code values into a list
        # currency_codes = [item['currency_code'] for item in currency_data]

        # print("All currency_codes:", currency_codes)
        # if response.status_code != 200:
        #     return render(request, 'error500.html', {'error': str(response.json())})
        # response1 = call_get_method(BASE_URL,endpoint1,request.user)
        # if response1.status_code != 200:
        #     return render(request, 'error500.html', {'error': str(response.json())})
        if request.method == "POST":
            form = SchoolRegistrationForm(request.POST)
            if form.is_valid():
                local_currency = form.cleaned_data['local_currency']
                print("reference_id", local_currency.currency_id)
                currency_value = sub_part_Currency.objects.get(currency_id=local_currency.currency_id)
                print("currency_value", currency_value.reference_id)
                data = {
                    'company_name': form.cleaned_data['school_name'],
                    'address': form.cleaned_data['address'],
                    'last_name': form.cleaned_data['last_name'],
                    'phone': form.cleaned_data['phone_number'],
                    'email': form.cleaned_data['email'],
                    'incorporation_number': form.cleaned_data['incorporation_number'],
                    'website': form.cleaned_data['website'],
                    'number_of_branches': form.cleaned_data['number_of_branches'],
                    'number_of_staffs': form.cleaned_data['number_of_staffs'],
                    'end_of_financial_year': form.cleaned_data['end_of_financial_year'].strftime('%Y-%m-%d'),
                    'end_of_month_date': form.cleaned_data['end_of_month_date'].strftime('%Y-%m-%d'),
                    'amount_rounded_to': form.cleaned_data['amount_rounded_to'],
                    'local_currency': currency_value.reference_id,
                }

                print("+++++++++++++++++")
                json_data = json.dumps(data)
                print("=========", json_data)
                response = call_post_method(BASE_URL, endpoint, json_data, token)

                if response.status_code != 200:
                    print('Response Status Code:', response.content)
                    
                response_data = json.loads(response.content.decode('utf-8'))
                print("response_data",response_data)
                record = form.save(commit=False)
                print("record===", record)

                # Assign branch_id and reference_id before saving
                record.branch_id = branch_id
                record.reference_id = response_data['record_id']

                # Generate a unique school_id and assign it
                record.school_id = unique_id("SCHREG", SchoolRegistration)

                # Save the record to the database
                record.save()
                print('record',record.school_name)
            
            request.session['school_registration_id'] = record.id
            print("session_value",request.session['school_registration_id'])
            messages.success(request, "Record Saved Successfully")
            return HttpResponseRedirect(f"create_branch/{record.id}")
        else:
            print("Not comes")
        context = {"records": records,"form":form, "school_registration": "active"}
        return render(request, "System_setting/create_school_registration.html", context)
    except Exception as error:
        return render(request, "error.html", {"error": error})


def create_branch(request,pk):
   
    try:
        token = request.session['user_token']
        branch_name = request.POST.get("branch_name")
        print('branch_name',branch_name)
        location = request.POST.get("location")
        print('location',location)
        email = request.POST.get("email")
        print('email',email)
        description = request.POST.get("description")
        print('description',description)
       
        endpoint = 'finance/branch/' 
        # school_id = request.  POST.get("school_id")
        # print('school_id',school_id)            
        if request.method == "POST":
            record = SchoolRegistration.objects.get(id=pk)
            data = {
                    'branch_name' : branch_name,
                    'description':description,
                    'company_name':record.reference_id,
                    }
            print("++++++++++++++++++",data)                        
            json_data = json.dumps(data)
            print("=========",json_data)                    
            response = call_post_method(BASE_URL,endpoint,json_data,token)
            print("response",response)
            if response.status_code != 200:              
                print('Response Status Code:', response.content)
            response_data = json.loads(response.content.decode('utf-8'))
            print("response_data",response_data)
            record = Branch.objects.create(  
                    name=branch_name,
                    location=location,
                    email=email,
                    school_id=pk,
                    reference_id=response_data['record_id'],
                    description = description
                    
                )            
            request.session['branch_id'] = record.id
            print("session_value",request.session['branch_id'])
            messages.success(request, "Record Saved Successfully")
            return redirect("select_school") 
        else:
            print("Not comes")
        context = { "school_registration": "active"}
        return render(request, "System_setting/create_branch.html", context)
    except Exception as error:
        return render(request, "error.html", {"error": error})
                       

@login_required
def  select_branch(request,pk):
    if request.user.is_superuser :
        # try:
            record=Branch.objects.filter(school__school_id=pk)   
            print("record+++",record)
            
            branch_name = request.POST.get("branch_name")
            if request.method == "POST":
                request.session['branch_id'] = branch_name
                print("session_value",request.session['branch_id'])        
                # return HttpResponseRedirect("/")  
                if branch_name:
                    return redirect("dashboard")    
                else:
                    return redirect('/')         
            else:               
                context = {                   
                    "school_registration": "active",                 
                    "record":record
                }
                return render(request, "System_setting/select_branch.html", context)
        # except Exception as error:
        #     return render(request, "error.html", {"error": error})
    elif request.user.is_school_admin or "admission_enquiry_view" in request.permissions:
        record=Branch.objects.filter(school=pk)   
        print("record+++",record)
        
        branch_name = request.POST.get("branch_name")
        if request.method == "POST":
            request.session['branch_id'] = branch_name
            print("session_value",request.session['branch_id'])        
            # return HttpResponseRedirect("/")  
            if branch_name:
                return redirect("dashboard")    
            else:
                return redirect('/')              
        else:               
            context = {                   
                "school_registration": "active",                 
                "record":record
            }
            return render(request, "System_setting/select_branch.html", context)
    else:
        return redirect('/')   


def create_branch_school(request):
    try:
        token = request.session['user_token']
        endpoint = 'finance/branch/'
        branch_name = request.POST.get("branch_name")
        print('branch_name',branch_name)
        location = request.POST.get("location")
        print('location',location)
        email = request.POST.get("email")
        print('email',email)
        description = request.POST.get("description")
        print('description',description)
        school_id=request.user.school.id
        print('ghsfdhga',school_id)
        records = SchoolRegistration.objects.get(pk=school_id)
        if request.method == "POST":
            school_id = request.POST.get("school_id")
            print('school_id',school_id)
            record = SchoolRegistration.objects.get(id=school_id)
            data = {
                    'branch_name' : branch_name,
                    'description':description,
                    'company_name':record.reference_id,
                    }
            print("++++++++++++++++++",data)                        
            json_data = json.dumps(data)
            print("=========",json_data)                    
            response = call_post_method(BASE_URL,endpoint,json_data,token)
            print("response",response)
            if response.status_code != 200:              
                print('Response Status Code:', response.content)
            response_data = json.loads(response.content.decode('utf-8'))
            print("response_data",response_data)
            record = Branch.objects.create(  
                    name=branch_name,
                    location=location,
                    email=email,
                    school_id=school_id,
                    reference_id=response_data['record_id'],
                    description=description
                )             
            request.session['branch_id'] = record.id
            print("session_value",request.session['branch_id'])
            messages.success(request, "Record Saved Successfully")
            return HttpResponseRedirect("select_school")
        else:
            print("Not comes")
        context = {"records": records, "school_registration": "active"}
        return render(request, "System_setting/create_branch_school.html", context)
    except Exception as error:
        return render(request, "error.html", {"error": error})
                    

     
    


#===============================19/08/===============
def backup(request):
    
    records = DownloadRecord.objects.all().order_by('-downloaded_at')
    context = {
        'records': records,
        'BACKUP_URL': settings.BACKUP_URL,
        'backup_data':"active"
    }
    return render(request, 'backup.html',context)

import os
import csv
import io
import zipfile
from django.http import HttpResponse
from django.apps import apps
from django.conf import settings
from .models import DownloadRecord

MODEL_NAMES = [
    "SchoolRegistration","StudentHouse","User","Purpose",
    "ComplainType", "Source", "Reference", "Section", "ClassRegister", "GuardianMaster",
    "GradingScale", "GradingSystem", "Class", "AssignSubjects", "AssignSubject", "Branch"
    , "Department", "SchoolCompositions", "EducationLevel", "SchoolYear", "Term",
    "StudentCategory", "DisableReason", "Route", "Hostel", "FeesGroup", "FeesType", 
    "Incomehead", "ExpenseHead", "Role", "AddLeaveType", "Company", "Designation", "AddItem",
    "ItemCategory", "ItemStore", "ItemSupplier", "AdmissionEnquiry", "VisitorBook", "PhoneCallLog",
    "PostalDispatch", "PostalReceive", "Complain", "StudentAdmission", "StudentGuardianDetails", 
    "LoginCredentials", "DisableHistroy", "AddIncome", "IncomeExpense", "FeesCollectionAccount",
    "ExpenseCashBookAccount", "FeesMaster", "FeesAssign", "DiscountAssign", "AddExpense", 
    "FeesTypeDiscount", "AssetType", "ChargeType", "GLLine", "AccountType", "Account", 
    "TransactionCode", "TransactionType", "AccountEntry", "FinancialTransaction", "JournalEntry",
    "Addleave", "examGroup", "AdmitCard", "DesignMarkSheet", "AddGrade", "OnlineExam", 
    "QuestionBank", "Lesson", "topic", "AssignClassTeacher", "AssignSubjectTeacher", "Subjects", 
    "SubjectGroup", "Curriculum", "ApproveLeave", "ApplyLeave", "noticeBoard", "UploadContent", 
    "AddHomeWork", "AddBook", "IssueBook", "LibrayMember", "IssueItem", "NonReturnableItem", 
    "ItemReturn", "ItemStock", "ItemStockDeatail", "Vehicle", "AssignVehicle", "HostelRoom", 
    "RoomType", "StudentCertificate", "StudentId", "Event", "MediaManager", "Menu", "Session", 
    "AlumniEvent", "AddStaff", "StaffEducationQualification", "StaffLeave", "AvailableLeave", 
    "Timeline", "StudentFess", "PaymentRecord", "StudentAttendance", "PromoteStudent", "TimeTable", 
    "AddExam", "ExamStudent", "AddExamSubject", "EntryMarks", "MarkDocument", "StaffAttendance", 
    "PayrollSummary", "Managealumini", "GeneralSetting", "StudentSession", "StudentClass", 
    "AssingHomeWork", "CaroselImage", "SchoolHeads", "SchoolStaff", "Events", "Infrastructure", 
    "News", "Offers", "Contact", "WebEnquiry", "TeacherRating", "SendEmail", "LessonPlan", 
    "MailSearchTemp", "MeetingLinkMaster", "OnlineClass", "StaffMeeting", "ParentMeeting", 
    "StaffMeetingNote", "ParentMeetingNote", "Studentmeetingnote", "EmailSetting", "AddContact", 
    "ContanctMessage", "SMSSetting", "EmailSmsLog", "EventCalendar", "Calendarnofication", 
    "CustomFields", "StudentCustomFieldValues", "StaffCustomFieldValues", "Modules", 
    "Studentprofileupdate", "SystemFields", "StudentDocuments", "StaffDocument", "StaffTimeline", 
    "PrintHeaderFooter", "OnlineClassAttendance"
]

def export_all_data_zip(request):
    zip_buffer = io.BytesIO()
    current_datetime = datetime.now().strftime("%Y%m%d%H%M%S")
    zip_filename =  f"{str(current_datetime)}.zip"
    # zip_filename = "all_data.zip"
    with zipfile.ZipFile(zip_buffer, 'w') as zip_file:

        for model_name in MODEL_NAMES:
            # Get the model class from the sub_part app
            model = apps.get_model(app_label='sub_part', model_name=model_name)

            # Create a CSV in memory
            csv_buffer = io.StringIO()
            writer = csv.writer(csv_buffer)
            fields = [field.name for field in model._meta.fields]
            writer.writerow(fields)

            # Write each row of the model's data
            for record in model.objects.filter(branch=branch_id):
                writer.writerow([getattr(record, field) for field in fields])

            # Add CSV to the ZIP file
            csv_filename = f"{model_name.lower()}_data.csv"
            zip_file.writestr(csv_filename, csv_buffer.getvalue())
    
    
    base_path = os.path.abspath('Backup/')
    zip_file_path = os.path.join(base_path, zip_filename)

    # zip_file_path = os.path.join(settings.MEDIA_ROOT, zip_filename)
    with open(zip_file_path, 'wb') as f:
        f.write(zip_buffer.getvalue())

    DownloadRecord.objects.create(
        user=request.user,
        file_path=zip_filename,
        created_by=request.user.username  
    )

    response = HttpResponse(zip_buffer.getvalue(), content_type='application/zip')
    response['Content-Disposition'] = f'attachment; filename="{zip_filename}"'

    return response

#=============20/08========================
from django.shortcuts import render, redirect, get_object_or_404
from .models import QuestionPaper, Question
from .forms import QuestionPaperForm, QuestionForm
from django.forms import modelformset_factory, inlineformset_factory

def create_question_paper(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name    
        print("branch_id@@@",branch_id)   
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    if request.method == 'POST':
        form = QuestionPaperForm(request.POST)
        if form.is_valid():
            question_paper = form.save()
            question_paper.branch_id = branch_id
            question_paper.save()
            return redirect('add_questions', paper_id=question_paper.id)
    else:
        form = QuestionPaperForm()
    return render(request, 'OnlineExamination/create_question_paper.html', {"create_question_paper": "active",'form': form})



def question_list(request, paper_id):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    question_paper = QuestionPaper.objects.get(id=paper_id,branch_id=branch_id)
    questions = question_paper.questions.filter(branch=branch_id)
    return render(request, 'OnlineExamination/question_list.html', {'questions': questions, 'question_paper': question_paper})


# #===============================================================
# from django.http import JsonResponse
# from django.views.decorators.csrf import csrf_exempt
# import json

# def add_questions(request, paper_id):
#     question_paper = QuestionPaper.objects.get(id=paper_id)
#     print("questionsquestionsquestionsquestions")
#     if request.method == 'POST':
#         data = json.loads(request.body)
#         print("datatdyfct",data)
#         part_count = request.POST.get("part_count")
#         total_questions = request.POST.get("total_questions")
#         formCount = request.POST.get("dataaa")
#         print("part_count",part_count)
#         part_names = request.POST.getlist('part_name')
#         marks_per_question = request.POST.getlist('marks_per_question')
#         marks_total = request.POST.getlist('marks_total')
#         print("marks_total",marks_total,marks_per_question)

#         question_texts = []
#         question_types = []
#         marks_list = []
#         for key in request.POST:
#             if key.startswith("question_text_"):
#                 question_texts.append(request.POST[key])
#             elif key.startswith("question_type_"):
#                 question_types.append(request.POST[key])
#             elif key.startswith("marks_per_que"):
#                 marks_list.append(request.POST[key])

#         print("question_texts",question_texts)
#         print("question_types",question_types)
#         print("marks_list",marks_list)


#         data = request.POST.dict()
#         print("questionsquestions11",data)
#         empty_disc={}
#         for key, value in data.items():
#                 print(f"{key}: {value}")
#                 empty_disc[key]=value
#         print("empty_disc",empty_disc)     
#         for i in range(len(part_names)):
#             part = Part.objects.create(
#                 question_paper=question_paper,
#                 part_name=part_names[i],
#                 per_Question_mark=marks_per_question[i],
#                 total_mark=marks_total[i]
#             )
#             part.save()
#             part_id = part.id
#         # Create the Question record
#         for j in range(len(question_texts)):
#             question = Question.objects.create(
#                 part=part,
#                 question_paper=question_paper,
#                 text=question_texts[j],
#                 question_type=question_types[j],
#                 mark=marks_list[j],
#                 # options=options
#             )

#         # if question_type == 'choice':
#         #             # Assuming options are stored as a string or JSON in the options field
#         #             question.options = json.dumps([
#         #                 {
#         #                     'text': option['text'],
#         #                     'is_correct': option['correct']
#         #                 } for option in options
#         #             ])
#         #             question.save()



#     return render(request, 'OnlineExamination/add_questions.html', {
#         'paper_form': QuestionPaperForm(instance=question_paper),
#         "paper_id":paper_id,
#         'question_formset': []  # Adjust as needed for existing forms
#     })


#===================================================================

from django.http import JsonResponse
from django.views.decorators.csrf import csrf_exempt
import json

def add_questions(request, paper_id):
    
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    question_paper = QuestionPaper.objects.get(id=paper_id,branch_id=branch_id)
    print("questionsquestionsquestionsquestions")
    if request.method == 'POST':
        part_count = request.POST.get("total_part")
        total_questions = request.POST.get(f"total_questions")
        print("part_count55",part_count,total_questions)
     

        for i in range(int(part_count)):
            i+=1
            part_obj = Part.objects.create(
                question_paper=question_paper,
                part_name=request.POST.get(f"part-{i}-name"),
                per_Question_mark=request.POST.get(f"part-{i}-marks-per-question"),
                total_mark=request.POST.get(f"part-{i}-marks-total"),
                branch_id=branch_id
            )
            part_que_count = request.POST.get(f'part-{i}-total-questions')
            print("part_que_count@@@@",part_que_count)
            for j in range(int(part_que_count)):
                que_text=request.POST.get(f"part-{i}-form-{j}-text")
                choice=request.POST.get(f"part-{i}-form-{j}-question_type")
                options=request.POST.getlist(f"part-{i}-form-{j}-option")
                correct_options=request.POST.getlist(f"part-{i}-form-{j}-correct_option")
                mark=request.POST.get(f"part-{i}-form-{j}-marks")
                print("que_text",que_text,choice,options,correct_options,mark)
                # Create a dictionary to hold the options and correct options
                # options_dict = {}

                # # Populate the dictionary
                # for idx, option in enumerate(options):
                #     is_correct = f"{idx+1}" in correct_options
                #     print('karan',f"{idx}" , correct_options)
                #     options_dict[f'option_{idx + 1}'] = {'text': option, 'is_correct': is_correct}
                # print("options_dict===",options_dict)  
                print("----",options,correct_options)
                options_list = []
                # Populate the list
                for idx, option in enumerate(options):
                    is_correct = f"{idx + 1}" in correct_options
                    option_data = {
                        'option': f"option_{idx + 1}",
                        'text': option,
                        'is_correct': is_correct
                    }
                    options_list.append(option_data)
                print("options_list ===", options_list) 
                         
                if choice == 'choice':
                    Question.objects.create(
                        part=part_obj,
                        question_paper=question_paper,
                        text=que_text,
                        question_type="choice",
                        options= options_list,
                        mark=mark,
                        branch_id=branch_id
                    )
                else:
                    Question.objects.create(
                        part=part_obj,
                        question_paper=question_paper,
                        text=que_text,
                        question_type="paragraph",
                        options= None,
                        mark=mark,
                        branch_id=branch_id
                    )                        
              
                print(f'part {i} question {j}QQQQQ, = {que_text}')
                print(f'choice= ,{choice}')
                print(f'optios=== ,{options}')
                print(f'correct_optios= ,{correct_options}')                       
               
    return render(request, 'OnlineExamination/add_questions.html', {
        'paper_form': QuestionPaperForm(instance=question_paper),
        "paper_id":paper_id,
        'question_formset': [] ,"create_question_paper":"active"
        # Adjust as needed for existing formsj
    })


def enrollment(request):
 
    try:
        branch_name = request.session.get('branch_id', None)
        if branch_name:
            branch_id = branch_name       
        else:
            branch_id = None  
            print("branch_name@@@",branch_name)
        records = QuestionPaper.objects.filter(branch=branch_id)       
        context = {"records": records, "enrollment": "active"}
        return render(request, "OnlineExamination/enrollment.html", context)
    except Exception as error:
        return render(request, "error.html", {"error": error})


def question_paper_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "admission_enquiry_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None    
            print("branch_name@@@",branch_name)
            question_paper = QuestionPaper.objects.get(id=pk)
            question_paper_branch_id = question_paper.branch.id
            if int(question_paper_branch_id) == int(branch_id):                        
                QuestionPaper.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/enrollment")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")
    
def enrollment_assign(request,pk):
   
    try:
        branch_name = request.session.get('branch_id', None)
        if branch_name:
            branch_id = branch_name       
        else:
            branch_id = None  
            print("branch_name@@@",branch_name)
        branch_name = request.POST.get("branch_name")
        print('branch_name',branch_name)
       
        # school_id = request.POST.get("school_id")
        # print('school_id',school_id) 
        class_records = Class.objects.filter(branch=branch_id)
        section_records = Section.objects.filter(branch=branch_id)
        question_paper_records = QuestionPaper.objects.get(id=pk)           
        form = EnrollmentForm()
        record = Enrollment.objects.filter(branch=branch_id)
        enrollment_assign = EnrollmentAssign.objects.filter(enrollment__question_paper=question_paper_records)
        print("+++enrollment_assign",enrollment_assign )
        classs = request.POST.getlist("class[]")
        section_ids = request.POST.getlist("selected_sections[]")
        exam_date = request.POST.get("exam_date")
        any_time_value = request.POST.get("any_time")
        any_time = True if any_time_value == "on" else False
        start_time = request.POST.get("start_time")
        allowed_time = request.POST.get("allowed_time")
        email_sent = request.POST.get("email_sent")
        print("+++email_sent", email_sent, )  
        print("+++section_ids",section_ids) 
        print("+++", classs, section_ids, exam_date, any_time, start_time)
        if request.method == "POST":
            record = Enrollment.objects.create(
                question_paper_id=pk,
                exam_date=exam_date,
                any_time=any_time,
                start_time=start_time,
                status="assign",
                allowed_time=allowed_time,
                branch_id=branch_id
            )
            for i in range(len(classs)):               
                
                enrollment_assign = EnrollmentAssign.objects.create(
                    enrollment=record,
                    Class_id=classs[i],
                    branch_id=branch_id,
                    created_by=request.user
                )              
              
                section_list = request.POST.get("selected_sections[]")
                print("section_list===",section_list)

                # Check if section_list is a comma-separated string and split it into a list
                if isinstance(section_list, str):
                    section_list = section_list.split(',')

                # Convert section_ids to a list of integers
                section_list = [int(section_id) for section_id in section_list]
                print("section_list===", section_list)

                # Update the many-to-many relationship
                enrollment_assign.section.set(section_list)  
            classs_id  = [int(c) for c in classs] 
            section_id = [int(s)for s in section_ids]
            print("section_id",section_id)
            student_admission_record=StudentAdmission.objects.filter(Class_id__in=classs_id,section_id__in=section_id,branch_id=branch_id)
            print("student_admission_record",student_admission_record)
            
            if email_sent == "checked" :    
                for data in student_admission_record: 
                    subject = ' Littele Rocker School  Exam Time Table '
                    message = f'''    
                    Dear : {data.first_name}    

                    **New School Format Details:**
                    **Academic Calendar:** Littele Rocker School 
                    **Question paper:** {question_paper_records.question_paper_name}  
                    **Class:** {data.Class.Class}
                    **Section:** {data.section.section_name}
                    **Exam Date:** {record.exam_date}                   
                    **Start Time:** {record.start_time}
                    **Allowed Time:** {record.allowed_time}

                    '''
                    list_mail = [data.email]
                    print("list_mail",list_mail)
                    send_email_notification(
                                subject, message, list_mail
                            )       
           
            messages.success(request, "Record Saved Successfully")
            return redirect(f'/enrollment_assign/{pk}')
        else:
            print("Not comes")
        context = { "school_registration": "active","record":record,"records":question_paper_records,
                   'form':form,"class_records": class_records,"enrollment_assign":enrollment_assign,
                   "section_records": section_records,"enrollment":"active"
                   }
        return render(request, "OnlineExamination/enrollment_assign.html", context)
    except Exception as error:
        return render(request, "error.html", {"error": error})
                           
                           
def enrollment_assign_delete(request,question_paper_id,data_id):
    if request.user.is_superuser or request.user.is_school_admin or "admission_enquiry_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None    
            print("branch_name@@@",branch_name)
            enrollment_assign = EnrollmentAssign.objects.get(id=data_id)
            enrollment_assign = enrollment_assign.branch.id
            if int(enrollment_assign) == int(branch_id):                        
                EnrollmentAssign.objects.get(id=data_id).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect(f'/enrollment_assign/{question_paper_id}')
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")  
    
def enrollment_assign_view(request,question_paper_id,data_id): 
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    class_records = Class.objects.filter(branch=branch_id)
    section_records = Section.objects.filter(branch=branch_id)
    question_paper_records = QuestionPaper.objects.get(id=question_paper_id)
    enrollment_assign = EnrollmentAssign.objects.filter(enrollment__question_paper=question_paper_records)
    record = EnrollmentAssign.objects.get(id=data_id)
    start_time_str = record.enrollment.start_time.strftime('%H:%M') if record.enrollment.start_time else ''
    exam_date_str = record.enrollment.exam_date.strftime('%Y-%m-%d') if record.enrollment.exam_date else ''
    context = {       
        "record": record,
        "admission_enquiry": "active",
        "view": True,
        "records":question_paper_records,
        "class_records": class_records,
        "section_records": section_records,
        "start_time_str":start_time_str,
        "exam_date_str":exam_date_str,
        "enrollment_assign":enrollment_assign
            
    }      
    return render(request, "OnlineExamination/enrollment_assign_view.html", context)


def enrollment_assign_edit(request,question_paper_id,data_id):
   
    try:
        branch_name = request.session.get('branch_id', None)
        if branch_name:
            branch_id = branch_name       
        else:
            branch_id = None  
            print("branch_name@@@",branch_name)
            branch_name = request.POST.get("branch_name")
            print('branch_name',branch_name)
        classs = request.POST.get("class")
        print("classs===",classs)
        selected_sections = request.POST.getlist('selected_sections')
        if isinstance(selected_sections, str):
            selected_sections = selected_sections.split(',')
            # Convert section_ids to a list of integers
            selected_sections = [int(section_id) for section_id in selected_sections]
            print("selected_sections===", selected_sections)           
        exam_date = request.POST.get("exam_date")
        any_time_value = request.POST.get("any_time")
        any_time = True if any_time_value == "on" else False
        start_time = request.POST.get("start_time")
        print("classs===",classs,selected_sections,exam_date,any_time,start_time)
        # school_id = request.POST.get("school_id")
        # print('school_id',school_id) 
        class_records = Class.objects.filter(branch=branch_id)
        section_records = Section.objects.filter(branch=branch_id)
        question_paper_records = QuestionPaper.objects.get(id=question_paper_id)
        enrollment_assign = EnrollmentAssign.objects.filter(enrollment__question_paper=question_paper_records)
        record = EnrollmentAssign.objects.get(id=data_id)
        print("record++++++",record)
        start_time_str = record.enrollment.start_time.strftime('%H:%M') if record.enrollment.start_time else ''
        exam_date_str = record.enrollment.exam_date.strftime('%Y-%m-%d') if record.enrollment.exam_date else ''
        if request.method == "POST":
            record.Class_id = classs
            record.enrollment_id = record.enrollment.id
            record.section.set(selected_sections)
            record.enrollment.exam_date = exam_date
            record.enrollment.any_time = any_time
            record.enrollment.start_time = start_time
            record.enrollment.save()   
            messages.success(request, "Record Saved Successfully")
            return redirect(f'/enrollment_assign/{question_paper_id}')            
            
                          
        context = {       
            "record": record,
            "admission_enquiry": "active",
            "view": True,
            "records":question_paper_records,
            "class_records": class_records,
            "section_records": section_records,
            "start_time_str":start_time_str,
            "exam_date_str":exam_date_str,
            "enrollment_assign":enrollment_assign
                
        }      
          
        return render(request, "OnlineExamination/enrollment_assign_edit.html", context)
    except Exception as error:
        return render(request, "error.html", {"error": error})
    
    
def question_paper_sent(request):
 
    try:
        branch_name = request.session.get('branch_id', None)
        if branch_name:
            branch_id = branch_name  
            print("branch_name@@@",branch_name)     
        else:
            branch_id = None  
        class_records = Class.objects.filter(branch=branch_id)
        section_records = Section.objects.filter(branch=branch_id)
        
        records = QuestionPaper.objects.filter(branch=branch_id)
        print("records",records)
        for data in records:
            date_value=Enrollment.objects.filter(question_paper=data)   
        
        context = {"records": records,"class_records":class_records,
                   "section_records":section_records,
                   "question_paper_sent": "active"}
        return render(request, "OnlineExamination/question_models.html", context)
    except Exception as error:
        return render(request, "error.html", {"error": error})    
                            
def online_exam_assign(request,pk):
 
    try:      
        branch_name = request.session.get('branch_id', None)
        if branch_name:
            branch_id = branch_name       
        else:
            branch_id = None  
            print("branch_name@@@",branch_name)
            
        student_answer = AnswerPeperSubmit.objects.filter(student_answers=pk)
        # total_value = 0
        # single_value = []
        # for data in student_answer:
        #     # Calculate the value based on data.questiones.mark
        #     value_calculate = data.questiones.question_type
        #     if value_calculate == "choice":
        #        records=data.questiones.mark
        #        single_value.append(records)
        #     # Accumulate the total value
        #     # total_value += value_calculate

        # # Print the total value
        # print("records", single_value) 
        # print("Total value:", value_calculate)
        print("student_answer+++",student_answer)
        final_mark=request.POST.get('final_mark')
        pass_mark=request.POST.get('pass_mark')
        print("pass_mark",pass_mark)
        print("final_mark",type(final_mark))
        paragraph_value=request.POST.get('paragraph_value')
        paragraph_mark = int(paragraph_value) if paragraph_value else 0
        final_marks = int(final_mark) if final_mark else 0
        print("paragraph_value",type(paragraph_value))
        total_marks = paragraph_mark+final_marks
        if request.method == "POST":
            for question_id in student_answer:
                print("question_id+++",question_id.questiones.id)
                # Get the option from the request.POST dictionary for each question
                selected_option = request.POST.get(f"option_{question_id.questiones.id}")

                print("selected_option",selected_option)    
                
                
                question_id.student_answers = question_id.student_answers
                question_id.questiones = question_id.questiones             
                question_id.options = selected_option
                question_id.mark = question_id.questiones.mark
                question_id.validation = True
                question_id.branch_id = branch_id
                question_id.save()
            if int(pass_mark) < total_marks:
                PaperCorrection.objects.create(
                    student_id=question_id.student_answers.student.id,
                    question_paper=question_id.questiones.question_paper,  # Assuming 'questiones' refers to the question instance
                    total_mark=total_marks,  # Save the selected option directly
                    is_pass=True,
                    branch_id=branch_id
                )
            else:   
                PaperCorrection.objects.create(
                    student_id=question_id.student_answers.student.id,                   
                    question_paper=question_id.questiones.question_paper,  # Assuming 'questiones' refers to the question instance
                    total_mark=total_marks,  # Save the selected option directly
                    is_pass=False,
                    branch_id=branch_id
                )     
            
              
        
        for data in student_answer:
            record=data.questiones.question_paper
        single_value=QuestionPaper.objects.filter(id=record.id).last()
        print("single_value",single_value) 
        
        
        
            
        
        # total_mark = AnswerPeperSubmit.objects.filter(questiones=         
           
        context = {
                   "questions":student_answer,"single_value":single_value,
                   "question_models": "active"}
        return render(request, "OnlineExamination/online_exam_assign.html", context)
    except Exception as error:
        return render(request, "error.html", {"error": error})   
    
    
def answer_paper_correction(request):  
    try:
        branch_name = request.session.get('branch_id', None)
        if branch_name:
            branch_id = branch_name  
            print("branch_name@@@",branch_name)     
        else:
            branch_id = None  
        class_records = Class.objects.filter(branch=branch_id)
        section_records = Section.objects.filter(branch=branch_id)

        if request.method == "POST":
            classs = request.POST.get("class")
            section = request.POST.get("section")
            filters = {}
            
            if classs:
                filters["Class_id"] = classs 

            if section:
                filters["section"] = section
            
            if branch_id:
                filters["branch_id"] = branch_id  
            
            print("filters+++", filters)
            try:
                records = EnrollmentAssign.objects.get(**filters)
            except EnrollmentAssign.DoesNotExist:
                records = None

            if records:  # Ensure records exist before proceeding
                try:
                    en_rollment = Enrollment.objects.get(id=records.enrollment.id)
                except Enrollment.DoesNotExist:
                    en_rollment = None
            else:
                en_rollment = None

            if en_rollment:  # Ensure en_rollment exists before accessing question_paper
                try:
                    student_answers = StudentAnswers.objects.filter(question_paper=en_rollment.question_paper)
                except StudentAnswers.DoesNotExist:
                    student_answers = None
            else:
                student_answers = None
            print("student_answers----", student_answers)
                          
           
            context = {       
                    "answer_paper_correction": "active",
                    "class_records":class_records,
                    "section_records":section_records,
                    "student_answers":student_answers
                    
                    
                    }
            return render(request, "OnlineExamination/answer_paper_correction.html", context)  
        context = {       
                   "answer_paper_correction": "active",
                   "class_records":class_records,
                   "section_records":section_records,
                  
                   
                   
                   }
        return render(request, "OnlineExamination/answer_paper_correction.html", context)
    except Exception as error:
        return render(request, "error.html", {"error": error})  
    
    
@login_required
@user_type_required("Staff")  
def curreny(request):
    try:
        token = request.session['user_token']
        branch_name = request.session.get('branch_id', None)
        if branch_name:
            branch_id = branch_name       
        else:
            branch_id = None    
        print("branch_name@@@",branch_name)
        endpoint = 'finance/currency/'
        records = sub_part_Currency.objects.filter(branch=branch_id)
        form = CurrencyForm()
        if request.method == "POST":
            form = CurrencyForm(request.POST)
            if form.is_valid():   
                # currency_id=form.cleaned_data['currency_id']  
                # currency_unique = unique_id("CAD", currency_id)  
                # print("currency_unique",currency_unique)            
                data = {
                'currency_name' : form.cleaned_data['currency_name'],
                'symbol':form.cleaned_data['symbol'],
                'currency_code':form.cleaned_data['currency_code'],
                }
                print("++++++++++++++++++",data)                        
                json_data = json.dumps(data) 
                print("=========",json_data)                    
                response = call_post_method(BASE_URL,endpoint,json_data,token)
                print("response",response)
                if response.status_code != 200:              
                    print('Response Status Code:', response.content)
                response_data = json.loads(response.content.decode('utf-8'))    
                sub_part_Currency.objects.create(                  
                currency_name=form.cleaned_data['currency_name'], 
                symbol=form.cleaned_data['symbol'],
                currency_code=form.cleaned_data['currency_code'], 
                reference_id=response_data['record_id'],
                branch_id = branch_id
                )  
                messages.success(request, "Record Saved Successfully")
                return HttpResponseRedirect("/curreny")
            else:
                print("errors",form.errors)
                messages.success(request,form.errors)
                return HttpResponseRedirect("/curreny")
        context = {"form": form, "records": records, "curreny": "active"}
        return render(request, "System_setting/curreny.html", context)
    except Exception as error:
        return render(request, "error.html", {"error": error})
                                     


@login_required
@user_type_required("Staff")
def curreny_edit(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "meeting_link_masters_edit" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None    
            print("branch_name@@@",branch_name)
            records = MeetingLinkMaster.objects.filter(branch=branch_id)
            record = MeetingLinkMaster.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = MeetingLinkMasterForm(instance=record)
            if request.method == "POST":
                form = MeetingLinkMasterForm(request.POST, instance=record)
                if form.is_valid():
                    if branch_id == data_branch_id:
                        # Save the form with from_school_id
                        form.save()
                    else:
                        # Save the form with the session value
                        form.instance.branch_id = branch_id
                    form.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/meeting_link_master")
            context = {
                "form": form,
                "records": records,
                "meeting_link_master": "active",
                "edit": True,
            }
            return render(request, "Livesession/meeting_link_master_edit.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def curreny_view(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "meeting_link_masters_view" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = MeetingLinkMaster.objects.filter(branch=branch_id)
            record = MeetingLinkMaster.objects.get(id=pk)
            form = MeetingLinkMasterForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "meeting_link_master": "active",
                "view": True,
            }
            return render(request, "Livesession/meeting_link_master.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def curreny_delete(request, pk):
    if request.user.is_superuser or request.user.is_school_admin or "meeting_link_masters_delete" in request.permissions:
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
            meeter_link=MeetingLinkMaster.objects.get(id=pk)
            meeter_branch_id = meeter_link.branch.id
            if int(meeter_branch_id) == int(branch_id):                        
                MeetingLinkMaster.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/meeting_link_master")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard") 
    
    
@login_required 
def add_curreny(request):
    # if (
    #     request.user.is_superuser or request.user.is_school_admin
    #     or "meeting_link_master_view" in request.permissions
    #     or "meeting_link_master_add" in request.permissions
    # ):
        try:
            token = request.session['user_token']
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None    
            print("branch_name@@@",branch_name)
            endpoint = 'finance/currency/'
            records = sub_part_Currency.objects.filter(branch=branch_id)
            form = CurrencyForm()
            if request.method == "POST":
                form = CurrencyForm(request.POST)
                if form.is_valid():   
                    # currency_id=form.cleaned_data['currency_id']  
                    # currency_unique = unique_id("CAD", currency_id)  
                    # print("currency_unique",currency_unique)            
                    data = {
                    'currency_name' : form.cleaned_data['currency_name'],
                    'symbol':form.cleaned_data['symbol'],
                    'currency_code':form.cleaned_data['currency_code'],
                    }
                    print("++++++++++++++++++",data)                        
                    json_data = json.dumps(data)
                    print("=========",json_data)                    
                    response = call_post_method(BASE_URL,endpoint,json_data,token)
                    print("response",response)
                    if response.status_code != 200:              
                        print('Response Status Code:', response.content)
                    else:
                        print('Response Status Code:', response.content)
                    response_data = json.loads(response.content.decode('utf-8'))  
                    print('response_data', response_data['record_id'])  
                    sub_part_Currency.objects.create(                  
                    currency_name=form.cleaned_data['currency_name'], 
                    symbol=form.cleaned_data['symbol'],
                    currency_code=form.cleaned_data['currency_code'], 
                    reference_id=response_data['record_id'],
                    branch = branch_id 
                    )  
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/create_school_registration")
                else:
                    print("errors",form.errors)
                    messages.success(request,form.errors)
                    return HttpResponseRedirect("/create_school_registration")
            context = {"form": form, "records": records, "curreny": "active"}
            return render(request, "System_setting/add_curreny.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    # else:
    #     return redirect("dashboard")         

@login_required
# @user_type_required("Staff")
def accouting_report(request):
    # if request.user.is_superuser or request.user.is_school_admin or "student_report_view" in request.permissions:
        try:       
            token = request.session['user_token']
            print("token---",token)
            endpoint = '/txn-reports/date-wise/'

            if request.method == "POST":
                from_date = request.POST.get("from_date")
                to_date = request.POST.get("to_date")
                data  = {
                    'start_date': from_date,
                    'end_date': to_date,                    
                }
                print("++++++++++++++++++")

                json_data = json.dumps(data)
                print("=========", json_data)
                print("BASE_URL",BASE_URL)  
                print("endpoint",endpoint)  
                response = call_post_method(BASE_URL, endpoint, json_data, token)
                print("response+++value", response)
                transaction_details = response.json()
                print("transaction_details",transaction_details)
                for item in transaction_details:
                # Convert date string to desired format and append to change_dates list
                    item['entry_date'] = datetime.strptime(item['entry_date'], '%Y-%m-%dT%H:%M:%S.%fZ').strftime('%Y-%m-%d %H:%M:%S')
                if response.status_code != 200:
                    print('Response Status Code:value1', response.content)
                else:
                    print('Response Status Code:value', response.content)      
                context = {
                    "accouting_report": "active","transaction_details":transaction_details
                }
                return render(request, "Reports/accouting_report.html", context)
            context = {
                "student_information_report": "active",
            }
            return render(request, "Reports/accouting_report.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    # else:
    #     return redirect("dashboard")    

# @login_required
# # @user_type_required("Staff")
# def accouting_details_report(request):
#     if request.user.is_superuser or request.user.is_school_admin or "student_report_view" in request.permissions:
#         try:
#             endpoint = '/txn-reports/custom-transaction-details-by-txn-id/'
#             transaction_id = request.POST.get("transaction_id")
#             print("transaction_id",transaction_id)  
#             if request.method == "POST":
#                 transaction_id = request.POST.get("transaction_id")
#                 print("transaction_id",transaction_id)            
#                 data = {
#                     'transaction_id': transaction_id,
                                     
#                 }
#                 print("++++++++++++++++++")

#                 json_data = json.dumps(data)
#                 print("=========", json_data)
               
#                 response = call_post_method(BASE_URL, endpoint, json_data, access_token)
#                 print("response+++", response)
#                 if response.status_code != 200:
#                     print('Response Status Code:', response.content)
#                 else:
#                     print('Response Status Code:', response.content)  

#                 context = {
#                     "accouting_report": "active",
                 
#                 }

#                 return render(request, "Reports/accouting_details_report.html", context)

#             context = {
#                 "student_information_report": "active",
                
#             }

#             return render(request, "Reports/accouting_details_report.html", context)
#         except Exception as error:
#             return render(request, "error.html", {"error": error})
#     else:
#         return redirect("dashboard")      
    
@login_required
# @user_type_required("Staff")
def accouting_more_details(request,transaction_id):
    # if request.user.is_superuser or request.user.is_school_admin or "student_report_view" in request.permissions:
    #     try:
                token = request.session['user_token']
                endpoint = '/txn-reports/custom-transaction-details-by-txn-id/'
                
                print("transaction_id------",transaction_id)  
            
                data = {
                    'transaction_id': transaction_id                                     
                }
                print("++++++++++++++++++")

                json_data = json.dumps(data)
                print("=========", json_data)
               
                response = call_post_method(BASE_URL, endpoint, json_data, token)
                print("response+++",response)
                more_details = response.json()
                print("transation_more_details",more_details)
                
                # Convert date string to desired format and append to change_dates list

                if response.status_code != 200:
                    print('Response Status Code:value1', response.content)
                else:
                    print('Response Status Code:value', response.content)   

                context = {
                    "accouting_report": "active","transation_more_details":more_details
                 
                }

                return render(request, "Reports/accouting_more_details.html", context)

            #     except Exception as error:
    #         return render(request, "error.html", {"error": error})
    # else:
    #     return redirect("dashboard")     

@login_required
# @user_type_required("Staff")
def accouting_details_report(request):
    if request.user.is_superuser or request.user.is_school_admin or "student_report_view" in request.permissions:
        try:
            token = request.session['user_token'] 
            endpoint = '/txn-reports/trail-balance-report/'

            if request.method == "POST":
                from_date = request.POST.get("from_date")
                to_date = request.POST.get("to_date")
                print("to_date====",to_date)
                data = {
                    'start_date': from_date,
                    'end_date': to_date,                    
                }
                print("++++++++++++++++++")

                json_data = json.dumps(data)
                print("=========", json_data)
                print("BASE_URL",BASE_URL)  
                print("endpoint",endpoint)  
                response = call_post_method(BASE_URL, endpoint, json_data, token)
                print("response+++value", response)
                transaction_details = response.json()
                print("transaction_details",transaction_details)
                # for item in transaction_details:
                # # Convert date string to desired format and append to change_dates list
                #     item['entry_date'] = datetime.strptime(item['entry_date'], '%Y-%m-%dT%H:%M:%S.%fZ').strftime('%Y-%m-%d %H:%M:%S')
                if response.status_code != 200:
                    print('Response Status Code:value1', response.content)
                else:
                    print('Response Status Code:value', response.content)  

                context = {
                    "accouting_report": "active","transaction_details":transaction_details
                 
                }

                return render(request, "Reports/accouting_details_report.html", context)

            context = {
                "student_information_report": "active",
                
            }

            return render(request, "Reports/accouting_details_report.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard") 
    
@login_required
# @user_type_required("Staff")
def accouting_ledger(request):
    # if request.user.is_superuser or request.user.is_school_admin or "student_report_view" in request.permissions:
        try:       
            token = request.session['user_token'] 
            endpoint ="/txn-reports/general-ledger-with-diff-sub-ledger/"
            print("BASE_URL",BASE_URL)  
            print("endpoint",endpoint)  
            response = call_get_method(BASE_URL,endpoint,token)
            print("response+++", response)
            
            accouting_ledger = response.json()
            print("accouting_ledger+++", accouting_ledger)
            # print("accouting_ledger", accouting_ledger)

            # Extract 'name' and 'transaction_type_id' into a list of dictionaries
            for item in accouting_ledger:
                print("item+++", item)
                # Convert date string to both date and time format
                item['transaction_date'] = datetime.strptime(item['transaction_date'], '%Y-%m-%dT%H:%M:%S.%fZ').strftime('%Y-%m-%d %H:%M:%S')
            # print("transaction_list", transaction_list)
            
            # if response.status_code != 200:
            #     print('Response Status Code:value1', response.content)
            # else:
            #     print('Response Status Code:value', response.content)      
            context = {
                "accouting_report": "active",
                "record":accouting_ledger
            }
            return render(request, "Reports/accouting_ledger.html", context)
           
        except Exception as error:
            return render(request, "error.html", {"error": error})
    # else:
    #     return redirect("dashboard")  
    

@login_required
# @user_type_required("Staff")
def statement_cashflow(request):
    # if request.user.is_superuser or request.user.is_school_admin or "student_report_view" in request.permissions:
        try:       
            token = request.session['user_token'] 
            endpoint = '/txn-reports/statement-of-cashflow/'

            response = call_get_method(BASE_URL, endpoint, token)
            statement_cashflow = response.json()
            print("statement_cashflow", statement_cashflow)
            for item in statement_cashflow:
                # Convert date string with time and timezone to 'YYYY-MM-DD' format (date only)
                item['last_updated_at'] = datetime.strptime(item['last_updated_at'], '%Y-%m-%dT%H:%M:%S.%fZ').strftime('%Y-%m-%d')
            # Extract 'name' and 'transaction_type_id' into a list of dictionaries
            # transaction_list = [{'name': item['name'], 'transaction_type_id': item['transaction_type_id']} for item in transaction_data]

            if response.status_code != 200:
                return render(request, 'error500.html', {'error': str(response.json())})     
                
            context = {
                "student_information_report": "active","statement_cashflow":statement_cashflow
            }
            return render(request, "Reports/statement_cashflow.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    # else:
    #     return redirect("dashboard")   
    

@login_required
# @user_type_required("Staff")
def statement_payment(request):
    # if request.user.is_superuser or request.user.is_school_admin or "student_report_view" in request.permissions:
        try:       
            token = request.session['user_token'] 
            endpoint = '/finance/accounts/'
            endpoint_transaction = '/finance/funds-transfer/'
            endpoint_transaction_type = 'finance/transaction-type/'
            
            response_transaction_type = call_get_method(BASE_URL, endpoint_transaction_type, token)
            transaction_data = response_transaction_type.json()
            print("transaction_data", transaction_data)

            # Extract 'name' and 'transaction_type_id' into a list of dictionaries
            transaction_list = [{'name': item['name'], 'transaction_type_id': item['transaction_type_id']} for item in transaction_data]
            
            if response_transaction_type.status_code != 200: 
                return render(request, 'error500.html', {'error': str(response_transaction_type.json())}) 
            
            payroll_transaction = next((transaction for transaction in transaction_list if transaction['name'] == 'Funds Transfer'), None)
            if payroll_transaction:
                transaction_name = payroll_transaction['name']
                transaction_type_id = payroll_transaction['transaction_type_id']
                print("Transaction Name:", transaction_name)
                print("Transaction Type ID:", transaction_type_id)
            else:
                print("No 'Payroll' transaction found.")
            response_accounts = call_get_method(BASE_URL, endpoint, token)
            account_number = response_accounts.json()
            print("account_number++++----", account_number)
      
                # Convert date string in 'YYYY-MM-DD' format to desired format (date only)
            account_list = [{'account_number': item['account_number'], 'account_id': item['account_id'],'total_balance': item['total_balance']} for item in account_number]
            # Extract 'name' and 'transaction_type_id' into a list of dictionaries
            # transaction_list = [{'name': item['name'], 'transaction_type_id': item['transaction_type_id']} for item in transaction_data]

            if response_accounts.status_code != 200: 
                return render(request, 'error500.html', {'error': str(response_accounts.json())})   

            if request.method == "POST":
                amount = request.POST.get("amount")
                from_account_user = request.POST.get("from_account")
                to_account_user = request.POST.get("to_account")
                print("amount---",amount,from_account_user,to_account_user)                
            
                data = {
                        'from_account_no': str(from_account_user),
                        'to_account_no': str(to_account_user),
                        'amount': int(amount),
                        'transaction_type': str(transaction_type_id) 
                    }

                json_data = json.dumps(data)
                print("=========", json_data)

                response = call_post_method(BASE_URL, endpoint_transaction, json_data, token)
                print("response+++", response)
                response_accounts = call_get_method(BASE_URL, endpoint, token)
                account_number = response_accounts.json()
                print("account_number++++----", account_number)
        
                    # Convert date string in 'YYYY-MM-DD' format to desired format (date only)
                account_list = [{'account_number': item['account_number'], 'account_id': item['account_id']} for item in account_number]
                
                response_accounts = call_get_method(BASE_URL, endpoint, token)
                account_number = response_accounts.json()
                print("account_number++++----", account_number)
        
                    # Convert date string in 'YYYY-MM-DD' format to desired format (date only)
                account_list = [{'account_number': item['account_number'], 'account_id': item['account_id'],'total_balance': item['total_balance']} for item in account_number]
                
                if response.status_code != 200:
                    # Decode the byte response to string and then load it as JSON
                    response_data = json.loads(response.content.decode('utf-8'))

                    # Access the message from the JSON response
                    error_message = response_data.get('message', 'An error occurred')
                    
                    # Print the response content for debugging
                    print('Response Content:', response.content)
                    
                    # Check the status and message in the JSON response
                    if response_data.get("status") == "Success" and response_data.get("message") == "Its Success":
                        messages.success(request, response_data.get("message"))
                        context = {
                            "statement_payment": "active","account_list":account_list,"account_number":account_number
                             }
                        return render(request, "Reports/statement_payment.html",context)  
                    else:
                        messages.error(request, error_message)              
                
                        context = {
                                "statement_payment": "active","account_list":account_list,"account_number":account_number
                                }
                        return render(request, "Reports/statement_payment.html",context)          
                
            context = {
                "statement_payment": "active","account_list":account_list,"account_number":account_number
            }
            return render(request, "Reports/statement_payment.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    # else:
    #     return redirect("dashboard")   
    
@login_required
# @user_type_required("Staff")
def statement_receipt(request):
    # if request.user.is_superuser or request.user.is_school_admin or "student_report_view" in request.permissions:
        try:       
            token = request.session['user_token'] 
            endpoint = '/txn-reports/statement-of-receipt/'

            response = call_get_method(BASE_URL, endpoint, token)
            statement_receipt = response.json()
            print("statement_receipt", statement_receipt)
            for item in statement_receipt:
                # Convert date string in 'YYYY-MM-DD' format to desired format (date only)
                item['last_updated_at'] = datetime.strptime(item['last_updated_at'], '%Y-%m-%d').strftime('%Y-%m-%d')
            # Extract 'name' and 'transaction_type_id' into a list of dictionaries
            # transaction_list = [{'name': item['name'], 'transaction_type_id': item['transaction_type_id']} for item in transaction_data]

            if response.status_code != 200: 
                return render(request, 'error500.html', {'error': str(response.json())})     
                
            context = {
                "student_information_report": "active","statement_receipt":statement_receipt
            }
            return render(request, "Reports/statement_receipt.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    # else:
    #     return redirect("dashboard")     
    
    
@login_required
# @user_type_required("Staff")
def trail_balance_report(request):
    # if request.user.is_superuser or request.user.is_school_admin or "student_report_view" in request.permissions:
        try:       
            token = request.session['user_token']
            print("token---",token)
            endpoint = '/txn-reports/trail-balance-report/'

            if request.method == "POST":
                from_date = request.POST.get("from_date")
                to_date = request.POST.get("to_date")
                data  = {
                    'start_date': from_date,
                    'end_date': to_date,                    
                }
                print("++++++++++++++++++")

                json_data = json.dumps(data)
                print("=========", json_data)
                print("BASE_URL",BASE_URL)  
                print("endpoint",endpoint)  
                response = call_post_method(BASE_URL, endpoint, json_data, token)
                print("response+++value", response)
                trail_balance = response.json()
                print("trail_balance",trail_balance)
 
                if response.status_code != 200:
                    print('Response Status Code:value1', response.content)
                else:
                    print('Response Status Code:value', response.content)      
                context = {
                    "trail_balance_report": "active","trail_balance":trail_balance
                }
                return render(request, "Reports/trail_balance_report.html", context)
            context = {
                "trail_balance_report": "active",
            }
            return render(request, "Reports/trail_balance_report.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    # else:
    #     return redirect("dashboard") 
    
    
@login_required
# @user_type_required("Staff")
def payable_listing(request):
    # if request.user.is_superuser or request.user.is_school_admin or "student_report_view" in request.permissions:
    #     try:       
            token = request.session['user_token'] 
            endpoint ="/txn-reports/payable-listing/"
            print("BASE_URL",BASE_URL)  
            print("endpoint",endpoint)  
            response = call_get_method(BASE_URL,endpoint,token)
            print("response+++", response)
            
            payable_listing = response.json()
            print("payable_listing+++", payable_listing)
            # print("payable_listing", payable_listing)

            # Extract 'name' and 'transaction_type_id' into a list of dictionaries
            for item in payable_listing:
                print("item+++", item)
                # Convert date string to both date and time format
                item['transaction_date'] = datetime.strptime(item['transaction_date'], '%Y-%m-%dT%H:%M:%S.%fZ').strftime('%Y-%m-%d %H:%M:%S')
            # print("transaction_list", transaction_list)
            
            # if response.status_code != 200:
            #     print('Response Status Code:value1', response.content)
            # else:
            #     print('Response Status Code:value', response.content)      
            context = {
                "accouting_report": "active",
                "record":payable_listing
            }
            return render(request, "Reports/payable_listing.html", context)
           
    #     except Exception as error:
    #         return render(request, "error.html", {"error": error})
    # else:
    #     return redirect("dashboard")             
    

@login_required
# @user_type_required("Staff")
def receivable_listing(request):
    # if request.user.is_superuser or request.user.is_school_admin or "student_report_view" in request.permissions:
    #     try:       
            token = request.session['user_token'] 
            endpoint ="/txn-reports/receivable-listing/"
            print("BASE_URL",BASE_URL)  
            print("endpoint",endpoint)  
            response = call_get_method(BASE_URL,endpoint,token)
            print("response+++", response)
            
            receivable_listing = response.json()
            print("receivable_listing+++", receivable_listing)
            # print("receivable_listing", receivable_listing)

            # Extract 'name' and 'transaction_type_id' into a list of dictionaries
            for item in receivable_listing:
                print("item+++", item)
                # Convert date string to both date and time format
                item['transaction_date'] = datetime.strptime(item['transaction_date'], '%Y-%m-%dT%H:%M:%S.%fZ').strftime('%Y-%m-%d %H:%M:%S')
            # print("transaction_list", transaction_list)
            
            # if response.status_code != 200:
            #     print('Response Status Code:value1', response.content)
            # else:
            #     print('Response Status Code:value', response.content)      
            context = {
                "accouting_report": "active",
                "record":receivable_listing
            }
            return render(request, "Reports/receivable_listing.html", context)
           
    #     except Exception as error:
    #         return render(request, "error.html", {"error": error})
    # else:
    #     return redirect("dashboard")    
    
    
@login_required
# @user_type_required("Staff")
def statement_changes_in_equity(request):
    if request.user.is_superuser or request.user.is_school_admin or "student_report_view" in request.permissions:
        try:       
            token = request.session['user_token'] 
            endpoint ="/txn-reports/statement-of-changes_in_equity"
            print("BASE_URL",BASE_URL)  
            print("endpoint",endpoint)  
            response = call_get_method(BASE_URL,endpoint,token)
            print("response+++", response)
            
            statement_changes_in_equity = response.json()
            print("statement_changes_in_equity+++", statement_changes_in_equity)
            # print("statement_changes_in_equity", statement_changes_in_equity)

            # Extract 'name' and 'transaction_type_id' into a list of dictionaries
            for item in statement_changes_in_equity:
                print("item+++", item)
                
                # Ensure item is a dictionary and contains the 'date' key
                if isinstance(item, dict) and 'date' in item:
                    # Check if the date string contains time
                    try:
                        # Try parsing as full datetime (with time)
                        item['date'] = datetime.strptime(item['date'], '%Y-%m-%dT%H:%M:%S.%fZ').strftime('%Y-%m-%d %H:%M:%S')
                    except ValueError:
                        # If no time part, treat it as just a date and add '00:00:00' as time
                        item['date'] = datetime.strptime(item['date'], '%Y-%m-%d').strftime('%Y-%m-%d %H:%M:%S')

                    print("Formatted date:", item['date'])
                else:
                    print("Invalid item format or missing 'date' key:", item)
            # print("transaction_list", transaction_list)
            
            # if response.status_code != 200:
            #     print('Response Status Code:value1', response.content)
            # else:
            #     print('Response Status Code:value', response.content)      
            context = {
                "accouting_report": "active",
                 "record": statement_changes_in_equity["equity_changes"]
            }
            return render(request, "Reports/statement_changes_in_equity.html", context)
           
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")     
    
    
@login_required
# @user_type_required("Staff")
def statement_financial_position(request):
    # Check user permissions (optional, based on your needs)
    # if request.user.is_superuser or request.user.is_school_admin or "student_report_view" in request.permissions:

    try:       
        # Extract the token and set up the endpoint
        token = request.session['user_token'] 
        endpoint = "/txn-reports/statement-of-financial-position/"
        print("BASE_URL", BASE_URL)  
        print("endpoint", endpoint)  

        # Make the API call
        response = call_get_method(BASE_URL, endpoint, token)
        print("Response status code:", response.status_code)
        
        # Parse JSON response
        statement_financial_position = response.json()
        print("Statement of Financial Position:", statement_financial_position)

        # Extract data for date, liabilities, assets, and equity
        date = statement_financial_position.get('date')
        liabilities = statement_financial_position.get('liabilities', [])
        assets = statement_financial_position.get('assets', [])
        equity = statement_financial_position.get('equity', [])
        total_assets = statement_financial_position.get('total_assets', 0.0)
        total_liabilities = statement_financial_position.get('total_liabilities', 0.0)
        total_equity = statement_financial_position.get('total_equity', 0.0)

        # Log individual liabilities, assets, and equity details
        print(f"Date: {date}")
        print("Liabilities:")
        for item in liabilities:
            print(f"  Account Number: {item.get('account_number')}, Amount: {item.get('amount')}")

        print("Assets:")
        for item in assets:
            print(f"  Account Number: {item.get('account_number')}, Amount: {item.get('amount')}")

        print("Equity:")
        for item in equity:
            print(f"  Account Number: {item.get('account_number')}, Amount: {item.get('amount')}")

        # Prepare context for rendering the template
        context = {
            "accounting_report": "active",
            "date": date,
            "liabilities": liabilities,
            "assets": assets,
            "equity": equity,
            "total_assets": total_assets,
            "total_liabilities": total_liabilities,
            "total_equity": total_equity,
        }
        return render(request, "Reports/statement_financial_position.html", context)
      
    except Exception as error:
        return render(request, "error.html", {"error": error})
    # else:
    #     return redirect("dashboard")      
    
    
@login_required
# @user_type_required("Staff")
def budget_forecast(request):
    # if request.user.is_superuser or request.user.is_school_admin or "student_report_view" in request.permissions:
    try:
        token = request.session['user_token'] 
        endpoint = "/txn-reports/budget-and-forecast/"
        print("BASE_URL", BASE_URL)  
        print("endpoint", endpoint)  
        response = call_get_method(BASE_URL, endpoint, token)
        print("response+++", response)
                
        budget_forecast = response.json()
        print("budget_forecast+++", budget_forecast)
        
        # Initialize total variables
        total_actual = 0
        total_budget = 0
        total_forecast = 0

        # Loop through the actual_vs_budget_data
        for item in budget_forecast['actual_vs_budget_data']:
            print("Item type:", type(item))  # Check type of each item
            
            # Accumulate the values
            total_actual += item.get('actual', 0)
            total_budget += item.get('budget', 0)
            total_forecast += item.get('forecast', 0)

            print(f"Account Number: {item.get('account_number')}")
            print(f"Actual: {item.get('actual')}, Budget: {item.get('budget')}, Forecast: {item.get('forecast')}")
        
        # Prepare context for rendering
        context = {
            "accouting_report": "active",
            "record": budget_forecast.get("actual_vs_budget_data", []),  # Actual data for the template
            'total_actual': total_actual,
            'total_budget': total_budget,
            'total_forecast': total_forecast,
        }

        # Render the template with the context
        return render(request, "Reports/budget_forecast.html", context)
           
    except Exception as error:
            return render(request, "error.html", {"error": error})
    # else:
    #     return redirect("dashboard")                     
                                      


@login_required
@user_type_required("Staff")
def collect_fees_edit(request,uniqueid,pk):
    # print(f"is superuser {request.user.is_superuser or request.user.is_school_admin}")
    # if (request.user.is_superuser or request.user.is_school_admin or "collect_fees_add" in request.permissions):
    #     try:
            print("uniqueid---",uniqueid)
            print("pk---",pk)
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name   
                print("branch_name@@@",branch_name)    
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
          
            if request.method == "POST":
                records = StudentAdmission.objects.get(id=pk)
                print("records+++",records)
                payment_mode_fee = request.POST.get("payment_mode_fee")
                amount_discount = request.POST.get("amount_discount")
                amount_fine = request.POST.get("amount_fine")
                amount = request.POST.get("amount")
                payment_date = request.POST.get("payment_date")
                fees_idd = request.POST.get("fees_idd") 
                print("amount,percentage---",amount,payment_date,amount_discount,amount_discount,amount_fine,uniqueid,fees_idd)                
            
                updatefess=StudentFess.objects.get(id=uniqueid,session=request.Session,branch_id = branch_id)
                print("updatefess---",updatefess)
                updatefess.student_id=pk     
                updatefess.created_at=payment_date         
                updatefess.payment_mode_fee=payment_mode_fee
                updatefess.amount_discount=amount_discount
                updatefess.amount_fine=amount_fine           
                updatefess.status="Paid"          
                updatefess.paid_amount = amount                 
                updatefess.save()
                
                fees_record = FeesAssign.objects.get(id=fees_idd)
                   
                
                fees_record.paid_amount = int(fees_record.paid_amount) + int(amount)
                if fees_record.balance_amount == None:
                    balance = (
                        int(fees_record.fees.amount)
                        - int(amount)
                        - int(amount_discount)
                    )
                    paid = fees_record.paid_amount
                else:
                    balance = (
                        int(fees_record.balance_amount)
                        - int(amount)
                        - int(amount_discount)
                    )
                    paid = int(fees_record.paid_amount) + int(amount)
                fees_record.balance_amount = balance
                # fees_record.paid_amount=paid
                if balance == 0:
                    fees_record.status = "fully paid"
                else:
                    fees_record.status = "partially paid"
                fees_record.save()

                # for student in records:
                if records.branch is not None:
                    # Retrieve the user-inputted amount from the form
                    # fee_amount = request.POST.get(f"fee_amount_{records.id}")
                    print("amount", amount)
                    fee_amount = amount
                    # Ensure fee_amount is not None and is a valid number
                    if fee_amount is not None and fee_amount.isdigit():
                        fee_amount = int(fee_amount)
                    else:
                        print(f"Invalid fee amount for student {records.id}")
                        # Handle the error or return an appropriate response

                    # Collect fees from student and credit it to the school
                    # success = collect_school_fees(request,records, fee_amount)
                    # Assuming you have the student and fee_amount variables defined earlier in your code
                    success = collect_school_fees(
                        records_id=records.id,
                        fee_amount=fee_amount,
                        user_id=request.user.id,
                    )

                    if success:
                        print(f"Fee collected for student {records.id}")
                    else:
                        print(f"Failed to collect fee for student {records.id}")
                return HttpResponseRedirect(f"/collect_fees_detail/{pk}")
                
            context = {
                "collect_fees": "active",
              
            }

            return render(request, "Fees_Collection/collect_fees.html", context)
    #     except Exception as error:
    #         print(f"error {error}")
    #         return render(request, "error.html", {"error": error})
    # else:
    #     return redirect("dashboard")   




@login_required
@user_type_required("Staff")
def expense_category(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "income_head_view" in request.permissions
        or "income_head_add" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = ExpenseCategory.objects.filter(branch=branch_id)
            form = ExpenseCategoryForm()
            if request.method == "POST":
                form = ExpenseCategoryForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.created_by = request.user
                    obj.save()
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/expense_category")
                else:
                    print(form.errors)
            context = {"form": form, "records": records, "expense_category": "active"}
            return render(request, "Income/expense_category.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def expense_category_edit(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "income_head_edit" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)

            records = ExpenseCategory.objects.filter(branch=branch_id)
            record = ExpenseCategory.objects.get(id=pk)
            record_branch_id = record.branch.id
            form = ExpenseCategoryForm(instance=record)
            if request.method == "POST":
                form = ExpenseCategoryForm(request.POST, instance=record)
                if form.is_valid():
                    obj=form.save()
                    if branch_id == record_branch_id:
                        obj.created_by = request.user
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                        obj.created_by = request.user
                    obj.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/expense_category")
            context = {
                "form": form,
                "records": records,
                "expense_category": "active",
                "edit": True,
            }
            return render(request, "Income/expense_category.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def expense_category_view(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "income_head_view" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = ExpenseCategory.objects.filter(branch=branch_id)
            record = ExpenseCategory.objects.get(id=pk)
            form = ExpenseCategoryForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "income_head": "active",
                "view": True,
            }
            return render(request, "Income/expense_category.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def expense_category_delete(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "income_head_delete" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            expensecategory=ExpenseCategory.objects.get(id=pk)
            expensecategory_branch_id = expensecategory.branch.id
            if int(expensecategory_branch_id) == int(branch_id):                        
                ExpenseCategory.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/expense_category")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")                  
    
    
@login_required
@user_type_required("Staff")
def create_expense(request):
    # if (
    #     request.user.is_superuser or request.user.is_school_admin
    #     or "expense_view" in request.permissions
    #     or "expense_add" in request.permissions
    #     or request.permissions
    # ):
    #     try:
            token = request.session['user_token'] 
            # endpoint = 'finance/transaction-type/'
            # endpoint_transaction = 'finance/all-transaction/'
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Expense.objects.filter(branch=branch_id)
            form = ExpenseForm()

            if request.method == "POST":
                payment_type = request.POST.get("option")                
                print("payment_type", payment_type)
                form = ExpenseForm(request.POST, request.FILES)
                if form.is_valid():
                    # response = call_get_method(BASE_URL, endpoint, token)
                    # transaction_data = response.json()
                    # print("transaction_data", transaction_data)

                    # Extract 'name' and 'transaction_type_id' into a list of dictionaries
                    # transaction_list = [{'name': item['name'], 'transaction_type_id': item['transaction_type_id']} for item in transaction_data]

                    # print("transaction_list", transaction_list)
                    # payroll_transaction = next((transaction for transaction in transaction_list if transaction['name'] == 'Payroll'), None)
                    # if payroll_transaction:
                    #     transaction_name = payroll_transaction['name']
                    #     transaction_type_id = payroll_transaction['transaction_type_id']
                    #     print("Transaction Name:", transaction_name)
                    #     print("Transaction Type ID:", transaction_type_id)
                    # else:
                    #     print("No 'Payroll' transaction found.")
                    # if response.status_code != 200:
                    #     return render(request, 'error500.html', {'error': str(response.json())})
                            

                    if request.method == "POST":
                        expence_amount=form.cleaned_data["amount"]
                        vendor=form.cleaned_data["vendor"]
                        branch = Branch.objects.get(id=branch_id)
                        print("branch+++", branch.school.reference_id) 
                        
                      
                        student_information = {
                            "student_name": f"{form.cleaned_data.get('name')}",
                            "roll_no": f"{form.cleaned_data.get('invoice_number')}"
                        }
                        
                        
                        # converting student_information to JSON format
                        # student_information_json = json.dumps(student_information)
                        # print("++++tudent",type(student_information_json))

                        # using it in the data dictionary
                    data = {
                        # 'transaction_type_id': str(transaction_type_id),
                        'company_id': str(branch.school.reference_id),
                        'amount': int(expence_amount),
                        'input_params_values': student_information 
                    }
                    print("++++++++++++++++++",type(data))

                    json_data = json.dumps(data)
                    print("=========", type(json_data))

                    # response = call_post_method(BASE_URL, endpoint_transaction, json_data, token)
                    # print("response+++", response)
                    # if response.status_code != 200:
                    #     print('Response Status Code:', response.content)
                    # response_data = json.loads(response.content.decode('utf-8')) 
                    # transaction_id=response_data['record_id']    
                    # print("transaction_id",transaction_id)
                    # Transaction.objects.create(
                    #     student_id=None,
                    #     reference_id=transaction_id,                   
                    #     branch_id = branch_id
                    # )
                    
                expense_instance = form.save()
                expense_instance.branch_id = branch_id
                if payment_type == "regular_payment":
                    expense_instance.regular_payment = True 
                    expense_instance.one_time_payment = False   
                    expense_instance.save()
                    
                if  payment_type == "one_time_payment":   
                    expense_instance.one_time_payment = True
                    expense_instance.regular_payment = False  
                    expense_instance.save()
                    
                    valid_expenses = []
                    expense = Expense.objects.get(id=expense_instance.id)  
                    print("expense----",expense)          
                    valid_expenses.append(expense.id) 
                    invoice = Invoice.objects.create(          
                    issue_date=form.cleaned_data["invoice_date"],
                    due_date=None,    
                    vendor = expense.vendor,           
                    total_amount=form.cleaned_data["amount"],
                    status="GranateInvoice",
                    payment_date=form.cleaned_data["payment_date"],
                    created_by=request.user,
                    branch_id=branch_id       
                    )
                    invoice.invoice_number = unique_id("Invoice", Invoice)
                    invoice.expense.set(valid_expenses) 
                    invoice.save()
                    print("expense.id",vendor.id,expense.id,expence_amount,expence_amount)
                    acc_rec_obj = AccountPayable.objects.create(reference_type_id='RT-001',reference_number=expense.id,vendor_id=vendor.id,
                                                                    vendor_name=vendor.name,
                            actual_amount=str(expence_amount),amount_due=str(expence_amount))
                    print('acc_rec_obj',acc_rec_obj)
                    return HttpResponseRedirect(f"/view_invoice/{invoice.id}")                 
                success =True
                if success:
                    messages.success(request, "Record Saved Successfully")
                else:
                    messages.error(request, "Failed to process the expense")
                return HttpResponseRedirect("/create_expense")
            else:
                print(form.errors)

            context = {"form": form, "records": records, "create_expense": "active"}
            return render(request, "Expenses/create_expense.html", context)
    #     except Exception as error:
    #         return render(request, "error.html", {"error": error})
    # else:
    #     return redirect("dashboard")


@login_required
@user_type_required("Staff")
def create_expense_edit(request, pk):
    # if (
    #     request.user.is_superuser or request.user.is_school_admin
    #     or "expense_edit" in request.permissions
    #     or request.permissions
    # ):
    #     try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)

            records = Expense.objects.filter(branch=branch_id)
            record = Expense.objects.get(id=pk)
            data_branch_id = record.branch.id
            form = ExpenseForm(instance=record)
            if request.method == "POST":
                payment_type = request.POST.get("option") 
                form = ExpenseForm(request.POST, instance=record)
                if form.is_valid():
                    
                    if branch_id == data_branch_id:
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                    expense_instance = form.save()
                    
                    if payment_type == "regular_payment":
                        expense_instance.regular_payment = True 
                        expense_instance.one_time_payment = False   
                        expense_instance.save()
                    if  payment_type == "one_time_payment":   
                        expense_instance.one_time_payment = True
                        expense_instance.regular_payment = False  
                        expense_instance.save()
                    expense_instance.save()
                    acc_rec_obj, created = AccountPayable.objects.update_or_create(
                        reference_number=record.pk,
                        defaults={
                            'reference_type_id': 'RT-001',
                            'vendor_id': record.vendor.pk,
                            'actual_amount': str(record.amount),
                            'amount_due': str(record.amount),
                        }
                    )
                    print('acc_rec_obj',acc_rec_obj,created)
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/create_expense")
            context = {
                "form": form,
                "records": records,
                "create_expense": "active",
                "edit": True,
                "record":record
            }
            return render(request, "Expenses/create_expense_edit.html", context)
    #     except Exception as error:
    #         return render(request, "error.html", {"error": error})
    # else:
    #     return redirect("dashboard")


@login_required
@user_type_required("Staff")
def create_expense_view(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "expense_view" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Expense.objects.filter(branch=branch_id)
            record = Expense.objects.get(id=pk)
            form = ExpenseForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "create_expense": "active",
                "view": True,
            }
            return render(request, "Expenses/create_expense.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def create_expense_delete(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "expense_delete" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            addexpense=Expense.objects.get(id=pk)
            addexpense_branch_id = addexpense.branch.id
            if int(addexpense_branch_id) == int(branch_id):                        
                Expense.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/create_expense")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")
    
    
@login_required
@user_type_required("Staff")
def invoice_granate(request):
    # if request.user.is_superuser or request.user.is_school_admin or "human_resource_report_view" in request.permissions:
    #     try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            expense_category = ExpenseCategory.objects.filter(branch=branch_id)
            vendor_list = Vendor.objects.filter(branch=branch_id)
            
            records = Expense.objects.filter(branch=branch_id)
            print('-----++----',vendor_list)
            if request.method == "POST":
                expense_categorys = ExpenseCategory.objects.filter(branch=branch_id)
                vendor_list = Vendor.objects.filter(branch=branch_id)
                print("expense_categorys@@@",expense_categorys)
                category_id = request.POST.get("category_id")
                vendor_id = request.POST.get("vendor_id")
             
                filters = {}            
                if category_id:
                    filters["category_id"] = category_id
                if vendor_id:
                    filters["vendor_id"] = vendor_id    
                if branch_id:
                    filters["branch_id"] = branch_id    

                records = Expense.objects.filter(**filters)
                print('-----++----',records)
                context = {
                    "records": records,
                    "expense_category": expense_categorys,                    
                    "expense_categorys": "active",
                    "vendor_list":vendor_list
                    
                }
                return render(request, "Expenses/invoice_granate.html", context)
            context = {
                "records": records,
                "expense_categorys": "active",
                "expense_category": expense_category,
                "vendor_list":vendor_list
                
            }
            return render(request, "Expenses/invoice_granate.html", context)
    #     except Exception as error:
    #         return render(request, "error.html", {"error": error})
    # else:
    #     return render(request, "page_not_found.html", {"error": error})  
    
@login_required
@user_type_required("Staff")
def previous_invoice(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    records = GeneralSetting.objects.filter(branch=branch_id)
    total_amount_expense = 0  
    valid_expenses = []  
    print("valid_expenses",valid_expenses)   
    expense_list = request.POST.getlist("expense_list")
    print("expense_list",expense_list)   
    for data in expense_list:
        try:
            expense = Expense.objects.get(id=data)            
            valid_expenses.append(expense.id)            
            print("valid_expenses",valid_expenses)  
            total_amount_expense += expense.amount  
            expense.status = "generateinvoice"
            expense.save()
        except Expense.DoesNotExist:
            print(f"Expense with id {data} does not exist.")  
            continue
        print("total_amount_expense---:", total_amount_expense)
    expense = Expense.objects.filter(id__in=valid_expenses)  
    
    print(f"Expense with id {expense}===.")  
    
    context = {"print_header_footer": "active","records":records,
               "expense":expense,"total_amount_expense":total_amount_expense
               }
    return render(request, "Expenses/previous_invoice.html", context)
    
    

def create_invoice(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    current_date = date.today()
    total_amount_expense = 0  
    valid_expenses = []  
    valid_vendor = []  
    print("valid_vendor",valid_vendor)   
    expense_list = request.POST.getlist("expense_get_all")
    due_date = request.POST.get("due_date")
    issue_date = request.POST.get("issue_date")
    print("expense_list",expense_list,due_date,issue_date)   
    for data in expense_list:
        try:
            expense = Expense.objects.get(id=data)            
            valid_expenses.append(expense.id)            
            valid_vendor.append(expense.vendor)            
            print("valid_vendor",valid_vendor)  
            total_amount_expense += expense.amount  
        except Expense.DoesNotExist:
            print(f"Expense with id {data} does not exist.")  
            continue    
    if len(set(valid_vendor)) != 1:
        print("Error: Expenses have different vendors.")
        # Handle the error case, such as returning a response or raising an exception
    else:
        # Only create the invoice if there's a single vendor
        if request.method == "POST":
            vendor = valid_vendor[0]  # Since all vendors are the same, we can take the first one
            
            invoice = Invoice.objects.create(          
                issue_date=issue_date,
                due_date=due_date,   
                total_amount=total_amount_expense,
                status="GranateInvoice",
                payment_date=current_date,
                created_by=request.user,
                branch_id=branch_id,
                vendor=vendor,  # Set the vendor here
            )
            invoice.invoice_number = unique_id("Invoice", Invoice)
            invoice.expense.set(valid_expenses) 
            invoice.save()
            acc_rec_obj = AccountPayable.objects.create(reference_type_id='RT-001',reference_number=expense.id,vendor_id=vendor.id,
                                                                    vendor_name=vendor.name,
                            actual_amount=str(expense.amount),amount_due=str(expense.amount))
    return HttpResponseRedirect("/invoice_details")   
    

def invoice_details(request): 
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    invoice_all=Invoice.objects.filter(branch=branch_id)        
    context = {
               "invoice_details_view": "active",
               "invoice_all":invoice_all
               }
    return render(request, "Expenses/invoice_details.html", context)   

@login_required
@user_type_required("Staff")
def view_invoice(request,pk):
    invoice = Invoice.objects.get(id=pk)
    print("invoice---",invoice.due_date)
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    records = GeneralSetting.objects.filter(branch=branch_id)
  
    context = {
                "invoice_details_view": "active",
                "invoice":invoice,"records":records
              
               }
    return render(request, "Expenses/view_invoice.html", context)



@login_required
@user_type_required("Staff")
def vendor(request):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "income_head_view" in request.permissions
        or "income_head_add" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Vendor.objects.filter(branch=branch_id)
            form = VendorForm()
            if request.method == "POST":
                form = VendorForm(request.POST)
                if form.is_valid():
                    obj=form.save()
                    obj.branch_id = branch_id
                    obj.created_by = request.user
                    obj.save()
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/vendor")
                else:
                    print(form.errors)
            context = {"form": form, "records": records, "vendor_create": "active"}
            return render(request, "Income/vendor.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def vendor_edit(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "income_head_edit" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)

            records = Vendor.objects.filter(branch=branch_id)
            record = Vendor.objects.get(id=pk)
            record_branch_id = record.branch.id
            form = VendorForm(instance=record)
            if request.method == "POST":
                form = VendorForm(request.POST, instance=record)
                if form.is_valid():
                    obj=form.save()
                    if branch_id == record_branch_id:
                        obj.created_by = request.user
                        form.save()
                    else:
                        form.instance.branch_id = branch_id
                        obj.created_by = request.user
                    obj.save()
                    messages.warning(request, "Record Updated Successfully")
                    return HttpResponseRedirect("/vendor")
            context = {
                "form": form,
                "records": records,
                "vendor_create": "active",
                "edit": True,
            }
            return render(request, "Income/vendor.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def vendor_view(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "income_head_view" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            records = Vendor.objects.filter(branch=branch_id)
            record = Vendor.objects.get(id=pk)
            form = VendorForm(instance=record)
            context = {
                "form": form,
                "records": records,
                "vendor_create": "active",
                "view": True,
            }
            return render(request, "Income/vendor.html", context)
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")


@login_required
@user_type_required("Staff")
def vendor_delete(request, pk):
    if (
        request.user.is_superuser or request.user.is_school_admin
        or "income_head_delete" in request.permissions
        or request.permissions
    ):
        try:
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            Vendor_delete=Vendor.objects.get(id=pk)
            Vendor_delete_branch_id = Vendor_delete.branch.id
            if int(Vendor_delete_branch_id) == int(branch_id):                        
                Vendor.objects.get(id=pk).delete()
            else:
                messages.error(request, "School id Doesn't match record no delete")
            messages.error(request, "Record Deleted Successfully")
            return HttpResponseRedirect("/vendor")
        except Exception as error:
            return render(request, "error.html", {"error": error})
    else:
        return redirect("dashboard")  
    
   
# ==============================Start Alumni===========================

@login_required
@user_type_required("Staff")
def alumni_type(request):
    try:
        print("enter")
        branch_name = request.session.get('branch_id', None)
        if branch_name:
            branch_id = branch_name       
        else:
            branch_id = None  
            print("branch_name@@@",branch_name)
        form = AluminitypeForm()
        records  = AlumniType.objects.filter(branch=branch_id)
        print("records+++",records)
        if request.method == "POST":
            form = AluminitypeForm(request.POST)
            if form.is_valid():
                obj=form.save()
                obj.branch_id = branch_id
                obj.created_by = request.user
                obj.save()
                return redirect('alumni_type')  
            else:
                print(form.errors)
        context = {
            'form': form,'recordss':records,"alumni_type":"active"
            }
        return render(request, 'Alumni/alumnitype.html',context)
    except Exception as error:
            return render(request, "error.html", {"error": error})

@login_required
@user_type_required("Staff")
def edit_alumni_type(request, pk):
    try:
        branch_name = request.session.get('branch_id', None)
        if branch_name:
            branch_id = branch_name       
        else:
            branch_id = None  
            print("branch_name@@@",branch_name)
        alumni_type = get_object_or_404(AlumniType, pk=pk) 
        if request.method == "POST":
            form = AluminitypeForm(request.POST, instance=alumni_type)
            if form.is_valid():
                obj=form.save()
                if branch_id == alumni_type.branch.id:
                    obj.created_by = request.user
                    form.save()
                else:
                    form.instance.branch_id = branch_id
                    obj.created_by = request.user
                obj.save()
                return redirect('alumni_type')  
        else:
            form = AluminitypeForm(instance=alumni_type)
            records  = AlumniType.objects.filter(branch=branch_id)
        return render(request, 'Alumni/alumnitype.html', {'form': form,'recordss':records,'edit':True,"alumni_type":"active"})
    except Exception as error:
            return render(request, "error.html", {"error": error})

@login_required
@user_type_required("Staff")
def view_alumni_type(request, pk):
    try:
        branch_name = request.session.get('branch_id', None)
        if branch_name:
            branch_id = branch_name       
        else:
            branch_id = None  
            print("branch_name@@@",branch_name)
        alumni_type = get_object_or_404(AlumniType, pk=pk) 
        if request.method == "POST":
            form = AluminitypeForm(request.POST, instance=alumni_type)
            if form.is_valid():
                form.save()  
                return redirect('alumni_type')  
        else:
            form = AluminitypeForm(instance=alumni_type)
            records  = AlumniType.objects.filter(branch=branch_id)
        return render(request, 'Alumni/alumnitype.html', {'form': form,'recordss':records,'view':True,"alumni_type":"active"})
    except Exception as error:
            return render(request, "error.html", {"error": error})

@login_required
@user_type_required("Staff")
def delete_alumni_type(request,pk):
    try:
        branch_name = request.session.get('branch_id', None)
        if branch_name:
            branch_id = branch_name       
        else:
            branch_id = None  
            print("branch_name@@@",branch_name)
        alumni_type = get_object_or_404(AlumniType, pk=pk) 
        print("alumni_type--",alumni_type) 
        alumni_type_branch_id = alumni_type.branch.id
        if int(alumni_type_branch_id) == int(branch_id):                        
            AlumniType.objects.get(id=pk).delete()
        else:
            messages.error(request, "School id Doesn't match record no delete")
        messages.error(request, "Record Deleted Successfully")    
        return redirect('alumni_type')  
    except Exception as error:
            return render(request, "error.html", {"error": error})

@login_required
@user_type_required("Staff")  
def create_event_type(request):
    try:
        branch_name = request.session.get('branch_id', None)
        if branch_name:
            branch_id = branch_name       
        else:
            branch_id = None  
            print("branch_name@@@",branch_name)
        form = EventTypeForm() 
        if request.method == "POST":
            form = EventTypeForm(request.POST)
            if form.is_valid():
                obj=form.save()
                obj.branch_id = branch_id
                obj.created_by = request.user
                obj.save()
                return redirect('create_event_type') 
        records  = EventType.objects.filter(branch=branch_id)
        context = {'form': form,'records':records,"create_event_type":"active"}
        return render(request, 'Alumni/event_type.html', context)
    except Exception as error:
            return render(request, "error.html", {"error": error})

@login_required
@user_type_required("Staff")
def edit_event_type(request, pk):
    try:
        event_type = get_object_or_404(EventType, pk=pk) 
        if request.method == "POST":
            form = EventTypeForm(request.POST, instance=event_type)
            if form.is_valid():
                form.save() 
                return redirect('create_event_type') 
        else:
            form = EventTypeForm(instance=event_type)  
            records  = EventType.objects.all()
        return render(request, 'Alumni/event_type.html', {'form': form,'records':records,'edit':True})
    except Exception as error:
            return render(request, "error.html", {"error": error})

@login_required
@user_type_required("Staff")
def view_event_type(request, pk):
    try:
        event_type = get_object_or_404(EventType, pk=pk) 
        if request.method == "POST":
            form = EventTypeForm(request.POST, instance=event_type)
            if form.is_valid():
                form.save() 
                return redirect('create_event_type') 
        else:
            form = EventTypeForm(instance=event_type)  
            records  = EventType.objects.all()
        return render(request, 'Alumni/event_type.html', {'form': form,'records':records,'view':True})
    except Exception as error:
            return render(request, "error.html", {"error": error})


@login_required
@user_type_required("Staff")
def delete_event_type(request, pk):
    try :
        branch_name = request.session.get('branch_id', None)
        if branch_name:
            branch_id = branch_name       
        else:
            branch_id = None  
            print("branch_name@@@",branch_name)
        event_type = get_object_or_404(EventType, pk=pk)  
        event_type.delete() 
        return redirect('create_event_type') 
    except Exception as error:
            return render(request, "error.html", {"error": error})

@login_required
@user_type_required("Staff")
def alumni_create(request):
    try :
        branch_name = request.session.get('branch_id', None)
        if branch_name:
            branch_id = branch_name       
        else:
            branch_id = None  
            print("branch_name@@@",branch_name)
        records  = Alumni.objects.filter(branch=branch_id)    
        if request.method == "POST":
            form = AlumniForm(request.POST, request.FILES)
            if form.is_valid():
                obj=form.save()
                obj.branch_id = branch_id
                obj.created_by = request.user
                obj.save()
                return redirect('alumni_create') 
        else:
            form = AlumniForm()
        return render(request, 'Alumni/alumni.html', {'form': form,"alumni_create":"active","records":records})
    except Exception as error:
            return render(request, "error.html", {"error": error})

@login_required
@user_type_required("Staff")
def edit_alumni(request, pk):
    try:
        branch_name = request.session.get('branch_id', None)
        if branch_name:
            branch_id = branch_name       
        else:
            branch_id = None  
            print("branch_name@@@",branch_name)
        alumni_instance = get_object_or_404(Alumni, pk=pk)  
        print("alumni_instance+++",alumni_instance)
        form = AlumniForm(instance=alumni_instance) 
        records  = Alumni.objects.filter(branch=branch_id)    
        if request.method == "POST":
            form = AlumniForm(request.POST, request.FILES, instance=alumni_instance)
            if form.is_valid():
                obj=form.save()
                if branch_id == alumni_instance.branch.id:
                    obj.created_by = request.user
                    form.save()
                else:
                    form.instance.branch_id = branch_id
                    obj.created_by = request.user
                obj.save()
                return redirect('alumni_create') 
        else:
            form = AlumniForm(instance=alumni_instance)
        return render(request, 'Alumni/alumni.html', {'form': form,"alumni_create":"active","records":records})
    except Exception as error:
            return render(request, "error.html", {"error": error})

@login_required
@user_type_required("Staff")
def delete_alumni(request, pk):
    try :
        branch_name = request.session.get('branch_id', None)
        if branch_name:
            branch_id = branch_name       
        else:
            branch_id = None  
            print("branch_name@@@",branch_name)
        alumni_instance = get_object_or_404(Alumni, pk=pk)  
        alumni_instance_branch_id = alumni_instance.branch.id
        if int(alumni_instance_branch_id) == int(branch_id):                        
            Alumni.objects.get(id=pk).delete()
        else:
            messages.error(request, "School id Doesn't match record no delete")
        messages.error(request, "Record Deleted Successfully")   
        return redirect('alumni_create')  
    except Exception as error:
            return render(request, "error.html", {"error": error})

@login_required
@user_type_required("Staff")
def alumni_profile(request, pk):
    try:
        branch_name = request.session.get('branch_id', None)
        if branch_name:
            branch_id = branch_name       
        else:
            branch_id = None  
            print("branch_name@@@",branch_name)
        alumni_instance = get_object_or_404(Alumni, pk=pk)  
        records  = Alumni.objects.filter(branch=branch_id)
        form = AlumniForm(request.POST, instance=alumni_instance)
        if request.method == "POST":
            form = AlumniForm(request.POST, instance=alumni_instance)
            if form.is_valid():
                form.save()  
                return redirect('alumni_type')  
        else:
            form = AlumniForm(instance=alumni_instance)
        return render(request, 'Alumni/alumni.html', {'form': form,"alumni_create":"active",'view':True,"records":records})
    except Exception as error:
            return render(request, "error.html", {"error": error})
        
@login_required
@user_type_required("Staff")
def create_event(request):
    try:
        branch_name = request.session.get('branch_id', None)
        if branch_name:
            branch_id = branch_name       
        else:
            branch_id = None  
            print("branch_name@@@",branch_name)
        form = AlumniEventsForm() 
        if request.method == "POST":
            form = AlumniEventsForm(request.POST, request.FILES)  
            if form.is_valid():
                obj=form.save()
                obj.branch_id = branch_id
                obj.created_by = request.user
                obj.save()
                return redirect('create_event') 
        records = AlumniEvents.objects.filter(branch=branch_id)  
        context = {'form': form, 'records': records,"create_event":"active"}
        return render(request, 'Alumni/events.html', context)
    except Exception as error:
            return render(request, "error.html", {"error": error})

@login_required
@user_type_required("Staff")
def edit_event(request, pk):
    try:
        branch_name = request.session.get('branch_id', None)
        if branch_name:
            branch_id = branch_name       
        else:
            branch_id = None  
            print("branch_name@@@",branch_name)
        event = get_object_or_404(AlumniEvents, pk=pk) 
        if request.method == "POST":
            form = AlumniEventsForm(request.POST, request.FILES, instance=event) 
            if form.is_valid():
                obj=form.save()
                if branch_id == event.branch.id:
                    obj.created_by = request.user
                    form.save()
                else:
                    form.instance.branch_id = branch_id
                    obj.created_by = request.user
                obj.save() 
                return redirect('create_event') 
        else:
            form = AlumniEventsForm(instance=event) 
            records = AlumniEvents.objects.filter(branch=branch_id) 
        return render(request, 'Alumni/events.html', {'form': form, 'records': records, 'edit': True})
    except Exception as error:
            return render(request, "error.html", {"error": error})

@login_required
@user_type_required("Staff")
def view_event(request, pk):   
    try: 
        event = get_object_or_404(AlumniEvents, pk=pk) 
        if request.method == "POST":
            form = AlumniEventsForm(request.POST, request.FILES, instance=event) 
            if form.is_valid():
                form.save()  
                return redirect('create_event') 
        else:
            form = AlumniEventsForm(instance=event) 
            records = AlumniEvents.objects.all()
        return render(request, 'Alumni/events.html', {'form': form, 'records': records, 'view': True})
    except Exception as error:
            return render(request, "error.html", {"error": error})

@login_required
@user_type_required("Staff")
def delete_event(request, pk):
    try :
        branch_name = request.session.get('branch_id', None)
        if branch_name:
            branch_id = branch_name       
        else:
            branch_id = None  
            print("branch_name@@@",branch_name)
        event_instance = get_object_or_404(AlumniEvents, pk=pk)  
        event_instance_branch_id = event_instance.branch.id
        if int(event_instance_branch_id) == int(branch_id):                        
            AlumniEvents.objects.get(id=pk).delete()
        else:
            messages.error(request, "School id Doesn't match record no delete")
        messages.error(request, "Record Deleted Successfully") 
        return redirect('create_event')  
    except Exception as error:
            return render(request, "error.html", {"error": error})


# ==============================End Alumni=============================

def guest_register(request):    
    if request.method == "GET":
        form = SignUpForm()
        context = {
            "form": form,
        }
        return render(request, "Auth/guest_register.html", context)
    elif request.method == "POST":        
        form = SignUpForm(data=request.POST)
        if form.is_valid():
            user = form.save(commit=False)
            user.set_password(user.password)           
            user.save()
            return redirect("signin")
        else:
            context = {
                "form": form,
            }
            return render(request, "Auth/guest_register.html", context)    


@login_required
@user_type_required("Staff")
def buyer_register(request):
    # if request.user.is_superuser or request.user.is_school_admin or "staff_add" in request.permissions:
    #     try:
            token = request.session['user_token']
            branch_name = request.session.get('branch_id', None)
            if branch_name:
                branch_id = branch_name       
            else:
                branch_id = None  
                print("branch_name@@@",branch_name)
            endpoint = 'finance/user/'    
            school_name=Branch.objects.get(id=branch_id)
            print("school_name===",school_name.school)
            login_redentials=BuyerLoginCredentials.objects.filter(branch=branch_id)
            roles_list=Role.objects.filter(branch=branch_id)
            form = SignUpForm()
            if request.method == "POST":
                roles_id = request.POST.get("roles_id")
                print("roles_id---",roles_id)
                form = SignUpForm(request.POST)
                branch = Branch.objects.get(id=branch_id)
                if form.is_valid():                    
                    user = form.save(commit=False)
                    user.set_password(user.password) 
                    user.school = school_name.school
                    user.user_type = "Staff"
                    user.save()
                    AddStaff.objects.create(
                    user_id=user.pk,
                    staff_id=unique_id("BUYSTAFF", AddStaff),
                    registration_number=unique_id("BUYS", AddStaff),
                    first_name=form.cleaned_data["first_name"],
                    email=form.cleaned_data["email"],
                    gender="male",
                    date_of_birth=form.cleaned_data["dob"],
                    school_id = branch.school.id,
                    branch_id = branch_id,
                    is_admin = True,
                    roles_id = roles_id
                    )
                    
                    BuyerLoginCredentials.objects.create(
                        user_id=user.id,
                        buyer_username=form.cleaned_data["username"],
                        buyer_passwod=form.cleaned_data["password"],  
                        branch_id=branch_id
                    )
                    
                    print("branch+++", branch.school.reference_id)            
                    data = {
                        'password': form.cleaned_data["password"],
                        'first_name': form.cleaned_data["first_name"],
                        'middle_name': form.cleaned_data["last_name"],
                        'last_name': form.cleaned_data["last_name"],
                        'email': form.cleaned_data["username"],
                        'phone_number': form.cleaned_data["phone_number"],
                        'company_name': branch.school.reference_id,  
                        'branch_name': branch.reference_id  
                    }
                    print("++++++++++++++++++")

                    json_data = json.dumps(data)
                    print("=========", json_data)

                    response = call_post_method(BASE_URL, endpoint, json_data, token)
                    print("response+++", response)
                    if response.status_code != 200:
                        print('Response Status Code:', response.content)
                    messages.success(request, "Record Saved Successfully")
                    return HttpResponseRedirect("/buyer_register")
                else:
                    print(form.errors)
            context = {
                "form": form,                
                "buyer_register": "active",
                "view": True,
                "login_redentials":login_redentials,
                "roles_list":roles_list
            }
            return render(request, "System_setting/buyer_register.html", context)

    #     except Exception as error:
    #         return render(request, "error.html", {"error": error})
    # else:
    #     return redirect("dashboard")   
    
    
@login_required
def warning_page(request):
    try:
        redirect_url = request.GET.get("redirect_url")  
        print("redirect_url---",redirect_url)
        if request.method == "POST":
            select_pk=request.POST.get("select_pk")
            print("select_pk---",select_pk)
            return redirect(f'{redirect_url}') 
        else:               
            context = {                   

            }
            return render(request, "System_setting/warning_page.html", context)
    except Exception as error:
        return render(request, "error.html", {"error": error})

@login_required
def exam_type_list(request):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
    print("branch_name@@@",branch_name)
    records = ExamType.objects.filter(branch=branch_id)
    form = ExamTypeForm()
    if request.method == "POST":
        form = ExamTypeForm(request.POST)
        if form.is_valid():
            obj=form.save()
            obj.branch_id = branch_id
            obj.save()
            messages.success(request, "Record Saved Successfully")
            return HttpResponseRedirect("/exam_type")
    context = {"form": form, "records": records, "exam_type_list": "active"}
    return render(request, "Examinations/exam_type_list.html", context)

def exam_type_edit(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    records = ExamType.objects.filter(branch=branch_id)
    record = ExamType.objects.get(id=pk)
    data_branch_id = record.branch.id
    form = ExamTypeForm(instance=record)
    if request.method == "POST":
        form = ExamTypeForm(request.POST, instance=record)
        if form.is_valid():
            if branch_id == data_branch_id:
                form.save()
            else:
                form.instance.branch_id = branch_id
            form.save()
            return HttpResponseRedirect("/exam_type")
    context = {"form": form, "records": records, "exam_type_list": "active"}
    return render(request, "Examinations/exam_type_list.html", context)


@login_required
@user_type_required("Staff")
def exam_type_view(request, pk):
    branch_name = request.session.get('branch_id', None)
    if branch_name:
        branch_id = branch_name       
    else:
        branch_id = None  
        print("branch_name@@@",branch_name)
    records = ExamType.objects.filter(branch=branch_id)
    record = ExamType.objects.get(id=pk)
    form = ExamTypeForm(instance=record)
    context = {"form": form, "records": records, "exam_type_list": "active", "view": True}
    return render(request, "Examinations/exam_type_list.html", context)


@login_required
@user_type_required("Staff")
def exam_type_delete(request, pk):
    try:
        branch_name = request.session.get('branch_id', None)
        if branch_name:
            branch_id = branch_name       
        else:
            branch_id = None  
        print("branch_name@@@",branch_name)
        add_grade=ExamType.objects.get(id=pk)
        add_grade_id = add_grade.branch.id
        if int(add_grade_id) == int(branch_id):                        
                ExamType.objects.get(id=pk).delete()
        else:
            messages.error(request, "School id Doesn't match record no delete")
        messages.error(request, "Record Deleted Successfully")
        return HttpResponseRedirect("/exam_type_list")
    except Exception as error:
            return render(request, "error.html", {"error": error})

# ===========================Frist Import Excel===============================

def import_data_excel(request):
    if request.method == "POST":
        uploaded_files = {file.name: file for file in request.FILES.getlist("files")}  #  Store files in dict
        print("Uploaded files:", uploaded_files.keys())

        models = [ReferenceType, Finance_Currency,
                AssetTypeCategory, Finance_AssetType,AccountCategory, Finance_AccountType,
                Finance_GLLine,Accounts, Finance_TransactionCode, TransactionTypeMode ,Finance_TransactionType,TransactionTypeClassification
                ,PL_Catogary,PL_Reportmapping,ReportType
            ]  #  Add more models if needed

        temp_dir = "media/temp"
        os.makedirs(temp_dir, exist_ok=True)  #  Ensure temp directory exists

        for model in models:
            model_name = model.__name__
            print(f"Processing model: {model_name}")

            #  Check if file exists for the model
            file_name = next(
                (name for ext in [".csv", ".xlsx", ".xls"] if (name := model_name + ext) in uploaded_files), 
                None
            )

            if not file_name:
                print(f"No file found for model {model_name}, skipping.")
                continue  

            uploaded_file = uploaded_files[file_name]
            file_path = os.path.join(temp_dir, file_name)

            #  Save file in media/temp directory
            try:
                with open(file_path, "wb") as destination:
                    for chunk in uploaded_file.chunks():
                        destination.write(chunk)
                print(f"Saved file: {file_name}")
            except Exception as e:
                print(f"Error saving file {file_name}: {e}")
                continue

            #  Read data
            try:
                if file_name.endswith(".xlsx"):
                    df = pd.read_excel(file_path, engine="openpyxl", dtype=str)
                elif file_name.endswith(".xls"):
                    df = pd.read_excel(file_path, engine="xlrd", dtype=str)
                elif file_name.endswith(".csv"):
                    df = pd.read_csv(file_path, dtype=str)
                else:
                    print(f"Unsupported file format: {file_name}")
                    continue
                print(f"Read file {file_name} successfully with columns: {df.columns.tolist()}")
            except Exception as e:
                print(f"Error reading {file_name}: {e}")
                continue  

            headers = df.columns.tolist()
            print(f"Headers for {file_name}: {headers}")

            for index, row in df.iterrows():
                try:
                    record_data = {field: row[field] for field in headers if pd.notna(row[field]) and field != "charge_code"}
                    print(f"Row {index} data: {record_data}")

                    #  Create object
                    obj = model.objects.create(**record_data)
                    print(f"Created {model_name} object with ID: {obj.id}")

                    #  Handle Many-to-Many charge_code field safely
                    if "charge_code" in headers and pd.notna(row["charge_code"]):
                        charge_codes = row["charge_code"].split(',')
                        charge_code_objects = ChargeCode.objects.filter(charge_code_id__in=charge_codes)

                        obj.charge_code.set(charge_code_objects)  #  Set Many-to-Many field after saving object
                        print(f"Set charge codes for {model_name} object {obj.id}: {charge_codes}")

                except Exception as e:
                    print(f"Error processing row {index} in {file_name}: {e}")
                    continue  #  Skip row if an error occurs

        return HttpResponse("All files have been processed in model order.")

    return render(request, "import_excel.html")


def import_gl_lines(request):
    if request.method == "POST" and request.FILES.get("gl_line_file"):
        file = request.FILES["gl_line_file"]
        df = pd.read_excel(file)  # Read Excel File

        # Print all input data
        print("Raw Input Data:\n", df.to_string(index=False))  # Prints entire DataFrame without index

        # Clean column names (remove spaces, make lowercase)
        df.columns = df.columns.str.strip().str.lower()

        for index, row in df.iterrows():
            gl_line_id = str(row.get("gl_line_id", "")).strip() if pd.notna(row.get("gl_line_id")) else None
            gl_line_number = str(row.get("gl_line_number", "")).strip() if pd.notna(row.get("gl_line_number")) else None
            name = str(row.get("name", "")).strip() if pd.notna(row.get("name")) else None
            description = str(row.get("description", "")).strip() if pd.notna(row.get("description")) else None
            
            # Print each row's data
            print(f"Processing Row {index+1}:")
            print(f"  gl_line_id: {gl_line_id}")
            print(f"  gl_line_number: {gl_line_number}")
            print(f"  name: {name}")
            print(f"  description: {description}")

            # Skip row if `gl_line_id` is missing
            if not gl_line_id:
                print(f"  Skipping row {index+1}: Missing gl_line_id.")
                continue
            
            # Fetch or assign master_gl (itself as FK)
            master_gl_id = str(row.get("master_gl", "")).strip() if pd.notna(row.get("master_gl")) else None
            master_gl = Finance_GLLine.objects.filter(gl_line_id=master_gl_id).first() if master_gl_id else None
            
            # Fetch `AssetType` ForeignKey
            asset_type_name = str(row.get("asset_type", "")).strip() if pd.notna(row.get("asset_type")) else None
            asset_type = Finance_AssetType.objects.filter(asset_type_id=asset_type_name).first()
            
            if not asset_type:
                print(f"  Asset Type '{asset_type_name}' not found. Skipping row {index+1}.")
                continue  # Skip if asset type is not found
            
            # Create and Save GLLine
            Finance_GLLine.objects.create(
                gl_line_id=gl_line_id,
                gl_line_number=gl_line_number,
                name=name,
                description=description,
                master_gl=master_gl,
                asset_type=asset_type
            )

        return HttpResponseRedirect("/import_gl_lines")
    
    return render(request, "import_gl_lines.html")



def import_asset_types(request):
    if request.method == "POST" and request.FILES.get("asset_type_file"):
        file = request.FILES["asset_type_file"]
        df = pd.read_excel(file)  # Read Excel file

        # Print raw input data
        print("Raw Input Data:\n", df.to_string(index=False))

        # Clean column names (remove spaces, make lowercase)
        df.columns = df.columns.str.strip().str.lower()

        for index, row in df.iterrows():
            asset_type_id = str(row.get("asset_type_id", "")).strip() if pd.notna(row.get("asset_type_id")) else None
            name = str(row.get("name", "")).strip() if pd.notna(row.get("name")) else None
            description = str(row.get("description", "")).strip() if pd.notna(row.get("description")) else None
            asset_type_category_id = str(row.get("asset_type_category", "")).strip() if pd.notna(row.get("asset_type_category")) else None

            print(f"Processing Row {index+1}:")
            print(f"  Asset Type ID: {asset_type_id}")
            print(f"  Name: {name}")
            print(f"  Description: {description}")
            print(f"  Asset Type Category: {asset_type_category_id}")

            if not asset_type_id or not name:
                print(f"  Skipping row {index+1}: Missing required fields.")
                continue

            # Fetch AssetTypeCategory if provided
            asset_type_category = None
            if asset_type_category_id:
                asset_type_category = AssetTypeCategory.objects.filter(asset_type_category_id=asset_type_category_id).first()
                if not asset_type_category:
                    print(f"  Asset Type Category '{asset_type_category_id}' not found. Skipping row {index+1}.")
                    continue

            # Create and save AssetType
            Finance_AssetType.objects.create(
                asset_type_id=asset_type_id,  # Now using asset_type_id from Excel
                name=name,
                description=description,
                asset_type_category=asset_type_category
            )

        return redirect("/import_asset_types")

    return render(request, "import_asset_types.html")

def convert_nan_to_none(value):
    """ Convert NaN or empty values to None """
    return None if pd.isna(value) or value == "" else value

def import_accounts(request):
    if request.method == "POST" and request.FILES.get("accounts_file"):
        file = request.FILES["accounts_file"]
        df = pd.read_excel(file)  # Read Excel file

        # Print raw input data
        print("Raw Input Data:\n", df.to_string(index=False))

        # Clean column names (remove spaces, make lowercase)
        df.columns = df.columns.str.strip().str.lower()

        created_count = 0
        skipped_count = 0

        for index, row in df.iterrows():
            account_id = convert_nan_to_none(row.get("account_id"))
            account_number = convert_nan_to_none(row.get("account_number"))
            short_description = convert_nan_to_none(row.get("short_description"))
            account_holder_id = convert_nan_to_none(row.get("account_holder"))
            student_id = convert_nan_to_none(row.get("student_id"))
            gl_line_id = convert_nan_to_none(row.get("gl_line"))
            account_type_id = convert_nan_to_none(row.get("account_type"))
            account_category_id = convert_nan_to_none(row.get("account_category"))
            base_currency_id = convert_nan_to_none(row.get("base_currency"))
            cr_id = convert_nan_to_none(row.get("cr_id"))
            bank_id = convert_nan_to_none(row.get("bank"))

            overdraft_limit = convert_nan_to_none(row.get("overdraft_limit")) or 0
            opening_balance = convert_nan_to_none(row.get("opening_balance")) or 0
            current_cleared_balance = convert_nan_to_none(row.get("current_cleared_balance")) or 0
            current_uncleared_balance = convert_nan_to_none(row.get("current_uncleared_balance")) or 0
            total_balance = convert_nan_to_none(row.get("total_balance")) or 0

            print(f"Processing Row {index+1}: {account_id}, {account_number}")

            if not account_id or not account_number:
                print(f"  Skipping row {index+1}: Missing required fields.")
                skipped_count += 1
                continue

            # Check if the account already exists
            if Accounts.objects.filter(account_id=account_id).exists():
                print(f"  Skipping row {index+1}: Account ID '{account_id}' already exists.")
                skipped_count += 1
                continue

            # Fetch foreign key objects (convert NaN to None)
            account_holder = AccountHolder.objects.filter(account_holder_id=account_holder_id).first() if account_holder_id else None
            student = StudentMain.objects.filter(id=student_id).first() if student_id else None
            gl_line = Finance_GLLine.objects.filter(gl_line_id=gl_line_id).first() if gl_line_id else None
            account_type = Finance_AccountType.objects.filter(account_type_id=account_type_id).first() if account_type_id else None
            account_category = AccountCategory.objects.filter(account_category_id=account_category_id).first() if account_category_id else None
            base_currency = Finance_Currency.objects.filter(currency_id=base_currency_id).first() if base_currency_id else None
            cr = CommonRegistration.objects.filter(id=cr_id).first() if cr_id else None
            bank = BankRegistration.objects.filter(id=bank_id).first() if bank_id else None

            # Create new account
            Accounts.objects.create(
                account_id=account_id,
                account_number=account_number,
                short_description=short_description,
                account_holder=account_holder,
                student_id=student,
                gl_line=gl_line,
                account_type=account_type,
                account_category=account_category,
                base_currency=base_currency,
                cr_id=cr,
                bank=bank,
                overdraft_limit=overdraft_limit,
                opening_balance=opening_balance,
                current_cleared_balance=current_cleared_balance,
                current_uncleared_balance=current_uncleared_balance,
                total_balance=total_balance,
            )

            print(f"  Account '{account_id}' created successfully.")
            created_count += 1

        messages.success(request, f"Successfully created {created_count} accounts. Skipped {skipped_count} existing accounts.")

        return redirect("/import_accounts")

    return render(request, "import_accounts.html")


def import_transaction_codes(request):
    if request.method == "POST" and request.FILES.get("transaction_code_file"):
        file = request.FILES["transaction_code_file"]
        df = pd.read_excel(file)  # Read Excel file

        # Print raw input data
        print("Raw Input Data:\n", df.to_string(index=False))

        # Clean column names
        df.columns = df.columns.str.strip().str.lower()

        for index, row in df.iterrows():
            transaction_code_id = row.get("transaction_code_id")
            name = str(row.get("name", "")).strip() if pd.notna(row.get("name")) else None
            debit_gl_line_id = row.get("debit_gl_line")
            credit_gl_line_id = row.get("credit_gl_line")
            template_description = str(row.get("template_description", "")).strip() if pd.notna(row.get("template_description")) else None
            overdraft_check = str(row.get("overdraft_check", "FALSE")).strip().lower() == "true"

            print(f"Processing Row {index+1}:")
            print(f"  Transaction Code ID: {transaction_code_id}")
            print(f"  Name: {name}")
            print(f"  Debit GL Line ID: {debit_gl_line_id}")
            print(f"  Credit GL Line ID: {credit_gl_line_id}")
            print(f"  Template Description: {template_description}")
            print(f"  Overdraft Check: {overdraft_check}")

            # Validate required fields
            if not name or not debit_gl_line_id or not credit_gl_line_id:
                print(f"  Skipping row {index+1}: Missing required fields.")
                continue

            # Fetch ForeignKey references
            debit_gl_line = Finance_GLLine.objects.filter(gl_line_id=debit_gl_line_id).first()
            credit_gl_line = Finance_GLLine.objects.filter(gl_line_id=credit_gl_line_id).first()

            if not debit_gl_line or not credit_gl_line:
                print(f"  Invalid GL Line reference in row {index+1}. Skipping.")
                continue

            # Create and save TransactionCode
            Finance_TransactionCode.objects.create(
                name=name,
                debit_gl_line=debit_gl_line,
                credit_gl_line=credit_gl_line,
                template_description=template_description,
                overdraft_check=overdraft_check
            )

        return redirect("/import_transaction_codes")

    return render(request, "import_transaction_codes.html")

def import_transaction_types(request):
    if request.method == "POST" and request.FILES.get("transaction_type_file"):
        file = request.FILES["transaction_type_file"]
        df = pd.read_excel(file)  # Read Excel file

        # Print raw input data
        print("Raw Input Data:\n", df.to_string(index=False))

        # Clean column names
        df.columns = df.columns.str.strip().str.lower()

        for index, row in df.iterrows():
            transaction_type_id = row.get("transaction_type_id")
            name = str(row.get("name", "")).strip() if pd.notna(row.get("name")) else None
            debit_transaction_code_id = row.get("debit_transaction_code")
            credit_transaction_code_id = row.get("credit_transaction_code")
            charge_code_ids = str(row.get("charge_code", "")).split(",") if pd.notna(row.get("charge_code")) else []
            category_of_account_id = row.get("category_of_account")
            txn_type_classification_ids = str(row.get("txn_type_classification", "")).split(",") if pd.notna(row.get("txn_type_classification")) else []
            debit_currency = str(row.get("debit_currency", "")).strip() if pd.notna(row.get("debit_currency")) else None
            debit_account = str(row.get("debit_account", "")).strip() if pd.notna(row.get("debit_account")) else None
            credit_currency = str(row.get("credit_currency", "")).strip() if pd.notna(row.get("credit_currency")) else None
            credit_account = str(row.get("credit_account", "")).strip() if pd.notna(row.get("credit_account")) else None
            description = str(row.get("description", "")).strip() if pd.notna(row.get("description")) else None
            company_name_id = row.get("company_name")
            created_by_id = row.get("created_by")
            updated_by_id = row.get("updated_by")

            print(f"Processing Row {index+1}:")
            print(f"  Transaction Type ID: {transaction_type_id}")
            print(f"  Name: {name}")
            print(f"  Debit Transaction Code: {debit_transaction_code_id}")
            print(f"  Credit Transaction Code: {credit_transaction_code_id}")
            print(f"  Charge Codes: {charge_code_ids}")
            print(f"  Category of Account: {category_of_account_id}")
            print(f"  Transaction Type Classification: {txn_type_classification_ids}")
            print(f"  Debit Currency: {debit_currency}")
            print(f"  Debit Account: {debit_account}")
            print(f"  Credit Currency: {credit_currency}")
            print(f"  Credit Account: {credit_account}")
            print(f"  Description: {description}")
            print(f"  Company Name ID: {company_name_id}")
            print(f"  Created By ID: {created_by_id}")
            print(f"  Updated By ID: {updated_by_id}")

            debit_transaction_code_id = int(row["debit_transaction_code"]) if pd.notna(row["debit_transaction_code"]) else None
            credit_transaction_code_id = int(row["credit_transaction_code"]) if pd.notna(row["credit_transaction_code"]) else None
            company_name_id = int(company_name_id) if pd.notna(company_name_id) and str(company_name_id).strip().isdigit() else None
            # Validate required fields
            if not name:
                print(f"  Skipping row {index+1}: Missing required fields.")
                continue

            # Fetch ForeignKey references
            debit_transaction_code = Finance_TransactionCode.objects.filter(transaction_code_id=debit_transaction_code_id).first() if debit_transaction_code_id else None
            credit_transaction_code = Finance_TransactionCode.objects.filter(transaction_code_id=credit_transaction_code_id).first() if credit_transaction_code_id else None
            category_of_account = AccountCategory.objects.filter(account_category_id=category_of_account_id).first() if category_of_account_id else None
            company_name = Company.objects.filter(id=company_name_id).first() if company_name_id else None
   

            # Fetch ManyToMany references
            charge_codes = ChargeCode.objects.filter(charge_code_id__in=[int(cc) for cc in charge_code_ids if cc.isdigit()])
            txn_type_classifications = TransactionTypeClassification.objects.filter(TTC_ID__in=[int(tc) for tc in txn_type_classification_ids if tc.isdigit()])

            # Create TransactionType instance
            transaction_type = Finance_TransactionType.objects.create(
                name=name,
                debit_transaction_code=debit_transaction_code,
                credit_transaction_code=credit_transaction_code,
                category_of_account=category_of_account,
                debit_currency=debit_currency,
                debit_account=debit_account,
                credit_currency=credit_currency,
                credit_account=credit_account,
                description=description,
                company_name=company_name,
               
            )

            # Assign ManyToMany fields
            transaction_type.charge_code.set(charge_codes)
            transaction_type.txn_type_classification.set(txn_type_classifications)

        return redirect("/import_transaction_types")

    return render(request, "import_transaction_types.html")        
# ===========================End Import Excel=================================

# ============================ why this function parent records call api bbcounting ===============
# @login_required
# def parent_api_call(request):
#     try:
#         branch_name = request.session.get('branch_id', None)
#         if branch_name:
#             branch_id = branch_name       
#             print("branch_id",branch_id)
#         else:
#             branch_id = None  
#             print("branch_name@@@",branch_name)
#         branch = Branch.objects.get(id=branch_id)
#         token = request.session['user_token']
#         endpoint = 'finance/user/'
#         student_records = StudentAdmission.objects.filter(branch=branch_id)
#         for student in student_records:
#             student_guardians = StudentGuardianDetails.objects.filter(student=student)
#             print("student_guardian---", student_guardians)                                        
#             password_parent = generate_password()

#             for guardian in student_guardians:
#                 data = {
#                     'password': password_parent,
#                     'first_name': student.first_name,
#                     'middle_name': student.last_name,
#                     'last_name': student.last_name,
#                     'email': guardian.guardian_email,
#                     'phone_number': guardian.phone,
#                     'company_name': branch.school.reference_id,
#                     'branch_name': branch.reference_id  
#                 }
                
#                 json_data = json.dumps(data)
#                 print("Sending data:", json_data)

#                 response = call_post_method(BASE_URL, endpoint, json_data, token)
#                 print("Response:", response)

#                 if response.status_code != 200:
#                     print('Response Status Code:', response.status_code, response.content)

#         return redirect("dashboard")

#     except Exception as error:
#         return render(request, "error.html", {"error": error})
    
# =============================================================================    

